<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nijjara ERP - Demo Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-bg: #121212;
        --color-bg-panel: #1e1e1e;
        --color-border: rgba(255, 255, 255, 0.1);
        --color-text-primary: #f0f0f0;
        --color-text-secondary: #a0a0a0;
        --color-accent: #d4af37;
        --color-surface-light: #2a2a2a;
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
        --color-success: #2ecc71;
        --color-danger: #e74c3c;
        --font-family-arabic: "Cairo", sans-serif;
        --glassy-surface-bg: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.08),
            rgba(15, 15, 20, 0.65)
          ),
          rgba(18, 18, 24, 0.82);
        --glassy-border: rgba(255, 255, 255, 0.18);
        --glassy-shadow: 0 24px 48px rgba(0, 0, 0, 0.45);
        --glassy-shadow-soft: 0 16px 32px rgba(0, 0, 0, 0.35);
        --glassy-blur: 18px;
        --glassy-input-bg: linear-gradient(
          140deg,
          rgba(255, 255, 255, 0.1),
          rgba(24, 24, 32, 0.82)
        );
      }
      body[class*="module-theme-"] {
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
      }
      body.module-theme-portal {
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
      }
      body.module-theme-projects {
        --theme-accent: #153d7a; /* Dark Blue */
        --theme-accent-16: rgba(21, 61, 122, 0.16);
        --theme-accent-24: rgba(21, 61, 122, 0.24);
      }
      body.module-theme-finance {
        --theme-accent: #7c5a1f; /* Dark Gold */
        --theme-accent-16: rgba(124, 90, 31, 0.16);
        --theme-accent-24: rgba(124, 90, 31, 0.24);
      }
      body.module-theme-hr {
        --theme-accent: #0f6c43; /* Dark Green */
        --theme-accent-16: rgba(15, 108, 67, 0.16);
        --theme-accent-24: rgba(15, 108, 67, 0.24);
      }
      body.module-theme-system {
        --theme-accent: #3a1b5c; /* Dark Purple */
        --theme-accent-16: rgba(58, 27, 92, 0.16);
        --theme-accent-24: rgba(58, 27, 92, 0.24);
      }
      .module-card h2,
      .nav-btn,
      .nav-item,
      .portal-header h1,
      .portal-header p,
      .workspace-title,
      body,
      button,
      html,
      input,
      select,
      table,
      td,
      textarea,
      th {
        font-family: var(--font-family-arabic) !important;
      }
      .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      button,
      [role="button"],
      .nav-btn,
      .nav-item,
      .nav-icon-button,
      .icon-btn,
      .module-card,
      a[href] {
        cursor: pointer;
      }
      button:disabled,
      .icon-btn:disabled,
      .nav-btn:disabled {
        cursor: not-allowed;
      }
      html,
      body {
        height: 100%;
        background: var(--color-bg);
        color: var(--color-text-primary);
        overflow: hidden;
      }

      #main-content-wrapper {
        height: 100%; /* Fix for child containers not expanding */
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
      .view {
        position: fixed;
        inset: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.45s ease, visibility 0.45s;
      }
      .view.active {
        opacity: 1;
        visibility: visible;
      }
      #login-screen {
        display: grid;
        place-content: center;
        background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%232a2a2a" fill-opacity="0.2"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v-1zm-7 5h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zM54 95h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zM9 95h1v4h-1v-4zm-7 0h1v4H2v-4zM95 0h1v4h-1V0zM2 0h1v4H2V0z"/%3E%3Cpath d="M6 95h4v1H6v-1zM4 95h1v4H4v-4zM95 6h1v4h-1V6zM95 4h1v1h-1V4z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
      }
      .login-container {
        width: 400px;
        max-width: 92vw;
        padding: 3rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.88);
        backdrop-filter: blur(10px);
        animation: fadeIn 0.6s ease;
        position: relative;
      }
      .logo {
        font-size: 2.4rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
      }
      .logo span {
        color: var(--color-accent);
        font-weight: 600;
      }
      /* --- Form & Input Styles (NEW GLOSSY THEME) --- */
      .form-section {
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.05),
          rgba(0, 0, 0, 0.1)
        );
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        margin-bottom: 1.5rem;
      }

      .form-section-header {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--parent-color, var(--color-text-primary));
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--parent-color, rgba(255, 255, 255, 0.1));
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        font-size: 0.9rem;
        color: var(--color-text-secondary, #a0a0a0);
        margin-bottom: 0.5rem;
      }

      /* Glossy/Inset Inputs for Forms */
      .form-group input[type="text"],
      .form-group input[type="email"],
      .form-group input[type="password"],
      .form-group input[type="number"],
      .form-group input[type="date"],
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        background: linear-gradient(
          145deg,
          rgba(0, 0, 0, 0.1),
          rgba(0, 0, 0, 0.3)
        );
        color: var(--color-text-primary, #f0f0f0);
        font-size: 1rem;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3),
          0 1px 1px rgba(255, 255, 255, 0.05);
        transition: all 0.2s ease-in-out;
      }

      .form-group input[type="text"]::placeholder,
      .form-group textarea::placeholder {
        color: var(--color-text-secondary, #a0a0a0);
        opacity: 0.7;
      }

      .form-group input[type="text"]:focus,
      .form-group input[type="email"]:focus,
      .form-group input[type="password"]:focus,
      .form-group input[type="number"]:focus,
      .form-group input[type="date"]:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--parent-color, #4285f4);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3),
          0 0 0 2px var(--parent-color);
      }

      .form-group input[readonly] {
        background: rgba(0, 0, 0, 0.2);
        opacity: 0.7;
        cursor: not-allowed;
      }

      .form-group textarea {
        min-height: 120px;
        resize: vertical;
      }

      /* Form Actions (Save/Cancel buttons) */
      .form-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 1.5rem;
      }

      /* Glossy buttons for forms */
      .form-actions .btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.4);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3),
          inset 0 1px 1px rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
        cursor: pointer;
      }
      .form-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4),
          inset 0 1px 1px rgba(255, 255, 255, 0.2);
      }

      .form-actions .btn-save {
        background: linear-gradient(
          145deg,
          var(--parent-color, #0d6efd),
          color-mix(in srgb, var(--parent-color, #0d6efd) 70%, #000)
        );
        color: white;
      }
      .form-actions .btn-cancel {
        background: linear-gradient(145deg, #6c757d, #343a40);
        color: white;
      }
      .form-actions .btn:disabled {
        background: #555;
        border-color: #333;
        color: #999;
        opacity: 0.7;
        transform: none;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        cursor: not-allowed;
      }

      /* --- End of Form Styles --- */
      .main-button {
        width: 100%;
        padding: 0.9rem 1.2rem;
        border: 1px solid var(--glassy-border);
        border-radius: 14px;
        background: linear-gradient(
          160deg,
          rgba(212, 175, 55, 0.92),
          rgba(164, 135, 34, 0.85)
        );
        color: #111;
        font-weight: 700;
        cursor: pointer;
        position: relative;
        box-shadow: var(--glassy-shadow);
        backdrop-filter: blur(var(--glassy-blur));
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      }
      .main-button:hover {
        transform: translateY(-3px);
        border-color: rgba(255, 255, 255, 0.45);
      }
      .main-button:active {
        transform: translateY(-1px);
      }
      .main-button .spinner {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid #000;
        border-top-color: transparent;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: spin 0.8s linear infinite;
      }
      .main-button.loading .spinner {
        display: block;
      }
      .main-button.loading span {
        visibility: hidden;
      }

      .app-navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        min-height: 72px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        background: rgba(18, 18, 18, 0.92);
        border-bottom: 1px solid var(--glassy-border);
        backdrop-filter: blur(var(--glassy-blur));
        box-shadow: var(--glassy-shadow-soft);
        padding: 0.75rem 1.75rem;
        z-index: 50;
      }
      .app-navbar.hidden {
        display: none;
      }
      .app-navbar__left,
      .app-navbar__right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .app-navbar__right {
        align-items: center;
      }
      .navbar-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-inline-start: 0.75rem;
        align-items: center;
      }
      .app-brand {
        font-weight: 700;
        color: var(--color-accent);
      }
      .nav-btn {
        --nav-card-primary: rgba(36, 36, 36, 0.92);
        --nav-card-secondary: rgba(17, 17, 17, 0.88);
        --nav-card-border: rgba(255, 255, 255, 0.12);
        --nav-card-glow: rgba(255, 255, 255, 0.2);
        --nav-theme-accent: var(--color-accent);
        --theme-accent: var(--nav-theme-accent, var(--color-accent));
        position: relative;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        gap: 0.75rem;
        min-width: 150px;
        padding: 0.65rem 1rem;
        border-radius: 14px;
        background: radial-gradient(
            circle at top,
            rgba(255, 255, 255, 0.16),
            transparent 65%
          ),
          linear-gradient(
            160deg,
            var(--nav-card-primary),
            var(--nav-card-secondary)
          );
        border: 1px solid var(--nav-card-border, var(--glassy-border));
        color: var(--color-text-primary);
        cursor: pointer;
        box-shadow: var(--glassy-shadow-soft);
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          border-color 0.25s ease, filter 0.25s ease;
        text-align: right;
        backdrop-filter: blur(var(--glassy-blur));
      }
      .nav-btn:not(.active):hover {
        transform: translateY(-2px);
        border-color: var(--nav-card-glow);
        box-shadow: var(--glassy-shadow);
      }
      .nav-btn:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 3px;
      }
      .nav-btn.active {
        transform: translateY(2px);
        border-color: var(--nav-card-glow);
        box-shadow: inset 0 8px 14px rgba(0, 0, 0, 0.45);
      }
      .nav-btn__icon {
        flex: 0 0 auto;
        width: 36px;
        height: 36px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.08);
        color: var(--nav-theme-accent);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
        transition: background 0.25s ease, color 0.25s ease,
          box-shadow 0.25s ease, transform 0.25s ease;
      }
      .nav-btn.active .nav-btn__icon {
        background: var(--theme-accent);
        color: #111111;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.35) inset;
        transform: translateY(0.5px);
      }
      .nav-btn__label {
        flex: 1 1 auto;
        font-size: 0.95rem;
        font-weight: 600;
      }
      .nav-btn.active .nav-btn__label {
        color: var(--theme-accent);
      }
      .nav-btn .app-icon {
        --icon-color: currentColor;
      }
      .nav-btn[data-theme="projects"] {
        --nav-card-primary: rgba(90, 140, 255, 0.82);
        --nav-card-secondary: rgba(46, 80, 200, 0.92);
        --nav-card-border: rgba(90, 140, 255, 0.6);
        --nav-card-glow: rgba(90, 140, 255, 0.65);
        --nav-theme-accent: #5a8cff;
        --theme-accent: #5a8cff;
      }
      .nav-btn[data-theme="finance"] {
        --nav-card-primary: rgba(210, 170, 80, 0.78);
        --nav-card-secondary: rgba(140, 100, 32, 0.92);
        --nav-card-border: rgba(210, 170, 80, 0.58);
        --nav-card-glow: rgba(210, 170, 80, 0.65);
        --nav-theme-accent: #d2aa50;
        --theme-accent: #d2aa50;
      }
      .nav-btn[data-theme="hr"] {
        --nav-card-primary: rgba(102, 214, 168, 0.78);
        --nav-card-secondary: rgba(48, 140, 106, 0.9);
        --nav-card-border: rgba(102, 214, 168, 0.6);
        --nav-card-glow: rgba(102, 214, 168, 0.65);
        --nav-theme-accent: #66d6a8;
        --theme-accent: #66d6a8;
      }
      .nav-btn[data-theme="users"] {
        --nav-card-primary: rgba(200, 110, 210, 0.78);
        --nav-card-secondary: rgba(120, 60, 160, 0.92);
        --nav-card-border: rgba(200, 110, 210, 0.58);
        --nav-card-glow: rgba(200, 110, 210, 0.65);
        --nav-theme-accent: #c86ed2;
        --theme-accent: #c86ed2;
      }
      .nav-btn[data-theme="portal"] {
        --nav-card-primary: rgba(212, 175, 55, 0.82);
        --nav-card-secondary: rgba(150, 110, 30, 0.92);
        --nav-card-border: rgba(212, 175, 55, 0.6);
        --nav-card-glow: rgba(212, 175, 55, 0.65);
        --nav-theme-accent: var(--color-accent);
        --theme-accent: var(--color-accent);
      }
      @media (max-width: 1100px) {
        .app-navbar {
          flex-wrap: wrap;
          justify-content: center;
          padding: 0.75rem 1.25rem;
        }
        .navbar-buttons {
          justify-content: center;
          margin-inline-start: 0;
        }
        .nav-btn {
          min-width: 140px;
        }
      }
      @media (max-width: 640px) {
        .nav-btn {
          min-width: 100%;
        }
      }
      .nav-icon-button {
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: transform 0.25s ease, box-shadow 0.25s ease,
          border-color 0.25s ease, background 0.25s ease;
      }
      .nav-icon-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.35);
        border-color: rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.08);
        color: var(--color-text-primary);
      }
      .navbar-user {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.65rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--color-text-secondary);
      }
      .navbar-user__text {
        font-size: 0.85rem;
        font-weight: 600;
      }
      .app-icon {
        width: 20px;
        height: 20px;
        fill: none;
        stroke: var(--icon-color, #d0d0d0);
        stroke-width: 1.7;
        stroke-linecap: round;
        stroke-linejoin: round;
      }
      .app-icon--lg {
        width: 22px;
        height: 22px;
      }
      .app-icon--dark {
        --icon-color: #1f1f1f;
      }
      .icon-wrapper {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .nav-icon-button .app-icon {
        --icon-color: currentColor;
      }
      .workspace[data-theme] .nav-icon-button {
        border-color: var(--theme-accent-24, rgba(255, 255, 255, 0.12));
        color: var(--theme-accent, var(--color-text-secondary));
        background: var(--theme-accent-16, rgba(255, 255, 255, 0.04));
      }
      .workspace[data-theme] .nav-icon-button:hover {
        background: var(--theme-accent, rgba(255, 255, 255, 0.16));
        border-color: var(--theme-accent);
        color: #111;
      }
      .nav-btn__icon .app-icon {
        --icon-color: currentColor;
      }
      .nav-btn.active .nav-btn__icon .app-icon {
        --icon-color: #111111;
      }
      .navbar-user .app-icon {
        --icon-color: #d0d0d0;
      }

      #portal-view {
        padding: 4.5rem 1.75rem 1.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .portal-header {
        text-align: center;
        margin-bottom: 2.2rem;
      }
      .module-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(180px, 1fr));
        gap: 1.5rem;
        max-width: 1100px;
        width: 100%;
      }
      .module-card {
        --theme-accent: var(--color-accent);
        --card-primary: rgba(36, 36, 36, 0.92);
        --card-secondary: rgba(17, 17, 17, 0.88);
        --card-border: var(--theme-accent-24, rgba(255, 255, 255, 0.1));
        --card-glow: var(--theme-accent, rgba(255, 255, 255, 0.18));
        position: relative;
        padding: 2rem 1.6rem;
        border: 1px solid var(--card-border, var(--glassy-border));
        border-radius: 16px;
        background: radial-gradient(
            circle at top,
            rgba(255, 255, 255, 0.18),
            transparent 68%
          ),
          linear-gradient(160deg, var(--card-primary), var(--card-secondary));
        box-shadow: var(--glassy-shadow);
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s,
          backdrop-filter 0.3s;
        text-align: center;
        backdrop-filter: blur(var(--glassy-blur));
      }
      .module-card:hover {
        transform: translateY(-8px);
        border-color: var(--card-glow);
        box-shadow: 0 20px 36px rgba(0, 0, 0, 0.6), 0 0 0 1px var(--card-glow);
      }
      .module-card h2 {
        font-size: 1.3rem;
      }
      .module-card[data-theme="projects"] {
        --theme-accent: #5a8cff;
        --theme-accent-16: rgba(90, 140, 255, 0.16);
        --theme-accent-24: rgba(90, 140, 255, 0.24);
        --card-primary: rgba(40, 52, 82, 0.92);
        --card-secondary: rgba(22, 30, 50, 0.88);
        --card-border: rgba(90, 140, 255, 0.28);
        --card-glow: rgba(90, 140, 255, 0.4);
      }
      .module-card[data-theme="finance"] {
        --theme-accent: #d2aa50;
        --theme-accent-16: rgba(210, 170, 80, 0.16);
        --theme-accent-24: rgba(210, 170, 80, 0.24);
        --card-primary: rgba(55, 45, 26, 0.92);
        --card-secondary: rgba(34, 28, 16, 0.88);
        --card-border: rgba(210, 170, 80, 0.28);
        --card-glow: rgba(210, 170, 80, 0.4);
      }
      .module-card[data-theme="hr"] {
        --theme-accent: #66d6a8;
        --theme-accent-16: rgba(102, 214, 168, 0.16);
        --theme-accent-24: rgba(102, 214, 168, 0.24);
        --card-primary: rgba(36, 54, 48, 0.92);
        --card-secondary: rgba(19, 33, 28, 0.88);
        --card-border: rgba(102, 214, 168, 0.28);
        --card-glow: rgba(102, 214, 168, 0.4);
      }
      .module-card[data-theme="users"] {
        --theme-accent: #c86ed2;
        --theme-accent-16: rgba(200, 110, 210, 0.16);
        --theme-accent-24: rgba(200, 110, 210, 0.24);
        --card-primary: rgba(46, 33, 52, 0.92);
        --card-secondary: rgba(27, 18, 32, 0.88);
        --card-border: rgba(200, 110, 210, 0.28);
        --card-glow: rgba(200, 110, 210, 0.4);
      }

      .workspace {
        height: 100vh;
        display: grid;
        grid-template-columns: 1fr 240px;
        grid-template-rows: auto 1fr;
        grid-template-areas: "header header" "content nav";
        gap: 1rem;
        padding: 4.5rem 1.75rem 1.75rem;
        transform: scale(1.04);
        transition: transform 0.45s ease;
      }
      .view.active .workspace {
        transform: scale(1);
      }
      .workspace-header {
        grid-area: header;
        display: flex;
        align-items: end;
        justify-content: space-between;
      }
      .workspace-title {
        font-size: 1.6rem;
      }
      .workspace-content {
        grid-area: content;
        border: 1px solid var(--glassy-border);
        border-radius: 12px;
        background: var(--glassy-surface-bg);
        padding: 1rem 1.25rem;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        backdrop-filter: blur(var(--glassy-blur));
        box-shadow: var(--glassy-shadow);
      }
      .workspace {
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
      }
      .workspace[data-theme="projects"] {
        --theme-accent: #5a8cff;
        --theme-accent-16: rgba(90, 140, 255, 0.16);
        --theme-accent-24: rgba(90, 140, 255, 0.24);
      }
      .workspace[data-theme="finance"] {
        --theme-accent: #d2aa50;
        --theme-accent-16: rgba(210, 170, 80, 0.16);
        --theme-accent-24: rgba(210, 170, 80, 0.24);
      }
      .workspace[data-theme="hr"] {
        --theme-accent: #66d6a8;
        --theme-accent-16: rgba(102, 214, 168, 0.16);
        --theme-accent-24: rgba(102, 214, 168, 0.24);
      }
      .workspace[data-theme="users"] {
        --theme-accent: #c86ed2;
        --theme-accent-16: rgba(200, 110, 210, 0.16);
        --theme-accent-24: rgba(200, 110, 210, 0.24);
      }
      .workspace-nav {
        grid-area: nav;
        border: 1px solid var(--glassy-border);
        border-radius: 12px;
        background: var(--glassy-surface-bg);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        backdrop-filter: blur(var(--glassy-blur));
        box-shadow: var(--glassy-shadow-soft);
      }
      .nav-item {
        background: transparent;
        border: 1px solid var(--theme-accent-24);
        color: var(--color-text-secondary);
        text-align: right;
        padding: 0.6rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
        font-weight: 600;
      }
      .nav-item.active,
      .nav-item:hover,
      .sidebar-item.active,
      .sidebar-item:hover {
        background: var(--theme-accent);
        border-color: var(--theme-accent);
        color: #111;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.2) inset;
      }
      .nav-item:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 2px;
      }

      .sys-pane {
        display: none;
        flex-direction: column;
        gap: 1.5rem;
      }
      .sys-pane.active {
        display: flex;
      }
      .sys-pane__header {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .pane-heading {
        font-size: 1.1rem;
        font-weight: 600;
      }
      .sys-overview__summary {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .overview-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.8rem;
        margin-bottom: 0;
      }
      .overview-card {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.9);
        padding: 1rem;
      }
      .muted {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
      }
      .error-text {
        color: var(--color-danger);
        font-size: 0.95rem;
        text-align: center;
      }
      .table-wrapper {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        overflow: hidden;
        width: 100%;
        background: rgba(18, 18, 18, 0.85);
        position: relative;
      }
      .workspace-content .table-wrapper,
      .workspace-content .pane-table-container,
      .workspace-content table {
        width: 100%;
      }
      .pane-table-container {
        border: 1px solid var(--theme-accent-24);
        border-radius: 16px;
        background: rgba(18, 18, 18, 0.9);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        width: 100%;
      }
      .pane-table-scroll {
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: auto;
      }
      .pane-table-scroll table {
        width: 100%;
        min-width: 720px;
        table-layout: auto;
      }
      table {
        width: 100%;
        min-width: 720px;
        border-collapse: collapse;
        table-layout: auto;
        background: var(--glassy-surface-bg);
        border: 1px solid var(--glassy-border);
        box-shadow: var(--glassy-shadow-soft);
        backdrop-filter: blur(var(--glassy-blur));
        border-radius: 14px;
      }
      .generic-table {
        table-layout: auto;
      }
      table thead {
        background: var(--table-header-bg, rgba(24, 24, 32, 0.98));
      }
      .table-wrapper table {
        width: 100%;
        min-width: 720px;
      }
      .table-wrapper thead,
      .pane-table-scroll thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--table-header-bg, rgba(24, 24, 32, 0.98));
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
      }
      .table-wrapper thead th,
      .pane-table-scroll thead th {
        position: sticky;
        top: 0;
        z-index: 11;
        background: inherit;
        color: var(--table-header-color, #ffffff);
      }
      body[class*="module-theme-"] table thead th {
        color: var(--table-header-color, #ffffff);
      }
      body[class*="module-theme-"] .sidebar-item.active {
        background: var(--theme-accent);
        border-color: var(--theme-accent);
        color: #111;
      }
      td,
      th {
        padding: 0.8rem 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        text-align: right;
        overflow: hidden;
        word-break: break-word;
        min-width: 120px;
      }
      tbody tr {
        position: relative;
        z-index: 1;
      }
      th {
        white-space: normal;
        font-weight: 600;
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.04);
      }
      .generic-table thead {
        background: var(
          --table-header-bg,
          var(--theme-accent, rgba(24, 24, 32, 0.98))
        );
        color: var(--table-header-color, #ffffff);
      }
      .generic-table thead th {
        color: var(--table-header-color, #ffffff);
      }
      .module-controls {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.6rem 0.75rem;
        margin-bottom: 0.6rem;
        width: 100%;
        border: 1px solid var(--glassy-border);
        border-radius: 14px;
        background: var(--glassy-surface-bg);
        box-shadow: var(--glassy-shadow-soft);
        backdrop-filter: blur(var(--glassy-blur));
      }
      .module-controls__row {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        justify-content: flex-start;
      }
      .module-controls__primary,
      .module-controls__secondary {
        display: flex;
        flex: 1 1 260px;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.5rem;
      }
      .module-controls__secondary {
        justify-content: flex-end;
      }
      .generic-pane__controls {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.6rem;
        padding: 0;
        width: 100%;
      }
      .generic-pane__controls.module-controls {
        gap: 0.5rem;
      }
      .pane-mode-switch {
        display: inline-flex;
        gap: 0.75rem;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
      }
      .pane-mode-button {
        min-width: 160px;
        min-height: 46px;
        padding: 0.6rem 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--theme-accent-24);
        background: linear-gradient(
          180deg,
          rgba(18, 18, 18, 0.92),
          rgba(18, 18, 18, 0.72)
        );
        color: var(--theme-accent);
        font-weight: 600;
        font-size: 0.95rem;
        text-align: center;
        transition: background 0.25s ease, color 0.25s ease,
          box-shadow 0.25s ease, border-color 0.25s ease, transform 0.25s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .pane-mode-button.is-active {
        background: var(--theme-accent);
        color: #111111;
        border-color: var(--theme-accent);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.32);
      }
      .pane-mode-button:not(.is-active) {
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.4);
      }
      .pane-mode-button__content {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.45rem;
      }
      .pane-mode-button .app-icon {
        --icon-color: #d0d0d0;
      }
      .pane-mode-button.is-active .app-icon {
        --icon-color: #1f1f1f;
      }
      .pane-mode-button:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 3px;
      }
      .pane-mode-button:hover {
        border-color: var(--theme-accent);
      }
      .pane-mode-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
      }
      .pane-search-bar {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
      }
      .pane-search-bar input[type="search"],
      .pane-search-bar select {
        min-width: 200px;
        padding: 0.6rem 1rem;
        border-radius: 999px;
        border: 1px solid var(--glassy-border);
        background: var(--glassy-input-bg);
        color: var(--color-text-primary);
        min-height: 44px;
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 10px 22px rgba(0, 0, 0, 0.3);
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
          transform 0.2s ease;
      }
      .pane-search-bar input[type="search"]:focus,
      .pane-search-bar select:focus {
        border-color: var(--theme-accent, rgba(212, 175, 55, 0.8));
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.18),
          0 16px 36px rgba(0, 0, 0, 0.45);
        transform: translateY(-1px);
        outline: none;
      }
      .pane-search-bar select {
        cursor: pointer;
      }
      .pane-search-bar select option {
        background: var(--color-surface-light);
        color: var(--color-text-primary);
      }
      .pane-search-summary {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
        flex-basis: 100%;
        text-align: center;
      }
      .pane-bulk-actions {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        width: 100%;
      }
      .pane-bulk-actions .ghost-button,
      .pane-bulk-actions .accent-button {
        padding: 0.45rem 1rem;
        min-height: 44px;
      }
      .icon-label {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.45rem;
      }
      .icon-label .app-icon {
        --icon-color: currentColor;
      }
      .generic-table__select-header,
      .generic-table__select-cell {
        width: 52px;
        text-align: center;
      }
      .generic-table__select-cell input[type="checkbox"],
      .generic-table__select-all {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
      .generic-table__row--selected {
        background: var(--theme-accent-16);
      }
      .generic-table__row--selected:hover {
        background: var(--theme-accent-24);
      }
      @media (max-width: 768px) {
        .pane-search-bar {
          flex-direction: column;
          align-items: stretch;
        }
        .pane-search-bar input[type="search"],
        .pane-search-bar select {
          width: 100%;
        }
        .pane-bulk-actions {
          justify-content: stretch;
        }
        .generic-pane__controls {
          align-items: stretch;
        }
        .pane-mode-switch {
          justify-content: center;
        }
        .pane-mode-button {
          width: 100%;
        }
        .module-controls {
          flex-direction: column;
          align-items: stretch;
          gap: 0.75rem;
        }
        .module-controls__primary,
        .module-controls__secondary {
          justify-content: center;
        }
      }
      .ghost-button,
      .accent-button,
      .action-button {
        padding: 0.55rem 1rem;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 12px 24px rgba(0, 0, 0, 0.3);
      }
      .ghost-button {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--theme-accent-24, var(--glassy-border));
        color: var(--theme-accent, var(--color-text-secondary));
      }
      .ghost-button:hover {
        color: var(--color-text-primary);
        border-color: var(--theme-accent, var(--glassy-border));
        background: var(--theme-accent-16, rgba(255, 255, 255, 0.08));
        box-shadow: var(--glassy-shadow-soft);
      }
      .accent-button {
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.25),
            rgba(255, 255, 255, 0)
          ),
          var(--theme-accent, var(--color-accent));
        color: #111;
        border: 1px solid var(--theme-accent-24, rgba(255, 255, 255, 0.16));
        box-shadow: var(--glassy-shadow-soft);
      }
      .accent-button:hover {
        box-shadow: var(--glassy-shadow);
      }
      .action-button {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--glassy-border);
        color: #111;
      }
      .save-button {
        background: var(--color-success);
        border-color: rgba(46, 204, 113, 0.4);
        color: #111;
      }
      .cancel-button {
        background: var(--color-danger);
        border-color: rgba(231, 76, 60, 0.4);
        color: #fff;
      }
      .edit-button {
        background: #e67e22;
        border-color: rgba(230, 126, 34, 0.4);
        color: #111;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.8rem;
        border: 1px solid transparent;
      }
      .badge--ok {
        background: rgba(46, 204, 113, 0.15);
        color: #2ecc71;
        border-color: rgba(46, 204, 113, 0.3);
      }
      .badge--no {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
        border-color: rgba(231, 76, 60, 0.3);
      }
      .pane-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }
      .pane-header__title {
        font-size: 1.05rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }
      .pane-header__buttons {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .pane-header__buttons .ghost-button {
        min-width: 130px;
      }
      .ghost-button--small {
        font-size: 0.8rem;
        padding: 0.25rem 0.55rem;
        border-radius: 8px;
      }
      .generic-pane__body {
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.5fr);
        gap: 1.25rem;
        align-items: start;
        width: 100%;
      }
      .generic-pane--exempt .generic-pane__controls {
        display: none;
      }
      .generic-pane--exempt .generic-pane__body {
        grid-template-columns: 1fr;
      }
      @media (max-width: 980px) {
        .generic-pane__body {
          grid-template-columns: 1fr;
        }
      }
      .sys-pane[data-mode="list"] .generic-pane__body,
      .sys-pane[data-mode="form"] .generic-pane__body {
        grid-template-columns: 1fr;
      }
      .sys-pane[data-mode="list"] .generic-pane__view,
      .sys-pane[data-mode="form"] .generic-pane__form {
        width: 100%;
      }
      .generic-pane__view {
        min-height: 240px;
        border: 1px solid var(--glassy-border);
        border-radius: 16px;
        padding: 1.25rem;
        background: var(--glassy-surface-bg);
        box-shadow: var(--glassy-shadow-soft);
        backdrop-filter: blur(var(--glassy-blur));
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }
      .generic-pane__form {
        border: 1px solid var(--glassy-border);
        border-radius: 16px;
        padding: 1.25rem;
        background: var(--glassy-surface-bg);
        box-shadow: var(--glassy-shadow);
        backdrop-filter: blur(var(--glassy-blur));
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        max-height: calc(100vh - 12rem);
        overflow: auto;
      }
      .generic-pane__form[hidden] {
        display: none !important;
      }
      .generic-form {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }
      .generic-form__grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem 1.25rem;
      }
      .generic-form__field {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .generic-form__field--wide {
        grid-column: 1 / -1;
      }
      .generic-form__field label {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }
      .generic-form__field input,
      .generic-form__field select,
      .generic-form__field textarea {
        width: 100%;
        padding: 0.55rem 0.75rem;
        border-radius: 12px;
        border: 1px solid var(--glassy-border);
        background: var(--glassy-input-bg);
        color: var(--color-text-primary);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 12px 24px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
          transform 0.2s ease;
      }
      .generic-form__field textarea {
        min-height: 120px;
        resize: vertical;
      }
      select option {
        background: #c4c4c4;
        color: #1a1a1a;
      }
      .generic-form__field input:focus,
      .generic-form__field select:focus,
      .generic-form__field textarea:focus {
        border-color: rgba(212, 175, 55, 0.8);
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.35),
          0 16px 36px rgba(0, 0, 0, 0.45);
        transform: translateY(-1px);
        outline: none;
      }
      .generic-form__actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: flex-start;
        position: sticky;
        bottom: 0;
        padding: 1rem 0 0.5rem;
        margin-top: auto;
        background: linear-gradient(
            180deg,
            rgba(18, 18, 24, 0),
            rgba(18, 18, 24, 0.92)
          ),
          var(--glassy-surface-bg);
        backdrop-filter: blur(var(--glassy-blur));
        border-top: 1px solid var(--glassy-border);
        box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.4);
        z-index: 5;
      }
      .generic-form__actions .accent-button[disabled] {
        opacity: 0.65;
        cursor: progress;
      }
      .generic-table__actions-header {
        width: 150px;
      }
      .generic-table__actions-cell {
        vertical-align: middle;
      }
      .generic-table__actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .generic-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 15, 20, 0.82);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 1.5rem;
      }
      .generic-modal {
        background: var(--glassy-surface-bg);
        border-radius: 18px;
        border: 1px solid var(--glassy-border);
        width: min(720px, 100%);
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: var(--glassy-shadow);
        backdrop-filter: blur(var(--glassy-blur));
      }
      .generic-modal--wide {
        width: min(880px, 100%);
      }
      .generic-modal__header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--glassy-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.06),
          rgba(18, 18, 24, 0.85)
        );
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.2));
      }
      .generic-modal__title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }
      .generic-modal__body {
        padding: 1.25rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: rgba(18, 18, 24, 0.82);
      }
      .generic-modal__footer {
        padding: 0.85rem 1.25rem;
        border-top: 1px solid var(--glassy-border);
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        background: linear-gradient(
          0deg,
          rgba(255, 255, 255, 0.06),
          rgba(18, 18, 24, 0.85)
        );
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.2));
      }
      .detail-tabs {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
      }
      .detail-tabs__nav {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-start;
      }
      .detail-tabs__button {
        border: 1px solid var(--theme-accent-24);
        border-radius: 999px;
        padding: 0.5rem 1.2rem;
        background: transparent;
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease,
          border-color 0.2s ease, box-shadow 0.2s ease;
      }
      .detail-tabs__button.is-active {
        background: var(--theme-accent);
        color: #111;
        border-color: var(--theme-accent);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
      }
      .detail-tab-pane {
        display: none;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        background: rgba(18, 18, 18, 0.88);
        max-height: 420px;
        overflow: auto;
      }
      .detail-tab-pane.active {
        display: block;
      }
      .detail-fields {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem 1.5rem;
      }
      .detail-field {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      .detail-field__label {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }
      .detail-field__value {
        font-weight: 600;
        color: var(--color-text-primary);
        word-break: break-word;
      }
      .detail-table {
        width: 100%;
        border-collapse: collapse;
      }
      .detail-table thead {
        background: var(--theme-accent-16);
        color: var(--theme-accent);
      }
      .detail-table th,
      .detail-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        padding: 0.5rem 0.75rem;
        text-align: right;
      }
      .detail-empty {
        text-align: center;
        color: var(--color-text-secondary);
        font-size: 0.95rem;
      }
      .generic-attachments__list {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        background: rgba(10, 12, 18, 0.6);
      }
      .generic-attachments__item {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 0.5rem 1rem;
        padding: 0.5rem 0.65rem;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.05);
      }
      .generic-attachments__item a {
        color: var(--color-accent);
      }
      .generic-attachments__form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem 1rem;
        border: 1px dashed rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        padding: 0.9rem;
        background: rgba(0, 0, 0, 0.3);
      }
      .generic-attachments__form label {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }
      .generic-attachments__form input {
        padding: 0.45rem 0.65rem;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.4);
        color: var(--color-text-primary);
      }
      .generic-attachments__actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .materials-catalog__controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem 1rem;
      }
      .materials-module__controls {
        gap: 0.5rem;
      }
      .materials-catalog__search,
      .materials-module__search {
        flex: 1 1 260px;
        max-width: 420px;
      }
      .materials-catalog__search input,
      .materials-module__search input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border-radius: 12px;
        border: 1px solid var(--glassy-border);
        background: var(--glassy-input-bg);
        color: var(--color-text-primary);
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 10px 20px rgba(0, 0, 0, 0.25);
      }
      .materials-catalog__table {
        width: 100%;
        border-collapse: collapse;
        --table-header-bg: #3563ff;
        --table-header-color: #ffffff;
      }
      .materials-catalog__table th {
        cursor: pointer;
        position: relative;
      }
      .materials-catalog__table th.sorted-asc::after,
      .materials-catalog__table th.sorted-desc::after {
        content: "";
        position: absolute;
        inset-inline-end: 0.75rem;
        border: 5px solid transparent;
      }
      .materials-catalog__table th.sorted-asc::after {
        border-bottom-color: var(--color-accent);
        top: 45%;
      }
      .materials-catalog__table th.sorted-desc::after {
        border-top-color: var(--color-accent);
        bottom: 45%;
      }
      .materials-module {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .materials-module__tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .materials-module__section {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        border: 1px solid var(--glassy-border);
        border-radius: 16px;
        padding: 1.5rem;
        background: var(--glassy-surface-bg);
        box-shadow: var(--glassy-shadow);
        backdrop-filter: blur(var(--glassy-blur));
      }
      .materials-form-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .materials-form__title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--color-text-primary);
      }
      .materials-form__hint {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }
      .materials-form {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        padding: 1.5rem;
        border-radius: 16px;
        border: 1px solid var(--glassy-border);
        background: var(--glassy-surface-bg);
        box-shadow: var(--glassy-shadow);
        backdrop-filter: blur(var(--glassy-blur));
      }
      .materials-form__grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem 1.25rem;
      }
      .materials-form__field {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
      }
      .materials-form__field--full {
        grid-column: 1 / -1;
      }
      .materials-form__label {
        font-size: 0.95rem;
        color: var(--color-text-secondary);
      }
      .materials-form__input,
      .materials-form__select,
      .materials-form textarea {
        width: 100%;
        padding: 0.65rem 0.8rem;
        border-radius: 12px;
        border: 1px solid var(--glassy-border);
        background: var(--glassy-input-bg);
        color: var(--color-text-primary);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 12px 24px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
      }
      .materials-form__input:focus,
      .materials-form__select:focus,
      .materials-form textarea:focus {
        border-color: rgba(90, 140, 255, 0.75);
        box-shadow: 0 0 0 2px rgba(90, 140, 255, 0.35),
          0 16px 36px rgba(0, 0, 0, 0.45);
        outline: none;
        transform: translateY(-1px);
      }
      .materials-form__toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        color: var(--color-text-secondary);
      }
      .materials-form__toggle input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--color-accent);
      }
      .materials-form__actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: flex-start;
        position: sticky;
        bottom: 0;
        padding: 1rem 0 0.5rem;
        margin-top: auto;
        background: linear-gradient(
            180deg,
            rgba(18, 18, 24, 0),
            rgba(18, 18, 24, 0.92)
          ),
          var(--glassy-surface-bg);
        border-top: 1px solid var(--glassy-border);
        backdrop-filter: blur(var(--glassy-blur));
        box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.4);
        z-index: 5;
      }
      .materials-form__actions .accent-button[disabled] {
        opacity: 0.65;
        cursor: progress;
      }
      .materials-form__note {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }
      .materials-module__filters {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 0.6rem;
        width: 100%;
      }
      .materials-module__filters .materials-module__search {
        flex: 1 1 auto;
      }
      .materials-module__selects {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.6rem;
      }
      .materials-module__selects select {
        min-width: 200px;
      }
      .materials-module__bulk {
        display: flex;
        gap: 0.6rem;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }
      .materials-module__select-column {
        width: 48px;
        text-align: center;
      }
      .materials-module__actions-column {
        white-space: nowrap;
        text-align: center;
      }
      .materials-module__count {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        text-align: center;
      }
      .materials-status-toggle {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        border: 1px solid rgba(212, 175, 55, 0.35);
        background: rgba(212, 175, 55, 0.08);
        color: var(--color-accent);
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .materials-status-toggle.is-active {
        border-color: rgba(46, 204, 113, 0.5);
        background: rgba(46, 204, 113, 0.15);
        color: var(--color-success);
      }
      .materials-row-action {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--color-text-primary);
        border-radius: 8px;
        padding: 0.25rem 0.45rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .materials-row-action:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .materials-row-action__icon {
        font-size: 0.85rem;
      }
      .pane-header .accent-button {
        min-width: 140px;
      }
      .direct-expense-pane {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .direct-expense__tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .direct-expense__section {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        border: 1px solid var(--glassy-border);
        border-radius: 16px;
        padding: 1.5rem;
        background: var(--glassy-surface-bg);
        box-shadow: var(--glassy-shadow);
        backdrop-filter: blur(var(--glassy-blur));
        max-width: 100%;
      }
      .direct-expense__table-wrapper {
        width: 100%;
        overflow-x: auto;
        border-radius: 12px;
      }
      .direct-expense__table-wrapper::-webkit-scrollbar {
        height: 8px;
      }
      .direct-expense__table-wrapper::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 999px;
      }
      .direct-expense__section[hidden] {
        display: none !important;
      }
      .direct-expense__header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem 1rem;
        align-items: end;
      }
      .direct-expense__footer {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
        justify-content: flex-start;
        position: sticky;
        bottom: 0;
        padding: 1rem 0 0.5rem;
        margin-top: auto;
        background: linear-gradient(
            180deg,
            rgba(18, 18, 24, 0),
            rgba(18, 18, 24, 0.92)
          ),
          var(--glassy-surface-bg);
        border-top: 1px solid var(--glassy-border);
        backdrop-filter: blur(var(--glassy-blur));
        box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.4);
        z-index: 5;
      }
      .direct-expense__meta {
        display: grid;
        grid-template-columns: minmax(260px, 2fr) minmax(200px, 1fr);
        gap: 0.75rem 1rem;
        align-items: stretch;
      }
      @media (max-width: 900px) {
        .direct-expense__meta {
          grid-template-columns: 1fr;
        }
      }
      .direct-expense__field {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 200px;
        flex: 1 1 200px;
      }
      .direct-expense__field--wide {
        flex-basis: 100%;
      }
      .direct-expense__field label {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__field select,
      .direct-expense__field input,
      .direct-expense__field textarea {
        background: var(--glassy-input-bg);
        border: 1px solid var(--glassy-border);
        border-radius: 12px;
        padding: 0.6rem 0.75rem;
        color: var(--color-text-primary);
        width: 100%;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 12px 24px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
          transform 0.2s ease;
      }
      .direct-expense__field textarea {
        resize: vertical;
        min-height: 72px;
      }
      .direct-expense__field select:focus,
      .direct-expense__field input:focus,
      .direct-expense__field textarea:focus {
        border-color: rgba(210, 170, 80, 0.8);
        box-shadow: 0 0 0 2px rgba(210, 170, 80, 0.35),
          0 16px 36px rgba(0, 0, 0, 0.45);
        transform: translateY(-1px);
        outline: none;
      }
      .direct-expense__main {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
      }
      .direct-expense__catalog,
      .direct-expense__cart {
        flex: 1;
        min-width: 300px;
        border: 1px solid var(--glassy-border);
        border-radius: 16px;
        background: var(--glassy-surface-bg);
        padding: 1.1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        box-shadow: var(--glassy-shadow-soft);
        backdrop-filter: blur(var(--glassy-blur));
      }
      .direct-expense__cart {
        overflow: hidden;
      }
      .direct-expense__catalog h3,
      .direct-expense__cart h3 {
        font-size: 1.1rem;
      }
      .direct-expense__filters {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .direct-expense__filters input,
      .direct-expense__filters select {
        flex: 1 1 160px;
        border: 1px solid var(--glassy-border);
        border-radius: 12px;
        background: var(--glassy-input-bg);
        color: var(--color-text-primary);
        padding: 0.55rem 0.75rem;
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 10px 20px rgba(0, 0, 0, 0.25);
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
          transform 0.2s ease;
      }
      .direct-expense__filters input:focus,
      .direct-expense__filters select:focus {
        border-color: rgba(210, 170, 80, 0.8);
        box-shadow: 0 0 0 2px rgba(210, 170, 80, 0.35),
          0 14px 28px rgba(0, 0, 0, 0.4);
        transform: translateY(-1px);
        outline: none;
      }
      .direct-expense__filters input[type="search"] {
        max-width: 260px;
      }
      .direct-expense__materials-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 0.5rem;
        max-height: 420px;
        overflow-y: auto;
        padding-inline-end: 0.5rem;
        align-content: start;
      }
      .direct-expense__material-card {
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        padding: 0.55rem 0.65rem;
        background: rgba(0, 0, 0, 0.25);
        display: grid;
        gap: 0.35rem;
        cursor: pointer;
        transition: border-color 0.2s ease, transform 0.2s ease,
          background 0.2s ease;
      }
      .direct-expense__material-card:hover,
      .direct-expense__material-card:focus-within {
        border-color: rgba(212, 175, 55, 0.6);
        transform: translateY(-2px);
        background: rgba(212, 175, 55, 0.08);
      }
      .direct-expense__material-id {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__material-name {
        font-weight: 600;
        font-size: 0.95rem;
      }
      .direct-expense__material-price {
        font-size: 0.85rem;
        color: var(--color-accent);
      }
      .direct-expense__cart-items {
        border: 1px solid var(--glassy-border);
        border-radius: 12px;
        background: var(--glassy-surface-bg);
        overflow-x: auto;
        overflow-y: hidden;
        padding: 0.35rem;
        backdrop-filter: blur(var(--glassy-blur));
        box-shadow: var(--glassy-shadow-soft);
      }
      .direct-expense__cart-table {
        width: 100%;
        min-width: 560px;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 12px;
        background: var(--glassy-surface-bg);
        border: 1px solid var(--glassy-border);
        box-shadow: var(--glassy-shadow-soft);
        backdrop-filter: blur(var(--glassy-blur));
        --table-header-bg: #d2aa50;
        --table-header-color: #ffffff;
      }
      .direct-expense__cart-table thead th {
        background: var(--table-header-bg, #d2aa50);
        color: var(--table-header-color, #ffffff);
        font-weight: 600;
        padding: 0.65rem 0.75rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
        text-align: center;
      }
      .direct-expense__cart-table tbody td {
        padding: 0.55rem 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        vertical-align: middle;
        text-align: center;
      }
      .direct-expense__cart-table tbody tr:last-child td {
        border-bottom: none;
      }
      .direct-expense__cart-table td:last-child,
      .direct-expense__cart-table th:last-child {
        width: 1%;
        white-space: nowrap;
        text-align: center;
      }
      .direct-expense__cart-meta {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 0.5rem;
        margin-bottom: 0.35rem;
      }
      .direct-expense__cart-name {
        font-weight: 600;
        font-size: 0.95rem;
      }
      .direct-expense__cart-code {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__cart-input {
        width: 100%;
        background: var(--glassy-input-bg);
        border: 1px solid var(--glassy-border);
        border-radius: 12px;
        padding: 0.35rem 0.5rem;
        color: var(--color-text-primary);
        text-align: center;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 10px 20px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        transition: border-color 0.2s ease, box-shadow 0.2s ease,
          transform 0.2s ease;
      }
      .direct-expense__cart-input:focus {
        border-color: rgba(210, 170, 80, 0.8);
        box-shadow: 0 0 0 2px rgba(210, 170, 80, 0.35),
          0 14px 32px rgba(0, 0, 0, 0.45);
        transform: translateY(-1px);
        outline: none;
      }
      .direct-expense__totals {
        border-top: 1px solid var(--glassy-border);
        padding-top: 0.75rem;
        display: grid;
        gap: 0.45rem;
      }
      .direct-expense__totals-row {
        display: flex;
        justify-content: space-between;
        color: var(--color-text-secondary);
      }
      .direct-expense__totals-row strong {
        color: var(--color-text-primary);
      }
      .direct-expense__remove-btn {
        background: transparent;
        border: 1px solid rgba(231, 76, 60, 0.6);
        color: #e74c3c;
        padding: 0.3rem 0.6rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .direct-expense__remove-btn:hover {
        background: rgba(231, 76, 60, 0.12);
      }
      .direct-expense__attachments-section {
        display: grid;
        gap: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        background: rgba(30, 30, 30, 0.85);
      }
      .direct-expense__attachments-section h3 {
        margin: 0;
        font-size: 1.05rem;
      }
      .direct-expense__attachments-block {
        display: grid;
        gap: 0.75rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding-top: 0.75rem;
      }
      .direct-expense__attachment-list,
      .direct-expense__attachments-list {
        display: grid;
        gap: 0.6rem;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .direct-expense__attachments-btn {
        width: fit-content;
      }
      .direct-expense__attachments {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .direct-expense__field--attachments .direct-expense__attachments {
        align-items: flex-start;
        gap: 0.5rem;
      }
      .direct-expense__field--attachments .direct-expense__attachment-list {
        margin-top: 0.5rem;
      }
      .direct-expense__attachment-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.25);
        padding: 0.75rem 0.85rem;
        display: grid;
        gap: 0.45rem;
      }
      .direct-expense__attachment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
      }
      .direct-expense__attachment-title {
        font-weight: 600;
      }
      .direct-expense__attachment-remove {
        background: transparent;
        border: 1px solid rgba(231, 76, 60, 0.6);
        color: #e74c3c;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.8rem;
      }
      .direct-expense__attachment-remove:hover {
        background: rgba(231, 76, 60, 0.15);
      }
      .direct-expense__attachment-meta {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .direct-expense__attachment-field {
        display: grid;
        gap: 0.35rem;
      }
      .direct-expense__attachment-label {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        padding: 0.4rem 0.55rem;
        color: var(--color-text-primary);
        width: 100%;
      }
      .direct-expense__attachment-field span {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__vat-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__vat-toggle input {
        width: auto;
      }
      .direct-expense__footer button {
        min-width: 180px;
      }
      .direct-expense__empty {
        color: var(--color-text-secondary);
        text-align: center;
        padding: 1rem 0;
      }
      .direct-expense__controls {
        gap: 0.5rem;
      }
      .direct-expense__view-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        width: 100%;
      }
      .direct-expense__view-controls input[type="search"] {
        flex: 1 1 260px;
        min-width: 220px;
        padding: 0.55rem 0.75rem;
        border-radius: 10px;
        border: 1px solid var(--color-border);
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-text-primary);
      }
      .direct-expense__table {
        width: 100%;
        border-collapse: collapse;
        --table-header-bg: #d2aa50;
        --table-header-color: #ffffff;
      }
      .direct-expense__table th {
        cursor: pointer;
        position: relative;
      }
      .direct-expense__table th.sorted-asc::after,
      .direct-expense__table th.sorted-desc::after {
        content: "";
        position: absolute;
        inset-inline-end: 0.75rem;
        border: 5px solid transparent;
      }
      .direct-expense__table th.sorted-asc::after {
        border-bottom-color: var(--color-accent);
        top: 45%;
      }
      .direct-expense__table th.sorted-desc::after {
        border-top-color: var(--color-accent);
        bottom: 45%;
      }
      .direct-expense__table tbody tr {
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .direct-expense__table tbody tr:hover {
        background: rgba(212, 175, 55, 0.12);
      }
      .direct-expense__modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.72);
        display: grid;
        place-items: center;
        z-index: 2000;
        padding: 2rem 1.5rem;
      }
      .direct-expense__modal {
        width: min(680px, 96vw);
        max-height: 90vh;
        overflow-y: auto;
        background: var(--glassy-surface-bg);
        border: 1px solid var(--glassy-border);
        border-radius: 18px;
        padding: 1.5rem;
        display: grid;
        gap: 1rem;
        box-shadow: var(--glassy-shadow);
        backdrop-filter: blur(var(--glassy-blur));
      }
      .direct-expense__modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        border-bottom: 1px solid var(--glassy-border);
        padding-bottom: 0.75rem;
      }
      .direct-expense__modal-body {
        display: grid;
        gap: 1rem;
        background: rgba(18, 18, 24, 0.82);
        padding: 0.75rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }
      .direct-expense__modal-grid {
        display: grid;
        gap: 0.5rem 1rem;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      .direct-expense__modal-grid dt {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__modal-grid dd {
        margin: 0;
        font-weight: 600;
      }
      .ghost-button--sm {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
      }
      .notice-card {
        border: 1px dashed var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        line-height: 1.6;
        color: var(--color-text-secondary);
        background: rgba(255, 255, 255, 0.04);
      }
      .notice-card strong {
        color: var(--color-accent);
      }
      .icon-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }
      .icon-btn {
        width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--glassy-border);
        background: var(--glassy-surface-bg);
        border-radius: 12px;
        cursor: pointer;
        --icon-color: #d0d0d0;
        color: var(--icon-color);
        transition: background 0.2s ease, color 0.2s ease,
          border-color 0.2s ease, transform 0.2s ease;
        backdrop-filter: blur(calc(var(--glassy-blur) / 1.5));
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08),
          0 8px 16px rgba(0, 0, 0, 0.25);
      }
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: var(--theme-accent, rgba(255, 255, 255, 0.2));
        color: #f6f6f6;
        transform: translateY(-2px);
        box-shadow: var(--glassy-shadow-soft);
      }
      .icon-btn:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        transform: none;
        background: rgba(255, 255, 255, 0.04);
        border-color: var(--glassy-border);
      }
      .icon-btn--accent {
        border-color: var(--theme-accent);
        background: linear-gradient(
            140deg,
            rgba(255, 255, 255, 0.25),
            rgba(255, 255, 255, 0)
          ),
          var(--theme-accent-16);
        --icon-color: #1f1f1f;
        color: #1f1f1f;
      }
      .icon-btn--accent:hover {
        background: var(--theme-accent);
        color: #111;
        border-color: var(--theme-accent);
      }
      .icon-btn--light {
        --icon-color: #1f1f1f;
        background: rgba(240, 240, 240, 0.92);
        border-color: rgba(0, 0, 0, 0.08);
      }
      .icon-btn--light:hover {
        background: rgba(240, 240, 240, 1);
        color: #111111;
        border-color: rgba(0, 0, 0, 0.18);
      }
      .icon-btn svg {
        width: 16px;
        height: 16px;
        fill: none;
        stroke: currentColor;
        stroke-width: 1.6;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      dialog .form-grid textarea {
        width: 100%;
        min-height: 110px;
        resize: vertical;
      }
      dialog .form-grid .span-2 {
        grid-column: 1 / span 2;
      }

      .profile-dialog__header {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        margin-bottom: 0.8rem;
      }
      .profile-dialog__username {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
      }
      .profile-tabs {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.8rem;
        flex-wrap: wrap;
      }
      .profile-tabs .nav-item {
        border: 1px solid var(--color-border);
      }
      .profile-tabs .nav-item.active {
        background: var(--color-accent);
        color: #111;
        border-color: transparent;
      }
      .profile-panels {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.25);
        max-height: 340px;
        overflow: auto;
      }
      .profile-panel {
        display: none;
      }
      .profile-panel.active {
        display: block;
      }
      .profile-dl {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 0.4rem 0.8rem;
      }
      .profile-dl dt {
        color: var(--color-text-secondary);
      }
      .profile-dl dd {
        margin: 0;
      }
      .profile-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }
      .profile-table th,
      .profile-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.45rem 0.6rem;
        text-align: right;
      }
      .profile-table tbody tr:last-child td {
        border-bottom: none;
      }
      .profile-empty {
        text-align: center;
        color: var(--color-text-secondary);
        padding: 1rem 0;
      }
      .profile-doc-link {
        color: var(--color-accent);
        text-decoration: none;
      }

      /* Toasts (under login button) */
      #login-screen .toast-container {
        position: absolute;
        top: 100%;
        inset-inline-start: 50%;
        transform: translateX(-50%);
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        z-index: 1000;
      }
      /* Toasts (app views) */
      body > .toast-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        z-index: 10000;
        width: min(90vw, 420px);
        pointer-events: none;
      }
      body > .toast-container .toast {
        pointer-events: auto;
      }
      .toast {
        min-width: 260px;
        max-width: 360px;
        padding: 0.9rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.96);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
        color: var(--color-text-primary);
        opacity: 0;
        transform: translateY(12px);
        animation: toast-in 0.25s ease forwards;
      }
      .toast.success {
        border-color: rgba(46, 204, 113, 0.35);
        background: rgba(46, 204, 113, 0.12);
      }
      .toast.error {
        border-color: rgba(231, 76, 60, 0.35);
        background: rgba(231, 76, 60, 0.12);
      }
      .toast.info {
        border-color: rgba(212, 175, 55, 0.35);
        background: rgba(212, 175, 55, 0.12);
      }
      .toast__title {
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      .toast__msg {
        font-size: 0.95rem;
        color: var(--color-text-secondary);
      }
      .toast--hide {
        animation: toast-out 0.3s ease forwards;
      }
      @keyframes toast-in {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes toast-out {
        to {
          opacity: 0;
          transform: translateY(12px);
        }
      }

      .hidden {
        display: none !important;
      }
      .row-actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .kpi-value {
        font-size: 1.6rem;
      }
      .sys-users__controls {
        align-items: center;
      }
      .sys-users__filters,
      .sys-users__bulk-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        justify-content: center;
        width: 100%;
      }
      .sys-users__filters {
        align-items: stretch;
      }
      .sys-users__filters input,
      .sys-users__filters select {
        padding: 0.6rem 0.8rem;
        border: 1px solid var(--color-border);
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--color-text-primary);
        min-width: 140px;
      }
      .sys-users__filters input[type="search"] {
        flex: 1 1 240px;
        min-width: 220px;
      }
      .sys-users__filters input[type="date"] {
        min-width: 180px;
      }
      .sys-users__bulk-actions {
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.2rem;
      }
      .sys-users__bulk-actions .ghost-button,
      .sys-users__bulk-actions select {
        min-width: 120px;
      }
      .sys-users__bulk-actions select:disabled,
      .sys-users__bulk-actions button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .select-cell {
        width: 44px;
        text-align: center;
      }
      .select-cell input {
        width: 16px;
        height: 16px;
      }
      dialog[open] {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: #191919;
        color: var(--color-text-primary);
        padding: 1rem 1.2rem;
        max-width: 860px;
        width: 95vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(2px);
      }
      dialog form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex: 1;
        min-height: 0;
      }
      dialog .dialog-body {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding-right: 0.2rem;
      }
      dialog .dialog-body .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.8rem;
        direction: rtl;
      }
      dialog .dialog-body label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }
      dialog .dialog-body input,
      dialog .dialog-body select,
      dialog .dialog-body textarea {
        width: 100%;
        padding: 0.55rem 0.7rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--color-text-primary);
      }
      dialog .dialog-body .span-2 {
        grid-column: 1 / -1;
      }
      dialog .actions {
        display: flex;
        gap: 0.6rem;
        justify-content: flex-start;
        margin-top: 0.5rem;
      }

      /* dynamic form layout */
      .dyn-layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 1rem;
        align-items: stretch;
        width: 100%;
        min-height: 320px;
      }
      .dyn-tabs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.2);
        overflow-y: auto;
      }
      .dyn-tabs .nav-item {
        width: 100%;
        text-align: right;
        padding: 0.55rem 0.8rem;
        border-color: transparent;
        background: transparent;
        color: var(--color-text-secondary);
        border-radius: 10px;
        font-weight: 600;
      }
      .dyn-tabs .nav-item.active {
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.3),
          rgba(212, 175, 55, 0.12)
        );
        border-color: var(--theme-accent);
        color: var(--color-text-primary);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25) inset,
          0 0 0 1px rgba(212, 175, 55, 0.25);
      }
      .dyn-tabs .nav-item:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 2px;
      }
      .dyn-tabs.direct-expense__tabs .nav-item,
      .dyn-tabs.materials-module__tabs .nav-item {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--color-text-secondary);
        transition: background 0.2s ease, color 0.2s ease,
          border-color 0.2s ease;
      }
      .dyn-tabs.direct-expense__tabs .nav-item:hover,
      .dyn-tabs.materials-module__tabs .nav-item:hover {
        color: var(--color-text-primary);
        border-color: rgba(212, 175, 55, 0.3);
      }
      .dyn-tabs.direct-expense__tabs .nav-item.active,
      .dyn-tabs.materials-module__tabs .nav-item.active {
        background: var(--theme-accent-16);
        border-color: var(--theme-accent);
        color: var(--color-text-primary);
        box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.2);
      }
      .dyn-pages {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.25);
        padding: 1rem;
        overflow: hidden;
        position: relative;
      }
      .dyn-pages .dyn-page {
        max-height: calc(75vh - 160px);
        overflow-y: auto;
        padding-inline-end: 0.5rem;
      }
      .dyn-pages .dyn-page.hidden {
        display: none !important;
      }
      @media (max-width: 900px) {
        .dyn-layout {
          grid-template-columns: 1fr;
        }
        .dyn-tabs {
          flex-direction: row;
          justify-content: flex-start;
          overflow-x: auto;
          padding: 0.5rem;
        }
        .dyn-tabs .nav-item {
          flex: 0 0 auto;
          min-width: 140px;
        }
      }

      /* Hide scrollbars globally */
      /* For Webkit browsers (Chrome, Safari, Edge Chromium) */
      ::-webkit-scrollbar {
        display: none;
        width: 0 !important;
        height: 0 !important;
      }

      /* For Firefox */
      * {
        scrollbar-width: none;
      }

      /* For IE/Edge (older versions, might not be necessary) */
      body {
        -ms-overflow-style: none;
      }

      /* --- Compact pills for tabs (Direct Expense + Materials) --- */
      .dyn-tabs.direct-expense__tabs .nav-item,
      .dyn-tabs.materials-module__tabs .nav-item {
        width: auto;
        min-width: 0;
        padding: 0.35rem 0.7rem;
        line-height: 1.1;
        border-radius: 999px;
        flex: 0 0 auto;
        white-space: nowrap;
      }

      /* Place tabs side-by-side tightly */
      .dyn-tabs.direct-expense__tabs,
      .dyn-tabs.materials-module__tabs {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.4rem;
        align-items: center;
      }

      /* --- Unified field styling --- */
      select {
        background-color: rgba(18, 18, 18, 0.92) !important;
        color: var(--color-text-primary) !important;
        border: 1px solid var(--theme-accent-24);
      }
      select option {
        background-color: #d4d4d4 !important;
        color: #1a1a1a !important;
      }
      select:focus {
        outline: 2px solid var(--theme-accent-24);
        outline-offset: 1px;
      }

      /* --- Direct Expense: header meta arranged horizontally --- */
      .direct-expense__header {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem 1rem;
        align-items: end;
      }
      .direct-expense__meta {
        display: grid !important;
        grid-template-columns: minmax(260px, 2fr) minmax(200px, 1fr);
        gap: 0.75rem 1rem;
        align-items: stretch;
      }
      @media (max-width: 900px) {
        .direct-expense__meta {
          grid-template-columns: 1fr;
        }
      }

      /* Add spacing before Notes and between sections */
      .direct-expense__field--wide {
        margin-top: 0.25rem;
      }
      .direct-expense__main {
        margin-top: 0.5rem;
      }

      /* --- Cart table fixes: middle-align + no overflow --- */
      .direct-expense__cart-table th,
      .direct-expense__cart-table td {
        vertical-align: middle;
        white-space: nowrap;
      }
      .direct-expense__cart-table td {
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .direct-expense__cart-input {
        width: 110px;
        text-align: center;
      }

      /* Align Delete button inside cell */
      .direct-expense__remove-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        max-width: 100%;
        white-space: nowrap;
      }

      /* --- Materials module compact tabs (match Direct Expense) --- */
      .materials-module__tabs .nav-item {
        padding: 0.35rem 0.7rem;
      }

      /* Remove any odd overlay/overlap effect */
      .materials-module__tabs .nav-item.active,
      .direct-expense__tabs .nav-item.active {
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.2) inset;
      }
    </style>
    <?!= include('ViewTab.css'); ?>
    <?!= include('FormModal.css'); ?>
  </head>
  <body>
    <!-- Login -->
    <div id="login-screen" class="view active">
      <div class="login-container">
        <div class="logo"><span>ERP</span></div>
        <form id="login-form" novalidate>
          <div class="form-group">
            <label for="username"> </label>
            <input id="username" type="text" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="password"> </label>
            <input
              id="password"
              type="password"
              autocomplete="current-password"
            />
          </div>
          <button id="login-button" class="main-button" type="submit">
            <span> </span>
            <div class="spinner"></div>
          </button>
        </form>
        <div
          id="toast-container"
          class="toast-container"
          aria-live="polite"
          aria-atomic="true"
        ></div>
      </div>
    </div>

    <!-- Top navbar -->
    <nav id="app-navbar" class="app-navbar hidden">
      <div class="app-navbar__left">
        <span class="app-brand">Nijjara ERP</span>
        <div id="navbar-buttons" class="navbar-buttons"></div>
      </div>
      <div class="app-navbar__right">
        <span id="navbar-user-label" class="navbar-user"></span>
        <button
          id="logout-button"
          class="nav-icon-button"
          title=" "
          aria-label=" "
        ></button>
      </div>
    </nav>

    <!-- Portal -->
    <div id="portal-view" class="view">
      <div class="portal-header">
        <h1 id="portal-welcome-message"></h1>
        <p class="muted">     </p>
      </div>
      <div class="module-grid"></div>
    </div>

    <!-- Projects (no demo data) -->
    <div id="projects-workspace" class="view">
      <div class="workspace" data-theme="projects">
        <header class="workspace-header">
          <h2 class="workspace-title"></h2>
          <div>
            <button
              class="nav-icon-button"
              data-go="portal-view"
              title=" "
              aria-label=" "
            ></button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">     .</p>
        </section>
        <aside id="prj-side-nav" class="workspace-nav"></aside>
      </div>
    </div>

    <!-- Finance (no demo data) -->
    <div id="finance-workspace" class="view">
      <div class="workspace" data-theme="finance">
        <header class="workspace-header">
          <h2 class="workspace-title"></h2>
          <div>
            <button
              class="nav-icon-button"
              data-go="portal-view"
              title=" "
              aria-label=" "
            ></button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">     .</p>
        </section>
        <aside id="fin-side-nav" class="workspace-nav"></aside>
      </div>
    </div>

    <!-- HR (no demo data) -->
    <div id="hr-workspace" class="view">
      <div class="workspace" data-theme="hr">
        <header class="workspace-header">
          <h2 class="workspace-title"> </h2>
          <div>
            <button
              class="nav-icon-button"
              data-go="portal-view"
              title=" "
              aria-label=" "
            ></button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">     .</p>
        </section>
        <aside id="hr-side-nav" class="workspace-nav"></aside>
      </div>
    </div>

    <!-- System Management -->
    <div id="system-management-view" class="view">
      <div class="workspace" data-theme="users">
        <header class="workspace-header">
          <h2 class="workspace-title"> </h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
               
            </button>
          </div>
        </header>

        <section class="workspace-content">
          <section
            id="sys-overview-pane"
            class="sys-pane sys-pane--overview active"
            data-pane="overview"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">   </h3>
              <p class="muted">
                       SYS_Profile_View 
                .
              </p>
            </div>
            <div class="sys-overview__summary">
              <div class="overview-cards">
                <div class="overview-card">
                  <div class="muted"> </div>
                  <div id="kpi-total-users" class="kpi-value"></div>
                </div>
                <div class="overview-card">
                  <div class="muted"> </div>
                  <div id="kpi-active-users" class="kpi-value"></div>
                </div>
                <div class="overview-card">
                  <div class="muted"> </div>
                  <div id="kpi-inactive-users" class="kpi-value"></div>
                </div>
                <div class="overview-card">
                  <div class="muted"> </div>
                  <div id="kpi-role-count" class="kpi-value"></div>
                </div>
                <div class="overview-card">
                  <div class="muted"> </div>
                  <div id="kpi-permission-count" class="kpi-value"></div>
                </div>
                <div class="overview-card">
                  <div class="muted">  </div>
                  <div id="kpi-pending-resets" class="kpi-value"></div>
                </div>
              </div>
              <p class="muted" style="margin: 0">
                       
                <strong></strong>     
                 PV_SYS_Users_Table.
              </p>
            </div>
          </section>

          <section id="sys-users-pane" class="sys-pane" data-pane="users">
            <div class="sys-pane__header">
              <h3 class="pane-heading"> </h3>
              <p class="muted">
                       .
              </p>
            </div>
            <div class="module-controls sys-users__controls">
              <div class="module-controls__row module-controls__primary">
                <div class="pane-mode-switch">
                  <button
                    type="button"
                    id="sys-users-view-btn"
                    class="pane-mode-button is-active"
                    data-mode="list"
                  >
                     
                  </button>
                  <button
                    type="button"
                    id="btn-new-user"
                    class="pane-mode-button"
                    data-mode="form"
                  >
                     
                  </button>
                </div>
              </div>
              <div class="module-controls__row module-controls__secondary">
                <div class="sys-users__filters">
                  <input
                    type="search"
                    id="users-search"
                    placeholder=" ..."
                  />
                  <select id="department-filter">
                    <option value=""> </option>
                  </select>
                  <select id="role-filter">
                    <option value=""> </option>
                  </select>
                  <select id="status-filter">
                    <option value=""> </option>
                    <option value="true"></option>
                    <option value="false"> </option>
                  </select>
                  <input
                    type="date"
                    id="updated-from"
                    aria-label="  "
                  />
                  <input
                    type="date"
                    id="updated-to"
                    aria-label="  "
                  />
                </div>
                <div class="sys-users__bulk-actions">
                  <button id="bulk-export" class="ghost-button" disabled>
                    
                  </button>
                  <button id="bulk-activate" class="ghost-button" disabled>
                    
                  </button>
                  <button id="bulk-deactivate" class="ghost-button" disabled>
                    
                  </button>
                  <select id="bulk-role-select" disabled>
                    <option value=""> </option>
                  </select>
                  <button id="bulk-assign-role" class="ghost-button" disabled>
                     
                  </button>
                </div>
              </div>
            </div>
            <div class="table-wrapper">
              <table id="users-table">
                <thead>
                  <tr>
                    <th class="select-cell">
                      <input type="checkbox" id="select-all-users" />
                    </th>
                    <th> </th>
                    <th> </th>
                    <th> </th>
                    <th> </th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th>  </th>
                    <th> </th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="users-tbody">
                  <tr>
                    <td colspan="11" class="muted"> </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-roles-pane" class="sys-pane" data-pane="roles">
            <div class="sys-pane__header">
              <h3 class="pane-heading"> </h3>
              <p class="muted">
                    SYS_Roles   .
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th> </th>
                    <th></th>
                    <th></th>
                    <th> </th>
                    <th> </th>
                  </tr>
                </thead>
                <tbody id="roles-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                          .
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-permissions-pane"
            class="sys-pane"
            data-pane="permissions"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading"> </h3>
              <p class="muted">
                 SYS_Permissions     .
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th> </th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th> </th>
                  </tr>
                </thead>
                <tbody id="permissions-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                          .
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-role-perms-pane"
            class="sys-pane"
            data-pane="rolePerms"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">  </h3>
              <p class="muted">
                        .
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th> </th>
                  </tr>
                </thead>
                <tbody id="role-perms-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                          .
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-properties-pane"
            class="sys-pane"
            data-pane="properties"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading"> </h3>
              <p class="muted">
                  SYS_User_Properties   .
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th> </th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="properties-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                          .
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-sessions-pane" class="sys-pane" data-pane="sessions">
            <div class="sys-pane__header">
              <h3 class="pane-heading">  </h3>
              <p class="muted">
                  SYS_Sessions     .
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="sessions-tbody">
                  <tr>
                    <td colspan="7" class="muted">
                          .
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-audit-pane" class="sys-pane" data-pane="audit">
            <div class="sys-pane__header">
              <h3 class="pane-heading"> </h3>
              <p class="muted">
                    SYS_Audit_Log  SYS_Audit_Report.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="audit-tbody">
                  <tr>
                    <td colspan="4" class="muted">
                          .
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        </section>

        <aside class="workspace-nav" id="sys-side-nav">
          <!-- Tabs will be rendered dynamically -->
        </aside>
      </div>
    </div>

    <!--   (      ) -->
    <dialog id="dlg-new-user">
      <h3 style="margin-bottom: 0.6rem">  </h3>
      <form method="dialog" id="new-user-form">
        <div id="new-user-fields" class="dialog-body"></div>
        <div class="actions">
          <button type="submit" class="action-button save-button"></button>
          <button
            type="button"
            id="btn-cancel-new"
            class="action-button cancel-button"
          >
            
          </button>
        </div>
      </form>
    </dialog>

    <!--   -->
    <dialog id="dlg-user-profile">
      <div class="profile-dialog__header">
        <h3 id="profile-title"> </h3>
        <div id="profile-username" class="profile-dialog__username"></div>
      </div>
      <div class="profile-tabs" id="profile-tabs">
        <button type="button" class="nav-item active" data-tab="profile">
          
        </button>
        <button type="button" class="nav-item" data-tab="properties">
          
        </button>
        <button type="button" class="nav-item" data-tab="documents">
          
        </button>
        <button type="button" class="nav-item" data-tab="sessions">
          
        </button>
        <button type="button" class="nav-item" data-tab="audit"></button>
      </div>
      <div class="profile-panels" id="profile-panels">
        <section class="profile-panel active" data-tab="profile">
          <dl class="profile-dl" id="profile-overview-list"></dl>
        </section>
        <section class="profile-panel" data-tab="properties">
          <table class="profile-table">
            <thead>
              <tr>
                <th></th>
                <th></th>
                <th> </th>
                <th></th>
              </tr>
            </thead>
            <tbody id="profile-properties-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="documents">
          <table class="profile-table">
            <thead>
              <tr>
                <th></th>
                <th> </th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="profile-documents-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="sessions">
          <table class="profile-table">
            <thead>
              <tr>
                <th>Session</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="profile-sessions-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="audit">
          <table class="profile-table">
            <thead>
              <tr>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody id="profile-audit-body"></tbody>
          </table>
        </section>
      </div>
      <div class="actions">
        <button
          type="button"
          id="btn-close-profile"
          class="action-button cancel-button"
        >
          
        </button>
      </div>
    </dialog>

    <!--   -->
    <dialog id="dlg-assign-role">
      <h3 style="margin-bottom: 0.6rem">  </h3>
      <form method="dialog" id="form-assign-role">
        <input type="hidden" id="assign-role-user" name="userId" />
        <div class="form-grid">
          <div class="span-2">
            <label for="assign-role-select"> </label>
            <select id="assign-role-select" name="roleId" required></select>
          </div>
          <div class="span-2 muted" id="assign-role-user-label"></div>
        </div>
        <div class="actions">
          <button type="submit" class="action-button save-button"></button>
          <button
            type="button"
            id="btn-cancel-assign"
            class="action-button cancel-button"
          >
            
          </button>
        </div>
      </form>
    </dialog>

    <!--     -->
    <dialog id="dlg-reset-pass">
      <h3 style="margin-bottom: 0.6rem">   </h3>
      <form method="dialog" id="form-reset-pass">
        <div class="form-grid">
          <div class="span-2">
            <label for="reset_pass">  </label
            ><input
              type="password"
              id="reset_pass"
              name="password"
              autocomplete="new-password"
              required
            />
          </div>
          <div class="span-2">
            <label for="reset_confirm">  </label
            ><input
              type="password"
              id="reset_confirm"
              name="confirm"
              autocomplete="new-password"
              required
            />
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action-button edit-button"></button>
          <button
            type="button"
            id="btn-cancel-reset"
            class="action-button cancel-button"
          >
            
          </button>
        </div>
      </form>
    </dialog>

    <?!= include('FormModal.js'); ?>
    <?!= include('ViewTab.js'); ?>

    <script>
      if (typeof window.currentFormId === "undefined") {
        window.currentFormId = null;
      }
      if (typeof window.currentFormStructure === "undefined") {
        window.currentFormStructure = null;
      }
      if (typeof window.currentSubTab === "undefined") {
        window.currentSubTab = null;
      }

      if (typeof window.collectFormData !== "function") {
        window.collectFormData = function collectFormData() {
          const formData = {};
          const fields = document.querySelectorAll(
            ".form-field input, .form-field select, .form-field textarea"
          );
          fields.forEach((field) => {
            const key =
              field.dataset.targetColumn ||
              field.dataset.fieldId ||
              field.dataset.fieldName ||
              field.name ||
              field.id;
            if (!key) {
              return;
            }
            const value =
              field.type === "checkbox" ? field.checked : field.value;
            formData[key] = value;

            if (field.dataset.fieldId && !(field.dataset.fieldId in formData)) {
              formData[field.dataset.fieldId] = value;
            }
            if (
              field.dataset.fieldName &&
              !(field.dataset.fieldName in formData)
            ) {
              formData[field.dataset.fieldName] = value;
            }
            if (field.name && !(field.name in formData)) {
              formData[field.name] = value;
            }
          });
          return formData;
        };
      }

      if (typeof window.validateForm !== "function") {
        window.validateForm = function validateForm(formData, formStructure) {
          const errors = [];
          if (!Array.isArray(formStructure)) {
            return errors;
          }

          const isEmptyValue = (value, field) => {
            if (
              value === false &&
              (field?.type === "checkbox" || field?.type === "boolean")
            ) {
              return false;
            }
            return value === undefined || value === null || value === "";
          };

          formStructure.forEach((field) => {
            if (!field || !field.required) {
              return;
            }
            const candidates = [
              field.fieldId,
              field.Field_ID,
              field.targetColumn,
              field.Target_Column,
              field.label,
              field.Label,
            ]
              .map((item) => (typeof item === "string" ? item.trim() : item))
              .filter(Boolean);

            let value;
            for (const candidate of candidates) {
              if (candidate in formData) {
                value = formData[candidate];
                break;
              }
              const normalized = String(candidate).replace(/\s+/g, "_");
              if (normalized in formData) {
                value = formData[normalized];
                break;
              }
              const lower = normalized.toLowerCase();
              if (lower in formData) {
                value = formData[lower];
                break;
              }
            }

            if (isEmptyValue(value, field)) {
              errors.push(
                ` ${
                  field.label ||
                  field.fieldId ||
                  field.targetColumn ||
                  " "
                } `
              );
            }
          });

          return errors;
        };
      }

      if (typeof window.submitFormModal !== "function") {
        window.submitFormModal = function submitFormModal(event) {
          event?.preventDefault?.();
          console.log(" Submit form modal called");

          if (!window.currentFormId) {
            window.showToast?.("     ", "error");
            return;
          }

          const formData = window.collectFormData();
          console.log(" Form data to submit:", formData);

          const errors = window.validateForm(
            formData,
            window.currentFormStructure
          );
          if (errors.length > 0) {
            window.showToast?.(` ${errors.join(", ")}`, "error");
            return;
          }

          const modal = document.getElementById("globalFormModal");
          const submitBtn = modal?.querySelector(".submit-btn");
          const originalText = submitBtn?.textContent;
          if (submitBtn) {
            submitBtn.textContent = " ...";
            submitBtn.disabled = true;
          }

          const runner = google?.script?.run;
          if (!runner) {
            if (submitBtn) {
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
            }
            window.showToast?.("  Google Apps Script  ", "error");
            return;
          }

          runner
            .withSuccessHandler((response) => {
              if (submitBtn) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
              }

              if (response?.success) {
                window.showToast?.("    ", "success");
                if (typeof window.closeModal === "function") {
                  window.closeModal();
                } else if (typeof window.closeFormModal === "function") {
                  window.closeFormModal();
                }

                const subTabToRefresh =
                  window.currentSubTab ||
                  (typeof window.getCurrentSubTab === "function"
                    ? window.getCurrentSubTab()
                    : null);
                if (
                  subTabToRefresh &&
                  typeof window.loadSubTabContent === "function"
                ) {
                  window.loadSubTabContent(subTabToRefresh);
                }
              } else {
                window.showToast?.(
                  `  : ${response?.message || "  "}`,
                  "error"
                );
              }
            })
            .withFailureHandler((error) => {
              if (submitBtn) {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
              }
              window.showToast?.(
                `   : ${error?.message || " "}`,
                "error"
              );
            })
            .submitDynamicForm(window.currentFormId, formData);
        };
      }

      // Global modal handler - fallback implementation if FormModal module is unavailable
      if (typeof window.openFormModal !== "function") {
        window.openFormModal = function openFormModal(
          formId,
          recordData,
          subTabId,
          isEditMode = false
        ) {
          console.log(" Opening form modal:", {
            formId,
            subTabId,
            isEditMode,
          });
          window.currentFormId = formId;

          const modal = document.getElementById("globalFormModal");
          if (!modal) {
            window.showToast?.("    ", "error");
            return;
          }

          const modalTitle = modal.querySelector(".modal-title");
          const formConfig = window.bootstrapData?.forms?.[subTabId];

          if (modalTitle) {
            if (isEditMode) {
              modalTitle.textContent = ` ${formConfig?.titleAr || ""}`;
            } else {
              modalTitle.textContent = `${formConfig?.titleAr || " "}`;
            }
          }

          const modalContent = modal.querySelector(".vertical-tabs-content");
          if (modalContent) {
            modalContent.innerHTML =
              '<div class="modal-loading">  ...</div>';
          }

          modal.classList.add("is-loading");
          modal.style.display = "flex";

          const submitBtn = modal.querySelector(".submit-btn");
          if (submitBtn && !submitBtn.dataset.fallbackBound) {
            submitBtn.addEventListener("click", window.submitFormModal);
            submitBtn.dataset.fallbackBound = "true";
          }

          const scriptRunner = google?.script?.run;
          if (!scriptRunner) {
            window.showToast?.("   ", "error");
            return;
          }

          scriptRunner
            .withSuccessHandler((response) => {
              modal.classList.remove("is-loading");
              if (response.success) {
                console.log(" Form data loaded, calling renderFormInModal");
                window.currentFormStructure = Array.isArray(
                  response.formStructure
                )
                  ? response.formStructure
                  : [];
                window.currentSubTab = subTabId || null;
                if (typeof renderFormInModal === "function") {
                  renderFormInModal(
                    response.formStructure,
                    response.recordData,
                    isEditMode,
                    subTabId
                  );
                } else {
                  console.error(" renderFormInModal function not found!");
                  window.showToast?.("    ", "error");
                }
              } else {
                window.showToast?.(
                  "  : " + response.message,
                  "error"
                );
                window.closeModal?.();
              }
            })
            .withFailureHandler((error) => {
              modal.classList.remove("is-loading");
              window.showToast?.(
                "   : " + error.message,
                "error"
              );
              window.closeModal?.();
            })
            .getFormWithRecordData(
              formId,
              recordData?.ID || recordData?.User_Id || recordData?.Employee_ID,
              subTabId
            );
        };
      }

      if (typeof window.closeModal !== "function") {
        window.closeModal = function closeModal() {
          if (typeof window.closeFormModal === "function") {
            window.closeFormModal();
            return;
          }
          const modal = document.getElementById("globalFormModal");
          if (!modal) {
            return;
          }

          modal.classList.remove("is-loading");
          modal.style.display = "none";
          const content = modal.querySelector(".vertical-tabs-content");
          const nav = modal.querySelector(".vertical-tabs-nav");
          if (content) {
            content.innerHTML = "";
          }
          if (nav) {
            nav.innerHTML = "";
          }
          window.currentFormStructure = null;
          window.currentFormId = null;
          window.currentSubTab = null;
        };
      }

      document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("globalFormModal");
        if (!modal) {
          return;
        }

        const closeBtn = modal.querySelector(".close-modal");
        const cancelBtn = modal.querySelector(".cancel-btn");
        const backdrop = modal.querySelector(".modal-backdrop");

        const handleClose = () => {
          if (typeof window.closeModal === "function") {
            window.closeModal();
          } else if (typeof window.closeFormModal === "function") {
            window.closeFormModal();
          }
        };

        if (closeBtn) {
          closeBtn.addEventListener("click", handleClose);
        }
        if (cancelBtn) {
          cancelBtn.addEventListener("click", handleClose);
        }
        if (backdrop) {
          backdrop.addEventListener("click", handleClose);
        }
      });
    </script>
    <script>
          (function () {
            const views = Array.from(document.querySelectorAll(".view"));
            const navbar = document.getElementById("app-navbar");
            const userLabel = document.getElementById("navbar-user-label");
            const navButtonsContainer = document.getElementById("navbar-buttons");
            const logoutButton = document.getElementById("logout-button");
            const txtSearch = document.getElementById("users-search");
            const selDept = document.getElementById("department-filter");
            const selRole = document.getElementById("role-filter");
            const selStatus = document.getElementById("status-filter");
            const dtUpdatedFrom = document.getElementById("updated-from");
            const dtUpdatedTo = document.getElementById("updated-to");
            const usersTbody = document.getElementById("users-tbody");
            const usersTable = document.getElementById("users-table");
            const selectAllUsers = document.getElementById("select-all-users");
            const bulkExportBtn = document.getElementById("bulk-export");
            const bulkActivateBtn = document.getElementById("bulk-activate");
            const bulkDeactivateBtn = document.getElementById("bulk-deactivate");
            const bulkAssignRoleBtn = document.getElementById("bulk-assign-role");
            const bulkRoleSelect = document.getElementById("bulk-role-select");
            const sysUsersViewButton =
              document.getElementById("sys-users-view-btn");
            const addUserButton = document.getElementById("btn-new-user");
            const dlgReset = document.getElementById("dlg-reset-pass");
            const formReset = document.getElementById("form-reset-pass");
            const dlgProfile = document.getElementById("dlg-user-profile");
            const profileTabsContainer = document.getElementById("profile-tabs");
            const profilePanelsContainer =
              document.getElementById("profile-panels");
            const profileTabButtons = profileTabsContainer
              ? Array.from(profileTabsContainer.querySelectorAll("[data-tab]"))
              : [];
            const profilePanels = profilePanelsContainer
              ? Array.from(
                  profilePanelsContainer.querySelectorAll(".profile-panel")
                )
              : [];
            const profileOverviewList = document.getElementById(
              "profile-overview-list"
            );
            const profilePropertiesBody = document.getElementById(
              "profile-properties-body"
            );
            const profileDocumentsBody = document.getElementById(
              "profile-documents-body"
            );
            const profileSessionsBody = document.getElementById(
              "profile-sessions-body"
            );
            const profileAuditBody = document.getElementById("profile-audit-body");
            const profileTitle = document.getElementById("profile-title");
            const profileUsername = document.getElementById("profile-username");
            const btnCloseProfile = document.getElementById("btn-close-profile");
            const dlgAssign = document.getElementById("dlg-assign-role");
            const formAssignRole = document.getElementById("form-assign-role");
            const assignRoleUserInput = document.getElementById("assign-role-user");
            const assignRoleSelect = document.getElementById("assign-role-select");
            const assignRoleUserLabel = document.getElementById(
              "assign-role-user-label"
            );
            const btnCancelAssign = document.getElementById("btn-cancel-assign");
            const sysView = document.getElementById("system-management-view");
            const sysNav = document.getElementById("sys-side-nav");
            const sysPanes = sysView
              ? Array.from(sysView.querySelectorAll(".sys-pane"))
              : [];
            const moduleGridContainer = document.querySelector(".module-grid");
            const prjSideNav = document.getElementById("prj-side-nav");
            const finSideNav = document.getElementById("fin-side-nav");
            const hrSideNav = document.getElementById("hr-side-nav");
            const rolesTbody = document.getElementById("roles-tbody");
            const permissionsTbody = document.getElementById("permissions-tbody");
            const rolePermsTbody = document.getElementById("role-perms-tbody");
            const propertiesTbody = document.getElementById("properties-tbody");
            const g = (window.g = window.g || {});
            g.bootstrap = g.bootstrap || {};
            const log = window.appLog || window.appLogger || console;
            const showSpinner =
              typeof window.showSpinner === "function"
                ? window.showSpinner.bind(window)
                : (message) => {
                    if (message) {
                      console.log(`[Spinner] ${message}`);
                    }
                  };
            const hideSpinner =
              typeof window.hideSpinner === "function"
                ? window.hideSpinner.bind(window)
                : () => {};
            const ICON_PATHS = Object.freeze({
              home: '<path d="M3 11.5 12 4l9 7.5"/><path d="M5 10v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V10"/><path d="M10 21v-5h4v5"/>',
              projects:
                '<path d="M4 21V7h6v14z"/><path d="M10 21V3h6v18z"/><path d="M6 11h2"/><path d="M6 15h2"/><path d="M14 7h2"/><path d="M14 11h2"/><path d="M14 15h2"/>',
              finance:
                '<circle cx="9" cy="9" r="3"/><path d="M4 21v-4a4 4 0 0 1 4-4h12"/><path d="M15 3h5v12h-5z"/>',
              hr: '<circle cx="12" cy="8" r="4"/><path d="M5 20v-1a7 7 0 0 1 14 0v1"/>',
              system:
                '<circle cx="12" cy="12" r="3"/><path d="M4.6 9a7 7 0 0 1 0 6"/><path d="M19.4 15a7 7 0 0 1 0-6"/><path d="M12 5.5V4"/><path d="M12 20v-1.5"/><path d="M7 9l-1-1"/><path d="M18 16l-1-1"/><path d="M7 15l-1 1"/><path d="M18 8l-1 1"/>',
              logout:
                '<path d="M16 17l5-5-5-5"/><path d="M21 12H9"/><path d="M9 5V3H3v18h6v-2"/>',
              portal:
                '<path d="M12 3l6 4v14H6V7z"/><path d="M10 21v-6h4v6"/><path d="M12 3v4"/>',
              refresh:
                '<path d="M21 3v6h-6"/><path d="M3 21v-6h6"/><path d="M5.6 5.6A9 9 0 0 1 20 8"/><path d="M19.4 18.4A9 9 0 0 1 4 16"/>',
              view: '<path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/>',
              add: '<path d="M12 5v14"/><path d="M5 12h14"/>',
              activate:
                '<circle cx="12" cy="12" r="9"/><path d="M8.5 12.5l2.5 2.5 4.5-5"/>',
              deactivate:
                '<circle cx="12" cy="12" r="9"/><path d="M8 8l8 8"/><path d="M8 16l8-8"/>',
              hide: '<path d="M1 12s4-7 11-7c3.5 0 6.6 1.9 9 5"/><path d="M23 12s-4 7-11 7c-3.5 0-6.6-1.9-9-5"/><path d="M3 3l18 18"/>',
              unhide:
                '<path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/>',
              password:
                '<rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V8a5 5 0 0 1 10 0v3"/><path d="M12 15v3"/>',
              archive:
                '<path d="M3 5h18v4H3z"/><path d="M5 9v10h14V9"/><path d="M10 13h4"/>',
              edit: '<path d="M4 21l2-2 10-10-2-2-10 10-2 4z"/><path d="M14 5l5 5"/>',
              delete:
                '<path d="M5 7h14"/><path d="M10 7V5h4v2"/><path d="M8 7l1 12h6l1-12"/>',
              file: '<path d="M7 3h7l5 5v13H7z"/><path d="M14 3v5h5"/><path d="M10 13h6"/><path d="M10 17h6"/>',
              impersonate:
                '<path d="M3 12c2-4 6-6 9-6s7 2 9 6c-2 4-6 6-9 6s-7-2-9-6z"/><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M9 15c1 .8 2 .8 3 0 1 .8 2 .8 3 0"/>',
              audit:
                '<path d="M7 3h10v4H7z"/><path d="M5 7h14v14H5z"/><path d="M9 11h6"/><path d="M9 15h6"/>',
              userProps:
                '<path d="M4 5h12v14H4z"/><path d="M16 9h4v10h-4z"/><path d="M8 9h4"/><path d="M8 13h6"/>',
              assign:
                '<circle cx="9" cy="8" r="4"/><path d="M4 20v-1a5 5 0 0 1 10 0v1"/><path d="M16 11v6"/><path d="M19 14h-6"/>',
            });

            function createIconElement(name, { size = 20, variant } = {}) {
              const svg = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "svg"
              );
              svg.setAttribute("viewBox", "0 0 24 24");
              svg.setAttribute("focusable", "false");
              svg.setAttribute("aria-hidden", "true");
              svg.classList.add("app-icon");
              if (size >= 22) {
                svg.classList.add("app-icon--lg");
              }
              if (variant === "dark") {
                svg.classList.add("app-icon--dark");
              }
              const markup = ICON_PATHS[name] || "";
              svg.innerHTML = markup;
              return svg;
            }

            function createIconButton(iconName, options = {}) {
              const button = document.createElement("button");
              button.type = options.type || "button";
              button.className = options.className || "icon-btn";
              if (options.title) button.title = options.title;
              if (options.ariaLabel)
                button.setAttribute("aria-label", options.ariaLabel);
              if (options.disabled) button.disabled = true;
              const icon = createIconElement(iconName, {
                size: options.iconSize || 18,
                variant: options.variant,
              });
              button.appendChild(icon);
              return button;
            }

            function setButtonIconLabel(button, iconName, text, options = {}) {
              if (!button) return;
              const {
                wrapperClass = "pane-mode-button__content",
                iconSize = 20,
                variant,
                textClass,
              } = options;
              button.innerHTML = "";
              const wrapper = document.createElement("span");
              wrapper.className = wrapperClass;
              const iconWrap = document.createElement("span");
              iconWrap.className = "icon-wrapper";
              iconWrap.appendChild(
                createIconElement(iconName, { size: iconSize, variant })
              );
              wrapper.appendChild(iconWrap);
              if (text) {
                const textSpan = document.createElement("span");
                textSpan.textContent = text;
                if (textClass) textSpan.classList.add(textClass);
                wrapper.appendChild(textSpan);
              }
              button.appendChild(wrapper);
            }

            if (logoutButton && logoutButton.childElementCount === 0) {
              logoutButton.appendChild(createIconElement("logout", { size: 20 }));
            }

            const portalBackButtons = Array.from(
              document.querySelectorAll('[data-go="portal-view"]')
            );
            portalBackButtons.forEach((btn) => {
              if (btn && btn.childElementCount === 0) {
                btn.appendChild(createIconElement("portal", { size: 20 }));
              }
            });
            const workspaceConfigs = {
              "projects-workspace": {
                tabId: "Tab_PRJ_Management",
                nav: prjSideNav,
                navId: "prj-side-nav",
                contentSelector: "#projects-workspace .workspace-content",
              },
              "finance-workspace": {
                tabId: "Tab_FIN_Management",
                nav: finSideNav,
                navId: "fin-side-nav",
                contentSelector: "#finance-workspace .workspace-content",
              },
              "hr-workspace": {
                tabId: "Tab_HR_Management",
                nav: hrSideNav,
                navId: "hr-side-nav",
                contentSelector: "#hr-workspace .workspace-content",
              },
            };
            const WORKSPACE_THEME_MAP = {
              "portal-view": {
                className: "module-theme-portal",
                label: "Portal",
                color: "gold",
              },
              "projects-workspace": {
                className: "module-theme-projects",
                label: "Projects",
                color: "blue",
              },
              "finance-workspace": {
                className: "module-theme-finance",
                label: "Finance",
                color: "amber",
              },
              "hr-workspace": {
                className: "module-theme-hr",
                label: "HR",
                color: "green",
              },
              "system-management-view": {
                className: "module-theme-system",
                label: "System Management",
                color: "violet",
              },
            };
            function applyModuleTheme(targetId) {
              const bodyEl = document.body;
              if (!bodyEl) return;
              const theme = WORKSPACE_THEME_MAP[targetId] || null;
              Array.from(bodyEl.classList)
                .filter((cls) => cls.startsWith("module-theme-"))
                .forEach((cls) => bodyEl.classList.remove(cls));
              if (theme?.className) {
                bodyEl.classList.add(theme.className);
                if (window.console) {
                  console.log(
                    `THEME: Applying ${theme.label} (${theme.color}) theme.`,
                    {
                      themeClass: theme.className,
                      targetId,
                    }
                  );
                }
              } else if (window.console) {
                console.log("THEME: Applying default theme.", { targetId });
              }
            }
            if (sysUsersViewButton) {
              setButtonIconLabel(sysUsersViewButton, "view", " ");
              sysUsersViewButton.addEventListener("click", () => {
                sysUsersViewButton.classList.add("is-active");
                if (addUserButton) {
                  addUserButton.classList.remove("is-active");
                }
                if (usersTable && typeof usersTable.scrollIntoView === "function") {
                  try {
                    usersTable.scrollIntoView({
                      behavior: "smooth",
                      block: "start",
                    });
                  } catch (err) {
                    usersTable.scrollIntoView();
                  }
                }
              });
            }
            if (addUserButton) {
              addUserButton.setAttribute("type", "button");
              setButtonIconLabel(addUserButton, "add", " ");
            }
            let lastWorkspaceNavRendered = null;
            let currencyFormatter;
            try {
              currencyFormatter = new Intl.NumberFormat("ar-EG", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              });
            } catch (err) {
              currencyFormatter = null;
            }
            const formatCurrencyValue = (value) => {
              const number = Number(value) || 0;
              if (currencyFormatter) {
                try {
                  return currencyFormatter.format(number);
                } catch (err) {
                  // fallback below
                }
              }
              return number.toFixed(2);
            };
            const sessionsTbody = document.getElementById("sessions-tbody");
            const auditTbody = document.getElementById("audit-tbody");
            const NAV_VIEW_MAP = {
              SYS: "system-management-view",
              PRJ: "projects-workspace",
              FIN: "finance-workspace",
              HR: "hr-workspace",
            };

            function resolveThemeFromIdentifier(identifier) {
              const normalized = (identifier || "").toString().toUpperCase();
              if (
                normalized.includes("PRJ") ||
                normalized.includes("PROJ") ||
                normalized.includes("PROJECT")
              ) {
                return "projects";
              }
              if (normalized.includes("FIN")) return "finance";
              if (normalized.includes("HR")) return "hr";
              return "users";
            }
            const NAV_ICON_MAP = Object.freeze({
              portal: "home",
              projects: "projects",
              finance: "finance",
              hr: "hr",
              users: "system",
            });
            const EXCLUDED_PANE_LABELS = new Set([
              " ",
              "",
              " ",
              "",
              " ",
              " ",
              "  ",
              " ",
              "   ",
              "  ",
              "Overview",
              "Sessions",
              "Audit",
              "Audit Log",
              "Audit Trail",
              "Settings",
              "KPIs",
              "Performance Indicators",
              "Leave Analysis",
              "Leave Analytics",
              "Schedule Calculator",
              "Timesheet Calculator",
              "Dashboard",
              "Monitoring Board",
              "Indirect Expense Allocation",
              "Indirect Cost Allocation",
              "General Ledger Summary",
            ]);
            const CLIENT_FORM_FALLBACKS = Object.freeze({
              Sub_SYS_Users: {
                formId: "FORM_SYS_AddUser",
                titleEn: "Add User",
                titleAr: "  ",
              },
              Sub_SYS_Roles: {
                formId: "FORM_SYS_AddRole",
                titleEn: "Add Role",
                titleAr: " ",
              },
              Sub_SYS_Permissions: {
                formId: "FORM_SYS_AddPermission",
                titleEn: "Add Permission",
                titleAr: " ",
              },
              Sub_SYS_RolePerms: {
                formId: "FORM_SYS_MapRolePermission",
                titleEn: "Map Role Permission",
                titleAr: "  ",
              },
              Sub_SYS_Properties: {
                formId: "FORM_SYS_AddUserProperty",
                titleEn: "Add User Property",
                titleAr: "  ",
              },
              Sub_PRJ_Main: {
                formId: "FORM_PRJ_AddProject",
                titleEn: "Add Project",
                titleAr: "  ",
              },
              Sub_PRJ_Tasks: {
                formId: "FORM_PRJ_AddTask",
                titleEn: "Add Project Task",
                titleAr: "  ",
              },
              Sub_PRJ_Costs: {
                formId: "FORM_PRJ_AddCost",
                titleEn: "Log Project Cost",
                titleAr: "  ",
              },
              Sub_PRJ_Materials: {
                formId: "FORM_PRJ_AddMaterial",
                titleEn: "Add Material",
                titleAr: "  ",
              },
              Sub_PRJ_Revenue: {
                formId: "FORM_PRJ_AddRevenue",
                titleEn: "Log Project Revenue",
                titleAr: "  ",
              },
              Sub_PRJ_Clients: {
                formId: "FORM_PRJ_AddClient",
                titleEn: "Add Client",
                titleAr: " ",
              },
              Sub_HR_Employees: {
                formId: "FORM_HR_AddEmployee",
                titleEn: "Add Employee",
                titleAr: " ",
              },
              Sub_HR_Attendance: {
                formId: "FORM_HR_AddAttendance",
                titleEn: "Log Attendance",
                titleAr: " ",
              },
              Sub_HR_Leave_Requests: {
                formId: "FORM_HR_AddLeaveRequest",
                titleEn: "Submit Leave Request",
                titleAr: "  ",
              },
              Sub_HR_Leave: {
                formId: "FORM_HR_AddLeave",
                titleEn: "Record Leave",
                titleAr: " ",
              },
              Sub_HR_Advances: {
                formId: "FORM_HR_AddAdvance",
                titleEn: "Log Advance",
                titleAr: " ",
              },
              Sub_HR_Deductions: {
                formId: "FORM_HR_AddDeduction",
                titleEn: "Log Deduction",
                titleAr: " ",
              },
              Sub_HR_Payroll: {
                formId: "FORM_HR_AddPayroll",
                titleEn: "Create Payroll Entry",
                titleAr: "  ",
              },
            });
            let bootstrapData = {};

            const TRUTHY_FLAG_SET = new Set([
              "true",
              "yes",
              "1",
              "y",
              "t",
              "enabled",
              "enable",
              "active",
              "",
              "",
              "",
              "",
              "",
            ]);
            const FALSY_FLAG_SET = new Set([
              "false",
              "no",
              "0",
              "n",
              "f",
              "disabled",
              "inactive",
              " ",
              "",
              "",
              " ",
              " ",
            ]);

            function isTruthyFlag(value) {
              if (value === true) return true;
              if (value === false) return false;
              if (typeof value === "number") {
                if (!Number.isFinite(value)) return false;
                return value !== 0;
              }
              const normalized = String(value ?? "")
                .trim()
                .toLowerCase();
              if (!normalized) return false;
              if (TRUTHY_FLAG_SET.has(normalized)) return true;
              if (FALSY_FLAG_SET.has(normalized)) return false;
              return false;
            }

            function isTruthyFlag_(value) {
              return isTruthyFlag(value);
            }
            const selectedUsers = new Set();
            let resetUserId = null;
            let currentProfileUserId = null;
            let profileDataCache = null;
            let roleOptionsCache = null;
            let normalizedUsersCache = [];
            let overviewLoaded = false;
            let sysTabRegister = []; // Will be populated from SYS_Tab_Register sheet data
            let sysSubTabLookup = Object.create(null);
            const tableLoadState = {
              roles: false,
              permissions: false,
              rolePerms: false,
              properties: false,
              sessions: false,
              audit: false,
            };
            const paneStateCache = new Map();
            if (!document.__paneRefreshListenerBound) {
              document.__paneRefreshListenerBound = true;
              document.addEventListener("formModal:submitted", (event) => {
                const detail = event?.detail || {};
                const subTabId = detail.subTabId || detail.paneId;
                if (!subTabId) return;
                const key = String(subTabId).trim();
                if (!key) return;
                const paneState = paneStateCache.get(key);
                if (!paneState || typeof paneState.fetchData !== "function") {
                  return;
                }
                try {
                  paneState.fetchData();
                } catch (err) {
                  console.error("Failed to refresh view data for", key, err);
                }
              });
            }
            let currentSysPane = "overview";
            let lastLoginIdentity = null;
            let loginSuccessToastShown = false;

            /* Basic nav */
            function isSysManagementTab(tabId) {
              return (
                String(tabId || "")
                  .trim()
                  .toLowerCase() === "tab_sys_management"
              );
            }

            function toNumberOrNull(value) {
              if (value == null || value === "") return null;
              const num = Number(value);
              return Number.isFinite(num) ? num : null;
            }

            function derivePaneNameFromEntry(entry) {
              if (!entry) return "";
              const subIdRaw =
                entry.subId || entry.Sub_ID || entry.subID || entry.id || "";
              if (subIdRaw) {
                let clean = String(subIdRaw).trim();
                if (clean) {
                  clean = clean.replace(/^Sub_/i, "");
                  clean = clean.replace(/^SYS_/i, "");
                  clean = clean.replace(/^Tab_/i, "");
                  const tokens = clean.split(/[_\s]+/).filter(Boolean);
                  if (tokens.length) {
                    const camel = tokens
                      .map((token, idx) => {
                        const normalized = token.replace(/[^A-Za-z0-9]/g, "");
                        if (!normalized) return "";
                        if (idx === 0) {
                          return (
                            normalized.charAt(0).toLowerCase() + normalized.slice(1)
                          );
                        }
                        return (
                          normalized.charAt(0).toUpperCase() + normalized.slice(1)
                        );
                      })
                      .join("");
                    if (camel) return camel;
                  }
                }
              }

              const routeRaw = entry.route || entry.Route || entry.path || "";
              if (routeRaw) {
                const route = String(routeRaw).trim();
                if (route) {
                  const parts = route.split("/").filter(Boolean);
                  if (!parts.length) {
                    return "";
                  }
                  let lastSegment = parts[parts.length - 1] || "";
                  if (!lastSegment && parts.length > 1) {
                    lastSegment = parts[parts.length - 2];
                  }
                  if (!lastSegment) {
                    return "";
                  }
                  if (lastSegment.toLowerCase() === "sys") {
                    return "overview";
                  }
                  const tokens = lastSegment.split(/[-_\s]+/).filter(Boolean);
                  if (tokens.length) {
                    const camel = tokens
                      .map((token, idx) => {
                        const normalized = token.replace(/[^A-Za-z0-9]/g, "");
                        if (!normalized) return "";
                        if (idx === 0) {
                          return normalized.toLowerCase();
                        }
                        return (
                          normalized.charAt(0).toUpperCase() +
                          normalized.slice(1).toLowerCase()
                        );
                      })
                      .join("");
                    if (camel) return camel;
                  }
                }
              }

              return "";
            }

            function getPaneState(paneId) {
              const key = String(paneId || "").trim();
              if (!key) {
                return {
                  paneId: "",
                  mode: "list",
                  searchText: "",
                  searchColumnIndex: -1,
                  headers: [],
                  rows: [],
                  filteredRows: [],
                  selectedIds: new Set(),
                  formAvailable: false,
                  formMeta: null,
                  sourceSheet: "",
                  dynamicRows: [],
                  rawRows: [],
                  resolvedFormId: "",
                  subTabConfig: null,
                };
              }

              if (!paneStateCache.has(key)) {
                paneStateCache.set(key, {
                  paneId: key,
                  mode: "list",
                  searchText: "",
                  searchColumnIndex: -1,
                  headers: [],
                  rows: [],
                  filteredRows: [],
                  selectedIds: new Set(),
                  formAvailable: false,
                  formMeta: null,
                  sourceSheet: "",
                  dynamicRows: [],
                  rawRows: [],
                  resolvedFormId: "",
                  subTabConfig: null,
                });
              }
              return paneStateCache.get(key);
            }

            function applyPaneFilters(paneState) {
              if (!paneState) return [];
              const headers = Array.isArray(paneState.headers)
                ? paneState.headers
                : [];
              const rows = Array.isArray(paneState.rows) ? paneState.rows : [];
              const searchTerm = String(paneState.searchText || "")
                .trim()
                .toLowerCase();

              if (!searchTerm) return rows.slice();

              const colIndex =
                paneState.searchColumnIndex != null
                  ? Number(paneState.searchColumnIndex)
                  : -1;

              const matches = (value) => {
                if (value == null || value === "") return false;
                if (value instanceof Date)
                  return value.toISOString().toLowerCase().includes(searchTerm);
                const text = String(value).toLowerCase();
                return text.includes(searchTerm);
              };

              return rows.filter((row) => {
                if (colIndex >= 0 && colIndex < headers.length) {
                  const value = Array.isArray(row)
                    ? row[colIndex]
                    : row?.[colIndex];
                  return matches(value);
                }

                for (let idx = 0; idx < headers.length; idx += 1) {
                  const value = Array.isArray(row) ? row[idx] : row?.[idx];
                  if (matches(value)) return true;
                }
                return false;
              });
            }

            function updatePaneSearchOptions(scaffold, paneState) {
              if (!scaffold || !paneState) return;
              const select = scaffold.columnSelect;
              if (!select) return;

              const headers = Array.isArray(paneState.headers)
                ? paneState.headers
                : [];
              const desiredValue =
                paneState.searchColumnIndex != null &&
                paneState.searchColumnIndex >= 0
                  ? String(paneState.searchColumnIndex)
                  : "";

              select.innerHTML = "";
              const anyOption = document.createElement("option");
              anyOption.value = "";
              anyOption.textContent = "   ";
              select.appendChild(anyOption);

              headers.forEach((header, index) => {
                const option = document.createElement("option");
                option.value = String(index);
                option.textContent = header || ` ${index + 1}`;
                select.appendChild(option);
              });

              if (
                desiredValue &&
                select.querySelector(`option[value="${desiredValue}"]`)
              ) {
                select.value = desiredValue;
              } else {
                select.value = "";
                paneState.searchColumnIndex = -1;
              }
            }

            function updatePaneSelectionSummary(scaffold, paneState) {
              if (!scaffold || !paneState) return;
              const summaryEl = scaffold.selectionSummary;
              if (!summaryEl) return;
              const total = Array.isArray(paneState.rows)
                ? paneState.rows.length
                : 0;
              const visible = Array.isArray(paneState.filteredRows)
                ? paneState.filteredRows.length
                : total;
              const selected = paneState.selectedIds
                ? paneState.selectedIds.size
                : 0;

              summaryEl.textContent = ` ${visible}  ${total}  |   ${selected}`;
            }

            function setPaneMode(paneElement, paneState, mode) {
              if (!paneElement || !paneState) return;
              const normalized =
                mode === "form" && paneState.formAvailable ? "form" : "list";
              paneState.mode = normalized;
              paneElement.dataset.mode = normalized;

              const scaffold = paneElement.__scaffold;
              if (scaffold) {
                if (scaffold.listButton) {
                  scaffold.listButton.classList.toggle(
                    "is-active",
                    normalized === "list"
                  );
                  scaffold.listButton.setAttribute(
                    "aria-pressed",
                    normalized === "list" ? "true" : "false"
                  );
                }
                if (scaffold.addButton) {
                  scaffold.addButton.classList.toggle(
                    "is-active",
                    normalized === "form"
                  );
                  scaffold.addButton.disabled = !paneState.formAvailable;
                  scaffold.addButton.setAttribute(
                    "aria-pressed",
                    normalized === "form" ? "true" : "false"
                  );
                }
                if (scaffold.viewContainer) {
                  scaffold.viewContainer.style.display =
                    normalized === "list" ? "" : "none";
                }
                if (scaffold.formContainer) {
                  scaffold.formContainer.style.display =
                    normalized === "form" && paneState.formAvailable ? "" : "none";
                }
              }
            }

            function normalizeTabRegister(tabRegisterData) {
              if (!Array.isArray(tabRegisterData)) return [];

              const map = new Map();

              const storeNormalized = (rawEntry) => {
                if (!rawEntry) return;
                const tabId =
                  rawEntry.tabId ||
                  rawEntry.Tab_ID ||
                  rawEntry.TabId ||
                  rawEntry.tabID ||
                  "";
                const normalizedTabId = String(tabId || "").trim();
                if (!isSysManagementTab(normalizedTabId)) return;

                const paneName = rawEntry.pane || derivePaneNameFromEntry(rawEntry);
                const subId =
                  rawEntry.subId || rawEntry.Sub_ID || rawEntry.subID || "";
                const normalizedSubId = subId ? String(subId).trim() : "";
                const normalizedPane = String(
                  paneName || (normalizedSubId ? normalizedSubId : "")
                ).trim();
                if (!normalizedPane && !normalizedSubId) return;

                const normalized = {
                  tabId: normalizedTabId || "Tab_SYS_Management",
                  subId: normalizedSubId || normalizedPane,
                  labelAr:
                    rawEntry.labelAr ||
                    rawEntry.Sub_Label_AR ||
                    rawEntry.subLabelAr ||
                    rawEntry.Tab_Label_AR ||
                    "",
                  labelEn:
                    rawEntry.labelEn ||
                    rawEntry.Sub_Label_EN ||
                    rawEntry.subLabelEn ||
                    rawEntry.Tab_Label_EN ||
                    "",
                  route: rawEntry.route || rawEntry.Route || rawEntry.path || "",
                  sortOrder: toNumberOrNull(
                    rawEntry.sortOrder ?? rawEntry.Sort_Order ?? rawEntry.order
                  ),
                  pane: normalizedPane,
                  sourceSheet:
                    rawEntry.sourceSheet ||
                    rawEntry.Source_Sheet ||
                    rawEntry.source_sheet ||
                    "",
                  renderMode:
                    rawEntry.renderMode ||
                    rawEntry.Render_Mode ||
                    rawEntry.render_mode ||
                    "",
                  viewLabel:
                    rawEntry.viewLabel ||
                    rawEntry.View_Label ||
                    rawEntry.view_label ||
                    "",
                  addLabel:
                    rawEntry.addLabel ||
                    rawEntry.Add_Label ||
                    rawEntry.add_label ||
                    "",
                  addFormId:
                    rawEntry.addFormId ||
                    rawEntry.Add_Form_ID ||
                    rawEntry.add_form_id ||
                    "",
                  addFormType:
                    rawEntry.addFormType ||
                    rawEntry.Add_Form_Type ||
                    rawEntry.add_form_type ||
                    "",
                  tabColor:
                    rawEntry.tabColor ||
                    rawEntry.Tab_Color ||
                    rawEntry.tab_colour ||
                    rawEntry.Tab_Colour ||
                    "",
                };

                if (!normalized.pane) return;
                const key = (normalized.subId || normalized.pane || "").trim();
                if (!key) return;

                if (!map.has(key)) {
                  map.set(key, normalized);
                } else {
                  const existing = map.get(key);
                  if (!existing.labelAr && normalized.labelAr)
                    existing.labelAr = normalized.labelAr;
                  if (!existing.labelEn && normalized.labelEn)
                    existing.labelEn = normalized.labelEn;
                  if (!existing.route && normalized.route)
                    existing.route = normalized.route;
                  if (
                    (existing.sortOrder == null ||
                      !Number.isFinite(existing.sortOrder)) &&
                    normalized.sortOrder != null
                  ) {
                    existing.sortOrder = normalized.sortOrder;
                  }
                  if (!existing.pane && normalized.pane) {
                    existing.pane = normalized.pane;
                  }
                  if (!existing.sourceSheet && normalized.sourceSheet) {
                    existing.sourceSheet = normalized.sourceSheet;
                  }
                  if (!existing.renderMode && normalized.renderMode) {
                    existing.renderMode = normalized.renderMode;
                  }
                  if (!existing.viewLabel && normalized.viewLabel) {
                    existing.viewLabel = normalized.viewLabel;
                  }
                  if (!existing.addLabel && normalized.addLabel) {
                    existing.addLabel = normalized.addLabel;
                  }
                  if (!existing.addFormId && normalized.addFormId) {
                    existing.addFormId = normalized.addFormId;
                  }
                  if (!existing.addFormType && normalized.addFormType) {
                    existing.addFormType = normalized.addFormType;
                  }
                  if (!existing.tabColor && normalized.tabColor) {
                    existing.tabColor = normalized.tabColor;
                  }
                }
              };

              const acceptRecordType = (value) => {
                if (!value) return true;
                const normalized = String(value).trim().toUpperCase();
                return (
                  normalized === "SUB" ||
                  normalized === "SUBTAB" ||
                  normalized === "SUB_TAB"
                );
              };

              const hasSubCollections = tabRegisterData.some((item) =>
                Array.isArray(item && item.subTabs)
              );

              if (hasSubCollections) {
                tabRegisterData.forEach((tab) => {
                  if (!tab) return;
                  const tabId =
                    tab.tabId || tab.Tab_ID || tab.TabId || tab.tabID || "";
                  if (!isSysManagementTab(tabId)) return;
                  const subTabs = Array.isArray(tab.subTabs) ? tab.subTabs : [];
                  subTabs.forEach((sub) => {
                    if (!sub) return;
                    storeNormalized({
                      tabId,
                      subId: sub.subId || sub.Sub_ID || sub.subID || sub.id || "",
                      labelAr:
                        sub.subLabelAr ||
                        sub.Sub_Label_AR ||
                        sub.labelAr ||
                        sub.label_ar ||
                        tab.tabLabelAr ||
                        tab.Tab_Label_AR ||
                        "",
                      labelEn:
                        sub.subLabelEn ||
                        sub.Sub_Label_EN ||
                        sub.labelEn ||
                        sub.label_en ||
                        tab.tabLabelEn ||
                        tab.Tab_Label_EN ||
                        "",
                      route: sub.route || sub.Route || sub.path || "",
                      sortOrder: toNumberOrNull(
                        sub.sortOrder ?? sub.Sort_Order ?? sub.order
                      ),
                      pane: sub.pane,
                      sourceSheet:
                        sub.sourceSheet ||
                        sub.Source_Sheet ||
                        sub.source_sheet ||
                        tab.sourceSheet ||
                        tab.Source_Sheet ||
                        "",
                      renderMode:
                        sub.renderMode ||
                        sub.Render_Mode ||
                        sub.render_mode ||
                        tab.renderMode ||
                        tab.Render_Mode ||
                        "",
                      viewLabel:
                        sub.viewLabel ||
                        sub.View_Label ||
                        sub.view_label ||
                        tab.viewLabel ||
                        tab.View_Label ||
                        "",
                      addLabel:
                        sub.addLabel ||
                        sub.Add_Label ||
                        sub.add_label ||
                        tab.addLabel ||
                        tab.Add_Label ||
                        "",
                      addFormId:
                        sub.addFormId ||
                        sub.Add_Form_ID ||
                        sub.add_form_id ||
                        tab.addFormId ||
                        tab.Add_Form_ID ||
                        "",
                      addFormType:
                        sub.addFormType ||
                        sub.Add_Form_Type ||
                        sub.add_form_type ||
                        tab.addFormType ||
                        tab.Add_Form_Type ||
                        "",
                      tabColor:
                        sub.tabColor ||
                        sub.Tab_Color ||
                        sub.tab_colour ||
                        tab.tabColor ||
                        tab.Tab_Color ||
                        "",
                    });
                  });
                });
              } else {
                tabRegisterData.forEach((row) => {
                  if (!row) return;
                  const recordType =
                    row.recordType || row.Record_Type || row.Type || "";
                  if (!acceptRecordType(recordType)) return;
                  storeNormalized({
                    tabId: row.tabId || row.Tab_ID || row.TabId || row.tabID || "",
                    subId: row.subId || row.Sub_ID || row.subID || row.id || "",
                    labelAr:
                      row.subLabelAr ||
                      row.Sub_Label_AR ||
                      row.labelAr ||
                      row.Tab_Label_AR ||
                      "",
                    labelEn:
                      row.subLabelEn ||
                      row.Sub_Label_EN ||
                      row.labelEn ||
                      row.Tab_Label_EN ||
                      "",
                    route: row.route || row.Route || row.path || "",
                    sortOrder: toNumberOrNull(
                      row.sortOrder ?? row.Sort_Order ?? row.order
                    ),
                    pane: row.pane,
                    sourceSheet:
                      row.sourceSheet || row.Source_Sheet || row.source_sheet || "",
                    renderMode:
                      row.renderMode || row.Render_Mode || row.render_mode || "",
                    viewLabel:
                      row.viewLabel || row.View_Label || row.view_label || "",
                    addLabel: row.addLabel || row.Add_Label || row.add_label || "",
                    addFormId:
                      row.addFormId || row.Add_Form_ID || row.add_form_id || "",
                    addFormType:
                      row.addFormType ||
                      row.Add_Form_Type ||
                      row.add_form_type ||
                      "",
                    tabColor:
                      row.tabColor ||
                      row.Tab_Color ||
                      row.tab_colour ||
                      row.Tab_Colour ||
                      "",
                  });
                });
              }

              return Array.from(map.values()).sort((a, b) => {
                const aOrder =
                  a.sortOrder != null && Number.isFinite(a.sortOrder)
                    ? a.sortOrder
                    : Number.MAX_SAFE_INTEGER;
                const bOrder =
                  b.sortOrder != null && Number.isFinite(b.sortOrder)
                    ? b.sortOrder
                    : Number.MAX_SAFE_INTEGER;
                if (aOrder !== bOrder) return aOrder - bOrder;
                return String(a.pane || "").localeCompare(String(b.pane || ""));
              });
            }

            function updateSysNavActive(paneName) {
              if (!sysNav) return;
              Array.from(sysNav.querySelectorAll("[data-pane]")).forEach((btn) => {
                btn.classList.toggle("active", btn.dataset.pane === paneName);
              });
            }

            function renderSysNav(tabRegisterData) {
              if (!sysNav) return;

              const sourceData =
                tabRegisterData !== undefined ? tabRegisterData : sysTabRegister;
              const normalized = normalizeTabRegister(sourceData);
              const effectiveRegister = normalized.length ? normalized : [];

              sysTabRegister = effectiveRegister.map((entry) => ({ ...entry }));
              sysSubTabLookup = Object.create(null);
              sysNav.innerHTML = "";

              const groupedTabs = new Map();

              let firstPane = "";
              const seen = new Set();

              sysTabRegister.forEach((entry) => {
                if (!entry || !entry.pane) return;
                const pane = entry.pane;
                const key = entry.subId || pane;
                if (seen.has(key)) return;
                seen.add(key);

                if (!firstPane) firstPane = pane;

                const button = document.createElement("button");
                button.type = "button";
                button.className = "nav-item sidebar-item sub-tab-item";
                button.dataset.pane = pane;
                if (entry.subId) {
                  button.dataset.subId = entry.subId;
                  button.dataset.subTabId = entry.subId;
                } else {
                  button.dataset.subTabId = pane;
                }
                if (entry.tabId) button.dataset.tabId = entry.tabId;
                if (entry.route) button.dataset.route = entry.route;
                if (entry.renderMode) button.dataset.renderMode = entry.renderMode;
                if (entry.sourceSheet)
                  button.dataset.sourceSheet = entry.sourceSheet;
                if (entry.tabColor) button.dataset.color = entry.tabColor;
                if (entry.viewLabel) button.dataset.viewLabel = entry.viewLabel;
                if (entry.addLabel) button.dataset.addLabel = entry.addLabel;
                if (entry.addFormId) button.dataset.addFormId = entry.addFormId;
                button.textContent = entry.labelAr || entry.labelEn || pane;
                sysNav.appendChild(button);

                const tabKey = entry.tabId || "Tab_SYS_Management";
                let grouped = groupedTabs.get(tabKey);
                if (!grouped) {
                  grouped = {
                    Tab_ID: tabKey,
                    Tab_Label_EN: entry.labelEn || "",
                    Tab_Label_AR: entry.labelAr || "",
                    Tab_Color: entry.tabColor || "",
                    subTabs: [],
                  };
                  groupedTabs.set(tabKey, grouped);
                } else {
                  if (!grouped.Tab_Label_EN && entry.labelEn) {
                    grouped.Tab_Label_EN = entry.labelEn;
                  }
                  if (!grouped.Tab_Label_AR && entry.labelAr) {
                    grouped.Tab_Label_AR = entry.labelAr;
                  }
                  if (!grouped.Tab_Color && entry.tabColor) {
                    grouped.Tab_Color = entry.tabColor;
                  }
                }

                const subRecord = {
                  Tab_ID: tabKey,
                  Sub_ID: entry.subId || entry.pane || "",
                  Sub_Label_AR: entry.labelAr || "",
                  Sub_Label_EN: entry.labelEn || "",
                  Render_Mode: entry.renderMode || "",
                  View_Label: entry.viewLabel || "",
                  Add_Label: entry.addLabel || "",
                  Add_Form_ID: entry.addFormId || "",
                  Add_Form_Type: entry.addFormType || "",
                  Edit_Form_ID: entry.editFormId || "",
                  Source_Sheet: entry.sourceSheet || "",
                  Route: entry.route || "",
                  Tab_Color: entry.tabColor || grouped.Tab_Color || "",
                  Pane: entry.pane || "",
                  Search_Bar: entry.searchBar || false,
                  Filter_Options: entry.filterOptions || [],
                };

                const alreadyPresent = grouped.subTabs.some(
                  (sub) => sub.Sub_ID === subRecord.Sub_ID
                );
                if (!alreadyPresent) {
                  grouped.subTabs.push(subRecord);
                }

                const lookupKeys = new Set([
                  pane,
                  pane.toLowerCase(),
                  entry.subId,
                  entry.subId ? entry.subId.toLowerCase() : "",
                  entry.route,
                  entry.route ? entry.route.toLowerCase() : "",
                ]);

                if (entry.sourceSheet) {
                  lookupKeys.add(entry.sourceSheet);
                  lookupKeys.add(entry.sourceSheet.toLowerCase());
                }

                if (entry.route) {
                  const routeParts = String(entry.route).split("/").filter(Boolean);
                  if (routeParts.length) {
                    const last = routeParts[routeParts.length - 1];
                    if (last) {
                      lookupKeys.add(last);
                      lookupKeys.add(last.toLowerCase());
                    }
                  }
                }

                lookupKeys.forEach((lookupKey) => {
                  if (!lookupKey) return;
                  sysSubTabLookup[lookupKey] = entry;
                });
              });

              g.bootstrap.tabs = Array.from(groupedTabs.values());

              if (!firstPane) {
                updateSysNavActive(currentSysPane);
                return;
              }

              if (!currentSysPane || !sysSubTabLookup[currentSysPane]) {
                currentSysPane = firstPane;
              }

              updateSysNavActive(currentSysPane);
            }

            function findParentTabRecord(tabId, subId) {
              const tabs = Array.isArray(g.bootstrap?.tabs) ? g.bootstrap.tabs : [];
              const normalizedTabId = (tabId || "").toString().toLowerCase();
              const normalizedSubId = (subId || "").toString().toLowerCase();
              let fallback = null;

              for (const tab of tabs) {
                if (!tab) continue;
                const candidateTabId = (tab.Tab_ID || tab.tabId || tab.id || "")
                  .toString()
                  .toLowerCase();
                const subTabs = Array.isArray(tab.subTabs) ? tab.subTabs : [];

                for (const sub of subTabs) {
                  if (!sub) continue;
                  const candidateSubId = (sub.Sub_ID || sub.subId || sub.id || "")
                    .toString()
                    .toLowerCase();
                  if (normalizedSubId && candidateSubId === normalizedSubId) {
                    return { tab, sub };
                  }
                }

                if (
                  !fallback &&
                  candidateTabId &&
                  candidateTabId === normalizedTabId
                ) {
                  fallback = { tab, sub: null };
                } else if (!fallback && !normalizedTabId) {
                  fallback = { tab, sub: null };
                }
              }

              return fallback;
            }

            function resolveSubTabEntry(subTabId) {
              if (!subTabId) return null;
              const candidates = new Set();
              const raw = String(subTabId).trim();
              if (raw) {
                candidates.add(raw);
                candidates.add(raw.toLowerCase());
                candidates.add(raw.toUpperCase());
                const withoutPrefix = raw.replace(/^Sub_/i, "");
                if (withoutPrefix && withoutPrefix !== raw) {
                  candidates.add(withoutPrefix);
                  candidates.add(withoutPrefix.toLowerCase());
                  candidates.add(withoutPrefix.toUpperCase());
                }
              }

              for (const candidate of candidates) {
                if (candidate && sysSubTabLookup[candidate]) {
                  return sysSubTabLookup[candidate];
                }
              }
              return null;
            }

            function mapSubTabEntryForRouter(entry, parentLookup) {
              if (!entry) return null;
              const tabId = entry.tabId || entry.Tab_ID || "Tab_SYS_Management";
              const subId = entry.subId || entry.Sub_ID || entry.pane || "";
              const mapped = {
                Tab_ID: tabId,
                Sub_ID: subId,
                Sub_Label_AR: entry.labelAr || entry.Sub_Label_AR || "",
                Sub_Label_EN: entry.labelEn || entry.Sub_Label_EN || "",
                Render_Mode: entry.renderMode || entry.Render_Mode || "",
                View_Label: entry.viewLabel || entry.View_Label || "",
                Add_Label: entry.addLabel || entry.Add_Label || "",
                Add_Form_ID: entry.addFormId || entry.Add_Form_ID || "",
                Add_Form_Type: entry.addFormType || entry.Add_Form_Type || "",
                Edit_Form_ID: entry.editFormId || entry.Edit_Form_ID || "",
                Source_Sheet: entry.sourceSheet || entry.Source_Sheet || "",
                Route: entry.route || entry.Route || "",
                Tab_Color: entry.tabColor || entry.Tab_Color || "",
                Pane: entry.pane || entry.Pane || "",
                Search_Bar: entry.searchBar || entry.Search_Bar || false,
                Filter_Options: entry.filterOptions || entry.Filter_Options || [],
              };

              const parentRecord =
                parentLookup || findParentTabRecord(tabId, subId) || null;
              if (parentRecord && parentRecord.tab) {
                const parentTab = parentRecord.tab;
                if (!mapped.Tab_Color) {
                  mapped.Tab_Color =
                    parentTab.Tab_Color || parentTab.tabColor || "";
                }
                if (!mapped.Sub_Label_AR) {
                  mapped.Sub_Label_AR = parentTab.Tab_Label_AR || "";
                }
                if (!mapped.Sub_Label_EN) {
                  mapped.Sub_Label_EN = parentTab.Tab_Label_EN || "";
                }
                if (!mapped.Render_Mode && parentRecord.sub) {
                  mapped.Render_Mode =
                    parentRecord.sub.Render_Mode ||
                    parentRecord.sub.renderMode ||
                    "";
                }
                if (!mapped.View_Label && parentRecord.sub) {
                  mapped.View_Label =
                    parentRecord.sub.View_Label || parentRecord.sub.viewLabel || "";
                }
                if (!mapped.Add_Label && parentRecord.sub) {
                  mapped.Add_Label =
                    parentRecord.sub.Add_Label || parentRecord.sub.addLabel || "";
                }
                if (!mapped.Add_Form_ID && parentRecord.sub) {
                  mapped.Add_Form_ID =
                    parentRecord.sub.Add_Form_ID ||
                    parentRecord.sub.addFormId ||
                    "";
                }
                if (!mapped.Edit_Form_ID && parentRecord.sub) {
                  mapped.Edit_Form_ID =
                    parentRecord.sub.Edit_Form_ID ||
                    parentRecord.sub.editFormId ||
                    "";
                }
                if (!mapped.Add_Form_Type && parentRecord.sub) {
                  mapped.Add_Form_Type =
                    parentRecord.sub.Add_Form_Type ||
                    parentRecord.sub.addFormType ||
                    "";
                }
                if (!mapped.Source_Sheet && parentRecord.sub) {
                  mapped.Source_Sheet =
                    parentRecord.sub.Source_Sheet ||
                    parentRecord.sub.sourceSheet ||
                    "";
                }
                if (!mapped.Route && parentRecord.sub) {
                  mapped.Route =
                    parentRecord.sub.Route || parentRecord.sub.route || "";
                }
                if (!mapped.Search_Bar && parentRecord.sub) {
                  mapped.Search_Bar =
                    parentRecord.sub.Search_Bar ||
                    parentRecord.sub.searchBar ||
                    false;
                }
                if (
                  (!mapped.Filter_Options ||
                    (Array.isArray(mapped.Filter_Options) &&
                      !mapped.Filter_Options.length)) &&
                  parentRecord.sub
                ) {
                  mapped.Filter_Options =
                    parentRecord.sub.Filter_Options ||
                    parentRecord.sub.filterOptions ||
                    [];
                }
              }

              return mapped;
            }

            /**
             * @function handleSubTabClick
             * @description Handles the click event for a sidebar sub-tab.
             * @param {Event} e The click event.
             * @returns {boolean} True if the event was handled by the router.
             */
            function handleSubTabClick(e) {
              const FNAME = "handleSubTabClick";
              if (!e) return false;
              let target =
                e.target && e.target.closest
                  ? e.target.closest(".sub-tab-item")
                  : null;
              if (!target) return false;

              if (target.classList.contains("active")) {
                if (typeof log.debug === "function") {
                  log.debug(FNAME, "Sub-tab is already active, ignoring click.", {
                    id: target.dataset.subTabId || target.dataset.subId,
                  });
                }
                return true;
              }

              if (typeof e.preventDefault === "function") {
                e.preventDefault();
              }

              const subTabId =
                target.dataset.subTabId ||
                target.dataset.subId ||
                target.dataset.pane;
              if (typeof log.debug === "function") {
                log.debug(FNAME, `Click detected on sub-tab: ${subTabId}`);
              }

              const entry = resolveSubTabEntry(subTabId);
              const parentRecord = entry
                ? findParentTabRecord(entry.tabId || entry.Tab_ID, subTabId)
                : null;
              const subTabData = mapSubTabEntryForRouter(entry, parentRecord);

              if (!subTabData) {
                if (typeof log.error === "function") {
                  log.error(
                    FNAME,
                    `No bootstrap data found for Sub_ID: ${subTabId}`
                  );
                }
                return false;
              }

              document.querySelectorAll(".sub-tab-item.active").forEach((el) => {
                if (el !== target) {
                  el.classList.remove("active");
                }
              });
              target.classList.add("active");

              const parentTabId =
                subTabData.Tab_ID || target.dataset.tabId || "Tab_SYS_Management";
              const parentTabEl = document.getElementById(parentTabId);
              if (parentTabEl && !parentTabEl.classList.contains("active")) {
                document
                  .querySelectorAll(".nav-link.top-nav-link.active")
                  .forEach((el) => {
                    el.classList.remove("active");
                    el.style.backgroundColor = "";
                    el.style.color = "";
                  });
                parentTabEl.classList.add("active");
                const parentColor = parentTabEl.dataset.color || "#4285f4";
                parentTabEl.style.backgroundColor = parentColor;
                parentTabEl.style.color = "white";
              }

              if (subTabData.Route) {
                window.location.hash = subTabData.Route;
              }

              renderSubTabContent(target, subTabData);
              return true;
            }

            function loadSubTabContent(subTabConfig) {
              const contentContainer = document.getElementById(
                "main-content-wrapper"
              );
              if (!contentContainer) {
                console.warn(
                  "loadSubTabContent: 'main-content-wrapper' container not found."
                );
                return;
              }

              const targetSubId =
                subTabConfig?.subId ||
                subTabConfig?.Sub_ID ||
                subTabConfig?.subTabId ||
                subTabConfig?.sub_id;
              if (!targetSubId) {
                contentContainer.innerHTML =
                  '<p class="error">    .</p>';
                return;
              }

              contentContainer.innerHTML = "<p> ...</p>";

              console.log("Loading sub-tab with new system:", subTabConfig);

              if (!(window.google && google.script && google.script.run)) {
                contentContainer.innerHTML =
                  '<p class="error"> Google Apps Script   .</p>';
                return;
              }

              google.script.run
                .withSuccessHandler((response) => {
                  contentContainer.innerHTML = "";

                  if (response?.success) {
                    const builder =
                      (window.viewTab &&
                        typeof window.viewTab.buildDynamicViewPad === "function" &&
                        window.viewTab.buildDynamicViewPad) ||
                      (typeof window.buildDynamicViewPad === "function"
                        ? window.buildDynamicViewPad
                        : null);

                    if (builder) {
                      try {
                        const viewPad = builder(
                          response.subTabConfig || subTabConfig,
                          response.viewData
                        );
                        if (viewPad) {
                          contentContainer.appendChild(viewPad);
                          return;
                        }
                      } catch (renderErr) {
                        console.error(
                          "Failed to render dynamic view pad",
                          renderErr
                        );
                      }
                    }

                    contentContainer.innerHTML =
                      '<p class="error">    .</p>';
                  } else {
                    const message =
                      response?.message || "     .";
                    contentContainer.innerHTML = `<p class="error">Error: ${message}</p>`;
                  }
                })
                .withFailureHandler((error) => {
                  const message = error?.message || String(error) || " ";
                  contentContainer.innerHTML = `<p class="error"> : ${message}</p>`;
                  console.error("Failed to load sub-tab:", error);
                })
                .getSubTabViewData(targetSubId);
            }

            /**
             * @function renderSubTabContent
             * @description Central router for rendering the main content of a sub-tab.
             * It reads the sub-tab's 'Render_Mode' to decide what UI to build.
             * @param {HTMLElement} subTabEl The sub-tab element that was clicked.
             * @param {object} subTabData The data object for the clicked sub-tab.
             */
            function renderSubTabContent(subTabEl, subTabData) {
              const FNAME = "renderSubTabContent";
              if (!subTabData) return;
              if (typeof log.debug === "function") {
                log.debug(FNAME, `Rendering content for: ${subTabData.Sub_ID}`, {
                  data: subTabData,
                });
              }

              const contentWrapper = document.getElementById(
                "main-content-wrapper"
              );
              if (!contentWrapper) {
                if (typeof log.warn === "function") {
                  log.warn(
                    FNAME,
                    "Skipping render: 'main-content-wrapper' not found."
                  );
                }
                return;
              }

              contentWrapper.innerHTML = "";

              const parentRecord = findParentTabRecord(
                subTabData.Tab_ID,
                subTabData.Sub_ID
              );
              const parentTab = parentRecord ? parentRecord.tab : null;
              const parentColor = parentTab
                ? parentTab.Tab_Color || parentTab.tabColor || "#4285f4"
                : "#4285f4";
              if (typeof log.debug === "function") {
                log.debug(
                  FNAME,
                  `Inheriting color: ${parentColor} from ${
                    parentTab?.Tab_ID || parentTab?.tabId || "<unknown>"
                  }`
                );
              }

              const modeRaw = subTabData.Render_Mode || "";
              const mode = typeof modeRaw === "string" ? modeRaw.trim() : modeRaw;

              switch (mode) {
                case "ViewAdd":
                case "viewadd":
                case "DataPad":
                case "datapad": {
                  if (typeof log.debug === "function") {
                    log.debug(
                      FNAME,
                      "Mode: 'ViewAdd'. Rendering dynamic data pad..."
                    );
                  }
                  const normalizedConfig = Object.assign({}, subTabData, {
                    subId:
                      subTabData?.subId ||
                      subTabData?.Sub_ID ||
                      subTabData?.subTabId ||
                      subTabData?.sub_id ||
                      "",
                  });
                  loadSubTabContent(normalizedConfig);
                  break;
                }

                case "Dashboard":
                case "dashboard": {
                  if (typeof log.debug === "function") {
                    log.debug(
                      FNAME,
                      "Mode: 'Dashboard'. Calling renderDashboardView..."
                    );
                  }
                  if (typeof renderDashboardView === "function") {
                    renderDashboardView(subTabData.Sub_ID, subTabData.Source_Sheet);
                  } else {
                    if (typeof log.warn === "function") {
                      log.warn(
                        FNAME,
                        "renderDashboardView is not available in this context."
                      );
                    }
                    contentWrapper.innerHTML = `
                      <div class="p-4">
                        <h2>Dashboard View</h2>
                        <p>No dashboard renderer is registered for <strong>${
                          subTabData.Sub_ID || "?"
                        }</strong>.</p>
                      </div>`;
                  }
                  break;
                }

                case "Custom":
                case "custom": {
                  if (typeof log.debug === "function") {
                    log.debug(
                      FNAME,
                      "Mode: 'Custom'. (Not fully implemented, placeholder)."
                    );
                  }
                  contentWrapper.innerHTML = `
                    <div class='p-4'>
                      <h2>Custom View</h2>
                      <p>Custom renderer for ${subTabData.Sub_ID}</p>
                    </div>`;
                  break;
                }

                default: {
                  if (typeof log.warn === "function") {
                    log.warn(
                      FNAME,
                      `Unknown Render_Mode: '${mode}' for ${subTabData.Sub_ID}.`
                    );
                  }
                  contentWrapper.innerHTML = `
                    <div class='p-4'>
                      <h2>Configuration Error</h2>
                      <p>Unknown Render_Mode: '${mode}'</p>
                    </div>`;
                }
              }
            }

            /**
             * @function colorHexToRgba
             * @description Converts a HEX color string to an rgba string with the requested alpha.
             * @param {string} hex The hex color string.
             * @param {number} alpha The target opacity (0-1).
             * @param {string} fallback Fallback rgba string.
             * @returns {string}
             */
            function colorHexToRgba(
              hex,
              alpha = 1,
              fallback = `rgba(0, 0, 0, ${alpha})`
            ) {
              if (!hex || typeof hex !== "string") {
                return fallback;
              }

              const sanitized = hex.trim().replace(/^#/, "");
              if (![3, 6].includes(sanitized.length)) {
                return fallback;
              }

              const normalized =
                sanitized.length === 3
                  ? sanitized
                      .split("")
                      .map((segment) => segment + segment)
                      .join("")
                  : sanitized;

              const r = parseInt(normalized.substring(0, 2), 16);
              const g = parseInt(normalized.substring(2, 4), 16);
              const b = parseInt(normalized.substring(4, 6), 16);

              if ([r, g, b].some((channel) => Number.isNaN(channel))) {
                return fallback;
              }

              return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            function loadTab(identifier, options = {}) {
              if (!identifier) {
                if (currentSysPane) {
                  setActiveSysPane(currentSysPane, options);
                }
                return;
              }

              const rawKey = String(identifier).trim();
              if (!rawKey) return;

              const candidates = [rawKey, rawKey.toLowerCase()];
              if (rawKey.startsWith("Sub_")) {
                const trimmed = rawKey.replace(/^Sub_/i, "");
                candidates.push(trimmed);
                candidates.push(trimmed.toLowerCase());
              }

              let entry = null;
              for (const candidate of candidates) {
                if (!candidate) continue;
                if (sysSubTabLookup[candidate]) {
                  entry = sysSubTabLookup[candidate];
                  break;
                }
              }

              const paneName =
                entry?.pane || derivePaneNameFromEntry({ subId: rawKey });
              if (paneName) {
                setActiveSysPane(paneName, options);
              } else {
                setActiveSysPane(rawKey, options);
              }
            }

            function switchView(id) {
              applyModuleTheme(id);
              Object.keys(workspaceConfigs).forEach((key) => {
                if (key === id) return;
                const config = workspaceConfigs[key];
                if (!config) return;
                const navEl =
                  config.nav ||
                  (config.navId ? document.getElementById(config.navId) : null);
                if (navEl) {
                  navEl.innerHTML = "";
                  config.nav = navEl;
                }
                const contentEl =
                  config.content ||
                  (config.contentSelector
                    ? document.querySelector(config.contentSelector)
                    : null);
                if (contentEl) {
                  config.content = contentEl;
                  contentEl.innerHTML = "";
                }
              });

              views.forEach((v) => v.classList.toggle("active", v.id === id));
              document.querySelectorAll(".app-navbar .nav-btn").forEach((b) => {
                const target = b.getAttribute("data-target");
                b.classList.toggle(
                  "active",
                  target === id ||
                    (id === "portal-view" && target === "portal-view")
                );
              });
              if (id === "system-management-view") {
                lastWorkspaceNavRendered = null;
                loadTab(currentSysPane || "overview");
                return;
              }

              const workspaceConfig = workspaceConfigs[id];
              if (workspaceConfig) {
                const navEl =
                  workspaceConfig.nav ||
                  (workspaceConfig.navId
                    ? document.getElementById(workspaceConfig.navId)
                    : null);
                if (navEl) {
                  workspaceConfig.nav = navEl;
                }

                const contentEl =
                  workspaceConfig.content ||
                  (workspaceConfig.contentSelector
                    ? document.querySelector(workspaceConfig.contentSelector)
                    : null);
                if (contentEl) {
                  workspaceConfig.content = contentEl;
                }

                if (
                  navEl &&
                  (navEl.dataset.rendered !== "true" ||
                    navEl.childElementCount === 0 ||
                    lastWorkspaceNavRendered !== id)
                ) {
                  renderWorkspaceNav(
                    workspaceConfig.tabId,
                    navEl.id || workspaceConfig.navId,
                    contentEl
                  );
                  lastWorkspaceNavRendered = id;
                }
              } else {
                lastWorkspaceNavRendered = null;
              }
            }
            function createNavButton(label, target) {
              const btn = document.createElement("button");
              btn.className = "nav-btn";
              btn.dataset.target = target;
              const themeKey =
                target === "portal-view"
                  ? "portal"
                  : resolveThemeFromIdentifier(target || label);
              if (themeKey) {
                btn.dataset.theme = themeKey;
              }
              const iconName =
                NAV_ICON_MAP[target] ||
                NAV_ICON_MAP[themeKey] ||
                NAV_ICON_MAP.users;
              const iconHolder = document.createElement("span");
              iconHolder.className = "nav-btn__icon";
              iconHolder.appendChild(createIconElement(iconName, { size: 20 }));
              const labelSpan = document.createElement("span");
              labelSpan.className = "nav-btn__label";
              labelSpan.textContent = label;
              btn.title = label;
              btn.appendChild(labelSpan);
              btn.appendChild(iconHolder);
              return btn;
            }
            function renderNav(navConfig = []) {
              if (!navButtonsContainer) return;
              navButtonsContainer.innerHTML = "";
              navButtonsContainer.appendChild(
                createNavButton("Portal", "portal-view")
              );

              const appendedTargets = new Set(["portal-view"]);
              const items = Array.isArray(navConfig) ? navConfig : [];

              items
                .map((entry) => ({
                  key: entry?.key || entry?.id || entry?.module || "",
                  label:
                    entry?.label ||
                    entry?.title ||
                    entry?.text ||
                    entry?.key ||
                    entry?.id ||
                    "",
                  target:
                    entry?.target ||
                    entry?.viewId ||
                    NAV_VIEW_MAP[entry?.key] ||
                    entry?.route ||
                    entry?.moduleTarget ||
                    "",
                }))
                .filter((item) => item.target)
                .forEach((item) => {
                  const label = item.label || item.key || item.target;
                  const btn = createNavButton(label, item.target);
                  if (item.key) {
                    btn.dataset.key = item.key;
                  }
                  appendedTargets.add(item.target);
                  navButtonsContainer.appendChild(btn);
                });

              if (items.length === 0) {
                ["PRJ", "FIN", "HR", "SYS"].forEach((key) => {
                  const target = NAV_VIEW_MAP[key];
                  if (!target || appendedTargets.has(target)) return;
                  const label =
                    key === "PRJ"
                      ? "Projects"
                      : key === "FIN"
                      ? "Finance"
                      : key === "HR"
                      ? "HR"
                      : "System";
                  const btn = createNavButton(label, target);
                  btn.dataset.key = key;
                  appendedTargets.add(target);
                  navButtonsContainer.appendChild(btn);
                });
              }

              const activeView = document.querySelector(".view.active");
              if (activeView) switchView(activeView.id);
            }

            function renderModuleGrid(navConfig = []) {
              if (!moduleGridContainer) return;
              moduleGridContainer.innerHTML = "";

              const items = Array.isArray(navConfig) ? navConfig : [];
              items
                .filter((item) => item && item.target)
                .forEach((item) => {
                  const theme = resolveThemeFromIdentifier(
                    item?.key || item?.target || ""
                  );
                  const card = document.createElement("div");
                  card.className = "module-card";
                  card.dataset.workspace = item.target;
                  card.dataset.theme = theme;
                  card.textContent = item.label || item.key || item.target;
                  card.addEventListener("click", () => switchView(item.target));
                  moduleGridContainer.appendChild(card);
                });

              if (!moduleGridContainer.children.length) {
                moduleGridContainer.innerHTML =
                  '<p class="muted">    .</p>';
              }
            }

            function resolveFormMetaForPane(paneKey, sourceSheet, labelText) {
              const register =
                (bootstrapData && bootstrapData.forms) || Object.create(null);
              const resolveFallback = (key) => {
                if (!key) return null;
                const variations = new Set();
                variations.add(String(key));
                const trimmed = String(key).trim();
                if (!/^Sub_/i.test(trimmed)) {
                  variations.add(`Sub_${trimmed}`);
                }
                const withoutPrefix = trimmed.replace(/^(Sub_|PRJ_|FIN_|HR_)/i, "");
                if (withoutPrefix && withoutPrefix !== trimmed) {
                  variations.add(withoutPrefix);
                  variations.add(`Sub_${withoutPrefix}`);
                }
                const normalizedKey = trimmed
                  .replace(/[\s_\-]+/g, "")
                  .toLowerCase();
                variations.add(normalizedKey);
                variations.add(`sub${normalizedKey}`);

                for (const variant of variations) {
                  const direct = CLIENT_FORM_FALLBACKS[variant];
                  if (direct) return direct;
                }

                const normalizedVariants = Array.from(variations).map((variant) =>
                  String(variant || "")
                    .trim()
                    .replace(/[\s_\-]+/g, "")
                    .toLowerCase()
                );

                return (
                  Object.entries(CLIENT_FORM_FALLBACKS).find(([candidate]) => {
                    const normalizedCandidate = String(candidate || "")
                      .trim()
                      .replace(/[\s_\-]+/g, "")
                      .toLowerCase();
                    return normalizedVariants.includes(normalizedCandidate);
                  })?.[1] || null
                );
              };
              if (!register || typeof register !== "object") {
                return resolveFallback(paneKey);
              }

              const entries = Object.entries(register).map(([key, meta]) => ({
                key,
                meta,
                normalized: String(key || "")
                  .trim()
                  .replace(/[\s_\-]+/g, "")
                  .toLowerCase(),
              }));

              const candidates = new Set();
              const pushCandidate = (value) => {
                if (value == null) return;
                const trimmed = String(value).trim();
                if (!trimmed) return;
                candidates.add(trimmed);
                candidates.add(trimmed.toLowerCase());
                candidates.add(trimmed.toUpperCase());
              };

              pushCandidate(paneKey);
              if (paneKey) {
                const withoutSub = paneKey.replace(/^Sub_/i, "");
                pushCandidate(withoutSub);
                pushCandidate(withoutSub.replace(/^(PRJ|FIN|HR)_/i, ""));
              }

              if (sourceSheet) {
                pushCandidate(sourceSheet);
                pushCandidate(sourceSheet.replace(/^PV_/i, ""));
                pushCandidate(sourceSheet.replace(/^(PRJ|FIN|HR)_/i, ""));
              }

              if (labelText) {
                pushCandidate(labelText);
                pushCandidate(String(labelText).replace(/\s+/g, ""));
              }

              for (const candidate of candidates) {
                if (register[candidate]) return register[candidate];
                const fallback = resolveFallback(candidate);
                if (fallback) return fallback;
              }

              const normalizedCandidates = Array.from(candidates)
                .map((candidate) =>
                  String(candidate)
                    .replace(/[\s_\-]+/g, "")
                    .toLowerCase()
                )
                .filter(Boolean);

              for (const normalized of normalizedCandidates) {
                const match = entries.find(
                  (entry) => entry.normalized === normalized
                );
                if (match) return match.meta;
                const fallback = resolveFallback(normalized);
                if (fallback) return fallback;
              }

              return null;
            }

            function renderWorkspaceNav(tabId, navElementId, contentElement) {
              const navEl = navElementId
                ? document.getElementById(navElementId)
                : null;
              if (!navEl) return;

              const theme = resolveThemeFromIdentifier(tabId);
              const workspaceElement =
                navEl.closest(".workspace") ||
                (contentElement ? contentElement.closest(".workspace") : null);
              if (workspaceElement) {
                workspaceElement.dataset.theme = theme;
              }

              navEl.innerHTML = "";
              navEl.dataset.rendered = "false";

              if (contentElement) {
                contentElement.innerHTML = "";
              }

              const register = Array.isArray(bootstrapData?.tabRegister)
                ? bootstrapData.tabRegister
                : [];
              const normalizedId = (tabId || "").toString().toUpperCase();
              const tabEntry = register.find((tab) => {
                const tabKey = tab?.tabId || tab?.tabID;
                return tabKey && String(tabKey).toUpperCase() === normalizedId;
              });
              const subTabs = Array.isArray(tabEntry?.subTabs)
                ? tabEntry.subTabs
                : [];
              const seenSubIds = new Set();
              const seenLabels = new Set();
              const seenBaseLabels = new Map();

              subTabs.forEach((sub) => {
                if (!sub?.subId) return;
                const normalizedSubId = String(sub.subId).trim();
                const labelText =
                  sub.subLabelAr || sub.subLabelEn || sub.subId || "";
                const normalizedLabel = labelText.trim().toLowerCase();
                const baseLabelKey = labelText
                  .replace(/\(.*?\)/g, "")
                  .replace(/\s+/g, "")
                  .toLowerCase();
                const subSource = (sub.sourceSheet || "").trim();
                const sourceKey = subSource.toLowerCase();

                if (baseLabelKey) {
                  const seenSources = seenBaseLabels.get(baseLabelKey);
                  if (seenSources && seenSources.has(sourceKey)) {
                    return;
                  }
                }

                if (
                  (normalizedSubId &&
                    seenSubIds.has(normalizedSubId.toLowerCase())) ||
                  (normalizedLabel && seenLabels.has(normalizedLabel))
                ) {
                  return;
                }
                if (normalizedSubId) {
                  seenSubIds.add(normalizedSubId.toLowerCase());
                }
                if (normalizedLabel) {
                  seenLabels.add(normalizedLabel);
                }
                if (baseLabelKey) {
                  const bucket = seenBaseLabels.get(baseLabelKey) || new Set();
                  bucket.add(sourceKey);
                  seenBaseLabels.set(baseLabelKey, bucket);
                }
                const button = document.createElement("button");
                button.type = "button";
                button.className = "nav-item sidebar-item";
                button.textContent = labelText;
                button.dataset.label = labelText;
                button.title = labelText;
                button.dataset.subId = sub.subId;
                if (sub.route) button.dataset.route = sub.route;
                button.dataset.sourceSheet = subSource;
                button.addEventListener("click", () => {
                  navEl
                    .querySelectorAll(".nav-item")
                    .forEach((item) =>
                      item.classList.toggle("active", item === button)
                    );
                  loadGenericTab(sub.subId, subSource, contentElement, labelText);
                });
                navEl.appendChild(button);
              });

              const firstButton = navEl.querySelector("button.nav-item");
              if (firstButton) {
                firstButton.click();
              } else if (contentElement) {
                contentElement.innerHTML =
                  '<p class="muted">    .</p>';
              }

              navEl.dataset.rendered = "true";
            }

            function loadGenericTab(
              paneName,
              sourceSheet,
              contentElement,
              paneLabel = ""
            ) {
              if (!contentElement || !paneName) return;

              const paneId = String(paneName);
              const trimmedSource = (sourceSheet || "").trim();
              let paneElement = contentElement.querySelector(
                `[data-generic-pane="${paneId}"]`
              );
              if (!paneElement) {
                paneElement = document.createElement("div");
                paneElement.className = "generic-pane";
                paneElement.dataset.genericPane = paneId;
                paneElement.dataset.subTabId = paneId;
                contentElement.appendChild(paneElement);
              }

              Array.from(contentElement.children).forEach((child) => {
                if (child === paneElement) {
                  child.style.display = "";
                  child.classList.add("active");
                } else {
                  child.style.display = "none";
                  child.classList.remove("active");
                }
              });
              paneElement.dataset.subTabId = paneId;

              paneElement.classList.remove("direct-expense-pane");
              paneElement.classList.remove("materials-catalog-pane");
              paneElement.dataset.sourceSheet = trimmedSource;

              if (paneName === "Sub_PRJ_Materials") {
                // Materials pane now uses generic rendering from sheet data
                return;
              }

              if (paneName === "Sub_FIN_Direct") {
                // Direct expense pane now uses generic rendering from sheet data
                return;
              }

              const formsRegister =
                (bootstrapData && bootstrapData.forms) || Object.create(null);
              const formMeta = resolveFormMetaForPane(
                paneId,
                trimmedSource,
                paneLabel
              );

              if (window.console && typeof console.groupCollapsed === "function") {
                console.groupCollapsed(
                  `[loadGenericTab] ${paneId} (source: ${
                    trimmedSource || "<none>"
                  })`
                );
                console.log("forms keys", Object.keys(formsRegister));
                console.log("form meta", formMeta);
                console.groupEnd();
              } else if (window.console) {
                console.log("[loadGenericTab]", paneId, {
                  source: trimmedSource || null,
                  formsKeys: Object.keys(formsRegister),
                  formMeta,
                });
              }

              const paneState = getPaneState(paneId);
              const normalizedLabel =
                typeof paneLabel === "string" ? paneLabel.trim() : "";
              paneState.paneLabel = normalizedLabel;
              paneState.designExempt = normalizedLabel
                ? EXCLUDED_PANE_LABELS.has(normalizedLabel)
                : false;
              if (!(paneState.selectedIds instanceof Set)) {
                paneState.selectedIds = new Set();
              }
              paneState.sourceSheet = trimmedSource;
              paneState.formMeta = formMeta || null;
              const baseFormId =
                (formMeta &&
                  (formMeta.formId ||
                    formMeta.Form_ID ||
                    formMeta.addFormId ||
                    formMeta.Add_Form_ID)) ||
                paneState.resolvedFormId ||
                "";
              paneState.resolvedFormId = baseFormId;
              paneState.formAvailable = Boolean(baseFormId);
              if (typeof paneState.searchColumnIndex !== "number") {
                paneState.searchColumnIndex = -1;
              }
              if (typeof paneState.mode !== "string" || !paneState.mode) {
                paneState.mode = "list";
              }
              paneState.searchText = paneState.searchText || "";

              const scaffold = ensureGenericPaneScaffold(paneElement, paneState);
              paneState.scaffold = scaffold;

              const {
                viewContainer,
                formContainer,
                listButton,
                addButton,
                searchInput,
                columnSelect,
                selectVisibleBtn,
                clearSelectionBtn,
                applyBulkBtn,
              } = scaffold;

              if (!viewContainer || !formContainer) {
                return;
              }

              const entityKey = resolveEntityKeyForPane(paneId);
              const dynamicRowsFromArrays = (rows, headers) => {
                if (!Array.isArray(rows) || !rows.length) return [];
                if (!Array.isArray(headers) || !headers.length) return [];
                return rows.map((row) => {
                  if (row && typeof row === "object" && !Array.isArray(row)) {
                    return row;
                  }
                  const record = {};
                  headers.forEach((header, index) => {
                    record[header] = Array.isArray(row) ? row[index] : row?.[index];
                  });
                  return record;
                });
              };

              const sanitizeSelection = () => {
                const headers = Array.isArray(paneState.headers)
                  ? paneState.headers
                  : [];
                const rows = Array.isArray(paneState.rows) ? paneState.rows : [];
                if (!headers.length || !rows.length) {
                  paneState.selectedIds.clear();
                  return;
                }
                const validIds = new Set();
                rows.forEach((row) => {
                  const meta = resolveRecordMetadata(headers, row);
                  if (meta.recordId) validIds.add(meta.recordId);
                });
                paneState.selectedIds.forEach((value) => {
                  if (!validIds.has(value)) {
                    paneState.selectedIds.delete(value);
                  }
                });
              };

              const renderData = () => {
                const headers = Array.isArray(paneState.headers)
                  ? paneState.headers
                  : [];
                const dynamicRows = Array.isArray(paneState.dynamicRows)
                  ? paneState.dynamicRows
                  : [];
                const hasDynamicView =
                  window.viewTab &&
                  typeof window.viewTab.buildDynamicViewPad === "function" &&
                  paneState.subTabConfig &&
                  headers.length;

                if (hasDynamicView) {
                  try {
                    viewContainer.innerHTML = "";
                    const pad = window.viewTab.buildDynamicViewPad(
                      paneState.subTabConfig,
                      {
                        headers,
                        rows: dynamicRows.length
                          ? dynamicRows
                          : dynamicRowsFromArrays(paneState.rawRows, headers),
                      }
                    );
                    viewContainer.appendChild(pad);
                  } catch (viewErr) {
                    console.error("Dynamic view pad render failed", viewErr);
                    fallbackRender();
                  }
                  return;
                }

                fallbackRender();

                function fallbackRender() {
                  paneState.filteredRows = applyPaneFilters(paneState);
                  const selection = {
                    ids: paneState.selectedIds,
                    onUpdate: () => updatePaneSelectionSummary(scaffold, paneState),
                  };
                  renderGenericTable(
                    viewContainer,
                    {
                      headers,
                      rows: Array.isArray(paneState.filteredRows)
                        ? paneState.filteredRows
                        : [],
                    },
                    {
                      paneId,
                      entityKey,
                      formMeta: paneState.formMeta || formMeta,
                      selection,
                      onViewRecord: (record) =>
                        openGenericRecordModal({ paneId, entityKey, record }),
                    }
                  );
                  updatePaneSearchOptions(scaffold, paneState);
                  updatePaneSelectionSummary(scaffold, paneState);
                }
              };

              function fetchData() {
                const hasGoogleRunner =
                  window.google && google.script && google.script.run;
                const hasCustomFetch = false;
                const normalizeRows = (rows, headers) => {
                  if (!Array.isArray(rows) || !rows.length) return [];
                  return rows.map((row) => {
                    if (Array.isArray(row)) {
                      return row;
                    }
                    if (row && typeof row === "object") {
                      return headers.map((header) =>
                        row[header] == null ? "" : row[header]
                      );
                    }
                    return headers.map(() => (row == null ? "" : row));
                  });
                };
                const handleLegacyResult = (legacyResult) => {
                  if (legacyResult && legacyResult.success === false) {
                    const message = legacyResult.message || "  .";
                    viewContainer.innerHTML = `<p class="error-text">${message}</p>`;
                    paneState.headers = [];
                    paneState.rows = [];
                    paneState.filteredRows = [];
                    updatePaneSearchOptions(scaffold, paneState);
                    updatePaneSelectionSummary(scaffold, paneState);
                    return;
                  }
                  paneState.headers = Array.isArray(legacyResult?.headers)
                    ? legacyResult.headers
                    : [];
                  paneState.rows = Array.isArray(legacyResult?.rows)
                    ? legacyResult.rows
                    : [];
                  paneState.filteredRows = [];
                  paneState.rawRows = Array.isArray(paneState.rows)
                    ? paneState.rows.slice()
                    : [];
                  paneState.dynamicRows = [];
                  paneState.viewData = null;
                  paneState.resolvedFormId = "";
                  paneState.formAvailable = false;
                  paneState.subTabConfig = null;
                  if (addButton) {
                    addButton.disabled = true;
                  }
                  sanitizeSelection();
                  renderData();
                };

                if (!trimmedSource && !hasCustomFetch) {
                  paneState.headers = [];
                  paneState.rows = [];
                  paneState.filteredRows = [];
                  paneState.rawRows = [];
                  paneState.dynamicRows = [];
                  viewContainer.innerHTML =
                    '<p class="error-text">      .</p>';
                  updatePaneSearchOptions(scaffold, paneState);
                  updatePaneSelectionSummary(scaffold, paneState);
                  return;
                }

                if (!hasGoogleRunner) {
                  viewContainer.innerHTML =
                    '<p class="error-text"> Google Apps Script   .</p>';
                  paneState.rawRows = [];
                  paneState.dynamicRows = [];
                  return;
                }

                viewContainer.innerHTML =
                  '<p class="muted">    ...</p>';

                const runner = google.script.run
                  .withFailureHandler((err) => {
                    console.error("loadGenericTab failed", err);
                    viewContainer.innerHTML =
                      '<p class="error-text">  .</p>';
                    paneState.rawRows = [];
                    paneState.dynamicRows = [];
                  })
                  .withSuccessHandler((result) => {
                    try {
                      if (
                        result &&
                        typeof result === "object" &&
                        "viewData" in result
                      ) {
                        if (result.success === false) {
                          const message = result.message || "  .";
                          viewContainer.innerHTML = `<p class="error-text">${message}</p>`;
                          paneState.headers = [];
                          paneState.rows = [];
                          paneState.filteredRows = [];
                          paneState.rawRows = [];
                          paneState.dynamicRows = [];
                          updatePaneSearchOptions(scaffold, paneState);
                          updatePaneSelectionSummary(scaffold, paneState);
                          return;
                        }
                        const subTabConfig = result.subTabConfig || null;
                        const formConfig = result.formConfig || null;
                        const viewData = result.viewData || {};
                        if (viewData && viewData.success === false) {
                          const message =
                            viewData.message || "  .";
                          viewContainer.innerHTML = `<p class="error-text">${message}</p>`;
                          paneState.headers = [];
                          paneState.rows = [];
                          paneState.filteredRows = [];
                          paneState.rawRows = [];
                          paneState.dynamicRows = [];
                          updatePaneSearchOptions(scaffold, paneState);
                          updatePaneSelectionSummary(scaffold, paneState);
                          return;
                        }
                        const headers = Array.isArray(viewData?.headers)
                          ? viewData.headers
                          : [];
                        const rawRows = Array.isArray(viewData?.rows)
                          ? viewData.rows
                          : Array.isArray(viewData?.data)
                          ? viewData.data
                          : [];
                        paneState.headers = headers;
                        paneState.rows = normalizeRows(rawRows, headers);
                        paneState.rawRows = rawRows;
                        paneState.dynamicRows = Array.isArray(viewData?.data)
                          ? viewData.data
                          : dynamicRowsFromArrays(rawRows, headers);
                        paneState.viewData = viewData;
                        if (subTabConfig || formConfig) {
                          const mergedSubTabConfig = Object.assign(
                            {},
                            subTabConfig || {},
                            formConfig ? { formConfig } : {}
                          );
                          paneState.subTabConfig = mergedSubTabConfig;
                        }
                        if (formConfig) {
                          paneState.formMeta = Object.assign(
                            {},
                            paneState.formMeta || {},
                            formConfig
                          );
                          if (window.bootstrapData) {
                            if (!window.bootstrapData.forms) {
                              window.bootstrapData.forms = {};
                            }
                            window.bootstrapData.forms[paneId] = Object.assign(
                              {},
                              window.bootstrapData.forms[paneId] || {},
                              formConfig
                            );
                          }
                        }
                        const resolvedFormId =
                          (paneState.formMeta &&
                            (paneState.formMeta.formId ||
                              paneState.formMeta.Form_ID ||
                              paneState.formMeta.addFormId ||
                              paneState.formMeta.Add_Form_ID)) ||
                          (paneState.subTabConfig?.formConfig &&
                            (paneState.subTabConfig.formConfig.formId ||
                              paneState.subTabConfig.formConfig.Form_ID ||
                              paneState.subTabConfig.formConfig.addFormId ||
                              paneState.subTabConfig.formConfig.Add_Form_ID)) ||
                          "";
                        paneState.resolvedFormId = resolvedFormId;
                        paneState.formAvailable = Boolean(resolvedFormId);
                        if (addButton) {
                          addButton.disabled = !paneState.formAvailable;
                        }
                        sanitizeSelection();
                        renderData();
                        return;
                      }
                    } catch (normalizationError) {
                      console.error(
                        "loadGenericTab result normalization failed",
                        normalizationError
                      );
                    }
                    handleLegacyResult(result);
                  });

                if (hasCustomFetch) {
                  runner[fetchAction]();
                } else if (paneId) {
                  runner.getSubTabViewData(paneId);
                } else {
                  runner.getSheetData(trimmedSource);
                }
              }

              if (listButton && !listButton.dataset.bound) {
                listButton.dataset.bound = "true";
                listButton.addEventListener("click", () => {
                  setPaneMode(paneElement, paneState, "list");
                });
              }

              if (addButton) {
                addButton.disabled = !paneState.formAvailable;
                if (!addButton.dataset.bound) {
                  addButton.dataset.bound = "true";
                  addButton.addEventListener("click", () => {
                    const effectiveFormMeta =
                      paneState.formMeta ||
                      formMeta ||
                      paneState.subTabConfig?.formConfig ||
                      {};
                    const candidateFormId =
                      paneState.resolvedFormId ||
                      effectiveFormMeta.addFormId ||
                      effectiveFormMeta.Add_Form_ID ||
                      effectiveFormMeta.formId ||
                      effectiveFormMeta.Form_ID ||
                      "";
                    if (!candidateFormId) {
                      showToast("      .", "info");
                      return;
                    }
                    if (typeof window.openFormModal === "function") {
                      window.openFormModal(candidateFormId, null, paneId, false);
                      return;
                    }
                    setPaneMode(paneElement, paneState, "form");
                    const firstInput = formContainer.querySelector(
                      "input, select, textarea"
                    );
                    if (firstInput) firstInput.focus();
                  });
                }
              }

              if (searchInput) {
                searchInput.value = paneState.searchText || "";
                if (!searchInput.dataset.bound) {
                  searchInput.dataset.bound = "true";
                  searchInput.addEventListener("input", (event) => {
                    paneState.searchText = event.target.value || "";
                    renderData();
                  });
                }
              }

              updatePaneSearchOptions(scaffold, paneState);

              if (columnSelect && !columnSelect.dataset.bound) {
                columnSelect.dataset.bound = "true";
                columnSelect.addEventListener("change", (event) => {
                  const value = event.target.value;
                  paneState.searchColumnIndex =
                    value === "" ? -1 : Number.parseInt(value, 10);
                  if (!Number.isFinite(paneState.searchColumnIndex)) {
                    paneState.searchColumnIndex = -1;
                  }
                  renderData();
                });
              }

              if (selectVisibleBtn && !selectVisibleBtn.dataset.bound) {
                selectVisibleBtn.dataset.bound = "true";
                selectVisibleBtn.addEventListener("click", () => {
                  const headers = Array.isArray(paneState.headers)
                    ? paneState.headers
                    : [];
                  const rows = Array.isArray(paneState.filteredRows)
                    ? paneState.filteredRows
                    : [];
                  rows.forEach((row) => {
                    const meta = resolveRecordMetadata(headers, row);
                    if (meta.recordId) paneState.selectedIds.add(meta.recordId);
                  });
                  renderData();
                  showToast("   .", "success");
                });
              }

              if (clearSelectionBtn && !clearSelectionBtn.dataset.bound) {
                clearSelectionBtn.dataset.bound = "true";
                clearSelectionBtn.addEventListener("click", () => {
                  if (!paneState.selectedIds.size) {
                    showToast("    .", "info");
                    return;
                  }
                  paneState.selectedIds.clear();
                  renderData();
                });
              }

              if (applyBulkBtn && !applyBulkBtn.dataset.bound) {
                applyBulkBtn.dataset.bound = "true";
                applyBulkBtn.addEventListener("click", () => {
                  const count = paneState.selectedIds.size;
                  if (!count) {
                    showToast(
                      "        .",
                      "info"
                    );
                    return;
                  }
                  const detail = {
                    paneId,
                    entityKey,
                    selectedIds: Array.from(paneState.selectedIds),
                    headers: paneState.headers,
                  };
                  paneElement.dispatchEvent(
                    new CustomEvent("pane:bulk-action", { detail })
                  );
                  showToast(
                    `  ${count}    .`,
                    "success"
                  );
                });
              }

              renderPaneHeader(paneElement, paneName, {
                formMeta,
                paneLabel: normalizedLabel,
                sourceSheet: trimmedSource,
                onAdd: () => setPaneMode(paneElement, paneState, "form"),
                onRefresh: fetchData,
                hideAddButton: true,
              });

              renderGenericFormPane(formContainer, {
                paneId,
                formMeta,
                submitAction: null,
                onSubmitted: () => {
                  fetchData();
                  setPaneMode(paneElement, paneState, "list");
                },
              });

              setPaneMode(paneElement, paneState, paneState.mode);

              paneState.fetchData = fetchData;
              fetchData();
            }

            function renderGenericTable(container, data, options = {}) {
              if (!container) return;
              const headers = Array.isArray(data?.headers) ? data.headers : [];
              const rows = Array.isArray(data?.rows) ? data.rows : [];
              const selection = options?.selection || null;
              const selectedIds =
                selection && selection.ids instanceof Set
                  ? selection.ids
                  : new Set();

              container.innerHTML = "";

              if (!headers.length) {
                const wrapper = document.createElement("div");
                wrapper.className = "pane-table-container";
                const scroll = document.createElement("div");
                scroll.className = "pane-table-scroll";
                const emptyMessage = document.createElement("p");
                emptyMessage.className = "muted";
                emptyMessage.textContent = "    .";
                scroll.appendChild(emptyMessage);
                wrapper.appendChild(scroll);
                container.appendChild(wrapper);
                return;
              }

              const wrapper = document.createElement("div");
              wrapper.className = "pane-table-container";
              const scrollContainer = document.createElement("div");
              scrollContainer.className = "pane-table-scroll";

              const table = document.createElement("table");
              table.className = "sys-table generic-table";

              const thead = document.createElement("thead");
              const headerRow = document.createElement("tr");

              const selectTh = document.createElement("th");
              selectTh.className = "generic-table__select-header";
              const selectAllCheckbox = document.createElement("input");
              selectAllCheckbox.type = "checkbox";
              selectAllCheckbox.className = "generic-table__select-all";
              selectAllCheckbox.title = "  ";
              selectAllCheckbox.setAttribute("aria-label", "  ");
              selectTh.appendChild(selectAllCheckbox);
              headerRow.appendChild(selectTh);

              const actionsTh = document.createElement("th");
              actionsTh.className = "generic-table__actions-header";
              actionsTh.textContent = "";
              headerRow.appendChild(actionsTh);

              headers.forEach((header) => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
              });
              thead.appendChild(headerRow);

              const tbody = document.createElement("tbody");
              const rowEntries = [];

              const buildRecordObject = (row) => {
                const record = {};
                headers.forEach((header, index) => {
                  record[header] = Array.isArray(row) ? row[index] : row?.[index];
                });
                return record;
              };

              rows.forEach((row) => {
                const tr = document.createElement("tr");
                const metadata = resolveRecordMetadata(headers, row);
                const record = buildRecordObject(row);
                const isSelected =
                  metadata.recordId && selectedIds.has(metadata.recordId);

                const selectCell = document.createElement("td");
                selectCell.className = "generic-table__select-cell";
                const rowCheckbox = document.createElement("input");
                rowCheckbox.type = "checkbox";
                rowCheckbox.className = "generic-table__select";
                rowCheckbox.checked = Boolean(isSelected);
                if (!metadata.recordId) {
                  rowCheckbox.disabled = true;
                }
                rowCheckbox.title = metadata.label
                  ? ` ${metadata.label}`
                  : " ";
                rowCheckbox.setAttribute(
                  "aria-label",
                  metadata.label ? ` ${metadata.label}` : " "
                );
                selectCell.appendChild(rowCheckbox);
                tr.appendChild(selectCell);

                const actionCell = document.createElement("td");
                actionCell.className = "generic-table__actions-cell";
                const actionWrapper = document.createElement("div");
                actionWrapper.className = "generic-table__actions icon-row";

                const viewBtn = createIconButton("view", {
                  className: "icon-btn",
                  title: " ",
                  ariaLabel: " ",
                });
                viewBtn.addEventListener("click", () => {
                  if (typeof options.onViewRecord === "function") {
                    options.onViewRecord(
                      Object.assign({}, record, { __meta: metadata })
                    );
                  }
                });
                actionWrapper.appendChild(viewBtn);

                actionCell.appendChild(actionWrapper);
                tr.appendChild(actionCell);

                headers.forEach((_, index) => {
                  const td = document.createElement("td");
                  const value = Array.isArray(row) ? row[index] : row?.[index];
                  if (value === true || value === false) {
                    td.innerHTML = renderBooleanBadge(value);
                  } else if (
                    typeof value === "string" &&
                    /^(true|false|yes|no|y|n|1|0)$/i.test(value.trim())
                  ) {
                    td.innerHTML = renderBooleanBadge(value);
                  } else if (value instanceof Date) {
                    td.textContent = formatDateTime(value);
                  } else if (
                    typeof value === "string" &&
                    /^\d{4}-\d{2}-\d{2}T/.test(value)
                  ) {
                    td.textContent = formatDateTime(value);
                  } else {
                    td.innerHTML = escapeHtml(value == null ? "" : String(value));
                  }
                  tr.appendChild(td);
                });

                if (isSelected) {
                  tr.classList.add("generic-table__row--selected");
                }

                tbody.appendChild(tr);

                rowEntries.push({
                  checkbox: rowCheckbox,
                  rowElement: tr,
                  metadata,
                });

                rowCheckbox.addEventListener("change", () => {
                  if (!metadata.recordId) return;
                  if (rowCheckbox.checked) {
                    selectedIds.add(metadata.recordId);
                    tr.classList.add("generic-table__row--selected");
                  } else {
                    selectedIds.delete(metadata.recordId);
                    tr.classList.remove("generic-table__row--selected");
                  }
                  refreshSelectAllState();
                  if (typeof selection?.onUpdate === "function") {
                    selection.onUpdate();
                  }
                });
              });

              const refreshSelectAllState = () => {
                const selectable = rowEntries.filter(
                  (entry) => !entry.checkbox.disabled
                );
                if (!selectable.length) {
                  selectAllCheckbox.checked = false;
                  selectAllCheckbox.indeterminate = false;
                  return;
                }
                const selectedCount = selectable.filter(
                  (entry) => entry.checkbox.checked
                ).length;
                selectAllCheckbox.checked = selectedCount === selectable.length;
                selectAllCheckbox.indeterminate =
                  selectedCount > 0 && selectedCount < selectable.length;
              };

              selectAllCheckbox.addEventListener("change", () => {
                const shouldSelect = selectAllCheckbox.checked;
                rowEntries.forEach(({ checkbox, metadata, rowElement }) => {
                  if (checkbox.disabled) return;
                  checkbox.checked = shouldSelect;
                  if (metadata.recordId) {
                    if (shouldSelect) {
                      selectedIds.add(metadata.recordId);
                      rowElement.classList.add("generic-table__row--selected");
                    } else {
                      selectedIds.delete(metadata.recordId);
                      rowElement.classList.remove("generic-table__row--selected");
                    }
                  }
                });
                refreshSelectAllState();
                if (typeof selection?.onUpdate === "function") {
                  selection.onUpdate();
                }
              });

              refreshSelectAllState();

              table.appendChild(thead);
              table.appendChild(tbody);
              scrollContainer.appendChild(table);
              wrapper.appendChild(scrollContainer);
              container.appendChild(wrapper);
            }

            function ensureGenericPaneScaffold(paneElement, paneState = {}) {
              if (!paneElement) {
                return {
                  controls: null,
                  viewContainer: null,
                  formContainer: null,
                };
              }

              const scaffold = paneElement.__scaffold || {};
              const isExempt = Boolean(paneState?.designExempt);
              paneElement.classList.toggle("generic-pane--exempt", isExempt);

              let header = paneElement.querySelector(".pane-header");
              if (!header) {
                header = document.createElement("div");
                header.className = "pane-header";
                paneElement.prepend(header);
              }

              let controls =
                scaffold.controls ||
                paneElement.querySelector(".generic-pane__controls");
              if (!controls) {
                controls = document.createElement("div");
                controls.className = "generic-pane__controls module-controls";
                if (header && header.nextSibling) {
                  paneElement.insertBefore(controls, header.nextSibling);
                } else if (header) {
                  paneElement.appendChild(controls);
                } else {
                  paneElement.prepend(controls);
                }
              } else {
                controls.classList.add("module-controls");
              }
              scaffold.controls = controls;

              let primaryRow =
                scaffold.primaryRow ||
                controls.querySelector(".module-controls__primary");
              if (!primaryRow) {
                primaryRow = document.createElement("div");
                primaryRow.className =
                  "module-controls__row module-controls__primary";
                controls.appendChild(primaryRow);
              }
              scaffold.primaryRow = primaryRow;

              let secondaryRow =
                scaffold.secondaryRow ||
                controls.querySelector(".module-controls__secondary");
              if (!secondaryRow) {
                secondaryRow = document.createElement("div");
                secondaryRow.className =
                  "module-controls__row module-controls__secondary";
                controls.appendChild(secondaryRow);
              }
              scaffold.secondaryRow = secondaryRow;

              let modeSwitch =
                scaffold.modeSwitch ||
                primaryRow.querySelector(".pane-mode-switch");
              if (!modeSwitch) {
                modeSwitch = document.createElement("div");
                modeSwitch.className = "pane-mode-switch";
                primaryRow.appendChild(modeSwitch);
              }
              scaffold.modeSwitch = modeSwitch;

              let listButton =
                scaffold.listButton ||
                modeSwitch.querySelector('button[data-mode="list"]');
              if (!listButton) {
                listButton = document.createElement("button");
                listButton.type = "button";
                listButton.className = "pane-mode-button";
                listButton.dataset.mode = "list";
                listButton.textContent = " ";
                modeSwitch.appendChild(listButton);
              }
              scaffold.listButton = listButton;

              let addButton =
                scaffold.addButton ||
                modeSwitch.querySelector('button[data-mode="form"]');
              if (!addButton) {
                addButton = document.createElement("button");
                addButton.type = "button";
                addButton.className = "pane-mode-button";
                addButton.dataset.mode = "form";
                addButton.textContent = " ";
                modeSwitch.appendChild(addButton);
              }
              scaffold.addButton = addButton;

              const paneLabelText =
                typeof paneState?.paneLabel === "string"
                  ? paneState.paneLabel.trim()
                  : "";
              const viewLabel = paneLabelText
                ? ` ${paneLabelText}`
                : " ";
              const addLabel =
                paneState?.formMeta?.titleAr ||
                paneState?.formMeta?.titleEn ||
                (paneLabelText ? ` ${paneLabelText}` : " ");

              if (!isExempt) {
                setButtonIconLabel(listButton, "view", viewLabel);
                setButtonIconLabel(addButton, "add", addLabel);
                listButton.title = viewLabel;
                listButton.setAttribute("aria-label", viewLabel);
                addButton.title = addLabel;
                addButton.setAttribute("aria-label", addLabel);
              } else {
                listButton.textContent = " ";
                addButton.textContent = " ";
                listButton.removeAttribute("title");
                listButton.removeAttribute("aria-label");
                addButton.removeAttribute("title");
                addButton.removeAttribute("aria-label");
              }

              let searchBar =
                scaffold.searchBar ||
                secondaryRow.querySelector(".pane-search-bar");
              if (!searchBar) {
                searchBar = document.createElement("div");
                searchBar.className = "pane-search-bar";
                secondaryRow.appendChild(searchBar);
              }
              scaffold.searchBar = searchBar;

              let searchInput =
                scaffold.searchInput ||
                searchBar.querySelector('input[type="search"]');
              if (!searchInput) {
                searchInput = document.createElement("input");
                searchInput.type = "search";
                searchInput.dir = "rtl";
                searchInput.placeholder = "  ";
                searchBar.appendChild(searchInput);
              }
              scaffold.searchInput = searchInput;
              if (paneState) {
                const placeholder =
                  !paneState.designExempt && paneState.paneLabel
                    ? `  ${paneState.paneLabel}`
                    : "  ";
                searchInput.placeholder = placeholder;
                searchInput.setAttribute("title", placeholder);
              }

              let columnSelect =
                scaffold.columnSelect || searchBar.querySelector("select");
              if (!columnSelect) {
                columnSelect = document.createElement("select");
                searchBar.appendChild(columnSelect);
              }
              scaffold.columnSelect = columnSelect;

              let searchSummary =
                scaffold.searchSummary ||
                searchBar.querySelector(".pane-search-summary");
              if (!searchSummary) {
                searchSummary = document.createElement("span");
                searchSummary.className = "pane-search-summary";
                searchSummary.textContent = " 0  0  |   0";
                searchBar.appendChild(searchSummary);
              }
              scaffold.searchSummary = searchSummary;

              let bulkActions =
                scaffold.bulkActions ||
                secondaryRow.querySelector(".pane-bulk-actions");
              if (!bulkActions) {
                bulkActions = document.createElement("div");
                bulkActions.className = "pane-bulk-actions";
                secondaryRow.appendChild(bulkActions);
              }
              scaffold.bulkActions = bulkActions;

              let selectVisibleBtn =
                scaffold.selectVisibleBtn ||
                bulkActions.querySelector('button[data-action="select-visible"]');
              if (!selectVisibleBtn) {
                selectVisibleBtn = document.createElement("button");
                selectVisibleBtn.type = "button";
                selectVisibleBtn.className = "ghost-button";
                selectVisibleBtn.dataset.action = "select-visible";
                bulkActions.appendChild(selectVisibleBtn);
              }
              scaffold.selectVisibleBtn = selectVisibleBtn;

              let clearSelectionBtn =
                scaffold.clearSelectionBtn ||
                bulkActions.querySelector('button[data-action="clear-selection"]');
              if (!clearSelectionBtn) {
                clearSelectionBtn = document.createElement("button");
                clearSelectionBtn.type = "button";
                clearSelectionBtn.className = "ghost-button";
                clearSelectionBtn.dataset.action = "clear-selection";
                bulkActions.appendChild(clearSelectionBtn);
              }
              scaffold.clearSelectionBtn = clearSelectionBtn;

              let applyBulkBtn =
                scaffold.applyBulkBtn ||
                bulkActions.querySelector('button[data-action="apply-bulk"]');
              if (!applyBulkBtn) {
                applyBulkBtn = document.createElement("button");
                applyBulkBtn.type = "button";
                applyBulkBtn.className = "accent-button";
                applyBulkBtn.dataset.action = "apply-bulk";
                bulkActions.appendChild(applyBulkBtn);
              }
              scaffold.applyBulkBtn = applyBulkBtn;

              if (!isExempt) {
                selectVisibleBtn.classList.add("ghost-button");
                clearSelectionBtn.classList.add("ghost-button");
                applyBulkBtn.classList.add("accent-button");
                setButtonIconLabel(selectVisibleBtn, "view", " ", {
                  wrapperClass: "icon-label",
                  iconSize: 18,
                });
                setButtonIconLabel(clearSelectionBtn, "refresh", " ", {
                  wrapperClass: "icon-label",
                  iconSize: 18,
                });
                setButtonIconLabel(applyBulkBtn, "activate", " ", {
                  wrapperClass: "icon-label",
                  iconSize: 18,
                });
                selectVisibleBtn.title = "  ";
                selectVisibleBtn.setAttribute(
                  "aria-label",
                  "  "
                );
                clearSelectionBtn.title = "   ";
                clearSelectionBtn.setAttribute(
                  "aria-label",
                  "   "
                );
                applyBulkBtn.title = "  ";
                applyBulkBtn.setAttribute("aria-label", "  ");
              } else {
                if (!selectVisibleBtn.textContent) {
                  selectVisibleBtn.textContent = " ";
                }
                if (!clearSelectionBtn.textContent) {
                  clearSelectionBtn.textContent = " ";
                }
                if (!applyBulkBtn.textContent) {
                  applyBulkBtn.textContent = " ";
                }
                selectVisibleBtn.removeAttribute("title");
                selectVisibleBtn.removeAttribute("aria-label");
                clearSelectionBtn.removeAttribute("title");
                clearSelectionBtn.removeAttribute("aria-label");
                applyBulkBtn.removeAttribute("title");
                applyBulkBtn.removeAttribute("aria-label");
              }

              let body =
                scaffold.body || paneElement.querySelector(".generic-pane__body");
              if (!body) {
                body = document.createElement("div");
                body.className = "generic-pane__body";
                paneElement.appendChild(body);
              }
              scaffold.body = body;

              let viewContainer =
                scaffold.viewContainer || body.querySelector(".generic-pane__view");
              if (!viewContainer) {
                viewContainer = document.createElement("div");
                viewContainer.className = "generic-pane__view";
                body.appendChild(viewContainer);
              }
              scaffold.viewContainer = viewContainer;

              let formContainer =
                scaffold.formContainer || body.querySelector(".generic-pane__form");
              if (!formContainer) {
                formContainer = document.createElement("div");
                formContainer.className = "generic-pane__form";
                body.appendChild(formContainer);
              }
              scaffold.formContainer = formContainer;

              scaffold.paneState = paneState;
              paneElement.__scaffold = scaffold;
              return scaffold;
            }

            function resolveRecordMetadata(headers, row) {
              const normalizedHeaders = headers.map((header) =>
                String(header || "")
                  .replace(/[\s\u200f\u200e]+/g, "")
                  .toLowerCase()
              );

              const idPatterns = [
                "recordid",
                "id",
                "projectid",
                "taskid",
                "costid",
                "revenueid",
                "materialid",
                "documentid",
                "entityid",
              ];

              let recordId = "";
              let idHeader = headers[0] || "";
              idPatterns.some((pattern) => {
                const matchIndex = normalizedHeaders.findIndex((header) =>
                  header.endsWith(pattern)
                );
                if (matchIndex >= 0) {
                  recordId = Array.isArray(row)
                    ? row[matchIndex]
                    : row?.[matchIndex];
                  idHeader = headers[matchIndex];
                  return true;
                }
                return false;
              });

              if (recordId == null || recordId === "") {
                recordId = Array.isArray(row) ? row[0] : row?.[0];
                idHeader = headers[0] || idHeader;
              }

              const nameIndex = normalizedHeaders.findIndex((header) =>
                /name|title|label|subject/.test(header)
              );
              const labelParts = [];
              if (recordId != null && recordId !== "") {
                labelParts.push(String(recordId));
              }
              if (nameIndex >= 0) {
                const raw = Array.isArray(row) ? row[nameIndex] : row?.[nameIndex];
                if (raw != null && raw !== "") labelParts.push(String(raw));
              }

              return {
                recordId: String(recordId == null ? "" : recordId).trim(),
                idHeader,
                label: labelParts.join("  "),
              };
            }

            function resolveEntityKeyForPane(paneId) {
              const map = {
                Sub_PRJ_Main: "Projects",
                Sub_PRJ_Tasks: "Project_Tasks",
                Sub_PRJ_Costs: "Project_Costs",
                Sub_PRJ_Materials: "Project_Materials",
                Sub_PRJ_Revenue: "Project_Revenue",
              };
              return map[paneId] || paneId.replace(/^Sub_/i, "");
            }

            function renderGenericFormPane(container, options = {}) {
              if (!container) return;
              const formId = options?.formMeta?.formId;
              container.innerHTML = "";

              if (!formId) {
                container.innerHTML =
                  '<p class="muted">       .</p>';
                return;
              }

              container.dataset.formId = formId;
              container.innerHTML =
                '<p class="muted">     ...</p>';

              if (!(window.google && google.script && google.script.run)) {
                container.innerHTML =
                  '<p class="error-text"> Google Apps Script   .</p>';
                return;
              }

              google.script.run
                .withFailureHandler((err) => {
                  console.error("getFormWithOptions failed", err);
                  container.innerHTML =
                    '<p class="error-text">   .</p>';
                })
                .withSuccessHandler((fields) => {
                  if (String(options?.paneId || "") === "Sub_PRJ_Main") {
                    const status =
                      Array.isArray(fields) && fields.length ? "SUCCESS" : "EMPTY";
                    console.log("Projects dynamic form response received", {
                      formId,
                      status,
                      fieldCount: Array.isArray(fields) ? fields.length : 0,
                    });
                  }
                  if (!Array.isArray(fields) || !fields.length) {
                    container.innerHTML =
                      '<p class="muted">      .</p>';
                    return;
                  }
                  renderGenericDynamicForm(container, fields, options);
                })
                .getFormWithOptions(formId);
            }

            function renderGenericDynamicForm(container, fields, options = {}) {
              const formId = options?.formMeta?.formId;
              container.innerHTML = "";

              const heading = document.createElement("h3");
              heading.className = "pane-header__title";
              heading.textContent =
                options?.formMeta?.titleAr ||
                options?.formMeta?.titleEn ||
                " ";
              container.appendChild(heading);

              const form = document.createElement("form");
              form.className = "generic-form";
              container.appendChild(form);

              const sections = new Map();
              fields.forEach((field) => {
                const sectionKey = field.section || field.Section_Header || "";
                if (!sections.has(sectionKey)) sections.set(sectionKey, []);
                sections.get(sectionKey).push(field);
              });

              sections.forEach((sectionFields, sectionName) => {
                if (sectionName) {
                  const sectionHeading = document.createElement("h4");
                  sectionHeading.className = "muted";
                  sectionHeading.style.margin = "0.5rem 0";
                  sectionHeading.textContent = sectionName;
                  form.appendChild(sectionHeading);
                }

                const grid = document.createElement("div");
                grid.className = "generic-form__grid";
                form.appendChild(grid);

                sectionFields.forEach((field) => {
                  const wrapper = document.createElement("div");
                  wrapper.className = "generic-form__field";
                  const type = String(
                    field.type || field.Field_Type || "text"
                  ).toLowerCase();
                  if (type === "paragraph" || type === "textarea") {
                    wrapper.classList.add("generic-form__field--wide");
                  }

                  const label = document.createElement("label");
                  label.textContent =
                    field.label ||
                    field.Field_Label ||
                    field.targetColumn ||
                    field.fieldId ||
                    "";

                  const nameKey =
                    field.targetColumn || field.Target_Column || field.fieldId;
                  let input;
                  if (type === "dropdown") {
                    input = document.createElement("select");
                    const optionsList = Array.isArray(field.options)
                      ? field.options
                      : [];
                    if (!field.required) {
                      const emptyOpt = document.createElement("option");
                      emptyOpt.value = "";
                      emptyOpt.textContent = "";
                      input.appendChild(emptyOpt);
                    }
                    optionsList.forEach((opt) => {
                      const optionEl = document.createElement("option");
                      optionEl.value = opt.value;
                      optionEl.textContent = opt.label || opt.value;
                      input.appendChild(optionEl);
                    });
                  } else if (type === "paragraph" || type === "textarea") {
                    input = document.createElement("textarea");
                    input.rows = 4;
                  } else {
                    input = document.createElement("input");
                    if (type === "date") input.type = "date";
                    else if (type === "number") input.type = "number";
                    else if (type === "auto") input.type = "text";
                    else input.type = type === "email" ? "email" : "text";
                  }

                  if (type === "auto") {
                    input.readOnly = true;
                    input.placeholder = " ";
                  }

                  if (field.readOnly) {
                    input.readOnly = true;
                    input.setAttribute("aria-readonly", "true");
                  }

                  input.name =
                    nameKey || field.fieldId || field.Field_ID || "field";
                  if (field.required) input.required = true;
                  if (field.defaultValue != null && field.defaultValue !== "") {
                    input.value = field.defaultValue;
                  }

                  label.appendChild(input);
                  wrapper.appendChild(label);
                  grid.appendChild(wrapper);
                });
              });

              const actions = document.createElement("div");
              actions.className = "generic-form__actions";
              form.appendChild(actions);

              const submitButton = document.createElement("button");
              submitButton.type = "submit";
              submitButton.className = "accent-button";
              submitButton.textContent = "";
              actions.appendChild(submitButton);

              const resetButton = document.createElement("button");
              resetButton.type = "button";
              resetButton.className = "ghost-button";
              resetButton.textContent = "";
              resetButton.addEventListener("click", () => form.reset());
              actions.appendChild(resetButton);

              form.addEventListener("submit", (event) => {
                event.preventDefault();
                if (!(window.google && google.script && google.script.run)) {
                  showToast(" Google Apps Script  .", "error");
                  return;
                }

                const formData = new FormData(form);
                const payload = {};
                formData.forEach((value, key) => {
                  const inputEl = form.elements.namedItem(key);
                  if (inputEl && inputEl.type === "number") {
                    const numeric = Number(value);
                    payload[key] = Number.isFinite(numeric) ? numeric : value;
                  } else {
                    payload[key] = value;
                  }
                });

                payload.__pane = options?.paneId || "";

                submitButton.disabled = true;
                submitButton.textContent = " ...";

                const submitAction = options?.submitAction
                  ? String(options.submitAction)
                  : "";
                const hasCustomSubmit =
                  submitAction &&
                  typeof google.script.run[submitAction] === "function";

                const runner = google.script.run
                  .withFailureHandler((err) => {
                    console.error("submitDynamicForm failed", err);
                    submitButton.disabled = false;
                    submitButton.textContent = "";
                    showToast("  .", "error");
                  })
                  .withSuccessHandler((result) => {
                    submitButton.disabled = false;
                    submitButton.textContent = "";
                    const isSuccess = result?.success !== false;
                    showToast(
                      result?.message ||
                        (isSuccess
                          ? "   ."
                          : "  ."),
                      isSuccess ? "success" : "error"
                    );
                    if (isSuccess) {
                      form.reset();
                      if (typeof options.onSubmitted === "function") {
                        options.onSubmitted(result);
                      }
                    }
                  });

                if (hasCustomSubmit) {
                  runner[submitAction](payload);
                } else {
                  runner.submitDynamicForm(formId, payload, {
                    paneId: options?.paneId || "",
                  });
                }
              });
            }

            function openGenericRecordModal({ paneId, entityKey, record }) {
              if (!record || typeof record !== "object") return;
              const metadata = record.__meta || {};
              const recordId =
                metadata.recordId ||
                metadata.id ||
                record.ID ||
                record.Id ||
                record.id ||
                "";
              const resolvedLabel =
                metadata.label ||
                metadata.recordId ||
                record.Name ||
                record.Title ||
                recordId ||
                "";

              const overlay = document.createElement("div");
              overlay.className = "generic-modal-overlay";

              const dialog = document.createElement("div");
              dialog.className = "generic-modal generic-modal--wide";
              overlay.appendChild(dialog);

              const header = document.createElement("div");
              header.className = "generic-modal__header";
              const title = document.createElement("h3");
              title.className = "generic-modal__title";
              title.textContent = resolvedLabel
                ? "  (" + resolvedLabel + ")"
                : " ";
              header.appendChild(title);

              const closeBtn = document.createElement("button");
              closeBtn.type = "button";
              closeBtn.className = "ghost-button";
              closeBtn.textContent = "";
              header.appendChild(closeBtn);
              dialog.appendChild(header);

              const body = document.createElement("div");
              body.className = "generic-modal__body";
              dialog.appendChild(body);

              const footer = document.createElement("div");
              footer.className = "generic-modal__footer";
              dialog.appendChild(footer);
              const dismissBtn = document.createElement("button");
              dismissBtn.type = "button";
              dismissBtn.className = "ghost-button";
              dismissBtn.textContent = "";
              footer.appendChild(dismissBtn);

              const closeOverlay = () => {
                document.removeEventListener("keydown", handleKeydown);
                overlay.remove();
              };
              const handleKeydown = (event) => {
                if (event.key === "Escape") {
                  event.preventDefault();
                  closeOverlay();
                }
              };

              closeBtn.addEventListener("click", closeOverlay);
              dismissBtn.addEventListener("click", closeOverlay);
              overlay.addEventListener("click", (event) => {
                if (event.target === overlay) closeOverlay();
              });
              document.addEventListener("keydown", handleKeydown);
              document.body.appendChild(overlay);

              const renderFallback = (sourceRecord) => {
                body.innerHTML = "";
                const fields = document.createElement("div");
                fields.className = "detail-fields";
                const source = sourceRecord || record;
                Object.keys(source || {}).forEach((key) => {
                  if (key === "__meta") return;
                  const value = source[key];
                  const field = document.createElement("div");
                  field.className = "detail-field";
                  const labelEl = document.createElement("span");
                  labelEl.className = "detail-field__label";
                  labelEl.textContent = key;
                  const valueEl = document.createElement("span");
                  valueEl.className = "detail-field__value";
                  valueEl.textContent =
                    value == null || value === "" ? "-" : String(value);
                  field.appendChild(labelEl);
                  field.appendChild(valueEl);
                  fields.appendChild(field);
                });
                if (!fields.children.length) {
                  const empty = document.createElement("p");
                  empty.className = "detail-empty";
                  empty.textContent = "     .";
                  body.appendChild(empty);
                  return;
                }
                body.appendChild(fields);
              };

              const renderDetail = (detail) => {
                body.innerHTML = "";
                const sections = Array.isArray(detail?.sections)
                  ? detail.sections
                  : [];
                if (!sections.length) {
                  renderFallback(detail?.record || record);
                  return;
                }
                if (detail?.title) {
                  title.textContent = detail.title;
                }

                const tabsContainer = document.createElement("div");
                tabsContainer.className = "detail-tabs";
                const nav = document.createElement("div");
                nav.className = "detail-tabs__nav";
                const contentWrapper = document.createElement("div");
                contentWrapper.className = "detail-tabs__content";

                sections.forEach((section, idx) => {
                  const sectionId = section.id || "section-" + idx;
                  const button = document.createElement("button");
                  button.type = "button";
                  button.className = "detail-tabs__button";
                  button.dataset.tabTarget = sectionId;
                  button.textContent =
                    section.label || section.title || " " + (idx + 1);
                  nav.appendChild(button);

                  const pane = document.createElement("div");
                  pane.className = "detail-tab-pane";
                  pane.dataset.tabPane = sectionId;

                  if (
                    section.layout === "table" &&
                    Array.isArray(section.headers)
                  ) {
                    const table = document.createElement("table");
                    table.className = "detail-table";
                    const theadEl = document.createElement("thead");
                    const headRow = document.createElement("tr");
                    section.headers.forEach((header) => {
                      const th = document.createElement("th");
                      th.textContent = header;
                      headRow.appendChild(th);
                    });
                    theadEl.appendChild(headRow);
                    table.appendChild(theadEl);
                    const tbodyEl = document.createElement("tbody");
                    const rowsData = Array.isArray(section.rows)
                      ? section.rows
                      : [];
                    if (!rowsData.length) {
                      const emptyRow = document.createElement("tr");
                      const emptyCell = document.createElement("td");
                      emptyCell.colSpan = section.headers.length || 1;
                      emptyCell.className = "detail-empty";
                      emptyCell.textContent = "   .";
                      emptyRow.appendChild(emptyCell);
                      tbodyEl.appendChild(emptyRow);
                    } else {
                      rowsData.forEach((row) => {
                        const trRow = document.createElement("tr");
                        section.headers.forEach((_, colIdx) => {
                          const td = document.createElement("td");
                          const value = Array.isArray(row)
                            ? row[colIdx]
                            : row?.[colIdx];
                          const headerLabel = section.headers[colIdx] || "";
                          const normalizedHeader = headerLabel.toLowerCase();
                          const isLinkValue =
                            typeof value === "string" &&
                            (value.startsWith("http://") ||
                              value.startsWith("https://"));
                          const isLinkColumn =
                            normalizedHeader.includes("drive") ||
                            normalizedHeader.includes("url") ||
                            normalizedHeader.includes("link") ||
                            normalizedHeader.includes("");
                          if (isLinkValue && isLinkColumn) {
                            const link = document.createElement("a");
                            link.href = value;
                            link.target = "_blank";
                            link.rel = "noopener";
                            link.textContent = " ";
                            td.appendChild(link);
                          } else {
                            td.textContent =
                              value == null || value === "" ? "-" : String(value);
                          }
                          trRow.appendChild(td);
                        });
                        tbodyEl.appendChild(trRow);
                      });
                    }
                    table.appendChild(tbodyEl);
                    pane.appendChild(table);
                  } else if (
                    section.layout === "fields" &&
                    Array.isArray(section.fields)
                  ) {
                    const fieldsList = document.createElement("div");
                    fieldsList.className = "detail-fields";
                    section.fields.forEach((field) => {
                      const fieldWrapper = document.createElement("div");
                      fieldWrapper.className = "detail-field";
                      const labelEl = document.createElement("span");
                      labelEl.className = "detail-field__label";
                      labelEl.textContent = field.label || field.key || "";
                      const valueEl = document.createElement("span");
                      valueEl.className = "detail-field__value";
                      valueEl.textContent =
                        field.value == null || field.value === ""
                          ? "-"
                          : String(field.value);
                      fieldWrapper.appendChild(labelEl);
                      fieldWrapper.appendChild(valueEl);
                      fieldsList.appendChild(fieldWrapper);
                    });
                    if (!fieldsList.children.length) {
                      const empty = document.createElement("p");
                      empty.className = "detail-empty";
                      empty.textContent = "      .";
                      pane.appendChild(empty);
                    } else {
                      pane.appendChild(fieldsList);
                    }
                  } else if (section.layout === "html" && section.html) {
                    pane.innerHTML = section.html;
                  } else {
                    const fallbackMessage = document.createElement("p");
                    fallbackMessage.className = "detail-empty";
                    fallbackMessage.textContent =
                      "      .";
                    pane.appendChild(fallbackMessage);
                  }

                  contentWrapper.appendChild(pane);
                });

                tabsContainer.appendChild(nav);
                tabsContainer.appendChild(contentWrapper);
                body.appendChild(tabsContainer);

                const activateSection = (targetId) => {
                  nav.querySelectorAll(".detail-tabs__button").forEach((btn) => {
                    btn.classList.toggle(
                      "is-active",
                      btn.dataset.tabTarget === targetId
                    );
                  });
                  contentWrapper
                    .querySelectorAll(".detail-tab-pane")
                    .forEach((pane) => {
                      pane.classList.toggle(
                        "active",
                        pane.dataset.tabPane === targetId
                      );
                    });
                };

                nav.addEventListener("click", (event) => {
                  const btn = event.target.closest(".detail-tabs__button");
                  if (!btn) return;
                  const targetId = btn.dataset.tabTarget;
                  if (!targetId) return;
                  activateSection(targetId);
                });

                const initialButton = nav.querySelector(".detail-tabs__button");
                if (initialButton) {
                  activateSection(initialButton.dataset.tabTarget);
                }
              };

              const safeRecord = (() => {
                const clone = {};
                Object.keys(record).forEach((key) => {
                  if (key === "__meta") return;
                  clone[key] = record[key];
                });
                return clone;
              })();

              if (recordId && window.google && google.script && google.script.run) {
                body.innerHTML =
                  "<p class='muted'>    ...</p>";
                google.script.run
                  .withFailureHandler((err) => {
                    console.error("getRecordDetail failed", err);
                    renderFallback();
                  })
                  .withSuccessHandler((detail) => {
                    renderDetail(detail);
                  })
                  .getRecordDetail(paneId, recordId, entityKey || "", safeRecord);
              } else {
                renderFallback();
              }
            }

            function openAttachmentsModal({
              paneId,
              entityKey,
              recordId,
              record,
              onUpdated,
            }) {
              const normalizedId = String(recordId || "").trim();
              if (!normalizedId) {
                showToast("    .", "warning");
                return;
              }

              const overlay = document.createElement("div");
              overlay.className = "generic-modal-overlay";
              const dialog = document.createElement("div");
              dialog.className = "generic-modal generic-modal--wide";
              overlay.appendChild(dialog);

              const header = document.createElement("div");
              header.className = "generic-modal__header";
              const title = document.createElement("h3");
              title.className = "generic-modal__title";
              title.textContent = `  (${normalizedId})`;
              header.appendChild(title);
              const closeBtn = document.createElement("button");
              closeBtn.type = "button";
              closeBtn.className = "ghost-button";
              closeBtn.textContent = "";
              header.appendChild(closeBtn);
              dialog.appendChild(header);

              const body = document.createElement("div");
              body.className = "generic-modal__body";
              dialog.appendChild(body);

              const attachmentsList = document.createElement("div");
              attachmentsList.className = "generic-attachments__list";
              body.appendChild(attachmentsList);

              const form = document.createElement("form");
              form.className = "generic-attachments__form";
              form.innerHTML = `
        <label>
          <input name="Label" type="text" placeholder=":  " />
        </label>
        <label> 
          <input name="File_Name" type="text" placeholder="Contract.pdf" />
        </label>
        <label>  Drive
          <input name="Drive_File_ID" type="text" placeholder="1AbC..." />
        </label>
        <label> 
          <input name="Drive_URL" type="url" placeholder="https://drive.google.com/..." />
        </label>
        <div class="generic-attachments__actions">
          <button type="submit" class="accent-button"> </button>
          <button type="button" class="ghost-button" data-action="reset"></button>
        </div>
      `;
              body.appendChild(form);

              const footer = document.createElement("div");
              footer.className = "generic-modal__footer";
              const closeFooterBtn = document.createElement("button");
              closeFooterBtn.type = "button";
              closeFooterBtn.className = "ghost-button";
              closeFooterBtn.textContent = "";
              footer.appendChild(closeFooterBtn);
              dialog.appendChild(footer);

              const closeOverlay = () => {
                document.removeEventListener("keydown", handleKeydown);
                overlay.remove();
              };

              const handleKeydown = (event) => {
                if (event.key === "Escape") {
                  event.preventDefault();
                  closeOverlay();
                }
              };

              closeBtn.addEventListener("click", closeOverlay);
              closeFooterBtn.addEventListener("click", closeOverlay);
              overlay.addEventListener("click", (event) => {
                if (event.target === overlay) closeOverlay();
              });
              document.addEventListener("keydown", handleKeydown);
              document.body.appendChild(overlay);

              const renderAttachments = (attachments) => {
                attachmentsList.innerHTML = "";
                const items = Array.isArray(attachments) ? attachments : [];
                if (!items.length) {
                  const empty = document.createElement("p");
                  empty.className = "muted";
                  empty.textContent = "     .";
                  attachmentsList.appendChild(empty);
                  return;
                }

                items.forEach((item) => {
                  const card = document.createElement("div");
                  card.className = "generic-attachments__item";
                  const info = document.createElement("div");
                  info.innerHTML = `<strong>${
                    item?.Label || item?.File_Name || ""
                  }</strong><br/><small>${item?.Drive_File_ID || ""}</small>`;
                  card.appendChild(info);

                  const controls = document.createElement("div");
                  controls.className = "generic-attachments__actions";
                  if (item?.Drive_URL) {
                    const openBtn = document.createElement("a");
                    openBtn.href = item.Drive_URL;
                    openBtn.target = "_blank";
                    openBtn.rel = "noopener";
                    openBtn.className = "ghost-button ghost-button--small";
                    openBtn.textContent = "";
                    controls.appendChild(openBtn);
                  }

                  if (item?.Doc_ID) {
                    const deleteBtn = document.createElement("button");
                    deleteBtn.type = "button";
                    deleteBtn.className = "ghost-button ghost-button--small";
                    deleteBtn.textContent = "";
                    deleteBtn.addEventListener("click", () => {
                      if (
                        !(window.google && google.script && google.script.run) ||
                        !window.confirm("      ")
                      ) {
                        return;
                      }
                      google.script.run
                        .withFailureHandler((err) => {
                          console.error("deleteAttachmentRecord failed", err);
                          showToast("  .", "error");
                        })
                        .withSuccessHandler(() => {
                          showToast("  .", "success");
                          loadAttachments();
                          if (typeof onUpdated === "function") onUpdated();
                        })
                        .deleteAttachmentRecord(item.Doc_ID);
                    });
                    controls.appendChild(deleteBtn);
                  }

                  card.appendChild(controls);
                  attachmentsList.appendChild(card);
                });
              };

              const loadAttachments = () => {
                attachmentsList.innerHTML =
                  '<p class="muted">    ...</p>';
                if (!(window.google && google.script && google.script.run)) {
                  attachmentsList.innerHTML =
                    '<p class="error-text"> Google Apps Script  .</p>';
                  return;
                }
                google.script.run
                  .withFailureHandler((err) => {
                    console.error("getAttachmentsForEntity failed", err);
                    attachmentsList.innerHTML =
                      '<p class="error-text">   .</p>';
                  })
                  .withSuccessHandler((list) => {
                    renderAttachments(list);
                  })
                  .getAttachmentsForEntity(normalizedId, entityKey);
              };

              form.addEventListener("submit", (event) => {
                event.preventDefault();
                if (!(window.google && google.script && google.script.run)) {
                  showToast(" Google Apps Script  .", "error");
                  return;
                }
                const formData = new FormData(form);
                const payload = {
                  Entity: entityKey,
                  Entity_ID: normalizedId,
                };
                formData.forEach((value, key) => {
                  payload[key] = value;
                });

                const submitBtn = form.querySelector("button[type='submit']");
                if (submitBtn) {
                  submitBtn.disabled = true;
                  submitBtn.textContent = " ...";
                }

                google.script.run
                  .withFailureHandler((err) => {
                    console.error("saveAttachmentRecord failed", err);
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.textContent = " ";
                    }
                    showToast("  .", "error");
                  })
                  .withSuccessHandler(() => {
                    if (submitBtn) {
                      submitBtn.disabled = false;
                      submitBtn.textContent = " ";
                    }
                    showToast("   .", "success");
                    form.reset();
                    loadAttachments();
                    if (typeof onUpdated === "function") onUpdated();
                  })
                  .saveAttachmentRecord(payload);
              });

              const resetBtn = form.querySelector("button[data-action='reset']");
              if (resetBtn) {
                resetBtn.addEventListener("click", () => form.reset());
              }

              loadAttachments();
            }

            function loadMaterialsViewData(container, options = {}) {
              if (!container) return;
              const {
                reload = false,
                onComplete,
                formId,
                controlsRow,
                onSwitchMode,
              } = options;
              const alreadyLoaded = container.dataset.viewLoaded === "true";
              if (alreadyLoaded && !reload) {
                if (typeof onComplete === "function") onComplete();
                return;
              }

              container.dataset.viewLoaded = "false";
              container.innerHTML =
                '<p class="muted">     ...</p>';
              if (controlsRow) {
                controlsRow.innerHTML = "";
              }

              if (!(window.google && google.script && google.script.run)) {
                container.innerHTML =
                  '<p class="error-text"> Google Apps Script  .</p>';
                if (typeof onComplete === "function") onComplete();
                return;
              }

              google.script.run
                .withFailureHandler((err) => {
                  console.error("getMaterialsViewData failed", err);
                  container.innerHTML =
                    '<p class="error-text">   .</p>';
                  if (typeof showToast === "function") {
                    showToast("   .", "error");
                  }
                  if (typeof onComplete === "function") onComplete(err);
                })
                .withSuccessHandler((result) => {
                  container.dataset.viewLoaded = "true";
                  renderMaterialsTable(container, result, {
                    formId,
                    controlsRow,
                    onSwitchMode,
                    onRefresh: () =>
                      loadMaterialsViewData(container, {
                        reload: true,
                        formId,
                        controlsRow,
                        onSwitchMode,
                      }),
                  });
                  if (typeof onComplete === "function") onComplete(result);
                })
                .getMaterialsViewData();
            }
            function renderMaterialsTable(container, data, options = {}) {
              if (!container) return;

              const normalized = (() => {
                if (!data || typeof data !== "object" || Array.isArray(data)) {
                  return { headers: [], rows: [] };
                }
                if (Array.isArray(data.headers) && Array.isArray(data.rows)) {
                  return data;
                }
                if (data.data && typeof data.data === "object") {
                  return data.data;
                }
                if (Array.isArray(data.items)) {
                  return {
                    headers: Array.isArray(data.headers) ? data.headers : [],
                    rows: data.items,
                  };
                }
                return data;
              })();

              const headers = Array.isArray(normalized?.headers)
                ? normalized.headers
                : [];
              const rows = Array.isArray(normalized?.rows)
                ? normalized.rows
                : Array.isArray(normalized?.items)
                ? normalized.items
                : [];
              const formId =
                options?.formId ||
                (container.closest?.(".materials-catalog-pane")?.dataset
                  ?.materialsFormId ??
                  "FORM_PRJ_AddMaterial");

              container.innerHTML = "";

              if (!headers.length) {
                const empty = document.createElement("p");
                empty.className = "muted";
                empty.textContent = "    .";
                container.appendChild(empty);
                return;
              }

              const normalizeHeader = (header) =>
                String(header || "")
                  .replace(/[\s\u200f\u200e]+/g, "")
                  .replace(/[_-]+/g, "")
                  .toLowerCase();

              const matchHeaderIndex = (patterns) =>
                headers.findIndex((header) =>
                  patterns.includes(normalizeHeader(header))
                );

              const idIndex = matchHeaderIndex([
                "materialid",
                "materialcode",
                "id",
                "itemid",
                "",
                "",
              ]);
              const categoryIndex = matchHeaderIndex([
                "category",
                "materialcategory",
                "",
                "",
              ]);
              const subcategoryIndex = matchHeaderIndex([
                "subcategory",
                "materialsubcategory",
                "",
                "",
              ]);
              const activeIndex = matchHeaderIndex([
                "active",
                "isactive",
                "status",
                "enabled",
                "",
              ]);
              const priceIndex = matchHeaderIndex([
                "defaultprice",
                "unitprice",
                "price",
                "",
                "",
              ]);

              const nameKeys = new Set([
                "namear",
                "arabicname",
                "materialnamear",
                "nameen",
                "materialnameen",
                "name",
                "",
                "",
                "",
              ]);

              const records = rows.map((row, rowIndex) => {
                const entry = {};
                headers.forEach((header, index) => {
                  entry[header] = row[index];
                });
                const rawId = idIndex >= 0 ? row[idIndex] : rowIndex + 1;
                const materialId =
                  rawId != null && rawId !== "" ? String(rawId) : `row-${rowIndex}`;
                const category =
                  categoryIndex >= 0 ? String(row[categoryIndex] || "").trim() : "";
                const subcategory =
                  subcategoryIndex >= 0
                    ? String(row[subcategoryIndex] || "").trim()
                    : "";
                const nameTokens = headers
                  .map((header, index) => ({ header, index }))
                  .filter(({ header }) => nameKeys.has(normalizeHeader(header)))
                  .map(({ index }) => String(row[index] || ""))
                  .filter(Boolean);

                const searchText = [materialId, category, subcategory]
                  .concat(nameTokens)
                  .map((value) => String(value || "").toLowerCase())
                  .join(" ");

                return {
                  record: entry,
                  materialId,
                  category,
                  subcategory,
                  searchText,
                  isActive:
                    activeIndex >= 0 ? isTruthyFlag_(row[activeIndex]) : true,
                  priceValue: priceIndex >= 0 ? row[priceIndex] : "",
                };
              });

              const categories = Array.from(
                new Set(records.map((entry) => entry.category).filter(Boolean))
              ).sort((a, b) => a.localeCompare(b, "ar", { sensitivity: "base" }));

              const providedControlsRow = options?.controlsRow || null;
              const controlsHost = providedControlsRow
                ? providedControlsRow
                : (() => {
                    const fallback = document.createElement("div");
                    fallback.className =
                      "module-controls materials-module__controls";
                    const primary = document.createElement("div");
                    primary.className =
                      "module-controls__row module-controls__primary";
                    fallback.appendChild(primary);
                    const secondary = document.createElement("div");
                    secondary.className =
                      "module-controls__row module-controls__secondary";
                    fallback.appendChild(secondary);
                    container.appendChild(fallback);
                    if (typeof options.onSwitchMode === "function") {
                      const switcher = document.createElement("div");
                      switcher.className = "pane-mode-switch";
                      primary.appendChild(switcher);
                      const viewBtn = document.createElement("button");
                      viewBtn.type = "button";
                      viewBtn.className = "pane-mode-button is-active";
                      setButtonIconLabel(viewBtn, "view", " ");
                      viewBtn.addEventListener("click", () =>
                        options.onSwitchMode("view")
                      );
                      switcher.appendChild(viewBtn);
                      const addBtn = document.createElement("button");
                      addBtn.type = "button";
                      addBtn.className = "pane-mode-button";
                      setButtonIconLabel(addBtn, "add", " ");
                      addBtn.addEventListener("click", () =>
                        options.onSwitchMode("add")
                      );
                      switcher.appendChild(addBtn);
                    }
                    return secondary;
                  })();

              const filtersContainer = document.createElement("div");
              filtersContainer.className = "materials-module__filters";
              controlsHost.appendChild(filtersContainer);

              const searchWrapper = document.createElement("div");
              searchWrapper.className = "materials-module__search";
              const searchInput = document.createElement("input");
              searchInput.type = "search";
              searchInput.id = "material-view-search";
              searchInput.placeholder = "  ...";
              searchWrapper.appendChild(searchInput);
              filtersContainer.appendChild(searchWrapper);

              const selectsGroup = document.createElement("div");
              selectsGroup.className = "materials-module__selects";
              filtersContainer.appendChild(selectsGroup);

              const categorySelect = document.createElement("select");
              categorySelect.id = "material-view-category";
              const categoryDefault = document.createElement("option");
              categoryDefault.value = "";
              categoryDefault.textContent = " ";
              categorySelect.appendChild(categoryDefault);
              categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
              });
              selectsGroup.appendChild(categorySelect);

              const subcategorySelect = document.createElement("select");
              subcategorySelect.id = "material-view-subcategory";
              const subcategoryDefault = document.createElement("option");
              subcategoryDefault.value = "";
              subcategoryDefault.textContent = "  ";
              subcategorySelect.appendChild(subcategoryDefault);
              subcategorySelect.disabled = true;
              selectsGroup.appendChild(subcategorySelect);

              const bulkActions = document.createElement("div");
              bulkActions.className = "materials-module__bulk";
              bulkActions.hidden = true;

              const activateSelected = document.createElement("button");
              activateSelected.type = "button";
              activateSelected.className = "ghost-button ghost-button--sm";
              activateSelected.textContent = " ";
              bulkActions.appendChild(activateSelected);

              const deactivateSelected = document.createElement("button");
              deactivateSelected.type = "button";
              deactivateSelected.className = "ghost-button ghost-button--sm";
              deactivateSelected.textContent = " ";
              bulkActions.appendChild(deactivateSelected);

              controlsHost.appendChild(bulkActions);
              const table = document.createElement("table");
              table.className = "sys-table materials-catalog__table";
              const thead = document.createElement("thead");
              const headerRow = document.createElement("tr");

              const selectAllTh = document.createElement("th");
              selectAllTh.className = "materials-module__select-column";
              const selectAllCheckbox = document.createElement("input");
              selectAllCheckbox.type = "checkbox";
              selectAllCheckbox.setAttribute("aria-label", " ");
              selectAllTh.appendChild(selectAllCheckbox);
              headerRow.appendChild(selectAllTh);

              const headerCells = [];
              headers.forEach((header, index) => {
                const th = document.createElement("th");
                th.textContent = header;
                th.dataset.columnIndex = index;
                th.tabIndex = 0;
                th.addEventListener("click", () => toggleSort(index));
                th.addEventListener("keydown", (event) => {
                  if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault();
                    toggleSort(index);
                  }
                });
                headerCells.push(th);
                headerRow.appendChild(th);
              });

              const actionsTh = document.createElement("th");
              actionsTh.className = "materials-module__actions-column";
              actionsTh.textContent = "";
              headerRow.appendChild(actionsTh);

              thead.appendChild(headerRow);
              table.appendChild(thead);
              const tbody = document.createElement("tbody");
              table.appendChild(tbody);
              container.appendChild(table);

              const countBadge = document.createElement("div");
              countBadge.className = "materials-module__count";
              controlsHost.appendChild(countBadge);

              const selectedIds = new Set();
              const state = {
                search: "",
                category: "",
                subcategory: "",
                sortIndex: -1,
                sortDir: "asc",
              };

              const updateBulkActionsVisibility = () => {
                const hasSelection = selectedIds.size > 0;
                bulkActions.hidden = !hasSelection;
                activateSelected.disabled = !hasSelection;
                deactivateSelected.disabled = !hasSelection;
              };

              const populateSubcategories = (category) => {
                const options = Array.from(
                  new Set(
                    records
                      .filter((entry) => !category || entry.category === category)
                      .map((entry) => entry.subcategory)
                      .filter(Boolean)
                  )
                ).sort((a, b) => a.localeCompare(b, "ar", { sensitivity: "base" }));

                subcategorySelect.innerHTML = "";
                subcategorySelect.appendChild(subcategoryDefault.cloneNode(true));
                options.forEach((value) => {
                  const option = document.createElement("option");
                  option.value = value;
                  option.textContent = value;
                  subcategorySelect.appendChild(option);
                });
                subcategorySelect.disabled = options.length === 0;
                if (state.subcategory && !options.includes(state.subcategory)) {
                  state.subcategory = "";
                }
                if (state.subcategory) {
                  subcategorySelect.value = state.subcategory;
                }
              };

              const toComparable = (value) => {
                if (value === null || value === undefined || value === "") {
                  return { rank: 3, value: "" };
                }
                if (value instanceof Date) {
                  return { rank: 0, value: value.getTime() };
                }
                if (typeof value === "number") {
                  return { rank: 0, value };
                }
                const str = String(value).trim();
                if (!str) return { rank: 3, value: "" };
                const numeric = Number(str.replace(/,/g, ""));
                if (!Number.isNaN(numeric) && str !== "") {
                  return { rank: 0, value: numeric };
                }
                const dateValue = Date.parse(str);
                if (!Number.isNaN(dateValue)) {
                  return { rank: 0, value: dateValue };
                }
                return { rank: 2, value: str.toLowerCase() };
              };

              const updateSortIndicators = () => {
                headerCells.forEach((cell, index) => {
                  cell.classList.toggle(
                    "sorted-asc",
                    state.sortIndex === index && state.sortDir === "asc"
                  );
                  cell.classList.toggle(
                    "sorted-desc",
                    state.sortIndex === index && state.sortDir === "desc"
                  );
                });
              };

              const toggleSort = (index) => {
                if (state.sortIndex === index) {
                  state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
                } else {
                  state.sortIndex = index;
                  state.sortDir = "asc";
                }
                updateSortIndicators();
                applyFilters();
              };
              const selectedCheckboxes = () =>
                tbody.querySelectorAll("input.materials-module__select");

              const renderRows = (entries) => {
                tbody.innerHTML = "";
                countBadge.textContent = ` : ${entries.length}  ${records.length}`;

                if (!entries.length) {
                  const emptyRow = document.createElement("tr");
                  const emptyCell = document.createElement("td");
                  emptyCell.colSpan = headers.length + 2;
                  emptyCell.className = "materials-module__empty";
                  emptyCell.textContent = "     .";
                  emptyRow.appendChild(emptyCell);
                  tbody.appendChild(emptyRow);
                  return;
                }

                entries.forEach((entry) => {
                  const row = document.createElement("tr");
                  row.dataset.materialId = entry.materialId;

                  const selectCell = document.createElement("td");
                  selectCell.className = "materials-module__select-column";
                  const checkbox = document.createElement("input");
                  checkbox.type = "checkbox";
                  checkbox.className = "materials-module__select";
                  checkbox.dataset.materialId = entry.materialId;
                  checkbox.checked = selectedIds.has(entry.materialId);
                  checkbox.addEventListener("change", (event) => {
                    if (event.target.checked) {
                      selectedIds.add(entry.materialId);
                    } else {
                      selectedIds.delete(entry.materialId);
                    }
                    updateBulkActionsVisibility();
                  });
                  selectCell.appendChild(checkbox);
                  row.appendChild(selectCell);

                  headers.forEach((header, index) => {
                    const td = document.createElement("td");
                    const value = entry.record[header];
                    if (index === activeIndex) {
                      const button = document.createElement("button");
                      button.type = "button";
                      button.className =
                        "materials-status-toggle" +
                        (entry.isActive ? " is-active" : "");
                      button.textContent = entry.isActive ? "" : "";
                      button.dataset.materialId = entry.materialId;
                      button.addEventListener("click", () =>
                        handleToggleStatus(entry.materialId, button)
                      );
                      td.appendChild(button);
                    } else if (value === true || value === false) {
                      td.innerHTML = renderBooleanBadge(value);
                    } else if (
                      typeof value === "string" &&
                      /^(true|false|yes|no|y|n|1|0)$/i.test(value.trim())
                    ) {
                      td.innerHTML = renderBooleanBadge(value);
                    } else if (value instanceof Date) {
                      td.textContent = formatDateTime(value);
                    } else if (
                      typeof value === "string" &&
                      /^\d{4}-\d{2}-\d{2}T/.test(value)
                    ) {
                      td.textContent = formatDateTime(value);
                    } else {
                      td.textContent = value == null ? "" : String(value);
                    }
                    row.appendChild(td);
                  });

                  const actionsCell = document.createElement("td");
                  actionsCell.className = "materials-module__actions-column";

                  const createAction = (label, icon, handler) => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "materials-row-action";
                    btn.title = label;
                    const iconSpan = document.createElement("span");
                    iconSpan.className = "materials-row-action__icon";
                    iconSpan.setAttribute("aria-hidden", "true");
                    iconSpan.textContent = icon;
                    const textSpan = document.createElement("span");
                    textSpan.className = "visually-hidden";
                    textSpan.textContent = label;
                    btn.appendChild(iconSpan);
                    btn.appendChild(textSpan);
                    btn.addEventListener("click", handler);
                    return btn;
                  };

                  actionsCell.appendChild(
                    createAction("", "", () => handleEdit(entry))
                  );
                  actionsCell.appendChild(
                    createAction("", "", () => handleArchive(entry))
                  );
                  actionsCell.appendChild(
                    createAction(" ", "", () =>
                      handlePriceAdjust(entry)
                    )
                  );

                  row.appendChild(actionsCell);
                  tbody.appendChild(row);
                });
              };

              const applyFilters = () => {
                const term = state.search.trim().toLowerCase();
                let filtered = records.slice();
                if (state.category) {
                  filtered = filtered.filter(
                    (entry) => entry.category === state.category
                  );
                }
                if (state.subcategory) {
                  filtered = filtered.filter(
                    (entry) => entry.subcategory === state.subcategory
                  );
                }
                if (term) {
                  filtered = filtered.filter((entry) =>
                    entry.searchText.includes(term)
                  );
                }
                if (state.sortIndex >= 0) {
                  const dir = state.sortDir === "asc" ? 1 : -1;
                  const header = headers[state.sortIndex];
                  filtered.sort((a, b) => {
                    const aComparable = toComparable(a.record[header]);
                    const bComparable = toComparable(b.record[header]);
                    if (aComparable.rank !== bComparable.rank) {
                      return (aComparable.rank - bComparable.rank) * dir;
                    }
                    if (aComparable.value === bComparable.value) return 0;
                    return aComparable.value > bComparable.value ? dir : -dir;
                  });
                }
                renderRows(filtered);
                return filtered;
              };
              const handleToggleStatus = (materialId, button) => {
                if (!(window.google && google.script && google.script.run)) {
                  if (typeof showToast === "function") {
                    showToast("    .", "error");
                  }
                  return;
                }
                button.disabled = true;
                google.script.run
                  .withFailureHandler((err) => {
                    console.error("toggleMaterialActiveStatus failed", err);
                    button.disabled = false;
                    if (typeof showToast === "function") {
                      showToast("   .", "error");
                    }
                  })
                  .withSuccessHandler((result) => {
                    button.disabled = false;
                    if (result?.success) {
                      if (typeof showToast === "function") {
                        showToast("    .", "success");
                      }
                      options?.onRefresh?.();
                    } else if (typeof showToast === "function") {
                      showToast(
                        result?.message || "   .",
                        "warning"
                      );
                    }
                  })
                  .toggleMaterialActiveStatus(materialId);
              };

              const handleArchive = (entry) => {
                if (!(window.google && google.script && google.script.run)) {
                  if (typeof showToast === "function") {
                    showToast("    .", "error");
                  }
                  return;
                }
                google.script.run
                  .withFailureHandler((err) => {
                    console.error("archiveMaterial failed", err);
                    if (typeof showToast === "function") {
                      showToast("  .", "error");
                    }
                  })
                  .withSuccessHandler((result) => {
                    if (result?.success) {
                      if (typeof showToast === "function") {
                        showToast("   .", "success");
                      }
                      options?.onRefresh?.();
                    } else if (typeof showToast === "function") {
                      showToast("  .", "warning");
                    }
                  })
                  .archiveMaterial(entry.materialId);
              };

              const handlePriceAdjust = (entry) => {
                const currentPrice =
                  entry.priceValue != null ? String(entry.priceValue) : "";
                const response = window.prompt(
                  "   ",
                  currentPrice
                );
                if (response === null) return;
                const numeric = Number(response);
                if (!Number.isFinite(numeric) || numeric < 0) {
                  if (typeof showToast === "function") {
                    showToast("    .", "warning");
                  }
                  return;
                }
                if (!(window.google && google.script && google.script.run)) {
                  if (typeof showToast === "function") {
                    showToast("    .", "error");
                  }
                  return;
                }
                google.script.run
                  .withFailureHandler((err) => {
                    console.error("updateMaterialPrice failed", err);
                    if (typeof showToast === "function") {
                      showToast("   .", "error");
                    }
                  })
                  .withSuccessHandler((result) => {
                    if (result?.success) {
                      if (typeof showToast === "function") {
                        showToast("    .", "success");
                      }
                      options?.onRefresh?.();
                    } else if (typeof showToast === "function") {
                      showToast("   .", "warning");
                    }
                  })
                  .updateMaterialPrice(entry.materialId, numeric);
              };

              const handleEdit = (entry) => {
                const resolved = (() => {
                  const handler =
                    (typeof window !== "undefined" && window.renderForm) ||
                    (typeof window !== "undefined" &&
                      window.app &&
                      typeof window.app.renderForm === "function" &&
                      window.app.renderForm) ||
                    (typeof window !== "undefined" &&
                      window.forms &&
                      typeof window.forms.renderForm === "function" &&
                      window.forms.renderForm);
                  if (!handler) return null;
                  const context =
                    (typeof window !== "undefined" && window.app) ||
                    (typeof window !== "undefined" && window.forms) ||
                    window;
                  return { handler, context };
                })();

                if (!resolved || !resolved.handler) {
                  if (typeof showToast === "function") {
                    showToast("    .", "warning");
                  }
                  return;
                }

                try {
                  resolved.handler.call(resolved.context, formId, entry.record);
                } catch (err) {
                  console.error("renderForm edit invocation failed", err);
                  if (typeof showToast === "function") {
                    showToast("    .", "error");
                  }
                }
              };

              const performBulkStatusUpdate = (makeActive) => {
                const ids = Array.from(selectedIds);
                if (!ids.length) return;
                if (!(window.google && google.script && google.script.run)) {
                  if (typeof showToast === "function") {
                    showToast("    .", "error");
                  }
                  return;
                }
                google.script.run
                  .withFailureHandler((err) => {
                    console.error("bulkUpdateMaterialStatus failed", err);
                    if (typeof showToast === "function") {
                      showToast("    .", "error");
                    }
                  })
                  .withSuccessHandler((result) => {
                    if (result?.success) {
                      if (typeof showToast === "function") {
                        showToast("    .", "success");
                      }
                      selectedIds.clear();
                      updateBulkActionsVisibility();
                      options?.onRefresh?.();
                    } else if (typeof showToast === "function") {
                      showToast("    .", "warning");
                    }
                  })
                  .bulkUpdateMaterialStatus(ids, makeActive);
              };

              activateSelected.addEventListener("click", () =>
                performBulkStatusUpdate(true)
              );
              deactivateSelected.addEventListener("click", () =>
                performBulkStatusUpdate(false)
              );

              selectAllCheckbox.addEventListener("change", (event) => {
                const shouldSelect = event.target.checked;
                selectedCheckboxes().forEach((input) => {
                  input.checked = shouldSelect;
                  const id = input.dataset.materialId;
                  if (!id) return;
                  if (shouldSelect) {
                    selectedIds.add(id);
                  } else {
                    selectedIds.delete(id);
                  }
                });
                updateBulkActionsVisibility();
              });

              searchInput.addEventListener("input", () => {
                state.search = String(searchInput.value || "");
                applyFilters();
              });

              categorySelect.addEventListener("change", () => {
                state.category = categorySelect.value || "";
                state.subcategory = "";
                populateSubcategories(state.category);
                subcategorySelect.value = "";
                applyFilters();
              });

              subcategorySelect.addEventListener("change", () => {
                state.subcategory = subcategorySelect.value || "";
                applyFilters();
              });

              populateSubcategories("");
              updateSortIndicators();
              applyFilters();
              updateBulkActionsVisibility();
            }

            function renderPaneHeader(paneElement, paneName, options = {}) {
              if (!paneElement) return;

              const formsRegister =
                (bootstrapData && bootstrapData.forms) || Object.create(null);
              const formEntry =
                options.formMeta ||
                resolveFormMetaForPane(
                  paneName,
                  options?.sourceSheet,
                  options?.paneLabel
                ) ||
                null;

              if (window.console) {
                console.log(`[renderPaneHeader] lookup`, {
                  paneName,
                  hasForms: Boolean(formsRegister),
                  availableForms: Object.keys(formsRegister),
                  formEntry,
                  options,
                });
              }

              const formId = formEntry?.formId;
              let header = paneElement.querySelector(".pane-header");
              if (!header) {
                header = document.createElement("div");
                header.className = "pane-header";
                paneElement.prepend(header);
              }

              header.innerHTML = "";
              if (formId) header.dataset.formId = formId;

              const title = document.createElement("div");
              title.className = "pane-header__title";
              title.textContent =
                formEntry?.titleAr || formEntry?.titleEn || " ";
              header.appendChild(title);

              const buttonGroup = document.createElement("div");
              buttonGroup.className = "pane-header__buttons";
              header.appendChild(buttonGroup);

              if (options.enableAttachments) {
                const attachButton = createIconButton("file", {
                  className: "icon-btn",
                  title: " ",
                  ariaLabel: " ",
                });
                if (typeof options.onUpload === "function") {
                  attachButton.addEventListener("click", (event) => {
                    options.onUpload.call(paneElement, event);
                  });
                } else {
                  attachButton.addEventListener("click", () => {
                    showToast("      .", "info");
                  });
                }
                buttonGroup.appendChild(attachButton);
              }

              const refreshButton = createIconButton("refresh", {
                className: "icon-btn",
                title: " ",
                ariaLabel: " ",
              });
              if (typeof options.onRefresh === "function") {
                refreshButton.addEventListener("click", (event) => {
                  options.onRefresh.call(paneElement, event);
                });
              } else {
                refreshButton.disabled = true;
              }
              buttonGroup.appendChild(refreshButton);

              if (formId && options.hideAddButton !== true) {
                const addLabelText =
                  formEntry?.titleAr || formEntry?.titleEn || " ";
                const addButton = createIconButton("add", {
                  className: "icon-btn icon-btn--accent",
                  title: addLabelText,
                  ariaLabel: addLabelText,
                });

                if (typeof options.onAdd === "function") {
                  addButton.addEventListener("click", (event) => {
                    options.onAdd.call(paneElement, event);
                  });
                } else {
                  const renderFormHandler =
                    (typeof window !== "undefined" && window.renderForm) ||
                    (typeof window !== "undefined" &&
                      window.app &&
                      typeof window.app.renderForm === "function" &&
                      window.app.renderForm) ||
                    (typeof window !== "undefined" &&
                      window.forms &&
                      typeof window.forms.renderForm === "function" &&
                      window.forms.renderForm);

                  if (typeof renderFormHandler === "function") {
                    const context =
                      (typeof window !== "undefined" && window.app) ||
                      (typeof window !== "undefined" && window.forms) ||
                      window;
                    addButton.addEventListener("click", () => {
                      if (window.console) {
                        console.log("[renderPaneHeader] Add New button clicked", {
                          paneName,
                          formId,
                        });
                      }
                      renderFormHandler.call(context, formId, null);
                    });
                  } else {
                    addButton.addEventListener("click", () => {
                      console.warn("renderForm handler is not available", {
                        formId,
                        windowHasRenderForm:
                          typeof window !== "undefined" &&
                          typeof window.renderForm === "function",
                      });
                      showToast("    .", "warning");
                    });
                  }
                }

                buttonGroup.appendChild(addButton);
              }
            }

            function loadDirectExpenseViewData(container, options = {}) {
              if (!container) return;
              const {
                reload = false,
                onComplete,
                silent = false,
                controlsRow,
                onSwitchMode,
              } = options;
              const alreadyLoaded = container.dataset.viewLoaded === "true";
              if (alreadyLoaded && !reload) {
                if (typeof onComplete === "function") onComplete();
                return;
              }

              container.dataset.viewLoaded = "false";
              if (!silent) {
                container.innerHTML =
                  '<p class="muted">    ...</p>';
              }
              if (controlsRow) {
                controlsRow.innerHTML = "";
              }

              if (!(window.google && google.script && google.script.run)) {
                container.innerHTML =
                  '<p class="error-text"> Google Apps Script  .</p>';
                if (typeof onComplete === "function") onComplete();
                return;
              }

              google.script.run
                .withFailureHandler((err) => {
                  console.error("getDirectExpenseViewData failed", err);
                  container.innerHTML =
                    '<p class="error-text">  .</p>';
                  if (typeof showToast === "function") {
                    showToast("  .", "error");
                  }
                  if (typeof onComplete === "function") onComplete(err);
                })
                .withSuccessHandler((result) => {
                  container.dataset.viewLoaded = "true";
                  renderDirectExpenseTable(container, result, {
                    controlsRow,
                    onSwitchMode,
                    onRefresh: () =>
                      loadDirectExpenseViewData(container, {
                        reload: true,
                        silent: false,
                        controlsRow,
                        onSwitchMode,
                      }),
                  });
                  if (typeof onComplete === "function") onComplete(result);
                })
                .getDirectExpenseViewData();
            }

            function renderDirectExpenseTable(container, data, options = {}) {
              if (!container) return;

              const normalized = (() => {
                if (!data || typeof data !== "object" || Array.isArray(data)) {
                  return { headers: [], rows: [] };
                }
                if (Array.isArray(data.headers) && Array.isArray(data.rows)) {
                  return data;
                }
                if (data.data && typeof data.data === "object") {
                  return data.data;
                }
                if (Array.isArray(data.items)) {
                  return {
                    headers: Array.isArray(data.headers) ? data.headers : [],
                    rows: data.items,
                  };
                }
                return data;
              })();

              const headers = Array.isArray(normalized?.headers)
                ? normalized.headers
                : [];
              const rows = Array.isArray(normalized?.rows)
                ? normalized.rows
                : Array.isArray(normalized?.items)
                ? normalized.items
                : [];

              container.innerHTML = "";

              if (!headers.length) {
                const empty = document.createElement("p");
                empty.className = "direct-expense__empty";
                empty.textContent = "    .";
                container.appendChild(empty);
                return;
              }

              const resolveExpenseIdentifier = (record, fallbackIndex) => {
                if (!record || typeof record !== "object") {
                  return String(fallbackIndex);
                }
                const normalized = Object.keys(record).reduce((acc, key) => {
                  acc[
                    String(key || "")
                      .trim()
                      .toLowerCase()
                  ] = record[key];
                  return acc;
                }, {});
                const candidates = [
                  "expense_id",
                  "expenseid",
                  "directexpense_id",
                  "direct_expense_id",
                  "direct expense id",
                  "id",
                  "record_id",
                  "expense code",
                  "view_id",
                  "viewid",
                  "_",
                  "",
                ];
                for (const key of candidates) {
                  if (Object.prototype.hasOwnProperty.call(normalized, key)) {
                    const value = normalized[key];
                    if (
                      value !== undefined &&
                      value !== null &&
                      String(value).trim() !== ""
                    ) {
                      return value;
                    }
                  }
                }
                return String(fallbackIndex);
              };

              const currencyColumns = headers.map((header) =>
                /amount|total|price|cost|vat|||||/i.test(
                  String(header || "")
                )
              );

              const records = rows.map((row, index) => {
                const record = {};
                headers.forEach((header, columnIndex) => {
                  record[header] = row[columnIndex];
                });
                const identifier = resolveExpenseIdentifier(record, index);
                const searchText = Object.values(record)
                  .concat(identifier)
                  .filter((value) => value !== undefined && value !== null)
                  .map((value) => String(value).toLowerCase())
                  .join(" ");
                return { record, identifier, index, searchText };
              });

              const totalRecords = records.length;
              const state = { search: "", sortIndex: -1, sortDir: "asc" };

              const providedControlsRow = options?.controlsRow || null;
              const controlsHost = providedControlsRow
                ? providedControlsRow
                : (() => {
                    const fallback = document.createElement("div");
                    fallback.className = "module-controls direct-expense__controls";
                    const primary = document.createElement("div");
                    primary.className =
                      "module-controls__row module-controls__primary";
                    fallback.appendChild(primary);
                    const secondary = document.createElement("div");
                    secondary.className =
                      "module-controls__row module-controls__secondary";
                    fallback.appendChild(secondary);
                    container.appendChild(fallback);
                    if (typeof options.onSwitchMode === "function") {
                      const switcher = document.createElement("div");
                      switcher.className = "pane-mode-switch";
                      primary.appendChild(switcher);
                      const viewBtn = document.createElement("button");
                      viewBtn.type = "button";
                      viewBtn.className = "pane-mode-button is-active";
                      setButtonIconLabel(viewBtn, "view", " ");
                      viewBtn.addEventListener("click", () =>
                        options.onSwitchMode("view")
                      );
                      switcher.appendChild(viewBtn);
                      const addBtn = document.createElement("button");
                      addBtn.type = "button";
                      addBtn.className = "pane-mode-button";
                      setButtonIconLabel(addBtn, "add", " ");
                      addBtn.addEventListener("click", () =>
                        options.onSwitchMode("add")
                      );
                      switcher.appendChild(addBtn);
                    }
                    return secondary;
                  })();

              const controlsRowEl = controlsHost;
              const controls = document.createElement("div");
              controls.className = "direct-expense__view-controls";
              controlsRowEl.appendChild(controls);

              const searchInput = document.createElement("input");
              searchInput.type = "search";
              searchInput.placeholder = "  ...";
              controls.appendChild(searchInput);

              const refreshButton = document.createElement("button");
              refreshButton.type = "button";
              refreshButton.className = "ghost-button ghost-button--sm";
              refreshButton.textContent = "";
              refreshButton.addEventListener("click", () => {
                if (typeof options.onRefresh === "function") {
                  options.onRefresh();
                } else {
                  loadDirectExpenseViewData(container, {
                    reload: true,
                    controlsRow: controlsRowEl,
                    onSwitchMode: options.onSwitchMode,
                  });
                }
              });
              controls.appendChild(refreshButton);

              const countBadge = document.createElement("span");
              countBadge.className = "muted";
              controls.appendChild(countBadge);

              const table = document.createElement("table");
              table.className = "sys-table direct-expense__table";

              const tableWrapper = document.createElement("div");
              tableWrapper.className = "direct-expense__table-wrapper";
              tableWrapper.appendChild(table);

              const thead = document.createElement("thead");
              const headerRow = document.createElement("tr");
              const headerCells = [];

              const updateSortIndicators = () => {
                headerCells.forEach((cell, index) => {
                  cell.classList.toggle(
                    "sorted-asc",
                    state.sortIndex === index && state.sortDir === "asc"
                  );
                  cell.classList.toggle(
                    "sorted-desc",
                    state.sortIndex === index && state.sortDir === "desc"
                  );
                });
              };

              const toggleSort = (index) => {
                if (state.sortIndex === index) {
                  state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
                } else {
                  state.sortIndex = index;
                  state.sortDir = "asc";
                }
                updateSortIndicators();
                applyFilters();
              };

              headers.forEach((header, headerIndex) => {
                const th = document.createElement("th");
                th.textContent = header;
                th.tabIndex = 0;
                th.addEventListener("click", () => toggleSort(headerIndex));
                th.addEventListener("keypress", (event) => {
                  if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault();
                    toggleSort(headerIndex);
                  }
                });
                headerCells.push(th);
                headerRow.appendChild(th);
              });
              thead.appendChild(headerRow);
              table.appendChild(thead);

              const tbody = document.createElement("tbody");
              table.appendChild(tbody);
              container.appendChild(tableWrapper);

              const updateCount = (visibleCount) => {
                countBadge.textContent = ` : ${visibleCount}  ${totalRecords}`;
              };

              const toComparable = (value) => {
                if (value === null || value === undefined || value === "") {
                  return { rank: 3, value: "" };
                }
                if (value instanceof Date) {
                  return { rank: 0, value: value.getTime() };
                }
                if (typeof value === "number") {
                  return { rank: 0, value };
                }
                if (typeof value === "boolean") {
                  return { rank: 1, value: value ? 1 : 0 };
                }
                const str = String(value).trim();
                if (!str) return { rank: 3, value: "" };
                const numeric = Number(str.replace(/,/g, ""));
                if (!Number.isNaN(numeric) && str !== "") {
                  return { rank: 0, value: numeric };
                }
                const dateValue = Date.parse(str);
                if (!Number.isNaN(dateValue)) {
                  return { rank: 0, value: dateValue };
                }
                return { rank: 2, value: str.toLowerCase() };
              };

              const renderRows = (entries) => {
                tbody.innerHTML = "";
                updateCount(entries.length);

                if (!entries.length) {
                  const emptyRow = document.createElement("tr");
                  const emptyCell = document.createElement("td");
                  emptyCell.colSpan = headers.length;
                  emptyCell.className = "direct-expense__empty";
                  emptyCell.textContent = "   .";
                  emptyRow.appendChild(emptyCell);
                  tbody.appendChild(emptyRow);
                  return;
                }

                entries.forEach((entry) => {
                  const row = document.createElement("tr");
                  row.dataset.expenseId =
                    entry.identifier != null ? String(entry.identifier) : "";

                  headers.forEach((header, index) => {
                    const td = document.createElement("td");
                    const value = entry.record[header];
                    if (value === true || value === false) {
                      td.innerHTML = renderBooleanBadge(value);
                    } else if (
                      typeof value === "string" &&
                      /^(true|false|yes|no|y|n|1|0)$/i.test(value.trim())
                    ) {
                      td.innerHTML = renderBooleanBadge(value);
                    } else if (value instanceof Date) {
                      td.textContent = formatDateTime(value);
                    } else if (
                      typeof value === "string" &&
                      /^\d{4}-\d{2}-\d{2}T/.test(value)
                    ) {
                      td.textContent = formatDateTime(value);
                    } else if (currencyColumns[index]) {
                      const numericValue = Number(value);
                      td.textContent = Number.isFinite(numericValue)
                        ? formatCurrencyValue(numericValue)
                        : String(value ?? "");
                    } else {
                      td.textContent = value == null ? "" : String(value);
                    }
                    row.appendChild(td);
                  });

                  row.addEventListener("click", () =>
                    showExpenseDetailsPopup(entry.identifier, entry.record)
                  );
                  tbody.appendChild(row);
                });
              };

              const applyFilters = () => {
                const term = state.search.trim().toLowerCase();
                let filtered = records.slice();
                if (term) {
                  filtered = filtered.filter((entry) =>
                    entry.searchText.includes(term)
                  );
                }
                if (state.sortIndex >= 0) {
                  const dir = state.sortDir === "asc" ? 1 : -1;
                  const header = headers[state.sortIndex];
                  filtered.sort((a, b) => {
                    const aComparable = toComparable(a.record[header]);
                    const bComparable = toComparable(b.record[header]);
                    if (aComparable.rank !== bComparable.rank) {
                      return (aComparable.rank - bComparable.rank) * dir;
                    }
                    if (aComparable.value === bComparable.value) return 0;
                    return aComparable.value > bComparable.value ? dir : -dir;
                  });
                }
                renderRows(filtered);
                return filtered;
              };

              searchInput.addEventListener("input", () => {
                state.search = String(searchInput.value || "");
                applyFilters();
              });

              updateSortIndicators();
              applyFilters();
            }

            function showExpenseDetailsPopup(expenseId, fallbackRecord) {
              const existing = document.querySelector(
                ".direct-expense__modal-overlay"
              );
              if (existing && existing.parentElement) {
                existing.parentElement.removeChild(existing);
              }

              const overlay = document.createElement("div");
              overlay.className = "direct-expense__modal-overlay";
              const dialog = document.createElement("div");
              dialog.className = "direct-expense__modal";
              overlay.appendChild(dialog);

              const header = document.createElement("div");
              header.className = "direct-expense__modal-header";
              const title = document.createElement("h3");
              title.textContent = " ";
              header.appendChild(title);
              const closeButton = document.createElement("button");
              closeButton.type = "button";
              closeButton.className = "ghost-button ghost-button--sm";
              closeButton.textContent = "";
              header.appendChild(closeButton);
              dialog.appendChild(header);

              const body = document.createElement("div");
              body.className = "direct-expense__modal-body";
              const status = document.createElement("p");
              status.className = "muted";
              status.textContent = "  ...";
              body.appendChild(status);
              dialog.appendChild(body);

              const handleClose = () => {
                document.removeEventListener("keydown", handleKeydown);
                if (overlay.parentElement) {
                  overlay.parentElement.removeChild(overlay);
                }
              };

              const handleKeydown = (event) => {
                if (event.key === "Escape") {
                  event.preventDefault();
                  handleClose();
                }
              };

              closeButton.addEventListener("click", handleClose);
              overlay.addEventListener("click", (event) => {
                if (event.target === overlay) {
                  handleClose();
                }
              });
              document.addEventListener("keydown", handleKeydown);

              document.body.appendChild(overlay);

              if (!(window.google && google.script && google.script.run)) {
                status.textContent = " Google Apps Script  .";
                return;
              }

              const targetId =
                expenseId != null && expenseId !== ""
                  ? expenseId
                  : fallbackRecord && typeof fallbackRecord === "object"
                  ? fallbackRecord.Expense_ID || fallbackRecord.ID || ""
                  : "";

              const renderExpenseDetails = (
                detailsResult,
                attachments,
                resolvedId,
                fallback
              ) => {
                body.innerHTML = "";

                const records = Array.isArray(detailsResult?.details)
                  ? detailsResult.details
                  : [];
                const headers = Array.isArray(detailsResult?.headers)
                  ? detailsResult.headers
                  : [];
                const primaryRecord =
                  (records.length && records[0]) ||
                  (fallback && typeof fallback === "object" ? fallback : {});

                const resolveValue = (record, candidates) => {
                  if (!record || typeof record !== "object") return "";
                  for (const candidate of candidates) {
                    const key = String(candidate || "").trim();
                    if (key && key in record && record[key] !== undefined) {
                      return record[key];
                    }
                    const lowerKey = key.toLowerCase();
                    const match = Object.keys(record).find(
                      (rk) => rk && String(rk).toLowerCase() === lowerKey
                    );
                    if (match && record[match] !== undefined) {
                      return record[match];
                    }
                  }
                  return "";
                };

                const metaFields = [
                  {
                    label: " ",
                    keys: ["Expense_ID", "ExpenseId", "ID", "Record_ID"],
                  },
                  {
                    label: "",
                    keys: [
                      "Project_Name",
                      "Project",
                      "Project_ID",
                      "ProjectId",
                      "Project Code",
                    ],
                  },
                  {
                    label: "",
                    keys: ["Date", "Transaction_Date", "Posting_Date"],
                  },
                  {
                    label: " ",
                    keys: [
                      "Payment_Method",
                      "Pay_Method",
                      "PaymentMethod",
                      "Method",
                    ],
                  },
                  {
                    label: " ",
                    keys: ["Payment_Status", "Pay_Status", "Status"],
                  },
                  { label: "", keys: ["Notes", "Note", "Remarks"] },
                ];

                const metaList = document.createElement("dl");
                metaList.className = "direct-expense__modal-grid";
                metaFields.forEach(({ label, keys }) => {
                  const value = resolveValue(primaryRecord, keys);
                  if (value === undefined || value === null || value === "") return;
                  const dt = document.createElement("dt");
                  dt.textContent = label;
                  const dd = document.createElement("dd");
                  const normalizedKeys = keys.map((k) =>
                    String(k || "").toLowerCase()
                  );
                  if (normalizedKeys.some((k) => k.includes("date"))) {
                    dd.textContent = formatDateTime(value);
                  } else {
                    dd.textContent = String(value);
                  }
                  metaList.appendChild(dt);
                  metaList.appendChild(dd);
                });
                if (metaList.children.length) {
                  body.appendChild(metaList);
                }

                if (records.length) {
                  const itemsTable = document.createElement("table");
                  itemsTable.className = "sys-table direct-expense__table";
                  const itemsWrapper = document.createElement("div");
                  itemsWrapper.className = "direct-expense__table-wrapper";
                  const itemsHead = document.createElement("thead");
                  const headRow = document.createElement("tr");
                  const itemColumns = [
                    {
                      label: "",
                      keys: ["Material_Name", "Material", "Item_Name"],
                    },
                    { label: "", keys: ["Unit", "Default_Unit"] },
                    { label: "", keys: ["Qty", "Quantity"] },
                    { label: "", keys: ["Unit_Price", "Price"] },
                    { label: "", keys: ["Amount", "Line_Amount"] },
                    { label: "", keys: ["VAT_Amount", "Tax_Amount"] },
                    {
                      label: "  ",
                      keys: ["Total_With_VAT", "TotalWithVat", "Total"],
                    },
                  ];
                  itemColumns.forEach((column) => {
                    const th = document.createElement("th");
                    th.textContent = column.label;
                    headRow.appendChild(th);
                  });
                  itemsHead.appendChild(headRow);
                  itemsTable.appendChild(itemsHead);
                  const itemsBody = document.createElement("tbody");
                  itemsTable.appendChild(itemsBody);

                  records.forEach((record) => {
                    const row = document.createElement("tr");
                    itemColumns.forEach((column, columnIndex) => {
                      const td = document.createElement("td");
                      const rawValue = resolveValue(record, column.keys);
                      if (
                        rawValue === undefined ||
                        rawValue === null ||
                        rawValue === ""
                      ) {
                        td.textContent = "";
                      } else if (column.label.includes("")) {
                        td.textContent = formatDateTime(rawValue);
                      } else if (
                        column.label.includes("") ||
                        columnIndex >= 3
                      ) {
                        const numeric = Number(rawValue);
                        td.textContent = Number.isFinite(numeric)
                          ? formatCurrencyValue(numeric)
                          : String(rawValue);
                      } else if (column.label.includes("")) {
                        const numeric = Number(rawValue);
                        td.textContent = Number.isFinite(numeric)
                          ? numeric.toLocaleString("ar-EG", {
                              maximumFractionDigits: 2,
                            })
                          : String(rawValue);
                      } else {
                        td.textContent = String(rawValue);
                      }
                      row.appendChild(td);
                    });
                    itemsBody.appendChild(row);
                  });

                  itemsWrapper.appendChild(itemsTable);
                  body.appendChild(itemsWrapper);
                } else {
                  const noDetails = document.createElement("p");
                  noDetails.className = "direct-expense__empty";
                  noDetails.textContent = "     .";
                  body.appendChild(noDetails);
                }

                const attachmentsSection = document.createElement("div");
                attachmentsSection.className = "direct-expense__attachments-block";
                const attachmentsHeader = document.createElement("h4");
                attachmentsHeader.textContent = "";
                attachmentsSection.appendChild(attachmentsHeader);

                const attachmentList = document.createElement("ul");
                attachmentList.className = "direct-expense__attachment-list";

                if (attachments && attachments.length) {
                  attachments.forEach((attachment) => {
                    const item = document.createElement("li");
                    const link = document.createElement("a");
                    const url =
                      attachment?.Drive_URL ||
                      attachment?.URL ||
                      attachment?.Link ||
                      "";
                    const label =
                      attachment?.Label ||
                      attachment?.File_Name ||
                      attachment?.Name ||
                      "";

                    link.textContent = label;
                    if (url) {
                      link.href = url;
                      link.target = "_blank";
                      link.rel = "noopener";
                    } else {
                      link.href = "#";
                      link.addEventListener("click", (event) =>
                        event.preventDefault()
                      );
                    }
                    item.appendChild(link);
                    attachmentList.appendChild(item);
                  });
                  attachmentsSection.appendChild(attachmentList);
                } else {
                  const emptyAttachments = document.createElement("p");
                  emptyAttachments.className = "direct-expense__empty";
                  emptyAttachments.textContent =
                    "     .";
                  attachmentsSection.appendChild(emptyAttachments);
                }

                body.appendChild(attachmentsSection);

                if (resolvedId) {
                  title.textContent = `  (${resolvedId})`;
                }
              };

              google.script.run
                .withFailureHandler((err) => {
                  console.error("getDirectExpenseDetailsById failed", err);
                  status.textContent = "   .";
                  if (typeof showToast === "function") {
                    showToast("   .", "error");
                  }
                })
                .withSuccessHandler((details) => {
                  const resolvedId =
                    (details && details.expenseId) ||
                    targetId ||
                    (fallbackRecord && fallbackRecord.Expense_ID) ||
                    "";

                  const renderWithAttachments = (attachments) => {
                    renderExpenseDetails(
                      details,
                      attachments,
                      resolvedId,
                      fallbackRecord
                    );
                  };

                  if (resolvedId) {
                    google.script.run
                      .withFailureHandler((err) => {
                        console.error("getAttachmentsForEntity failed", err);
                        renderWithAttachments([]);
                      })
                      .withSuccessHandler((attachments) => {
                        renderWithAttachments(
                          Array.isArray(attachments) ? attachments : []
                        );
                      })
                      .getAttachmentsForEntity(resolvedId, "DirectExpense");
                  } else {
                    renderWithAttachments([]);
                  }
                })
                .getDirectExpenseDetailsById(targetId || "");
            }
            function renderDirectExpenseForm(paneElement, options = {}) {
              if (!paneElement) return;
              paneElement.innerHTML = "";
              const { onSaved } = options || {};

              let cart = [];
              let materialsCatalog = [];
              let materialsCatalogLoaded = false;
              let attachments = [];
              let selectedCategory = "";
              let selectedSubcategory = "";
              let isVatEnabled = false;

              const VAT_RATE = 0.14;

              const headerSection = document.createElement("div");
              headerSection.className = "direct-expense__header";

              const projectField = document.createElement("div");
              projectField.className = "direct-expense__field";
              const projectLabel = document.createElement("label");
              projectLabel.setAttribute("for", "de-project-select");
              projectLabel.textContent = "";
              const projectSelect = document.createElement("select");
              projectSelect.id = "de-project-select";
              const defaultProjectOption = document.createElement("option");
              defaultProjectOption.value = "";
              defaultProjectOption.textContent = " ";
              projectSelect.appendChild(defaultProjectOption);
              projectField.appendChild(projectLabel);
              projectField.appendChild(projectSelect);

              const dateField = document.createElement("div");
              dateField.className = "direct-expense__field";
              const dateLabel = document.createElement("label");
              dateLabel.setAttribute("for", "de-date-input");
              dateLabel.textContent = "";
              const dateInput = document.createElement("input");
              dateInput.type = "date";
              dateInput.id = "de-date-input";
              dateField.appendChild(dateLabel);
              dateField.appendChild(dateInput);

              headerSection.appendChild(projectField);
              headerSection.appendChild(dateField);

              const dropdowns =
                (typeof bootstrapData === "object" && bootstrapData?.dropdowns) ||
                {};
              const paymentMethodOptions = Array.isArray(dropdowns.paymentMethod)
                ? dropdowns.paymentMethod
                : [];
              const paymentStatusOptions = Array.isArray(dropdowns.paymentStatus)
                ? dropdowns.paymentStatus
                : [];

              const metaSection = document.createElement("div");
              metaSection.className = "direct-expense__meta";

              const paymentMethodField = document.createElement("div");
              paymentMethodField.className = "direct-expense__field";
              const paymentMethodLabel = document.createElement("label");
              paymentMethodLabel.setAttribute("for", "de-payment-method");
              paymentMethodLabel.textContent = " ";
              const paymentMethodSelect = document.createElement("select");
              paymentMethodSelect.id = "de-payment-method";
              const paymentMethodDefault = document.createElement("option");
              paymentMethodDefault.value = "";
              paymentMethodDefault.textContent = "  ";
              paymentMethodSelect.appendChild(paymentMethodDefault);
              paymentMethodOptions.forEach((option) => {
                const opt = document.createElement("option");
                opt.value = option?.value ?? option?.label ?? "";
                opt.textContent = option?.label ?? option?.value ?? "";
                paymentMethodSelect.appendChild(opt);
              });
              paymentMethodField.appendChild(paymentMethodLabel);
              paymentMethodField.appendChild(paymentMethodSelect);
              headerSection.appendChild(paymentMethodField);

              const paymentStatusField = document.createElement("div");
              paymentStatusField.className = "direct-expense__field";
              const paymentStatusLabel = document.createElement("label");
              paymentStatusLabel.setAttribute("for", "de-payment-status");
              paymentStatusLabel.textContent = " ";
              const paymentStatusSelect = document.createElement("select");
              paymentStatusSelect.id = "de-payment-status";
              const paymentStatusDefault = document.createElement("option");
              paymentStatusDefault.value = "";
              paymentStatusDefault.textContent = "  ";
              paymentStatusSelect.appendChild(paymentStatusDefault);
              paymentStatusOptions.forEach((option) => {
                const opt = document.createElement("option");
                opt.value = option?.value ?? option?.label ?? "";
                opt.textContent = option?.label ?? option?.value ?? "";
                paymentStatusSelect.appendChild(opt);
              });
              paymentStatusField.appendChild(paymentStatusLabel);
              paymentStatusField.appendChild(paymentStatusSelect);
              headerSection.appendChild(paymentStatusField);

              paneElement.appendChild(headerSection);

              const notesField = document.createElement("div");
              notesField.className =
                "direct-expense__field direct-expense__field--wide";
              const notesLabel = document.createElement("label");
              notesLabel.setAttribute("for", "de-notes");
              notesLabel.textContent = "";
              const notesInput = document.createElement("textarea");
              notesInput.id = "de-notes";
              notesInput.rows = 3;
              notesField.appendChild(notesLabel);
              notesField.appendChild(notesInput);

              const attachmentsField = document.createElement("div");
              attachmentsField.className =
                "direct-expense__field direct-expense__field--attachments";
              const attachmentsLabel = document.createElement("label");
              attachmentsLabel.setAttribute("for", "de-attachments");
              attachmentsLabel.textContent = "";
              const attachmentsControls = document.createElement("div");
              attachmentsControls.className = "direct-expense__attachments";
              const attachmentsInput = document.createElement("input");
              attachmentsInput.type = "file";
              attachmentsInput.id = "de-attachments";
              attachmentsInput.multiple = true;
              attachmentsInput.className = "direct-expense__file-input";
              attachmentsInput.style.display = "none";
              const attachmentsButton = document.createElement("label");
              attachmentsButton.className =
                "accent-button direct-expense__attachments-btn";
              attachmentsButton.setAttribute("for", "de-attachments");
              attachmentsButton.textContent = " ";
              attachmentsControls.appendChild(attachmentsInput);
              attachmentsControls.appendChild(attachmentsButton);
              const attachmentList = document.createElement("div");
              attachmentList.id = "de-attachment-list";
              attachmentList.className = "direct-expense__attachment-list";
              attachmentsField.appendChild(attachmentsLabel);
              attachmentsField.appendChild(attachmentsControls);
              attachmentsField.appendChild(attachmentList);

              metaSection.appendChild(notesField);
              metaSection.appendChild(attachmentsField);
              paneElement.appendChild(metaSection);

              const mainSection = document.createElement("div");
              mainSection.className = "direct-expense__main";

              const catalogContainer = document.createElement("div");
              catalogContainer.className = "direct-expense__catalog";
              const catalogTitle = document.createElement("h3");
              catalogTitle.textContent = " ";
              const filtersWrapper = document.createElement("div");
              filtersWrapper.className = "direct-expense__filters";
              const searchInput = document.createElement("input");
              searchInput.type = "search";
              searchInput.id = "material-search";
              searchInput.placeholder = "  ...";
              filtersWrapper.appendChild(searchInput);

              const categorySelect = document.createElement("select");
              categorySelect.id = "de-category-select";
              categorySelect.disabled = true;
              const categoryDefault = document.createElement("option");
              categoryDefault.value = "";
              categoryDefault.textContent = " ";
              categorySelect.appendChild(categoryDefault);
              filtersWrapper.appendChild(categorySelect);

              const subcategorySelect = document.createElement("select");
              subcategorySelect.id = "de-subcategory-select";
              subcategorySelect.disabled = true;
              const subcategoryDefault = document.createElement("option");
              subcategoryDefault.value = "";
              subcategoryDefault.textContent = "  ";
              subcategorySelect.appendChild(subcategoryDefault);
              filtersWrapper.appendChild(subcategorySelect);
              const materialsList = document.createElement("div");
              materialsList.id = "materials-list";
              materialsList.className = "direct-expense__materials-list";
              materialsList.innerHTML =
                '<p class="muted">   ...</p>';
              catalogContainer.appendChild(catalogTitle);
              catalogContainer.appendChild(filtersWrapper);
              catalogContainer.appendChild(materialsList);

              const cartContainer = document.createElement("div");
              cartContainer.className = "direct-expense__cart";
              const cartTitle = document.createElement("h3");
              cartTitle.textContent = " ";
              const cartItemsContainer = document.createElement("div");
              cartItemsContainer.className = "direct-expense__cart-items";
              const cartTotals = document.createElement("div");
              cartTotals.id = "cart-totals";
              cartTotals.className = "direct-expense__totals";
              // Live totals updater (no full re-render)
              function updateCartTotalsOnly() {
                try {
                  const totalsBox = document.getElementById("cart-totals");
                  if (!totalsBox) return;
                  const strongs = totalsBox.querySelectorAll(
                    ".direct-expense__totals-row strong"
                  );
                  if (strongs.length !== 3) return;
                  let subtotal = 0,
                    vatTotal = 0,
                    grandTotal = 0;
                  const defaultRate =
                    Number(typeof VAT_RATE !== "undefined" ? VAT_RATE : 0.14) ||
                    0.14;
                  (cart || []).forEach((item) => {
                    const quantity = Number(item?.quantity) || 0;
                    const price = Number(item?.price ?? item?.unitPrice) || 0;
                    const amount = quantity * price;
                    const vatRate = item?.vatApplied
                      ? Number(item?.vatRate ?? item?.baseVatRate ?? defaultRate)
                      : 0;
                    const vat = item?.vatApplied ? amount * vatRate : 0;
                    subtotal += amount;
                    vatTotal += vat;
                    grandTotal += amount + vat;
                  });
                  strongs[0].textContent = formatCurrencyValue(subtotal);
                  strongs[1].textContent = formatCurrencyValue(vatTotal);
                  strongs[2].textContent = formatCurrencyValue(grandTotal);
                } catch (e) {
                  console.warn("[updateCartTotalsOnly] failed", e);
                }
              }

              const vatToggleWrapper = document.createElement("label");
              vatToggleWrapper.className = "direct-expense__vat-toggle";
              vatToggleWrapper.setAttribute("for", "de-vat-toggle");
              const vatToggle = document.createElement("input");
              vatToggle.type = "checkbox";
              vatToggle.id = "de-vat-toggle";
              vatToggleWrapper.appendChild(vatToggle);
              const vatToggleText = document.createElement("span");
              vatToggleText.textContent =
                "    (Include VAT)";
              vatToggleWrapper.appendChild(vatToggleText);

              cartContainer.appendChild(cartTitle);
              cartContainer.appendChild(cartItemsContainer);
              cartContainer.appendChild(cartTotals);

              mainSection.appendChild(catalogContainer);
              mainSection.appendChild(cartContainer);
              paneElement.appendChild(mainSection);

              const footerSection = document.createElement("div");
              footerSection.className = "direct-expense__footer";

              const submitButton = document.createElement("button");
              submitButton.type = "button";
              submitButton.id = "submit-cart-btn";
              submitButton.className = "accent-button";
              submitButton.textContent = " ";
              footerSection.appendChild(submitButton);
              paneElement.appendChild(footerSection);

              const normalizeId = (material) =>
                material?.Material_ID ||
                material?.MaterialId ||
                material?.materialId ||
                material?.ID ||
                material?.id ||
                "";

              const toDecimalRate = (rate) => {
                let value = Number(rate);
                if (!Number.isFinite(value)) return null;
                if (value > 1) {
                  value = value / 100;
                }
                if (value < 0) {
                  return 0;
                }
                return value;
              };

              const formatFileSize = (bytes) => {
                const size = Number(bytes);
                if (!Number.isFinite(size) || size <= 0) {
                  return "";
                }
                const units = ["", ".", ".", "."];
                const exponent = Math.min(
                  units.length - 1,
                  Math.floor(Math.log(size) / Math.log(1024))
                );
                const value = size / Math.pow(1024, exponent);
                const formatted = value >= 10 ? value.toFixed(0) : value.toFixed(1);
                return `${formatted} ${units[exponent]}`;
              };

              const hydrateMaterial = (material) => {
                if (Array.isArray(material)) {
                  const [
                    materialId,
                    nameAr,
                    nameEn,
                    category,
                    subcategory,
                    defaultUnit,
                    defaultPrice,
                    vatRate,
                  ] = material;
                  return {
                    Material_ID: materialId,
                    Name_AR: nameAr || nameEn || materialId,
                    Name_EN: nameEn || nameAr || materialId,
                    Category: category || "",
                    Subcategory: subcategory || "",
                    Default_Unit: defaultUnit || "",
                    Default_Price: Number(defaultPrice) || 0,
                    VAT_Rate: toDecimalRate(vatRate) ?? VAT_RATE,
                  };
                }
                const hydratedId = normalizeId(material);
                const decimalRate = toDecimalRate(
                  material?.VAT_Rate ??
                    material?.Default_VAT ??
                    material?.vatRate ??
                    material?.VatRate
                );
                return {
                  Material_ID: hydratedId,
                  Name_AR:
                    material?.Name_AR ||
                    material?.Material_Name_AR ||
                    material?.Material_Name ||
                    material?.Name ||
                    hydratedId,
                  Name_EN:
                    material?.Name_EN ||
                    material?.Material_Name_EN ||
                    material?.MaterialName ||
                    material?.Name ||
                    hydratedId,
                  Category:
                    material?.Category ||
                    material?.Category_Name ||
                    material?.Material_Category ||
                    "",
                  Subcategory:
                    material?.Subcategory ||
                    material?.Sub_Category ||
                    material?.Material_Subcategory ||
                    "",
                  Default_Unit:
                    material?.Default_Unit ||
                    material?.Unit ||
                    material?.Unit_Name ||
                    "",
                  Default_Price:
                    Number(
                      material?.Default_Price ??
                        material?.Unit_Price ??
                        material?.UnitPrice ??
                        material?.Price
                    ) || 0,
                  VAT_Rate: decimalRate ?? VAT_RATE,
                };
              };

              function populateMaterialsList(materials) {
                materialsList.innerHTML = "";
                const list = Array.isArray(materials)
                  ? materials.map(hydrateMaterial)
                  : [];

                if (!list.length) {
                  const empty = document.createElement("p");
                  empty.className = "direct-expense__empty";
                  empty.textContent = "   .";
                  materialsList.appendChild(empty);
                  return;
                }

                list.forEach((material) => {
                  const materialId = normalizeId(material);
                  const displayName =
                    material?.Name_AR || material?.Name_EN || materialId || "";
                  const card = document.createElement("div");
                  card.className = "direct-expense__material-card";
                  card.tabIndex = 0;
                  card.setAttribute("role", "button");
                  card.setAttribute(
                    "aria-label",
                    `  ${displayName || ""}`
                  );

                  const idBadge = document.createElement("span");
                  idBadge.className = "direct-expense__material-id";
                  idBadge.textContent = materialId ? `#${materialId}` : "";
                  card.appendChild(idBadge);

                  const title = document.createElement("strong");
                  title.className = "direct-expense__material-name";
                  title.textContent = displayName || "";
                  card.appendChild(title);

                  const unitPrice =
                    Number(
                      material?.Default_Price ||
                        material?.Unit_Price ||
                        material?.UnitPrice ||
                        0
                    ) || 0;
                  const priceSpan = document.createElement("span");
                  priceSpan.className = "direct-expense__material-price";
                  priceSpan.textContent = `: ${formatCurrencyValue(
                    unitPrice
                  )}`;
                  card.appendChild(priceSpan);

                  const triggerAddToCart = () => {
                    if (!materialId) {
                      if (typeof showToast === "function") {
                        showToast("      .", "warning");
                      }
                      return;
                    }
                    addToCart(materialId);
                  };
                  card.addEventListener("click", triggerAddToCart);
                  card.addEventListener("keydown", (event) => {
                    if (event.key === "Enter" || event.key === " ") {
                      event.preventDefault();
                      triggerAddToCart();
                    }
                  });
                  materialsList.appendChild(card);
                });
              }

              function getUniqueValues(list, key) {
                return Array.from(
                  new Set(
                    list
                      .map((item) => String(item?.[key] || "").trim())
                      .filter(Boolean)
                  )
                ).sort((a, b) => a.localeCompare(b, "ar", { sensitivity: "base" }));
              }

              function populateSubcategoryOptions(category) {
                if (!materialsCatalogLoaded || !Array.isArray(materialsCatalog)) {
                  subcategorySelect.innerHTML = "";
                  const defaultOption = document.createElement("option");
                  defaultOption.value = "";
                  defaultOption.textContent = "  ";
                  subcategorySelect.appendChild(defaultOption);
                  subcategorySelect.disabled = true;
                  return;
                }
                const relevant = category
                  ? materialsCatalog.filter(
                      (item) => String(item?.Category || "") === category
                    )
                  : materialsCatalog;
                const subcategories = getUniqueValues(relevant, "Subcategory");
                subcategorySelect.innerHTML = "";
                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = "  ";
                subcategorySelect.appendChild(defaultOption);
                subcategories.forEach((subcategory) => {
                  const option = document.createElement("option");
                  option.value = subcategory;
                  option.textContent = subcategory;
                  subcategorySelect.appendChild(option);
                });
                const enableSub = Boolean(category) && subcategories.length > 0;
                if (!enableSub) {
                  selectedSubcategory = "";
                  subcategorySelect.value = "";
                } else if (
                  selectedSubcategory &&
                  !subcategories.includes(selectedSubcategory)
                ) {
                  selectedSubcategory = "";
                }
                if (selectedSubcategory) {
                  subcategorySelect.value = selectedSubcategory;
                }
                subcategorySelect.disabled = !enableSub;
              }

              function populateCategoryOptions() {
                if (!materialsCatalogLoaded || !Array.isArray(materialsCatalog)) {
                  categorySelect.innerHTML = "";
                  const defaultOption = document.createElement("option");
                  defaultOption.value = "";
                  defaultOption.textContent = " ";
                  categorySelect.appendChild(defaultOption);
                  categorySelect.disabled = true;
                  subcategorySelect.disabled = true;
                  return;
                }
                const categories = getUniqueValues(materialsCatalog, "Category");
                if (selectedCategory && !categories.includes(selectedCategory)) {
                  selectedCategory = "";
                }
                categorySelect.innerHTML = "";
                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.textContent = " ";
                categorySelect.appendChild(defaultOption);
                categories.forEach((category) => {
                  const option = document.createElement("option");
                  option.value = category;
                  option.textContent = category;
                  categorySelect.appendChild(option);
                });
                categorySelect.disabled = categories.length === 0;
                if (selectedCategory) {
                  categorySelect.value = selectedCategory;
                }
                populateSubcategoryOptions(selectedCategory);
              }

              function applyMaterialFilters() {
                if (!materialsCatalogLoaded || !Array.isArray(materialsCatalog)) {
                  return [];
                }
                if (!materialsCatalog.length) {
                  populateMaterialsList([]);
                  return [];
                }
                const term = String(searchInput.value || "")
                  .trim()
                  .toLowerCase();
                const filtered = materialsCatalog.filter((material) => {
                  const categoryValue = String(material?.Category || "").trim();
                  if (selectedCategory && categoryValue !== selectedCategory) {
                    return false;
                  }
                  const subcategoryValue = String(
                    material?.Subcategory || ""
                  ).trim();
                  if (
                    selectedSubcategory &&
                    subcategoryValue !== selectedSubcategory
                  ) {
                    return false;
                  }
                  if (!term) {
                    return true;
                  }
                  const haystack = [
                    normalizeId(material),
                    material?.Name_AR,
                    material?.Name_EN,
                    material?.Category,
                    material?.Subcategory,
                  ]
                    .filter(Boolean)
                    .map((value) => String(value).toLowerCase());
                  return haystack.some((value) => value.includes(term));
                });
                populateMaterialsList(filtered);
                return filtered;
              }

              function renderAttachmentList() {
                attachmentList.innerHTML = "";
                if (!attachments.length) {
                  const emptyAttachment = document.createElement("p");
                  emptyAttachment.className = "direct-expense__empty";
                  emptyAttachment.textContent = "    .";
                  attachmentList.appendChild(emptyAttachment);
                  return;
                }
                attachments.forEach((attachment, index) => {
                  const card = document.createElement("div");
                  card.className = "direct-expense__attachment-card";

                  const header = document.createElement("div");
                  header.className = "direct-expense__attachment-header";
                  const title = document.createElement("span");
                  title.className = "direct-expense__attachment-title";
                  const file = attachment.file || {};
                  const rawName = file.name || "";
                  const baseTitle = rawName.replace(/\.[^.]+$/, "") || rawName;
                  const currentValue = attachment.labelInput.value.trim();
                  const fallbackTitle = baseTitle || ` ${index + 1}`;
                  title.textContent = currentValue || fallbackTitle;
                  header.appendChild(title);

                  const removeButton = document.createElement("button");
                  removeButton.type = "button";
                  removeButton.className = "direct-expense__attachment-remove";
                  removeButton.textContent = "";
                  removeButton.addEventListener("click", () => {
                    attachments.splice(index, 1);
                    renderAttachmentList();
                  });
                  header.appendChild(removeButton);
                  card.appendChild(header);

                  const meta = document.createElement("div");
                  meta.className = "direct-expense__attachment-meta";
                  const typeLabel = file.type || "  ";
                  const sizeLabel = formatFileSize(file.size);
                  meta.append(
                    document.createTextNode(rawName || "  "),
                    document.createTextNode("  "),
                    document.createTextNode(typeLabel),
                    document.createTextNode("  "),
                    document.createTextNode(sizeLabel)
                  );
                  card.appendChild(meta);

                  const fieldWrapper = document.createElement("div");
                  fieldWrapper.className = "direct-expense__attachment-field";
                  const fieldLabel = document.createElement("span");
                  fieldLabel.textContent = " ";
                  fieldWrapper.appendChild(fieldLabel);
                  const labelInput = attachment.labelInput;
                  labelInput.type = "text";
                  labelInput.className = "direct-expense__attachment-label";
                  if (!labelInput.placeholder) {
                    labelInput.placeholder = "  ";
                  }
                  if (!currentValue) {
                    labelInput.value = fallbackTitle;
                  }
                  labelInput.dataset.attachmentIndex = index;
                  labelInput.oninput = () => {
                    const value = labelInput.value.trim();
                    title.textContent = value || fallbackTitle;
                  };
                  fieldWrapper.appendChild(labelInput);
                  card.appendChild(fieldWrapper);

                  attachmentList.appendChild(card);
                });
              }

              function addToCart(materialId) {
                const material = materialsCatalog.find(
                  (item) => String(normalizeId(item)) === String(materialId)
                );
                if (!material) {
                  showToast("    .", "error");
                  return;
                }

                const defaultPrice =
                  Number(
                    material.Default_Price ||
                      material.Unit_Price ||
                      material.UnitPrice ||
                      0
                  ) || 0;
                const baseVatRate = toDecimalRate(material.VAT_Rate) ?? VAT_RATE;

                const existing = cart.find(
                  (item) => String(item.materialId) === String(materialId)
                );

                if (existing) {
                  existing.quantity += 1;
                  existing.baseVatRate = baseVatRate;
                } else {
                  const name =
                    material.Name_AR || material.Name_EN || String(materialId);
                  const unit = material.Default_Unit || "";
                  const category = material.Category || "";
                  const subcategory = material.Subcategory || "";
                  const price = defaultPrice;
                  const quantity = 1;
                  const effectiveVatRate = isVatEnabled ? baseVatRate : 0;
                  const subtotal = quantity * price;
                  const vatAmount = subtotal * effectiveVatRate;
                  const totalWithVat = subtotal + vatAmount;

                  cart.push({
                    materialId: String(materialId),
                    name,
                    materialName: name,
                    category,
                    subcategory,
                    unit,
                    price,
                    unitPrice: price,
                    quantity,
                    baseVatRate,
                    vatRate: effectiveVatRate,
                    vatApplied: isVatEnabled,
                    subtotal,
                    amount: subtotal,
                    vatAmount,
                    total: totalWithVat,
                    totalWithVat,
                  });
                }

                renderCart();
              }

              function renderCart() {
                const previousScrollTop = window.scrollY;
                cartItemsContainer.innerHTML = "";
                cartTotals.innerHTML = "";

                vatToggle.checked = isVatEnabled;
                vatToggle.disabled = cart.length === 0;
                cartTotals.appendChild(vatToggleWrapper);

                let subtotal = 0;
                let vatTotal = 0;
                let grandTotal = 0;

                if (!cart.length) {
                  const emptyCart = document.createElement("p");
                  emptyCart.className = "direct-expense__empty";
                  emptyCart.textContent = "     .";
                  cartItemsContainer.appendChild(emptyCart);
                } else {
                  const table = document.createElement("table");
                  table.className = "direct-expense__cart-table";
                  const thead = document.createElement("thead");
                  const headRow = document.createElement("tr");
                  ["", "", "", "", ""].forEach((label) => {
                    const th = document.createElement("th");
                    th.textContent = label;
                    headRow.appendChild(th);
                  });
                  thead.appendChild(headRow);
                  table.appendChild(thead);

                  const tbody = document.createElement("tbody");

                  cart.forEach((item, index) => {
                    const quantity = Number(item.quantity) || 0;
                    const price = Number(item.price ?? item.unitPrice) || 0;
                    const baseRate = Number.isFinite(item.baseVatRate)
                      ? Number(item.baseVatRate)
                      : VAT_RATE;
                    const effectiveVatRate = isVatEnabled ? baseRate : 0;

                    item.baseVatRate = baseRate;

                    const rowSubtotal = quantity * price;
                    const rowVatAmount = rowSubtotal * effectiveVatRate;
                    const rowTotal = rowSubtotal + rowVatAmount;

                    item.quantity = quantity;
                    item.price = price;
                    item.unitPrice = price;
                    item.subtotal = rowSubtotal;
                    item.amount = rowSubtotal;
                    item.vatAmount = rowVatAmount;
                    item.total = rowTotal;
                    item.totalWithVat = rowTotal;
                    item.vatRate = effectiveVatRate;
                    item.vatApplied = isVatEnabled;

                    subtotal += rowSubtotal;
                    vatTotal += rowVatAmount;
                    grandTotal += rowTotal;

                    const row = document.createElement("tr");
                    row.dataset.index = String(index);

                    const quantityCell = document.createElement("td");
                    const metaWrapper = document.createElement("div");
                    metaWrapper.className = "direct-expense__cart-meta";
                    const nameStrong = document.createElement("span");
                    nameStrong.className = "direct-expense__cart-name";
                    nameStrong.textContent =
                      item.name || item.materialName || item.materialId || "";
                    metaWrapper.appendChild(nameStrong);
                    const codeSpan = document.createElement("span");
                    codeSpan.className = "direct-expense__cart-code";
                    codeSpan.textContent = item.materialId
                      ? `#${item.materialId}`
                      : "";
                    metaWrapper.appendChild(codeSpan);
                    quantityCell.appendChild(metaWrapper);

                    const qtyInput = document.createElement("input");
                    qtyInput.type = "number";
                    qtyInput.min = "0";
                    qtyInput.step = "0.01";
                    qtyInput.value = quantity.toString();
                    qtyInput.dataset.field = "quantity";
                    qtyInput.className = "direct-expense__cart-input";
                    const handleQuantityChange = () => {
                      const value = Number(qtyInput.value);
                      const resolved =
                        Number.isFinite(value) && value > 0 ? value : 1;
                      item.quantity = resolved;
                      renderCart();
                    };
                    qtyInput.addEventListener("input", () => {
                      const value = Number(qtyInput.value);
                      const resolved =
                        Number.isFinite(value) && value > 0 ? value : 1;
                      item.quantity = resolved;
                      updateCartTotalsOnly();
                    });
                    qtyInput.addEventListener("change", handleQuantityChange);
                    quantityCell.appendChild(qtyInput);
                    row.appendChild(quantityCell);

                    const priceCell = document.createElement("td");
                    const priceInput = document.createElement("input");
                    priceInput.type = "number";
                    priceInput.min = "0";
                    priceInput.step = "0.01";
                    priceInput.value = price.toString();
                    priceInput.dataset.field = "price";
                    priceInput.className = "direct-expense__cart-input";
                    const handlePriceChange = () => {
                      const value = Number(priceInput.value);
                      const resolved =
                        Number.isFinite(value) && value >= 0 ? value : 0;
                      item.price = resolved;
                      item.unitPrice = resolved;
                      renderCart();
                    };
                    priceInput.addEventListener("input", () => {
                      const value = Number(priceInput.value);
                      const resolved =
                        Number.isFinite(value) && value >= 0 ? value : 0;
                      item.price = resolved;
                      item.unitPrice = resolved;
                      updateCartTotalsOnly();
                    });
                    priceInput.addEventListener("change", handlePriceChange);
                    priceCell.appendChild(priceInput);
                    row.appendChild(priceCell);

                    const unitCell = document.createElement("td");
                    unitCell.textContent = item.unit || "";
                    row.appendChild(unitCell);

                    const totalCell = document.createElement("td");
                    totalCell.textContent = formatCurrencyValue(rowTotal);
                    totalCell.dataset.field = "total";
                    row.appendChild(totalCell);

                    const actionsCell = document.createElement("td");
                    const removeButton = document.createElement("button");
                    removeButton.type = "button";
                    removeButton.className = "direct-expense__remove-btn";
                    removeButton.textContent = "";
                    removeButton.addEventListener("click", () => {
                      cart.splice(index, 1);
                      renderCart();
                    });
                    actionsCell.appendChild(removeButton);
                    row.appendChild(actionsCell);

                    tbody.appendChild(row);
                  });

                  table.appendChild(tbody);
                  cartItemsContainer.appendChild(table);
                }

                const totalsConfig = [
                  { label: "  ", value: subtotal },
                  { label: "  ", value: vatTotal },
                  { label: " ", value: grandTotal },
                ];

                totalsConfig.forEach(({ label, value }) => {
                  const row = document.createElement("div");
                  row.className = "direct-expense__totals-row";
                  const labelSpan = document.createElement("span");
                  labelSpan.textContent = label;
                  const valueSpan = document.createElement("strong");
                  valueSpan.textContent = formatCurrencyValue(value);
                  row.appendChild(labelSpan);
                  row.appendChild(valueSpan);
                  cartTotals.appendChild(row);
                });

                window.scrollTo({ top: previousScrollTop });
              }

              function recomputeRowAndTotals(rootElement, items) {
                if (!rootElement) return;
                const table = rootElement.querySelector(
                  ".direct-expense__cart-table"
                );
                const totalsBox = rootElement.querySelector("#cart-totals");
                if (!table || !totalsBox) return;

                let subtotal = 0;
                let vatTotal = 0;
                let grandTotal = 0;

                table.querySelectorAll("tbody tr").forEach((row) => {
                  const index = Number(row.dataset.index);
                  if (
                    !Number.isFinite(index) ||
                    index < 0 ||
                    index >= items.length
                  ) {
                    return;
                  }

                  const currentItem = items[index];
                  if (!currentItem) return;

                  const priceInputEl = row.querySelector(
                    'input[data-field="price"]'
                  );
                  const qtyInputEl = row.querySelector(
                    'input[data-field="quantity"]'
                  );

                  const priceValue = Number(priceInputEl?.value);
                  const qtyValue = Number(qtyInputEl?.value);

                  const price =
                    Number.isFinite(priceValue) && priceValue >= 0 ? priceValue : 0;
                  const quantity =
                    Number.isFinite(qtyValue) && qtyValue > 0 ? qtyValue : 1;

                  const baseRate = Number.isFinite(currentItem.baseVatRate)
                    ? Number(currentItem.baseVatRate)
                    : VAT_RATE;
                  const effectiveVatRate = isVatEnabled ? baseRate : 0;

                  currentItem.price = price;
                  currentItem.unitPrice = price;
                  currentItem.quantity = quantity;
                  currentItem.vatApplied = isVatEnabled;
                  currentItem.vatRate = effectiveVatRate;

                  const amount = quantity * price;
                  const vatAmount = amount * effectiveVatRate;
                  const totalWithVat = amount + vatAmount;

                  currentItem.subtotal = amount;
                  currentItem.amount = amount;
                  currentItem.vatAmount = vatAmount;
                  currentItem.total = totalWithVat;
                  currentItem.totalWithVat = totalWithVat;

                  subtotal += amount;
                  vatTotal += vatAmount;
                  grandTotal += totalWithVat;

                  const totalCell = row.querySelector('[data-field="total"]');
                  if (totalCell)
                    totalCell.textContent = formatCurrencyValue(totalWithVat);
                });

                const totalsRows = totalsBox.querySelectorAll(
                  ".direct-expense__totals-row strong"
                );
                if (totalsRows.length >= 3) {
                  totalsRows[0].textContent = formatCurrencyValue(subtotal);
                  totalsRows[1].textContent = formatCurrencyValue(vatTotal);
                  totalsRows[2].textContent = formatCurrencyValue(grandTotal);
                }
              }

              cartItemsContainer.addEventListener("input", (event) => {
                const input = event.target;
                if (!(input instanceof HTMLInputElement)) return;
                if (input.type !== "number") return;
                const field = input.dataset.field;
                if (field !== "price" && field !== "quantity") return;

                const row = input.closest("tr");
                if (!row) return;
                const index = Number(row.dataset.index);
                if (!Number.isFinite(index) || index < 0 || index >= cart.length) {
                  return;
                }

                const value = Number(input.value);
                if (field === "price") {
                  const resolved = Number.isFinite(value) && value >= 0 ? value : 0;
                  cart[index].price = resolved;
                  cart[index].unitPrice = resolved;
                } else if (field === "quantity") {
                  cart[index].quantity =
                    Number.isFinite(value) && value > 0 ? value : 1;
                }

                recomputeRowAndTotals(paneElement, cart);
              });

              cartItemsContainer.addEventListener("change", (event) => {
                const input = event.target;
                if (!(input instanceof HTMLInputElement)) return;
                if (input.type !== "number") return;
                const field = input.dataset.field;
                if (field !== "price" && field !== "quantity") return;

                const row = input.closest("tr");
                if (!row) return;
                const index = Number(row.dataset.index);
                if (!Number.isFinite(index) || index < 0 || index >= cart.length) {
                  return;
                }

                const scrollTopBeforeRender = window.scrollY;
                renderCart();
                window.scrollTo({ top: scrollTopBeforeRender });
              });

              searchInput.addEventListener("input", () => {
                if (!materialsCatalogLoaded) return;
                applyMaterialFilters();
              });

              searchInput.addEventListener("keyup", (event) => {
                if (event.key === "Enter") {
                  event.preventDefault();
                }
              });

              categorySelect.addEventListener("change", () => {
                if (!materialsCatalogLoaded) return;
                selectedCategory = categorySelect.value;
                selectedSubcategory = "";
                subcategorySelect.value = "";
                populateSubcategoryOptions(selectedCategory);
                applyMaterialFilters();
              });

              subcategorySelect.addEventListener("change", () => {
                if (!materialsCatalogLoaded) return;
                selectedSubcategory = subcategorySelect.value;
                applyMaterialFilters();
              });

              vatToggle.addEventListener("change", () => {
                isVatEnabled = vatToggle.checked;
                cart.forEach((item) => {
                  item.vatApplied = isVatEnabled;
                });
                const y = window.scrollY;
                renderCart();
                window.scrollTo({ top: y });
              });

              attachmentsInput.addEventListener("change", (event) => {
                const files = Array.from(event.target.files || []);
                files.forEach((file) => {
                  const exists = attachments.some(
                    (attachment) =>
                      attachment.file.name === file.name &&
                      attachment.file.size === file.size &&
                      attachment.file.lastModified === file.lastModified
                  );
                  if (exists) {
                    return;
                  }
                  const labelInput = document.createElement("input");
                  labelInput.type = "text";
                  labelInput.className = "direct-expense__attachment-label";
                  const defaultLabel = file.name.replace(/\.[^.]+$/, "").trim();
                  if (defaultLabel) {
                    labelInput.value = defaultLabel;
                  }
                  labelInput.placeholder = "  ";
                  attachments.push({ file, labelInput });
                });
                attachmentsInput.value = "";
                renderAttachmentList();
              });

              renderCart();
              renderAttachmentList();

              if (!(window.google && google.script && google.script.run)) {
                materialsList.innerHTML =
                  '<p class="error-text"> Google Apps Script  .</p>';
                return;
              }

              google.script.run
                .withFailureHandler((err) => {
                  console.error("getMaterialsCatalog failed", err);
                  materialsCatalog = [];
                  materialsCatalogLoaded = false;
                  materialsList.innerHTML =
                    '<p class="error-text">   .</p>';
                  populateCategoryOptions();
                  showToast("   .", "error");
                })
                .withSuccessHandler((result) => {
                  const source = Array.isArray(result) ? result : [];
                  materialsCatalog = source.map(hydrateMaterial);
                  materialsCatalogLoaded = true;
                  populateCategoryOptions();
                  populateMaterialsList(materialsCatalog);
                  if (
                    String(searchInput.value || "").trim() ||
                    selectedCategory ||
                    selectedSubcategory
                  ) {
                    applyMaterialFilters();
                  }
                })
                .getMaterialsCatalog();

              google.script.run
                .withFailureHandler((err) => {
                  console.error("getProjectsForDropdown failed", err);
                  showToast("  .", "warning");
                })
                .withSuccessHandler((projects) => {
                  const list = Array.isArray(projects) ? projects : [];
                  list.forEach((project) => {
                    const option = document.createElement("option");
                    option.value =
                      project?.Project_ID ||
                      project?.projectId ||
                      project?.value ||
                      "";
                    option.textContent =
                      project?.Project_Name ||
                      project?.projectName ||
                      project?.label ||
                      option.value;
                    projectSelect.appendChild(option);
                  });
                })
                .getProjectsForDropdown();

              submitButton.addEventListener("click", () => {
                if (!cart.length) {
                  showToast("      .", "warning");
                  return;
                }

                if (!projectSelect.value) {
                  showToast("  .", "warning");
                  projectSelect.focus();
                  return;
                }

                if (!dateInput.value) {
                  showToast("  .", "warning");
                  dateInput.focus();
                  return;
                }

                const invalidItem = cart.some(
                  (item) =>
                    !Number.isFinite(item.quantity) ||
                    item.quantity <= 0 ||
                    !Number.isFinite(item.price ?? item.unitPrice) ||
                    (item.price ?? item.unitPrice) < 0
                );
                if (invalidItem) {
                  showToast("      .", "warning");
                  return;
                }

                if (!(window.google && google.script && google.script.run)) {
                  showToast("   .", "error");
                  return;
                }

                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.textContent = " ...";

                const payload = {
                  header: {
                    project: projectSelect.value,
                    date: dateInput.value,
                    vatIncluded: isVatEnabled,
                    paymentMethod: paymentMethodSelect.value || "",
                    paymentStatus: paymentStatusSelect.value || "",
                    notes: notesInput.value.trim(),
                  },
                  items: cart.map((item) => ({
                    materialId: item.materialId,
                    materialName: item.name || item.materialName || "",
                    category: item.category,
                    subcategory: item.subcategory,
                    unit: item.unit,
                    quantity: item.quantity,
                    unitPrice: item.price ?? item.unitPrice,
                    amount: item.amount ?? item.subtotal,
                    vatRate: item.vatRate,
                    vatAmount: item.vatAmount,
                    totalWithVat: item.totalWithVat ?? item.total,
                    vatApplied: item.vatApplied,
                  })),
                  attachments: attachments.map((attachment) => ({
                    name: attachment.file.name,
                    size: attachment.file.size,
                    type: attachment.file.type,
                    label: attachment.labelInput.value.trim(),
                    lastModified: attachment.file.lastModified,
                  })),
                };

                google.script.run
                  .withFailureHandler((err) => {
                    console.error("saveDirectExpenses failed", err);
                    showToast("  .", "error");
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                  })
                  .withSuccessHandler((response) => {
                    if (response && response.success) {
                      cart = [];
                      renderCart();
                      attachments = [];
                      attachmentsInput.value = "";
                      renderAttachmentList();
                      showToast(
                        response.message || "   .",
                        "success"
                      );
                      if (typeof onSaved === "function") {
                        try {
                          onSaved(response);
                        } catch (callbackError) {
                          console.error("onSaved callback failed", callbackError);
                        }
                      }
                    } else {
                      showToast(
                        (response && response.message) || "  .",
                        "error"
                      );
                    }
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                  })
                  .saveDirectExpenses(payload);
              });
            }

            function markTableLoaded(key, value) {
              if (!key) return;
              tableLoadState[key] = !!value;
            }

            function isTableLoaded(key) {
              return !!tableLoadState[key];
            }

            function resetTableLoadState() {
              Object.keys(tableLoadState).forEach((key) => {
                tableLoadState[key] = false;
              });
            }

            /* Bootstrap (server) */
            function applyBootstrap(data) {
              console.log("Bootstrap data received:", data);
              bootstrapData = Object.assign({}, data || {});
              const serverTabs = Array.isArray(data?.tabRegister)
                ? data.tabRegister
                : Array.isArray(data?.tabs)
                ? data.tabs
                : Array.isArray(data?.tabRegistry)
                ? data.tabRegistry
                : Array.isArray(data?.tabConfig)
                ? data.tabConfig
                : [];
              g.bootstrap = Object.assign({}, g.bootstrap, data || {});
              g.bootstrap.tabs = serverTabs || g.bootstrap.tabs || [];
              g.bootstrap.tabsRaw = serverTabs;
              overviewLoaded = false;
              resetTableLoadState();
              selectedUsers.clear();
              normalizedUsersCache = [];
              renderNav(data?.nav || []);
              // Restore module cards grid rendering after login bootstrap
              renderModuleGrid(data?.nav || []);
              renderSysNav(
                data?.tabRegister ||
                  data?.tabs ||
                  data?.tabRegistry ||
                  data?.tabConfig ||
                  undefined
              );
              const identityFromServer =
                data?.user &&
                (data.user.Full_Name || data.user.Username || data.user.Email)
                  ? data.user
                  : null;
              const displayName =
                data?.user?.Full_Name || data?.user?.Username || "User";
              const identityToUse =
                identityFromServer || lastLoginIdentity || displayName;
              updateUserContext(identityToUse);
              // Fill filter selects if server sent lists
              if (data?.filters) {
                fillSelect(selDept, data.filters.departments);
                fillSelect(selRole, data.filters.roles);
                fillSelect(
                  bulkRoleSelect,
                  data.filters.roleOptions || data.filters.roles
                );
                bulkRoleSelect.disabled = !(
                  (data.filters.roleOptions || data.filters.roles || []).length > 0
                );
              } else {
                // Try lazy fetch
                if (window.google && google.script && google.script.run) {
                  google.script.run
                    .withSuccessHandler((f) => {
                      console.log("Department and role filters received:", f);
                      fillSelect(selDept, f?.departments || []);
                      fillSelect(selRole, f?.roles || []);
                      fillSelect(bulkRoleSelect, f?.roleOptions || f?.roles || []);
                      bulkRoleSelect.disabled = !(f?.roleOptions || f?.roles || [])
                        ?.length;
                    })
                    .getDeptAndRoleFilters();
                }
              }
              fetchKPIs();
              loadUsers(); // prefetch for smoother UX
              syncBulkActionsState();
            }
            function fillSelect(selectEl, arr) {
              if (!selectEl) return;
              const keepFirst = selectEl.querySelector("option");
              selectEl.innerHTML = keepFirst ? keepFirst.outerHTML : "";
              (arr || []).forEach((item) => {
                const option = document.createElement("option");
                if (item && typeof item === "object") {
                  option.value = item.value ?? item.label ?? "";
                  option.textContent = item.label ?? item.value ?? "";
                } else {
                  option.value = item;
                  option.textContent = item;
                }
                selectEl.appendChild(option);
              });
            }
            function handleServerResponse(result, onSuccess) {
              if (result && typeof result === "object" && result.error) {
                console.error("Backend error:", result.message);
                alert("Error: " + (result.message || "Unknown error"));
                return;
              }
              if (typeof onSuccess === "function") {
                onSuccess(result);
              }
            }

            function bootstrapApp() {
              if (!(window.google && google.script && google.script.run)) {
                console.warn("Apps Script runtime not available.");
                return;
              }
              google.script.run
                .withFailureHandler((err) => console.error("Bootstrap failed", err))
                .withSuccessHandler(applyBootstrap)
                .getBootstrapData();
            }

            /* Login */
            const loginForm = document.getElementById("login-form");
            const loginBtn = document.getElementById("login-button");
            if (loginForm) {
              loginForm.addEventListener("submit", (e) => {
                e.preventDefault();
                if (!(window.google && google.script && google.script.run)) {
                  console.warn(
                    "[CLIENT] Login attempt without Apps Script runtime"
                  );
                  showToast("   .", "error", "");
                  return;
                }

                const usernameInput = document.getElementById("username");
                const passwordInput = document.getElementById("password");
                const username = (usernameInput?.value || "").trim();
                const password = passwordInput?.value || "";

                if (!username || !password) {
                  showToast("    .", "info");
                  return;
                }

                if (loginBtn) loginBtn.classList.add("loading");
                console.log("[CLIENT] Login attempt for:", username);

                google.script.run
                  .withFailureHandler((err) => {
                    if (loginBtn) loginBtn.classList.remove("loading");
                    console.error("[CLIENT] Login failed:", err);
                    showToast("  .", "error", "");
                  })
                  .withSuccessHandler((res) => {
                    if (loginBtn) loginBtn.classList.remove("loading");
                    console.log("[CLIENT] Login response received:", res);
                    try {
                      console.log(
                        "[CLIENT] Evaluating login response success flag..."
                      );
                      if (!res || res.success !== true) {
                        const messageFromServer =
                          res?.message ||
                          "        .";
                        console.warn(
                          "[CLIENT] Login response indicates failure:",
                          messageFromServer,
                          res
                        );
                        showToast(messageFromServer, "error", "  ");
                        return;
                      }

                      console.log(
                        "[CLIENT] Login response marked success. Extracting bootstrap data..."
                      );
                      const data = res.bootstrap || {};
                      console.log(
                        "[CLIENT] Bootstrap payload keys:",
                        Object.keys(data || {})
                      );
                      const identity = res.user ||
                        data.user || {
                          Username: username,
                        };
                      console.log("[CLIENT] Resolved login identity:", identity);
                      lastLoginIdentity = identity;
                      navbar.classList.remove("hidden");
                      console.log("[CLIENT] Applying bootstrap data to UI...");
                      applyBootstrap(data);
                      console.log(
                        "[CLIENT] Bootstrap applied. Switching to portal view..."
                      );
                      switchView("portal-view");
                      if (!loginSuccessToastShown) {
                        console.log("[CLIENT] Displaying success toast.");
                        showToast("   .", "success", " ");
                        loginSuccessToastShown = true;
                      }
                    } catch (handlerError) {
                      console.error(
                        "[CLIENT] Exception while handling successful login response:",
                        handlerError,
                        res
                      );
                      showToast(
                        "      .",
                        "error",
                        ""
                      );
                    }
                  })
                  .authenticateUser({
                    username,
                    password,
                  });
              });
            }

            /* Top nav clicks */
            navbar.addEventListener("click", (e) => {
              const btn = e.target.closest(".nav-btn[data-target]");
              if (!btn) return;
              e.preventDefault();
              switchView(btn.dataset.target);
            });

            /* Card clicks */
            document.querySelectorAll(".module-card").forEach((card) => {
              card.addEventListener("click", () =>
                switchView(card.getAttribute("data-workspace"))
              );
            });

            /* Back-to-portal */
            document.querySelectorAll('[data-go="portal-view"]').forEach((btn) => {
              btn.addEventListener("click", () => switchView("portal-view"));
            });

            /* Logout */
            if (logoutButton) {
              logoutButton.addEventListener("click", () => {
                navbar.classList.add("hidden");
                userLabel.innerHTML = "";
                userLabel.removeAttribute("title");
                const welcome = document.getElementById("portal-welcome-message");
                if (welcome) welcome.textContent = "";
                bootstrapData = {};
                lastLoginIdentity = null;
                loginSuccessToastShown = false;
                overviewLoaded = false;
                resetTableLoadState();
                selectedUsers.clear();
                normalizedUsersCache = [];
                profileDataCache = null;
                currentProfileUserId = null;
                renderNav();
                renderModuleGrid();
                switchView("login-screen");
                showToast("You have been signed out.", "info", "Logged Out");
              });
            }

            /* ---------- KPIs ---------- */
            function fetchKPIs() {
              if (!(window.google && google.script && google.script.run)) return;
              google.script.run
                .withFailureHandler(() => {})
                .withSuccessHandler((k) => {
                  console.log("System KPIs received:", k);
                  if (!k) return;
                  const $ = (id) => document.getElementById(id);
                  $("kpi-total-users").textContent = k.totalUsers ?? "";
                  $("kpi-active-users").textContent = k.activeUsers ?? "";
                  $("kpi-inactive-users").textContent = k.inactiveUsers ?? "";
                  $("kpi-role-count").textContent = k.roleCount ?? "";
                  $("kpi-permission-count").textContent = k.permissionCount ?? "";
                  $("kpi-pending-resets").textContent =
                    k.pendingPasswordResets ?? "";
                  overviewLoaded = true;
                })
                .getSystemKPIs();
            }

            function currentFilters() {
              return {
                search: (txtSearch.value || "").trim(),
                department: selDept.value || "",
                role: selRole.value || "",
                status: selStatus.value || "",
                updatedFrom: dtUpdatedFrom.value || "",
                updatedTo: dtUpdatedTo.value || "",
              };
            }

            let usersReqTimer = null;
            function loadUsers({ force } = {}) {
              console.log("[CLIENT] loadUsers called with force:", force);
              if (!(window.google && google.script && google.script.run)) {
                console.error("[CLIENT] Apps Script runtime not available");
                usersTbody.innerHTML =
                  '<tr><td colspan="11" class="muted">  .</td></tr>';
                selectedUsers.clear();
                syncSelectAllState();
                syncBulkActionsState();
                return;
              }
              if (force) {
                selectedUsers.clear();
                syncSelectAllState();
                syncBulkActionsState();
              }
              usersTbody.innerHTML =
                '<tr><td colspan="11" class="muted"> </td></tr>';
              const filters = currentFilters();
              console.log("[CLIENT] Requesting users with filters:", filters);
              // watchdog in case server throws silently
              clearTimeout(usersReqTimer);
              usersReqTimer = setTimeout(() => {
                const stillLoading =
                  usersTbody.textContent.includes(" ");
                if (stillLoading) {
                  console.warn("[CLIENT] User loading timeout after 8s");
                  usersTbody.innerHTML =
                    '<tr><td colspan="11" class="muted"> .</td></tr>';
                }
                if (stillLoading) {
                  selectedUsers.clear();
                  syncSelectAllState();
                  syncBulkActionsState();
                }
              }, 8000);
              google.script.run
                .withFailureHandler((err) => {
                  clearTimeout(usersReqTimer);
                  console.error("[CLIENT] searchUsers failed:", err);
                  usersTbody.innerHTML =
                    '<tr><td colspan="11" class="error-text">: ' +
                    (err.message || err) +
                    "</td></tr>";
                  selectedUsers.clear();
                  syncSelectAllState();
                  syncBulkActionsState();
                })
                .withSuccessHandler((result) => {
                  clearTimeout(usersReqTimer);
                  handleServerResponse(result, (users) => {
                    console.log("Users received from server:", users);
                    console.log(
                      "[CLIENT] User list received, count:",
                      Array.isArray(users) ? users.length : 0
                    );
                    console.log("[CLIENT] User list data:", users);
                    renderUsers(users);
                  });
                })
                .searchUsers(filters);
            }

            //   
            if (usersTable) {
              usersTable.addEventListener("click", (e) => {
                const btn = e.target.closest("button[data-act]");
                if (!btn) return;
                const act = btn.dataset.act;
                const userId = btn.dataset.id;
                if (!userId) return;
                if (!(window.google && google.script && google.script.run)) {
                  showToast("  .", "error");
                  return;
                }

                if (act === "reset") {
                  resetUserId = userId;
                  formReset.reset();
                  dlgReset.showModal();
                } else if (act === "toggle") {
                  google.script.run
                    .withFailureHandler((err) => {
                      console.error(err);
                      showToast("   .", "error");
                    })
                    .withSuccessHandler((res) => {
                      console.log("Toggle user active response:", res);
                      showToast("  .", "success");
                      loadUsers();
                    })
                    .toggleUserActive(userId);
                } else if (act === "edit") {
                  openUserEditor(userId);
                } else if (act === "view") {
                  openUserProfile(userId, "profile");
                } else if (act === "audit") {
                  openUserProfile(userId, "audit");
                } else if (act === "assign") {
                  openAssignRoleDialog(userId);
                } else if (act === "docs") {
                  openUserProfile(userId, "documents");
                } else if (act === "impersonate") {
                  startImpersonationFlow(userId);
                } else if (act === "delete") {
                  performSoftDelete(userId);
                }
              });

              usersTable.addEventListener("change", (e) => {
                const checkbox = e.target.closest(".row-select");
                if (!checkbox) return;
                const userId = checkbox.dataset.id;
                if (!userId) return;
                if (checkbox.checked) {
                  selectedUsers.add(userId);
                } else {
                  selectedUsers.delete(userId);
                }
                const row = checkbox.closest("tr");
                if (row) {
                  row.classList.toggle(
                    "generic-table__row--selected",
                    checkbox.checked
                  );
                }
                syncSelectAllState();
                syncBulkActionsState();
              });
            } else {
              console.warn(
                "[CLIENT] Users table element not found; actions disabled"
              );
            }

            selectAllUsers.addEventListener("change", (e) => {
              const checked = e.target.checked;
              usersTbody
                .querySelectorAll('input.row-select[type="checkbox"]')
                .forEach((cb) => {
                  cb.checked = checked;
                  const id = cb.dataset.id;
                  if (!id) return;
                  if (checked) {
                    selectedUsers.add(id);
                  } else {
                    selectedUsers.delete(id);
                  }
                  const row = cb.closest("tr");
                  if (row) {
                    row.classList.toggle(
                      "generic-table__row--selected",
                      cb.checked
                    );
                  }
                });
              syncSelectAllState();
              syncBulkActionsState();
            });

            ["input", "change"].forEach((evt) => {
              txtSearch.addEventListener(evt, loadUsers);
              selDept.addEventListener(evt, loadUsers);
              selRole.addEventListener(evt, loadUsers);
              selStatus.addEventListener(evt, loadUsers);
              dtUpdatedFrom.addEventListener(evt, loadUsers);
              dtUpdatedTo.addEventListener(evt, loadUsers);
            });

            if (bulkExportBtn)
              bulkExportBtn.addEventListener("click", handleBulkExport);
            if (bulkActivateBtn)
              bulkActivateBtn.addEventListener("click", () =>
                performBulkStatus(true)
              );
            if (bulkDeactivateBtn)
              bulkDeactivateBtn.addEventListener("click", () =>
                performBulkStatus(false)
              );
            if (bulkAssignRoleBtn)
              bulkAssignRoleBtn.addEventListener("click", handleBulkAssignRole);
            if (bulkRoleSelect)
              bulkRoleSelect.addEventListener("change", () => {
                syncBulkActionsState();
              });

            // Reset password dialog is already initialized above
            document
              .getElementById("btn-cancel-reset")
              .addEventListener("click", () => dlgReset.close());
            formReset.addEventListener("submit", (e) => {
              e.preventDefault();
              const fd = new FormData(formReset);
              const p = fd.get("password") || "",
                c = fd.get("confirm") || "";
              if (p !== c) {
                showToast("  .", "error");
                return;
              }
              if (!(window.google && google.script && google.script.run)) {
                showToast("  .", "error");
                return;
              }
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("   .", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Reset password response:", res);
                  showToast("    ().", "success");
                  dlgReset.close();
                })
                .updateUserPassword(resetUserId, p);
            });

            const DATE_OPTS = {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              hour12: false,
            };

            function formatDateTime(value) {
              if (!value) return "";
              // Attempt parsing robustly - handles ISO strings, common date strings, and Date objects
              const date = value instanceof Date ? value : new Date(value);

              // Check if the parsed date is valid
              if (Number.isNaN(date.getTime())) {
                // If invalid, return the original string (escaped) or a placeholder
                console.warn(
                  "formatDateTime: Invalid date value encountered:",
                  value
                );
                return typeof value === "string" ? escapeHtml(value) : "";
              }

              try {
                // Use a locale that gives a clear format like YYYY-MM-DD (only date)
                return date.toLocaleDateString("en-CA", {
                  year: "numeric",
                  month: "2-digit",
                  day: "2-digit",
                });
              } catch (err) {
                console.error("formatDateTime: localeString failed:", err);
                // Fallback to ISO string format YYYY-MM-DD if locale fails
                try {
                  return date.toISOString().substring(0, 10);
                } catch (isoErr) {
                  console.error(
                    "formatDateTime: ISOString fallback failed:",
                    isoErr
                  );
                  return "Invalid Date"; // Final fallback
                }
              }
            }

            function escapeHtml(value) {
              if (value == null) return "";
              const str = String(value);
              const div = document.createElement("div");
              div.textContent = str;
              return div.innerHTML;
            }

            // Enhanced input sanitization
            function sanitizeInput(input) {
              if (typeof input !== "string") return "";
              return input.trim().replace(/[<>]/g, "");
            }

            // Enhanced error handling
            function handleError(error, context = "Unknown") {
              console.error(`[${context}] Error:`, error);
              showToast(
                `   ${context}: ${error.message || error}`,
                "error"
              );
            }

            // Safe DOM manipulation
            function safeSetText(element, text) {
              if (!element) return;
              element.textContent = String(text || "");
            }

            function safeSetHTML(element, html) {
              if (!element) return;
              const sanitized = DOMPurify
                ? DOMPurify.sanitize(html)
                : escapeHtml(html);
              element.innerHTML = sanitized;
            }

            // Performance monitoring
            const performanceMarks = new Map();
            function markPerformance(name) {
              performanceMarks.set(name, performance.now());
            }

            function measurePerformance(name, startMark) {
              const start = performanceMarks.get(startMark);
              const end = performance.now();
              if (start) {
                console.log(`[${name}] Performance: ${end - start}ms`);
              }
            }

            // CSRF token management
            let csrfToken = null;
            function getCsrfToken() {
              if (!csrfToken) {
                csrfToken = generateToken();
                // Store in sessionStorage for persistence
                try {
                  sessionStorage.setItem("csrf_token", csrfToken);
                } catch (e) {
                  console.warn("Could not store CSRF token in sessionStorage");
                }
              }
              return csrfToken;
            }

            function generateToken() {
              return (
                Math.random().toString(36).substring(2) + Date.now().toString(36)
              );
            }

            function validateCsrfToken(token) {
              const stored = sessionStorage.getItem("csrf_token");
              return stored && stored === token;
            }

            function setTableStatus(bodyEl, message, type = "muted") {
              if (!bodyEl) return;
              const colCount = bodyEl.parentElement
                ? bodyEl.parentElement.querySelectorAll("thead th").length || 1
                : 1;
              const tr = document.createElement("tr");
              const td = document.createElement("td");
              td.colSpan = colCount;
              td.className = type === "error" ? "error-text" : "muted";
              td.textContent = message;
              tr.appendChild(td);
              bodyEl.innerHTML = "";
              bodyEl.appendChild(tr);
            }

            function renderBooleanBadge(value, yesLabel = "", noLabel = "") {
              const normalized = String(value).toLowerCase();
              const truthy =
                value === true ||
                normalized === "true" ||
                normalized === "yes" ||
                normalized === "1" ||
                normalized === "y";
              return truthy
                ? `<span class="badge badge--ok">${escapeHtml(yesLabel)}</span>`
                : `<span class="badge badge--no">${escapeHtml(noLabel)}</span>`;
            }

            function loadSimpleTable({
              key,
              fetcher,
              tbody,
              renderer,
              normalize,
              force = false,
              label,
            }) {
              if (!tbody) return;
              if (isTableLoaded(key) && !force) return;
              if (force) markTableLoaded(key, false);
              const methodLabel = label || fetcher || key || "list";
              console.log(`[CLIENT] ${methodLabel} requested (force=${force})`);
              if (!(window.google && google.script && google.script.run)) {
                console.error(
                  `[CLIENT] ${methodLabel} requires Apps Script runtime`
                );
                setTableStatus(tbody, "  .", "error");
                return;
              }
              setTableStatus(tbody, " ");
              const request = google.script.run
                .withFailureHandler((err) => {
                  console.error(`[CLIENT] ${methodLabel} failed:`, err);
                  markTableLoaded(key, false);
                  setTableStatus(
                    tbody,
                    ": " + (err && err.message ? err.message : err),
                    "error"
                  );
                })
                .withSuccessHandler((rows) => {
                  const count = Array.isArray(rows) ? rows.length : 0;
                  console.log(
                    `[CLIENT] ${methodLabel} data received, count:`,
                    count
                  );
                  markTableLoaded(key, true);
                  const list = Array.isArray(rows) ? rows : [];
                  const normalized = normalize
                    ? list.map((item) => normalize(item || {}))
                    : list;
                  renderTableRows(tbody, normalized, (row) => renderer(row || {}));
                });
              const fn = fetcher && request[fetcher];
              if (typeof fn === "function") {
                fn.call(request);
              } else {
                console.error(`[CLIENT] Missing server function: ${fetcher}`);
                markTableLoaded(key, false);
                setTableStatus(tbody, "  .", "error");
              }
            }

            function renderUsers(list) {
              usersTbody.innerHTML = "";
              if (!Array.isArray(list) || list.length === 0) {
                usersTbody.innerHTML =
                  '<tr><td colspan="11" class="muted">  .</td></tr>';
                selectedUsers.clear();
                syncSelectAllState();
                syncBulkActionsState();
                return;
              }
              const toDate = (value) => {
                if (!value) return null;
                if (value instanceof Date) return value;
                const parsed = new Date(value);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
              };
              const norm = (u) => {
                const id = u?.User_Id ?? u?.user_id ?? u?.id ?? "";
                const normalizedId = id != null ? String(id) : "";
                return {
                  userId: normalizedId,
                  fullName: u?.Full_Name ?? u?.fullName ?? u?.name ?? "",
                  username: u?.Username ?? u?.username ?? "",
                  email: u?.Email ?? u?.email ?? "",
                  department: u?.Department ?? u?.department ?? "",
                  role: u?.Role_Id ?? u?.role ?? u?.Role ?? "",
                  isActive:
                    u?.IsActive === true ||
                    String(u?.IsActive).toLowerCase() === "true" ||
                    u?.isActive === true,
                  lastLogin: toDate(u?.Last_Login ?? u?.lastLogin),
                  updatedAt: toDate(u?.Updated_At ?? u?.updatedAt),
                };
              };
              const normalized = list.map(norm);
              normalizedUsersCache = normalized;
              const frag = document.createDocumentFragment();
              const visibleIds = new Set();
              normalized.forEach((u) => {
                if (u.userId) visibleIds.add(u.userId);
                const tr = document.createElement("tr");
                const checked = u.userId && selectedUsers.has(u.userId);

                const selectTd = document.createElement("td");
                selectTd.className = "select-cell";
                const rowCheckbox = document.createElement("input");
                rowCheckbox.type = "checkbox";
                rowCheckbox.className = "row-select";
                if (u.userId) {
                  rowCheckbox.dataset.id = u.userId;
                  rowCheckbox.checked = !!checked;
                  const checkboxLabel = u.fullName
                    ? ` ${u.fullName}`
                    : ` ${u.userId}`;
                  rowCheckbox.title = checkboxLabel;
                  rowCheckbox.setAttribute("aria-label", checkboxLabel);
                } else {
                  rowCheckbox.disabled = true;
                }
                selectTd.appendChild(rowCheckbox);
                tr.appendChild(selectTd);

                const appendTextCell = (value) => {
                  const td = document.createElement("td");
                  td.textContent = value || "";
                  tr.appendChild(td);
                };

                appendTextCell(u.userId);
                appendTextCell(u.fullName);
                appendTextCell(u.username);
                appendTextCell(u.email);
                appendTextCell(u.department);
                appendTextCell(u.role);

                const statusTd = document.createElement("td");
                statusTd.innerHTML = u.isActive
                  ? '<span class="badge badge--ok"></span>'
                  : '<span class="badge badge--no"> </span>';
                tr.appendChild(statusTd);

                const lastLoginTd = document.createElement("td");
                lastLoginTd.textContent = formatDateTime(u.lastLogin);
                tr.appendChild(lastLoginTd);

                const updatedTd = document.createElement("td");
                updatedTd.textContent = formatDateTime(u.updatedAt);
                tr.appendChild(updatedTd);

                const actionsTd = document.createElement("td");
                const actionsRow = document.createElement("div");
                actionsRow.className = "icon-row";

                const pushAction = (act, icon, title, ariaLabel = title) => {
                  const btn = createIconButton(icon, {
                    className: "icon-btn",
                    title,
                    ariaLabel,
                  });
                  btn.dataset.act = act;
                  if (u.userId) {
                    btn.dataset.id = u.userId;
                  } else {
                    btn.disabled = true;
                  }
                  actionsRow.appendChild(btn);
                };

                pushAction("view", "view", " ");
                pushAction("edit", "edit", "");
                pushAction("assign", "assign", " ");
                pushAction("reset", "password", "  ");

                const toggleTitle = u.isActive ? "" : "";
                pushAction(
                  "toggle",
                  u.isActive ? "deactivate" : "activate",
                  toggleTitle
                );

                pushAction("docs", "file", "");
                pushAction("impersonate", "impersonate", "");
                pushAction("delete", "delete", " ");
                pushAction("audit", "audit", " ");

                actionsTd.appendChild(actionsRow);
                tr.appendChild(actionsTd);

                if (checked) {
                  tr.classList.add("generic-table__row--selected");
                }

                frag.appendChild(tr);
              });
              usersTbody.appendChild(frag);
              Array.from(selectedUsers).forEach((id) => {
                if (!visibleIds.has(id)) {
                  selectedUsers.delete(id);
                }
              });
              syncSelectAllState();
              syncBulkActionsState();
            }

            function loadRoles({ force = false } = {}) {
              loadSimpleTable({
                key: "roles",
                fetcher: "listRoles",
                tbody: rolesTbody,
                force,
                label: "listRoles",
                normalize: (row = {}) => ({
                  roleId: row.roleId ?? row.Role_Id ?? row.RoleID ?? row.id ?? "",
                  title: row.title ?? row.Role_Title ?? row.role ?? row.name ?? "",
                  description: row.description ?? row.Description ?? "",
                  isSystem: normalizeBool(
                    row.isSystem ??
                      row.Is_System ??
                      row.is_system ??
                      row.isSystemFlag
                  ),
                  updatedAt:
                    row.updatedAt ??
                    row.Updated_At ??
                    row.updated ??
                    row.updated_at ??
                    row.Last_Modified ??
                    "",
                }),
                renderer: (row) => `
                  <td>${escapeHtml(row.roleId || "")}</td>
                  <td>${escapeHtml(row.title || "")}</td>
                  <td>${escapeHtml(row.description || "")}</td>
                  <td>${renderBooleanBadge(row.isSystem)}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                `,
              });
            }

            function loadPermissions({ force = false } = {}) {
              loadSimpleTable({
                key: "permissions",
                fetcher: "listPermissions",
                tbody: permissionsTbody,
                force,
                label: "listPermissions",
                normalize: (row = {}) => ({
                  permissionKey:
                    row.permissionKey ??
                    row.Permission_Key ??
                    row.key ??
                    row.id ??
                    "",
                  label:
                    row.label ??
                    row.Permission_Label ??
                    row.name ??
                    row.Permission ??
                    "",
                  category: row.category ?? row.Category ?? "",
                  description: row.description ?? row.Description ?? "",
                  updatedAt:
                    row.updatedAt ??
                    row.Updated_At ??
                    row.updated ??
                    row.updated_at ??
                    "",
                }),
                renderer: (row) => `
                  <td>${escapeHtml(row.permissionKey || "")}</td>
                  <td>${escapeHtml(row.label || "")}</td>
                  <td>${escapeHtml(row.category || "")}</td>
                  <td>${escapeHtml(row.description || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                `,
              });
            }

            function loadRolePermissions({ force = false } = {}) {
              loadSimpleTable({
                key: "rolePerms",
                fetcher: "listRolePermissions",
                tbody: rolePermsTbody,
                force,
                label: "listRolePermissions",
                normalize: (row = {}) => ({
                  roleId: row.roleId ?? row.Role_Id ?? row.role ?? "",
                  roleTitle:
                    row.roleTitle ??
                    row.Role_Title ??
                    row.roleName ??
                    row.role ??
                    "",
                  permissionKey:
                    row.permissionKey ?? row.Permission_Key ?? row.permission ?? "",
                  permissionLabel:
                    row.permissionLabel ??
                    row.Permission_Label ??
                    row.permissionLabelAr ??
                    row.permission ??
                    "",
                  scope: row.scope ?? row.Scope ?? "",
                  allowed: normalizeBool(row.allowed ?? row.Allowed),
                  updatedAt:
                    row.updatedAt ??
                    row.Updated_At ??
                    row.updated ??
                    row.updated_at ??
                    "",
                }),
                renderer: (row) => {
                  const roleDisplay =
                    row.roleTitle && row.roleId
                      ? `${escapeHtml(row.roleTitle)} (${escapeHtml(row.roleId)})`
                      : escapeHtml(row.roleTitle || row.roleId || "");
                  const permDisplay =
                    row.permissionLabel && row.permissionKey
                      ? `${escapeHtml(row.permissionLabel)} (${escapeHtml(
                          row.permissionKey
                        )})`
                      : escapeHtml(row.permissionLabel || row.permissionKey || "");
                  return `
                    <td>${roleDisplay}</td>
                    <td>${permDisplay}</td>
                    <td>${escapeHtml(row.scope || "")}</td>
                    <td>${renderBooleanBadge(row.allowed, "", "")}</td>
                    <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                  `;
                },
              });
            }

            function loadProperties({ force = false } = {}) {
              loadSimpleTable({
                key: "properties",
                fetcher: "listUserProperties",
                tbody: propertiesTbody,
                force,
                label: "listUserProperties",
                normalize: (row = {}) => ({
                  userId: row.userId ?? row.User_Id ?? row.user ?? "",
                  key: row.key ?? row.Property_Key ?? row.name ?? "",
                  value: row.value ?? row.Property_Value ?? row.Property ?? "",
                  updatedAt:
                    row.updatedAt ??
                    row.Updated_At ??
                    row.updated ??
                    row.updated_at ??
                    "",
                  updatedBy:
                    row.updatedBy ?? row.Updated_By ?? row.actor ?? row.User ?? "",
                }),
                renderer: (row) => `
                  <td>${escapeHtml(row.userId || "")}</td>
                  <td>${escapeHtml(row.key || "")}</td>
                  <td>${escapeHtml(row.value || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                  <td>${escapeHtml(row.updatedBy || "")}</td>
                `,
              });
            }

            function loadSessions({ force = false } = {}) {
              loadSimpleTable({
                key: "sessions",
                fetcher: "listSessions",
                tbody: sessionsTbody,
                force,
                label: "listSessions",
                normalize: (row = {}) => ({
                  sessionId:
                    row.sessionId ?? row.Session_Id ?? row.session ?? row.id ?? "",
                  userId: row.userId ?? row.User_Id ?? row.user ?? "",
                  actor:
                    row.actor ??
                    row.Actor ??
                    row.actorEmail ??
                    row.Actor_Email ??
                    row.Created_By ??
                    "",
                  type: row.type ?? row.Type ?? row.Session_Type ?? "",
                  status: row.status ?? row.Status ?? row.Session_Status ?? "",
                  startedAt:
                    row.startedAt ??
                    row.Started_At ??
                    row.Created_At ??
                    row.start ??
                    "",
                  endedAt:
                    row.endedAt ??
                    row.Ended_At ??
                    row.Revoked_At ??
                    row.end ??
                    row.Last_Seen ??
                    "",
                }),
                renderer: (row) => `
                  <td>${escapeHtml(row.sessionId || "")}</td>
                  <td>${escapeHtml(row.userId || "")}</td>
                  <td>${escapeHtml(row.actor || "")}</td>
                  <td>${escapeHtml(row.type || "")}</td>
                  <td>${escapeHtml(row.status || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.startedAt))}</td>
                  <td>${escapeHtml(formatDateTime(row.endedAt))}</td>
                `,
              });
            }

            function loadAuditLog({ force = false } = {}) {
              loadSimpleTable({
                key: "audit",
                fetcher: "getAuditLog",
                tbody: auditTbody,
                force,
                label: "getAuditLog",
                normalize: (row = {}) => ({
                  timestamp:
                    row.timestamp ??
                    row.Timestamp ??
                    row.Created_At ??
                    row.createdAt ??
                    "",
                  user:
                    row.user ??
                    row.User ??
                    row.actor ??
                    row.Actor ??
                    row.Actor_Email ??
                    "",
                  action: row.action ?? row.Action ?? row.event ?? "",
                  details:
                    row.details ?? row.Details ?? row.Summary ?? row.Message ?? "",
                }),
                renderer: (row) => `
                  <td>${escapeHtml(formatDateTime(row.timestamp))}</td>
                  <td>${escapeHtml(row.user || "")}</td>
                  <td>${escapeHtml(row.action || "")}</td>
                  <td><pre style="white-space:pre-wrap;margin:0;">${escapeHtml(
                    parseDetails(row.details)
                  )}</pre></td>
                `,
              });
            }

            const sysPaneLoaders = {
              overview: ({ force } = {}) => {
                if (force) overviewLoaded = false;
                if (!overviewLoaded) {
                  fetchKPIs();
                  overviewLoaded = true;
                }
              },
              users: (options = {}) => loadUsers(options),
              roles: (options = {}) => loadRoles(options),
              permissions: (options = {}) => loadPermissions(options),
              rolePerms: (options = {}) => loadRolePermissions(options),
              properties: (options = {}) => loadProperties(options),
              sessions: (options = {}) => loadSessions(options),
              audit: (options = {}) => loadAuditLog(options),
            };

            function runPaneLoaders(paneName, options = {}) {
              const loader = sysPaneLoaders[paneName];
              if (loader) loader(options);
            }

            function setActiveSysPane(paneName, options = {}) {
              if (!paneName || !sysPanes.length) return;
              if (paneName === currentSysPane && !options.force) {
                updateSysNavActive(paneName);
                runPaneLoaders(paneName, options);
                return;
              }
              currentSysPane = paneName;
              sysPanes.forEach((pane) => {
                const paneKey = pane.dataset.pane;
                const stacksWith = (pane.dataset.stackWith || "")
                  .split(",")
                  .map((token) => token.trim())
                  .filter(Boolean);
                const shouldShow =
                  paneKey === paneName || stacksWith.includes(paneName);
                pane.classList.toggle("active", shouldShow);
              });
              updateSysNavActive(paneName);
              runPaneLoaders(paneName, options);
            }

            if (sysNav) {
              sysNav.addEventListener("click", (evt) => {
                const btn = evt.target.closest("button[data-pane]");
                if (!btn) return;
                handleSubTabClick(evt);
                const pane = btn.dataset.subId || btn.dataset.pane || "users";
                loadTab(pane);
              });
            }

            function syncSelectAllState() {
              if (!selectAllUsers) return;
              const checkboxes = Array.from(
                usersTbody.querySelectorAll('input.row-select[type="checkbox"]')
              ).filter((cb) => !cb.disabled);
              if (checkboxes.length === 0) {
                selectAllUsers.checked = false;
                selectAllUsers.indeterminate = false;
                return;
              }
              const checkedCount = checkboxes.filter((cb) => cb.checked).length;
              selectAllUsers.checked = checkedCount === checkboxes.length;
              selectAllUsers.indeterminate =
                checkedCount > 0 && checkedCount < checkboxes.length;
            }

            function syncBulkActionsState() {
              const hasSelection = selectedUsers.size > 0;
              if (bulkExportBtn) bulkExportBtn.disabled = !hasSelection;
              if (bulkActivateBtn) bulkActivateBtn.disabled = !hasSelection;
              if (bulkDeactivateBtn) bulkDeactivateBtn.disabled = !hasSelection;
              if (bulkAssignRoleBtn)
                bulkAssignRoleBtn.disabled =
                  !hasSelection || !bulkRoleSelect || !bulkRoleSelect.value;
            }

            function ensureSelection() {
              if (selectedUsers.size === 0) {
                showToast("     .", "info");
                return false;
              }
              return true;
            }

            function performBulkStatus(makeActive) {
              if (!ensureSelection()) return;
              if (!(window.google && google.script && google.script.run)) {
                showToast("  .", "error");
                return;
              }
              const ids = Array.from(selectedUsers);
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("    .", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Bulk status update response:", res);
                  const count = res?.updated ?? ids.length;
                  showToast(
                    "   " + count + " .",
                    "success",
                    " "
                  );
                  selectedUsers.clear();
                  loadUsers();
                })
                .bulkUpdateUserStatus(ids, makeActive);
            }

            function handleBulkAssignRole() {
              if (!bulkRoleSelect || !bulkRoleSelect.value) {
                showToast("   .", "info");
                return;
              }
              if (!ensureSelection()) return;
              if (!(window.google && google.script && google.script.run)) {
                showToast("  .", "error");
                return;
              }
              const ids = Array.from(selectedUsers);
              const roleId = bulkRoleSelect.value;
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("    .", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Bulk role assignment response:", res);
                  const count = res?.updated ?? ids.length;
                  showToast(
                    "    " + count + " .",
                    "success",
                    " "
                  );
                  selectedUsers.clear();
                  loadUsers();
                })
                .bulkAssignRole(ids, roleId);
            }

            function triggerExportDownload(payload) {
              if (!payload || !payload.content) {
                showToast("   .", "info");
                return;
              }
              try {
                const blob = new Blob([payload.content], {
                  type: payload.mimeType || "text/csv",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = payload.filename || "users_export.csv";
                document.body.appendChild(a);
                a.click();
                requestAnimationFrame(() => {
                  URL.revokeObjectURL(url);
                  a.remove();
                });
              } catch (err) {
                console.error(err);
                showToast("   .", "error");
              }
            }

            function handleBulkExport() {
              if (!ensureSelection()) return;
              if (!(window.google && google.script && google.script.run)) {
                showToast("  .", "error");
                return;
              }
              const filters = Object.assign({}, currentFilters(), {
                userIds: Array.from(selectedUsers),
              });
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("   .", "error");
                })
                .withSuccessHandler((payload) => {
                  console.log("Export payload received:", payload);
                  triggerExportDownload(payload);
                  showToast("   .", "success");
                })
                .exportUsers(filters, "csv");
            }

            /* ---------- Global Toast (usable anywhere) ---------- */
            function ensureToastContainer() {
              let c = document.getElementById("toast-container");
              const loginScreen = document.getElementById("login-screen");
              const loginVisible =
                loginScreen && loginScreen.classList.contains("active");
              if (
                c &&
                c.parentElement &&
                c.parentElement !== document.body &&
                !loginVisible
              ) {
                c.id = "login-toast-container";
                c.classList.add("toast-container--login");
                c = null;
              }
              if (!c) {
                c = document.createElement("div");
                c.id = "toast-container";
                c.className = "toast-container";
                c.setAttribute("aria-live", "polite");
                c.setAttribute("aria-atomic", "true");
                document.body.appendChild(c);
              }
              return c;
            }
            function showToast(message, type = "info", title) {
              const toastContainer = ensureToastContainer();
              const t = document.createElement("div");
              t.className = "toast " + type;
              t.innerHTML =
                '<div class="toast__title">' +
                (title || (type === "success" ? " " : "")) +
                '</div><div class="toast__msg">' +
                message +
                "</div>";
              toastContainer.appendChild(t);
              const hide = () => {
                t.classList.add("toast--hide");
                setTimeout(() => t.remove(), 300);
              };
              t.addEventListener("click", hide);
              setTimeout(hide, 3500);
            }

            /* ---------- Create / Edit User ---------- */
            const dlgNew = document.getElementById("dlg-new-user");
            const fieldsHost = document.getElementById("new-user-fields");
            let currentEditId = null; // null=create, value=edit mode
            if (dlgNew) {
              dlgNew.addEventListener("close", () => {
                if (sysUsersViewButton) {
                  sysUsersViewButton.classList.add("is-active");
                }
                if (addUserButton) {
                  addUserButton.classList.remove("is-active");
                }
              });
            }

            if (addUserButton) {
              addUserButton.addEventListener("click", () => {
                if (!(window.google && google.script && google.script.run)) {
                  showToast("  .", "error");
                  return;
                }
                currentEditId = null; // creation mode
                addUserButton.classList.add("is-active");
                if (sysUsersViewButton) {
                  sysUsersViewButton.classList.remove("is-active");
                }
                // Try dynamic form; if empty fallback to minimal static form
                google.script.run
                  .withFailureHandler((err) => {
                    console.error(err);
                    buildMinimalUserForm();
                    dlgNew.showModal();
                  })
                  .withSuccessHandler((fields) => {
                    console.log("Add user form fields received:", fields);
                    if (Array.isArray(fields) && fields.length) {
                      renderDynamicUserForm(fields, null);
                    } else {
                      buildMinimalUserForm();
                    }
                    dlgNew.showModal();
                  })
                  .getFormWithOptions("FORM_SYS_AddUser");
              });
            }

            document
              .getElementById("btn-cancel-new")
              .addEventListener("click", () => dlgNew.close());

            function renderDynamicUserForm(fields, initialData = null) {
              const host = document.getElementById("new-user-fields");
              host.classList.add("dialog-body");
              host.innerHTML = "";
              const layout = document.createElement("div");
              layout.className = "dyn-layout";
              const tabBar = document.createElement("div");
              tabBar.className = "dyn-tabs";
              tabBar.setAttribute("role", "tablist");
              const pages = document.createElement("div");
              pages.className = "dyn-pages";
              layout.appendChild(tabBar);
              layout.appendChild(pages);
              host.appendChild(layout);

              const tabs = {};
              fields.forEach((f) => {
                const tab = f.tabId || f.tabName || "default";
                const sec = f.section || "";
                if (!tabs[tab])
                  tabs[tab] = { name: f.tabName || "", sections: {} };
                if (!tabs[tab].sections[sec]) tabs[tab].sections[sec] = [];
                tabs[tab].sections[sec].push(f);
              });

              function makePage(tabKey, tab, index) {
                const page = document.createElement("div");
                const safeKey = String(tabKey || "tab")
                  .replace(/[^a-zA-Z0-9_-]+/g, "_")
                  .toLowerCase();
                page.className = "form-grid dyn-page hidden";
                page.id = `dyn-tab-${index}-${safeKey}`;
                page.setAttribute("role", "tabpanel");
                page.setAttribute("aria-hidden", "true");
                Object.keys(tab.sections).forEach((sec) => {
                  if (sec) {
                    const h = document.createElement("div");
                    h.className = "span-2 muted";
                    h.style.margin = ".4rem 0 .2rem";
                    h.textContent = sec;
                    page.appendChild(h);
                  }
                  tab.sections[sec].forEach((f, i) => {
                    const id = `nu_${(
                      f.targetColumn ||
                      f.fieldId ||
                      tabKey + i
                    ).replace(/\s+/g, "_")}`;
                    const wrap = document.createElement("div");
                    const label = document.createElement("label");
                    label.textContent =
                      f.label || f.targetColumn || f.fieldId || " " + (i + 1);
                    label.setAttribute("for", id);
                    let el;
                    const t = String(f.type || "text").toLowerCase();
                    const isPassword =
                      f.targetColumn === "Password_Hash" ||
                      f.targetColumn === "password" ||
                      /password/i.test(f.fieldId || "");
                    if (currentEditId && isPassword) return; //       
                    if (t === "dropdown") {
                      el = document.createElement("select");
                      (f.options || []).forEach((opt) => {
                        const o = document.createElement("option");
                        o.value = opt.value;
                        o.textContent = opt.label || opt.value;
                        el.appendChild(o);
                      });
                    } else if (t === "textarea" || t === "paragraph") {
                      el = document.createElement("textarea");
                      el.rows = 4;
                      wrap.classList.add("span-2");
                    } else if (t === "auto") {
                      el = document.createElement("input");
                      el.type = "text";
                      el.readOnly = true;
                      el.placeholder = "AutoGenerate";
                    } else if (t === "password" || isPassword) {
                      el = document.createElement("input");
                      el.type = "password";
                      el.autocomplete = initialData
                        ? "current-password"
                        : "new-password";
                    } else {
                      el = document.createElement("input");
                      el.type = t === "email" ? "email" : "text";
                    }
                    el.name = f.targetColumn || f.fieldId || id;
                    el.id = id;
                    if (f.readOnly) {
                      el.readOnly = true;
                      el.setAttribute("aria-readonly", "true");
                    }
                    if (f.required && !el.readOnly) el.required = true;
                    if (initialData) {
                      const k = f.targetColumn || f.fieldId;
                      if (k && initialData[k] != null) el.value = initialData[k];
                      if (k === "User_Id") el.readOnly = true;
                    } else if (
                      f.defaultValue !== undefined &&
                      f.defaultValue !== null &&
                      String(f.defaultValue) !== ""
                    ) {
                      el.value = f.defaultValue;
                    }
                    if (
                      !initialData &&
                      (f.targetColumn === "User_Id" ||
                        /User_Id/i.test(f.fieldId || ""))
                    ) {
                      if (window.google && google.script && google.script.run) {
                        google.script.run
                          .withSuccessHandler((nextId) => {
                            el.value = nextId;
                            el.readOnly = true;
                          })
                          .getNextUserId();
                      }
                    }
                    if (
                      /Notes|/i.test(f.fieldId || "") ||
                      /Notes|/i.test(f.targetColumn || "")
                    ) {
                      wrap.classList.add("span-2");
                    }
                    wrap.appendChild(label);
                    wrap.appendChild(el);
                    page.appendChild(wrap);
                  });
                });
                return page;
              }

              const tabKeys = Object.keys(tabs);
              const pagesEls = tabKeys.map((k, idx) => makePage(k, tabs[k], idx));
              pagesEls.forEach((p) => pages.appendChild(p));
              const tabButtons = [];
              const activateTab = (targetIdx) => {
                pagesEls.forEach((page, idx) => {
                  const isActive = idx === targetIdx;
                  page.classList.toggle("hidden", !isActive);
                  page.setAttribute("aria-hidden", isActive ? "false" : "true");
                });
                tabButtons.forEach((btn, idx) => {
                  const isActive = idx === targetIdx;
                  btn.classList.toggle("active", isActive);
                  btn.setAttribute("aria-selected", isActive ? "true" : "false");
                  btn.tabIndex = isActive ? 0 : -1;
                });
              };

              tabKeys.forEach((k, idx) => {
                const b = document.createElement("button");
                b.type = "button";
                b.className = "nav-item" + (idx === 0 ? " active" : "");
                b.textContent = tabs[k].name || "";
                b.setAttribute("role", "tab");
                b.setAttribute("aria-selected", idx === 0 ? "true" : "false");
                b.setAttribute("aria-controls", pagesEls[idx].id);
                b.tabIndex = idx === 0 ? 0 : -1;
                b.addEventListener("click", () => activateTab(idx));
                b.addEventListener("keydown", (evt) => {
                  if (evt.key === "ArrowLeft" || evt.key === "ArrowUp") {
                    evt.preventDefault();
                    const prev = (idx - 1 + tabButtons.length) % tabButtons.length;
                    activateTab(prev);
                    tabButtons[prev].focus();
                  } else if (evt.key === "ArrowRight" || evt.key === "ArrowDown") {
                    evt.preventDefault();
                    const next = (idx + 1) % tabButtons.length;
                    activateTab(next);
                    tabButtons[next].focus();
                  }
                });
                tabBar.appendChild(b);
                tabButtons.push(b);
              });

              if (tabKeys.length) {
                activateTab(0);
              }
            }

            function buildMinimalUserForm(initialData = null) {
              fieldsHost.innerHTML = "";
              fieldsHost.classList.add("dialog-body");
              const grid = document.createElement("div");
              grid.className = "form-grid";
              const isEdit = !!initialData;
              grid.innerHTML = `
                <div><label> </label><input id="nu_uid" name="User_Id" type="text" ${
                  isEdit ? "" : "readonly"
                } autocomplete="off" placeholder="AutoGenerate" /></div>
                <div><label> </label><input name="Full_Name" type="text" required /></div>
                <div><label> </label><input name="Username" type="text" required /></div>
                <div><label> </label><input name="Email" type="email" /></div>
                <div><label></label><select id="nu_dept" name="Department"></select></div>
                <div><label></label><select id="nu_role" name="Role_Id"></select></div>
                <div class="span-2"><label></label><textarea name="Notes" rows="3"></textarea></div>
                <div><label></label><select name="IsActive"><option value="true"></option><option value="false"></option></select></div>
                ${
                  isEdit
                    ? ""
                    : '<div><label> </label><input name="password" type="password" autocomplete="new-password" required /></div>'
                }`;
              fieldsHost.appendChild(grid);
              // next id & filters
              if (window.google && google.script && google.script.run) {
                if (!isEdit) {
                  google.script.run
                    .withSuccessHandler((nextId) => {
                      console.log("Next user ID received:", nextId);
                      const el = document.getElementById("nu_uid");
                      if (el) {
                        el.value = nextId;
                      }
                    })
                    .getNextUserId();
                }
                google.script.run
                  .withSuccessHandler((f) => {
                    console.log("Dynamic form filters received:", f);
                    const d = f?.departments || [];
                    const r = f?.roles || [];
                    const dSel = document.getElementById("nu_dept");
                    const rSel = document.getElementById("nu_role");
                    [d, r].forEach((arr, idx) => {
                      const sel = idx === 0 ? dSel : rSel;
                      sel.innerHTML =
                        '<option value=""></option>' +
                        (arr || [])
                          .map((v) => `<option value="${v}">${v}</option>`)
                          .join("");
                    });
                    if (initialData) {
                      if (initialData.Department)
                        dSel.value = initialData.Department;
                      if (initialData.Role_Id) rSel.value = initialData.Role_Id;
                    }
                  })
                  .getDeptAndRoleFilters();
              }
              if (initialData) {
                Object.keys(initialData).forEach((k) => {
                  const el = grid.querySelector(`[name="${k}"]`);
                  if (el) {
                    el.value = initialData[k];
                  }
                });
                const idEl = grid.querySelector("#nu_uid");
                if (idEl) {
                  idEl.readOnly = true;
                }
              }
            }

            //   (  )
            document
              .getElementById("new-user-form")
              .addEventListener("submit", (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const payload = {};
                for (const [k, v] of fd.entries()) {
                  if (k === "IsActive") {
                    payload[k] =
                      v === "true" || v === "Yes" || v === "" || v === "Active";
                  } else if (k === "password") {
                    payload.password = v;
                  } else {
                    payload[k] = v;
                  }
                }
                if (!(window.google && google.script && google.script.run)) {
                  showToast("  .", "error");
                  return;
                }
                if (currentEditId) {
                  payload.User_Id = payload.User_Id || currentEditId;
                  google.script.run
                    .withFailureHandler((err) => {
                      console.error(err);
                      showToast("  .", "error");
                    })
                    .withSuccessHandler((res) => {
                      console.log("Update user response:", res);
                      showToast("   .", "success");
                      dlgNew.close();
                      e.target.reset();
                      loadUsers();
                    })
                    .updateUser(payload);
                } else {
                  google.script.run
                    .withFailureHandler((err) => {
                      console.error(err);
                      showToast("  .", "error");
                    })
                    .withSuccessHandler((res) => {
                      console.log("Create user response:", res);
                      showToast("   .", "success");
                      dlgNew.close();
                      e.target.reset();
                      loadUsers();
                    })
                    .createUser(payload);
                }
              });

            function openUserEditor(userId) {
              currentEditId = userId;
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("   .", "error");
                })
                .withSuccessHandler((user) => {
                  console.log("User profile for edit received:", user);
                  if (!user) {
                    showToast("    .", "error");
                    return;
                  }
                  const handleForm = (fields) => {
                    console.log("Edit user form fields received:", fields);
                    if (Array.isArray(fields) && fields.length) {
                      renderDynamicUserForm(fields, user);
                    } else {
                      buildMinimalUserForm(user);
                    }
                    dlgNew.showModal();
                  };
                  google.script.run
                    .withFailureHandler((err2) => {
                      console.error(err2);
                      buildMinimalUserForm(user);
                      dlgNew.showModal();
                    })
                    .withSuccessHandler(handleForm)
                    .getFormWithOptions("FORM_SYS_EditUser");
                })
                .getUserById(userId);
            }

            function ensureRoleOptionsLoaded(callback) {
              const bootstrapRoles = (() => {
                if (bootstrapData?.filters?.roleOptions?.length) {
                  return bootstrapData.filters.roleOptions;
                }
                if (bootstrapData?.filters?.roles?.length) {
                  return bootstrapData.filters.roles.map((value) => ({
                    value,
                    label: value,
                  }));
                }
                return [];
              })();
              const cached =
                (roleOptionsCache && roleOptionsCache.length
                  ? roleOptionsCache
                  : bootstrapRoles) || [];
              if (cached.length) {
                roleOptionsCache = cached;
                callback(roleOptionsCache);
                return;
              }
              if (!(window.google && google.script && google.script.run)) {
                callback([]);
                return;
              }
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  callback([]);
                })
                .withSuccessHandler((options) => {
                  console.log("Role options received:", options);
                  roleOptionsCache = Array.isArray(options) ? options : [];
                  callback(roleOptionsCache);
                })
                .getRoleOptions();
            }

            function describeUserForLabel(userId) {
              const match = normalizedUsersCache.find((u) => u.userId === userId);
              if (!match) return userId;
              const pieces = [];
              if (match.fullName) pieces.push(match.fullName);
              if (match.username) pieces.push(`(${match.username})`);
              const joined = pieces.join(" ").trim();
              return joined || userId;
            }

            function openAssignRoleDialog(userId) {
              assignRoleUserInput.value = userId;
              assignRoleUserLabel.textContent = `: ${describeUserForLabel(
                userId
              )}`;
              ensureRoleOptionsLoaded((options) => {
                assignRoleSelect.innerHTML = '<option value=""> </option>';
                fillSelect(assignRoleSelect, options);
                const match = normalizedUsersCache.find((u) => u.userId === userId);
                if (match?.role) {
                  assignRoleSelect.value = match.role;
                }
                dlgAssign.showModal();
              });
            }

            function setProfileTab(tabName = "profile") {
              profileTabButtons.forEach((btn) => {
                btn.classList.toggle("active", btn.dataset.tab === tabName);
              });
              profilePanels.forEach((panel) => {
                panel.classList.toggle("active", panel.dataset.tab === tabName);
              });
            }

            profileTabButtons.forEach((btn) => {
              btn.addEventListener("click", () => {
                const tab = btn.dataset.tab || "profile";
                setProfileTab(tab);
              });
            });

            if (btnCloseProfile)
              btnCloseProfile.addEventListener("click", () => dlgProfile.close());
            if (btnCancelAssign)
              btnCancelAssign.addEventListener("click", () => dlgAssign.close());
            if (dlgProfile)
              dlgProfile.addEventListener("close", () => {
                currentProfileUserId = null;
                profileDataCache = null;
              });

            if (formAssignRole)
              formAssignRole.addEventListener("submit", (e) => {
                e.preventDefault();
                const userId = assignRoleUserInput.value;
                const roleId = assignRoleSelect.value;
                if (!userId || !roleId) {
                  showToast("  .", "info");
                  return;
                }
                google.script.run
                  .withFailureHandler((err) => {
                    console.error(err);
                    showToast("    .", "error");
                  })
                  .withSuccessHandler((res) => {
                    console.log("Assign user role response:", res);
                    showToast("   .", "success");
                    dlgAssign.close();
                    loadUsers();
                  })
                  .assignUserRole(userId, roleId);
              });

            function renderDefinitionList(listEl, rows) {
              if (!listEl) return;
              listEl.innerHTML = "";
              rows
                .filter((row) => row && row.label)
                .forEach((row) => {
                  const dt = document.createElement("dt");
                  dt.textContent = row.label;
                  const dd = document.createElement("dd");
                  dd.textContent = row.value ?? "";
                  listEl.appendChild(dt);
                  listEl.appendChild(dd);
                });
            }

            function renderTableRows(bodyEl, rows, renderRow) {
              if (!bodyEl) return;
              bodyEl.innerHTML = "";
              if (!rows || !rows.length) {
                const empty = document.createElement("tr");
                const td = document.createElement("td");
                td.colSpan = bodyEl.parentElement
                  ? bodyEl.parentElement.querySelectorAll("thead th").length || 1
                  : 1;
                td.className = "profile-empty";
                td.textContent = "  ";
                empty.appendChild(td);
                bodyEl.appendChild(empty);
                return;
              }
              const frag = document.createDocumentFragment();
              rows.forEach((row) => {
                const tr = document.createElement("tr");
                tr.innerHTML = renderRow(row || {});
                frag.appendChild(tr);
              });
              bodyEl.appendChild(frag);
            }

            function normalizeBool(val) {
              if (val === true) return true;
              if (val === false) return false;
              const str = String(val || "").toLowerCase();
              return (
                str === "true" ||
                str === "yes" ||
                str === "" ||
                str === "1" ||
                str === "enabled" ||
                str === "" ||
                str === "" ||
                str === "active"
              );
            }

            function parseDetails(details) {
              if (!details) return "";
              if (typeof details === "string") {
                try {
                  const parsed = JSON.parse(details);
                  if (parsed && typeof parsed === "object") {
                    return JSON.stringify(parsed, null, 2);
                  }
                } catch (err) {
                  return details;
                }
                return details;
              }
              if (typeof details === "object") {
                try {
                  return JSON.stringify(details, null, 2);
                } catch (err) {
                  return String(details);
                }
              }
              return String(details);
            }

            function renderUserProfileDialog(payload, defaultTab = "profile") {
              if (!payload) return;
              const user = payload.user || {};
              profileTitle.textContent =
                user.Full_Name || user.Username || user.User_Id || "";
              profileUsername.textContent = user.Username
                ? `@${user.Username}`
                : "";
              renderDefinitionList(profileOverviewList, [
                { label: " ", value: user.Full_Name || "" },
                { label: " ", value: user.Username || "" },
                { label: " ", value: user.Email || "" },
                { label: "", value: user.Department || "" },
                { label: "", value: user.Role_Id || "" },
                {
                  label: "",
                  value: normalizeBool(user.IsActive) ? "" : "",
                },
                {
                  label: " MFA",
                  value: normalizeBool(user.MFA_Enabled) ? "" : " ",
                },
                {
                  label: "  ",
                  value: formatDateTime(user.Last_Login || user.lastLogin),
                },
                {
                  label: " ",
                  value: formatDateTime(user.Created_At || user.createdAt),
                },
                {
                  label: " ",
                  value: formatDateTime(user.Updated_At || user.updatedAt),
                },
                { label: "", value: user.Notes || "" },
              ]);

              renderTableRows(profilePropertiesBody, payload.properties, (row) => {
                return `
                  <td>${escapeHtml(row.key || "")}</td>
                  <td>${escapeHtml(row.value || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                  <td>${escapeHtml(row.updatedBy || "")}</td>
                `;
              });

              renderTableRows(profileDocumentsBody, payload.documents, (row) => {
                const label = row.label || row.fileName || "";
                const link = row.url
                  ? `<a class="profile-doc-link" href="${escapeHtml(
                      row.url
                    )}" target="_blank" rel="noopener"></a>`
                  : "";
                return `
                  <td>${escapeHtml(label)}</td>
                  <td>${escapeHtml(row.uploadedBy || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.createdAt))}</td>
                  <td>${link}</td>
                `;
              });

              renderTableRows(profileSessionsBody, payload.sessions, (row) => {
                return `
                  <td>${escapeHtml(row.sessionId || "")}</td>
                  <td>${escapeHtml(row.actor || "")}</td>
                  <td>${escapeHtml(row.type || "")}</td>
                  <td>${escapeHtml(row.status || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.startedAt))}</td>
                  <td>${escapeHtml(formatDateTime(row.endedAt))}</td>
                `;
              });

              renderTableRows(profileAuditBody, payload.audit, (row) => {
                return `
                  <td>${escapeHtml(formatDateTime(row.timestamp))}</td>
                  <td>${escapeHtml(row.actor || "")}</td>
                  <td>${escapeHtml(row.action || "")}</td>
                  <td><pre style="white-space:pre-wrap;margin:0;">${escapeHtml(
                    parseDetails(row.details)
                  )}</pre></td>
                `;
              });

              setProfileTab(defaultTab);
              dlgProfile.showModal();
            }

            function openUserProfile(userId, tabName = "profile") {
              currentProfileUserId = userId;
              profileDataCache = null;
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("   .", "error");
                })
                .withSuccessHandler((payload) => {
                  console.log("User profile payload received:", payload);
                  if (!payload || !payload.user) {
                    showToast("    .", "error");
                    return;
                  }
                  profileDataCache = payload;
                  renderUserProfileDialog(payload, tabName);
                })
                .getUserProfile(userId);
            }

            function startImpersonationFlow(userId) {
              if (!userId) return;
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("   .", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Impersonation start response:", res);
                  const sessionId = res?.sessionId || "";
                  showToast(
                    sessionId
                      ? `    (${sessionId}).`
                      : "  .",
                    "success"
                  );
                  if (currentProfileUserId === userId && profileDataCache) {
                    openUserProfile(userId, "sessions");
                  }
                })
                .startImpersonation(userId);
            }

            function performSoftDelete(userId) {
              const confirmed = confirm("      ");
              if (!confirmed) return;
              const reason = prompt("    ():", "") || "";
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("  .", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Soft delete response:", res);
                  showToast("     .", "success");
                  loadUsers();
                  if (currentProfileUserId === userId && profileDataCache) {
                    openUserProfile(userId, "profile");
                  }
                })
                .softDeleteUser(userId, reason);
            }

            /* Welcome label shows Full_Name (Username) when available */
            function updateUserContext(identity) {
              if (!userLabel) return;
              let display = "";
              let username = "";

              if (identity && typeof identity === "object") {
                const normalizedFull =
                  identity.Full_Name ||
                  identity.fullName ||
                  identity.Name ||
                  identity.name ||
                  identity.displayName ||
                  "";
                const normalizedUser =
                  identity.Username ||
                  identity.username ||
                  identity.UserName ||
                  identity.userName ||
                  identity.Email ||
                  identity.email ||
                  "";
                display = normalizedFull || "";
                username = normalizedUser || "";
                lastLoginIdentity = {
                  Full_Name: normalizedFull || "",
                  Username: normalizedUser || normalizedFull || "",
                };
              } else if (typeof identity === "string") {
                const trimmed = identity.trim();
                if (trimmed) {
                  display = trimmed;
                  if (trimmed !== "User" || !lastLoginIdentity) {
                    lastLoginIdentity = {
                      Full_Name: trimmed,
                      Username: trimmed,
                    };
                  }
                }
              } else if (identity != null) {
                const text = String(identity).trim();
                if (text) {
                  display = text;
                  if (text !== "User" || !lastLoginIdentity) {
                    lastLoginIdentity = {
                      Full_Name: text,
                      Username: text,
                    };
                  }
                }
              }

              if (!display && lastLoginIdentity) {
                display =
                  lastLoginIdentity.Full_Name || lastLoginIdentity.Username || "";
                username = lastLoginIdentity.Username || username;
              }

              if (!display) display = "User";
              if (!username && lastLoginIdentity) {
                username = lastLoginIdentity.Username || "";
              }

              const suffix =
                username && username !== display ? ` (${username})` : "";
              userLabel.innerHTML = "";
              const iconSpan = document.createElement("span");
              iconSpan.className = "icon-wrapper";
              iconSpan.appendChild(createIconElement("userProps", { size: 18 }));
              userLabel.appendChild(iconSpan);
              const textSpan = document.createElement("span");
              textSpan.className = "navbar-user__text";
              textSpan.textContent = `User: ${display}${suffix}`;
              userLabel.appendChild(textSpan);
              userLabel.setAttribute("title", `${display}${suffix}`.trim());
              const welcome = document.getElementById("portal-welcome-message");
              if (welcome) welcome.textContent = `Welcome, ${display}${suffix}`;
            }

            // Set up sys nav event handlers
            /* Init */
            renderNav();
            renderSysNav();
            renderModuleGrid();
            setActiveSysPane("overview", { force: true });
            bootstrapApp();
          })();
    </script>
  </body>
</html>
