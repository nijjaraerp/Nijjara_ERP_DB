<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nijjara ERP - Demo Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-bg: #121212;
        --color-bg-panel: #1e1e1e;
        --color-border: rgba(255, 255, 255, 0.1);
        --color-text-primary: #f0f0f0;
        --color-text-secondary: #a0a0a0;
        --color-accent: #d4af37;
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
        --color-success: #2ecc71;
        --color-danger: #e74c3c;
        --font-family-arabic: "Cairo", sans-serif;
      }
      .module-card h2,
      .nav-btn,
      .nav-item,
      .portal-header h1,
      .portal-header p,
      .workspace-title,
      body,
      button,
      html,
      input,
      select,
      table,
      td,
      textarea,
      th {
        font-family: var(--font-family-arabic) !important;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
        background: var(--color-bg);
        color: var(--color-text-primary);
        overflow: hidden;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
      .view {
        position: fixed;
        inset: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.45s ease, visibility 0.45s;
      }
      .view.active {
        opacity: 1;
        visibility: visible;
      }
      #login-screen {
        display: grid;
        place-content: center;
        background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%232a2a2a" fill-opacity="0.2"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v-1zm-7 5h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zM54 95h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zM9 95h1v4h-1v-4zm-7 0h1v4H2v-4zM95 0h1v4h-1V0zM2 0h1v4H2V0z"/%3E%3Cpath d="M6 95h4v1H6v-1zM4 95h1v4H4v-4zM95 6h1v4h-1V6zM95 4h1v1h-1V4z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
      }
      .login-container {
        width: 400px;
        max-width: 92vw;
        padding: 3rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.88);
        backdrop-filter: blur(10px);
        animation: fadeIn 0.6s ease;
        position: relative;
      }
      .logo {
        font-size: 2.4rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
      }
      .logo span {
        color: var(--color-accent);
        font-weight: 600;
      }
      .form-group {
        margin-bottom: 1.2rem;
        text-align: right;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.4rem;
        font-size: 0.95rem;
        color: var(--color-text-secondary);
      }
      .form-group input {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 1px solid var(--color-border);
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-text-primary);
        font-size: 1rem;
        outline: 0;
        transition: border-color 0.25s, box-shadow 0.25s;
      }
      .form-group input:focus {
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
      }
      .main-button {
        width: 100%;
        padding: 0.9rem 1.2rem;
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 14px;
        background: linear-gradient(
          160deg,
          rgba(212, 175, 55, 0.92),
          rgba(164, 135, 34, 0.85)
        );
        color: #111;
        font-weight: 700;
        cursor: pointer;
        position: relative;
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.35);
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      }
      .main-button:hover {
        transform: translateY(-3px);
        border-color: rgba(255, 255, 255, 0.45);
      }
      .main-button:active {
        transform: translateY(-1px);
      }
      .main-button .spinner {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid #000;
        border-top-color: transparent;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: spin 0.8s linear infinite;
      }
      .main-button.loading .spinner {
        display: block;
      }
      .main-button.loading span {
        visibility: hidden;
      }

      .app-navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(18, 18, 18, 0.98);
        border-bottom: 1px solid var(--color-border);
        padding: 0 2rem;
        z-index: 50;
      }
      .app-navbar.hidden {
        display: none;
      }
      .app-navbar__left,
      .app-navbar__right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .navbar-buttons {
        display: inline-flex;
        gap: 0.5rem;
        margin-inline-start: 1rem;
      }
      .app-brand {
        font-weight: 700;
        color: var(--color-accent);
      }
      .nav-btn {
        background: 0 0;
        border: none;
        color: var(--color-text-secondary);
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }
      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--color-text-primary);
      }
      .nav-btn.active {
        background: rgba(212, 175, 55, 0.18);
        color: var(--color-accent);
      }
      .navbar-user {
        color: var(--color-text-secondary);
      }

      #portal-view {
        padding: 5.5rem 2rem 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .portal-header {
        text-align: center;
        margin-bottom: 2.2rem;
      }
      .module-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(180px, 1fr));
        gap: 1.5rem;
        max-width: 1100px;
        width: 100%;
      }
      .module-card {
        --card-primary: rgba(36, 36, 36, 0.92);
        --card-secondary: rgba(17, 17, 17, 0.88);
        --card-border: rgba(255, 255, 255, 0.1);
        --card-glow: rgba(255, 255, 255, 0.12);
        position: relative;
        padding: 2rem 1.6rem;
        border: 1px solid var(--card-border);
        border-radius: 16px;
        background: linear-gradient(
          160deg,
          var(--card-primary),
          var(--card-secondary)
        );
        box-shadow: 0 18px 32px rgba(0, 0, 0, 0.55),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        text-align: center;
      }
      .module-card:hover {
        transform: translateY(-8px);
        border-color: var(--card-glow);
      }
      .module-card h2 {
        font-size: 1.3rem;
      }
      .module-card[data-theme="projects"] {
        --card-primary: rgba(40, 52, 82, 0.92);
        --card-secondary: rgba(22, 30, 50, 0.88);
        --card-border: rgba(90, 140, 255, 0.28);
        --card-glow: rgba(90, 140, 255, 0.4);
      }
      .module-card[data-theme="finance"] {
        --card-primary: rgba(55, 45, 26, 0.92);
        --card-secondary: rgba(34, 28, 16, 0.88);
        --card-border: rgba(210, 170, 80, 0.28);
        --card-glow: rgba(210, 170, 80, 0.4);
      }
      .module-card[data-theme="hr"] {
        --card-primary: rgba(36, 54, 48, 0.92);
        --card-secondary: rgba(19, 33, 28, 0.88);
        --card-border: rgba(102, 214, 168, 0.28);
        --card-glow: rgba(102, 214, 168, 0.4);
      }
      .module-card[data-theme="users"] {
        --card-primary: rgba(46, 33, 52, 0.92);
        --card-secondary: rgba(27, 18, 32, 0.88);
        --card-border: rgba(200, 110, 210, 0.28);
        --card-glow: rgba(200, 110, 210, 0.4);
      }

      .workspace {
        height: 100vh;
        display: grid;
        grid-template-columns: 1fr 280px;
        grid-template-rows: auto 1fr;
        grid-template-areas: "header header" "content nav";
        gap: 1.25rem;
        padding: 5.5rem 2rem 2rem;
        transform: scale(1.04);
        transition: transform 0.45s ease;
      }
      .view.active .workspace {
        transform: scale(1);
      }
      .workspace-header {
        grid-area: header;
        display: flex;
        align-items: end;
        justify-content: space-between;
      }
      .workspace-title {
        font-size: 1.6rem;
      }
      .workspace-content {
        grid-area: content;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(18, 18, 18, 0.9);
        padding: 1.25rem;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .workspace {
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
      }
      .workspace[data-theme="projects"] {
        --theme-accent: #5a8cff;
        --theme-accent-16: rgba(90, 140, 255, 0.16);
        --theme-accent-24: rgba(90, 140, 255, 0.24);
      }
      .workspace[data-theme="finance"] {
        --theme-accent: #d2aa50;
        --theme-accent-16: rgba(210, 170, 80, 0.16);
        --theme-accent-24: rgba(210, 170, 80, 0.24);
      }
      .workspace[data-theme="hr"] {
        --theme-accent: #66d6a8;
        --theme-accent-16: rgba(102, 214, 168, 0.16);
        --theme-accent-24: rgba(102, 214, 168, 0.24);
      }
      .workspace[data-theme="users"] {
        --theme-accent: #c86ed2;
        --theme-accent-16: rgba(200, 110, 210, 0.16);
        --theme-accent-24: rgba(200, 110, 210, 0.24);
      }
      .workspace-nav {
        grid-area: nav;
        border: 1px solid var(--theme-accent-24);
        border-radius: 12px;
        background: rgba(18, 18, 18, 0.9);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .nav-item {
        background: transparent;
        border: 1px solid var(--theme-accent-24);
        color: var(--color-text-secondary);
        text-align: right;
        padding: 0.6rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
        font-weight: 600;
      }
      .nav-item.active,
      .nav-item:hover {
        background: var(--theme-accent);
        border-color: var(--theme-accent);
        color: #111;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.2) inset;
      }
      .nav-item:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 2px;
      }

      .sys-pane {
        display: none;
        flex-direction: column;
        gap: 1.5rem;
      }
      .sys-pane.active {
        display: flex;
      }
      .sys-pane__header {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .pane-heading {
        font-size: 1.1rem;
        font-weight: 600;
      }
      .sys-overview__summary {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .overview-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.8rem;
        margin-bottom: 0;
      }
      .overview-card {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.9);
        padding: 1rem;
      }
      .muted {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
      }
      .error-text {
        color: var(--color-danger);
        font-size: 0.95rem;
        text-align: center;
      }
      .table-wrapper {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: rgba(255, 255, 255, 0.04);
      }
      td,
      th {
        padding: 0.65rem 0.9rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        text-align: right;
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.04);
      }
      .ghost-button,
      .accent-button,
      .action-button {
        padding: 0.55rem 1rem;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }
      .ghost-button {
        background: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-secondary);
      }
      .ghost-button:hover {
        color: var(--color-text-primary);
        border-color: var(--theme-accent-24);
      }
      .accent-button {
        background: var(--theme-accent);
        color: #111;
        border: 1px solid var(--theme-accent-24);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }
      .accent-button:hover {
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
      }
      .action-button {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid transparent;
        color: #111;
      }
      .save-button {
        background: var(--color-success);
        border-color: rgba(46, 204, 113, 0.4);
        color: #111;
      }
      .cancel-button {
        background: var(--color-danger);
        border-color: rgba(231, 76, 60, 0.4);
        color: #fff;
      }
      .edit-button {
        background: #e67e22;
        border-color: rgba(230, 126, 34, 0.4);
        color: #111;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.8rem;
        border: 1px solid transparent;
      }
      .badge--ok {
        background: rgba(46, 204, 113, 0.15);
        color: #2ecc71;
        border-color: rgba(46, 204, 113, 0.3);
      }
      .badge--no {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
        border-color: rgba(231, 76, 60, 0.3);
      }
      .icon-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }
      .icon-btn {
        width: 32px;
        height: 32px;
        display: inline-grid;
        place-items: center;
        border: 1px solid var(--color-border);
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .icon-btn svg {
        width: 16px;
        height: 16px;
        fill: none;
        stroke: #cfcfcf;
        stroke-width: 1.6;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      dialog .form-grid textarea {
        width: 100%;
        min-height: 110px;
        resize: vertical;
      }
      dialog .form-grid .span-2 {
        grid-column: 1 / span 2;
      }

      .profile-dialog__header {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        margin-bottom: 0.8rem;
      }
      .profile-dialog__username {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
      }
      .profile-tabs {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.8rem;
        flex-wrap: wrap;
      }
      .profile-tabs .nav-item {
        border: 1px solid var(--color-border);
      }
      .profile-tabs .nav-item.active {
        background: var(--color-accent);
        color: #111;
        border-color: transparent;
      }
      .profile-panels {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.25);
        max-height: 340px;
        overflow: auto;
      }
      .profile-panel {
        display: none;
      }
      .profile-panel.active {
        display: block;
      }
      .profile-dl {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 0.4rem 0.8rem;
      }
      .profile-dl dt {
        color: var(--color-text-secondary);
      }
      .profile-dl dd {
        margin: 0;
      }
      .profile-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }
      .profile-table th,
      .profile-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.45rem 0.6rem;
        text-align: right;
      }
      .profile-table tbody tr:last-child td {
        border-bottom: none;
      }
      .profile-empty {
        text-align: center;
        color: var(--color-text-secondary);
        padding: 1rem 0;
      }
      .profile-doc-link {
        color: var(--color-accent);
        text-decoration: none;
      }

      /* Toasts (under login button) */
      #login-screen .toast-container {
        position: absolute;
        top: 100%;
        inset-inline-start: 50%;
        transform: translateX(-50%);
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        z-index: 1000;
      }
      /* Toasts (app views) */
      body > .toast-container {
        position: fixed;
        top: 16px;
        inset-inline-end: 16px;
        inset-inline-start: auto;
        transform: none;
        margin-top: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        z-index: 10000;
      }
      .toast {
        min-width: 260px;
        max-width: 360px;
        padding: 0.9rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.96);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
        color: var(--color-text-primary);
        opacity: 0;
        transform: translateY(12px);
        animation: toast-in 0.25s ease forwards;
      }
      .toast.success {
        border-color: rgba(46, 204, 113, 0.35);
        background: rgba(46, 204, 113, 0.12);
      }
      .toast.error {
        border-color: rgba(231, 76, 60, 0.35);
        background: rgba(231, 76, 60, 0.12);
      }
      .toast.info {
        border-color: rgba(212, 175, 55, 0.35);
        background: rgba(212, 175, 55, 0.12);
      }
      .toast__title {
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      .toast__msg {
        font-size: 0.95rem;
        color: var(--color-text-secondary);
      }
      .toast--hide {
        animation: toast-out 0.3s ease forwards;
      }
      @keyframes toast-in {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes toast-out {
        to {
          opacity: 0;
          transform: translateY(12px);
        }
      }

      .hidden {
        display: none !important;
      }
      .row-actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .kpi-value {
        font-size: 1.6rem;
      }
      .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin: 0 0 1rem 0;
        flex-wrap: wrap;
      }
      .toolbar input,
      .toolbar select {
        padding: 0.5rem 0.7rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--color-text-primary);
      }
      .toolbar-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .toolbar--bulk {
        justify-content: flex-start;
        margin-top: -0.5rem;
        margin-bottom: 1rem;
      }
      .toolbar--bulk .ghost-button,
      .toolbar--bulk select {
        min-width: 110px;
      }
      .toolbar--bulk select:disabled,
      .toolbar--bulk button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .select-cell {
        width: 44px;
        text-align: center;
      }
      .select-cell input {
        width: 16px;
        height: 16px;
      }
      dialog[open] {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: #191919;
        color: var(--color-text-primary);
        padding: 1rem 1.2rem;
        max-width: 860px;
        width: 95vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(2px);
      }
      dialog form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex: 1;
        min-height: 0;
      }
      dialog .dialog-body {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding-right: 0.2rem;
      }
      dialog .dialog-body .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.8rem;
        direction: rtl;
      }
      dialog .dialog-body label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }
      dialog .dialog-body input,
      dialog .dialog-body select,
      dialog .dialog-body textarea {
        width: 100%;
        padding: 0.55rem 0.7rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--color-text-primary);
      }
      dialog .dialog-body .span-2 {
        grid-column: 1 / -1;
      }
      dialog .actions {
        display: flex;
        gap: 0.6rem;
        justify-content: flex-start;
        margin-top: 0.5rem;
      }

      /* dynamic form layout */
      .dyn-layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 1rem;
        align-items: stretch;
        width: 100%;
        min-height: 320px;
      }
      .dyn-tabs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.2);
        overflow-y: auto;
      }
      .dyn-tabs .nav-item {
        width: 100%;
        text-align: right;
        padding: 0.55rem 0.8rem;
        border-color: transparent;
        background: transparent;
        color: var(--color-text-secondary);
        border-radius: 10px;
        font-weight: 600;
      }
      .dyn-tabs .nav-item.active {
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.3),
          rgba(212, 175, 55, 0.12)
        );
        border-color: var(--theme-accent);
        color: var(--color-text-primary);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25) inset,
          0 0 0 1px rgba(212, 175, 55, 0.25);
      }
      .dyn-tabs .nav-item:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 2px;
      }
      .dyn-pages {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.25);
        padding: 1rem;
        overflow: hidden;
        position: relative;
      }
      .dyn-pages .dyn-page {
        max-height: calc(75vh - 160px);
        overflow-y: auto;
        padding-inline-end: 0.5rem;
      }
      .dyn-pages .dyn-page.hidden {
        display: none !important;
      }
      @media (max-width: 900px) {
        .dyn-layout {
          grid-template-columns: 1fr;
        }
        .dyn-tabs {
          flex-direction: row;
          justify-content: flex-start;
          overflow-x: auto;
          padding: 0.5rem;
        }
        .dyn-tabs .nav-item {
          flex: 0 0 auto;
          min-width: 140px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login -->
    <div id="login-screen" class="view active">
      <div class="login-container">
        <div class="logo">نجارة<span>ERP</span></div>
        <form id="login-form" novalidate>
          <div class="form-group">
            <label for="username">اسم المستخدم</label>
            <input id="username" type="text" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="password">كلمة المرور</label>
            <input
              id="password"
              type="password"
              autocomplete="current-password"
            />
          </div>
          <button id="login-button" class="main-button" type="submit">
            <span>تسجيل الدخول</span>
            <div class="spinner"></div>
          </button>
        </form>
        <div
          id="toast-container"
          class="toast-container"
          aria-live="polite"
          aria-atomic="true"
        ></div>
      </div>
    </div>

    <!-- Top navbar -->
    <nav id="app-navbar" class="app-navbar hidden">
      <div class="app-navbar__left">
        <span class="app-brand">Nijjara ERP</span>
        <div id="navbar-buttons" class="navbar-buttons"></div>
      </div>
      <div class="app-navbar__right">
        <span id="navbar-user-label" class="navbar-user"></span>
        <button id="logout-button" class="nav-btn">تسجيل الخروج</button>
      </div>
    </nav>

    <!-- Portal -->
    <div id="portal-view" class="view">
      <div class="portal-header">
        <h1 id="portal-welcome-message"></h1>
        <p class="muted">اختر الوحدة التي تريد العمل عليها</p>
      </div>
      <div class="module-grid">
        <div
          class="module-card"
          data-workspace="projects-workspace"
          data-theme="projects"
        >
          <h2>المشاريع</h2>
        </div>
        <div
          class="module-card"
          data-workspace="finance-workspace"
          data-theme="finance"
        >
          <h2>المالية</h2>
        </div>
        <div class="module-card" data-workspace="hr-workspace" data-theme="hr">
          <h2>الموارد البشرية</h2>
        </div>
        <div
          class="module-card"
          data-workspace="system-management-view"
          data-theme="users"
        >
          <h2>إدارة المستخدمين</h2>
        </div>
      </div>
    </div>

    <!-- Projects (no demo data) -->
    <div id="projects-workspace" class="view">
      <div class="workspace" data-theme="projects">
        <header class="workspace-header">
          <h2 class="workspace-title">المشاريع</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">لا توجد بيانات معروضة هنا بعد.</p>
        </section>
        <aside class="workspace-nav">
          <button class="nav-item active">نظرة عامة</button>
          <button class="nav-item">المهام</button>
          <button class="nav-item">الملفات</button>
        </aside>
      </div>
    </div>

    <!-- Finance (no demo data) -->
    <div id="finance-workspace" class="view">
      <div class="workspace" data-theme="finance">
        <header class="workspace-header">
          <h2 class="workspace-title">المالية</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">لا توجد بيانات معروضة هنا بعد.</p>
        </section>
        <aside class="workspace-nav">
          <button class="nav-item active">لوحة مالية</button>
          <button class="nav-item">الإيرادات</button>
          <button class="nav-item">المصروفات</button>
        </aside>
      </div>
    </div>

    <!-- HR (no demo data) -->
    <div id="hr-workspace" class="view">
      <div class="workspace" data-theme="hr">
        <header class="workspace-header">
          <h2 class="workspace-title">الموارد البشرية</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">لا توجد بيانات معروضة هنا بعد.</p>
        </section>
        <aside class="workspace-nav">
          <button class="nav-item active">نظرة عامة</button>
          <button class="nav-item">الحضور</button>
          <button class="nav-item">الإجازات</button>
        </aside>
      </div>
    </div>

    <!-- System Management -->
    <div id="system-management-view" class="view">
      <div class="workspace" data-theme="users">
        <header class="workspace-header">
          <h2 class="workspace-title">إدارة النظام</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>

        <section class="workspace-content">
          <section
            id="sys-overview-pane"
            class="sys-pane sys-pane--overview active"
            data-pane="overview"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">نظرة عامة على النظام</h3>
              <p class="muted">
                تلخيص للحالة الحالية، يتم سحب بياناته من ‎SYS_Profile_View‎ عند
                توفرها.
              </p>
            </div>
            <div class="sys-overview__summary">
              <div class="overview-cards">
                <div class="overview-card">
                  <div class="muted">إجمالي المستخدمين</div>
                  <div id="kpi-total-users" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">المستخدمون النشطون</div>
                  <div id="kpi-active-users" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">المستخدمون المعطلون</div>
                  <div id="kpi-inactive-users" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">عدد الأدوار</div>
                  <div id="kpi-role-count" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">عدد الأذونات</div>
                  <div id="kpi-permission-count" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">طلبات إعادة التعيين</div>
                  <div id="kpi-pending-resets" class="kpi-value">—</div>
                </div>
              </div>
              <p class="muted" style="margin: 0">
                استعرض الأرقام المجمّعة هنا، ثم انتقل إلى تبويب
                <strong>المستخدمون</strong> لإدارة دليل المستخدمين بالكامل طبقًا
                لـ PV_SYS_Users_Table.
              </p>
            </div>
          </section>

          <section id="sys-users-pane" class="sys-pane" data-pane="users">
            <div class="sys-pane__header">
              <h3 class="pane-heading">دليل المستخدمين</h3>
              <p class="muted">
                أدوات بحث وإجراءات مجمّعة لإدارة المستخدمين بجميع حالاتهم.
              </p>
            </div>
            <div class="toolbar toolbar--filters">
              <input
                type="search"
                id="users-search"
                placeholder="بحث سريع..."
              />
              <select id="department-filter">
                <option value="">كل الأقسام</option>
              </select>
              <select id="role-filter">
                <option value="">كل الأدوار</option>
              </select>
              <select id="status-filter">
                <option value="">كل الحالات</option>
                <option value="true">نشط</option>
                <option value="false">غير نشط</option>
              </select>
              <input
                type="date"
                id="updated-from"
                aria-label="تاريخ التحديث من"
              />
              <input
                type="date"
                id="updated-to"
                aria-label="تاريخ التحديث إلى"
              />
              <button id="btn-new-user" class="accent-button">
                إنشاء مستخدم جديد
              </button>
            </div>
            <div class="toolbar toolbar--bulk">
              <div class="toolbar-group">
                <button id="bulk-export" class="ghost-button" disabled>
                  تصدير
                </button>
                <button id="bulk-activate" class="ghost-button" disabled>
                  تفعيل
                </button>
                <button id="bulk-deactivate" class="ghost-button" disabled>
                  تعطيل
                </button>
                <select id="bulk-role-select" disabled>
                  <option value="">اختر دورًا</option>
                </select>
                <button id="bulk-assign-role" class="ghost-button" disabled>
                  تعيين الدور
                </button>
              </div>
            </div>
            <div class="table-wrapper">
              <table id="users-table">
                <thead>
                  <tr>
                    <th class="select-cell">
                      <input type="checkbox" id="select-all-users" />
                    </th>
                    <th>معرّف المستخدم</th>
                    <th>الاسم الكامل</th>
                    <th>اسم المستخدم</th>
                    <th>البريد الإلكتروني</th>
                    <th>القسم</th>
                    <th>الدور</th>
                    <th>الحالة</th>
                    <th>آخر تسجيل دخول</th>
                    <th>آخر تحديث</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody id="users-tbody">
                  <tr>
                    <td colspan="11" class="muted">جاري التحميل…</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-roles-pane" class="sys-pane" data-pane="roles">
            <div class="sys-pane__header">
              <h3 class="pane-heading">سجل الأدوار</h3>
              <p class="muted">
                متابعة الأدوار المعرّفة في ‎SYS_Roles‎ وتحديد الأدوار النظامية.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>معرّف الدور</th>
                    <th>المسمى</th>
                    <th>الوصف</th>
                    <th>دور نظامي؟</th>
                    <th>آخر تحديث</th>
                  </tr>
                </thead>
                <tbody id="roles-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-permissions-pane"
            class="sys-pane"
            data-pane="permissions"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">سجل الأذونات</h3>
              <p class="muted">
                يعرض ‎SYS_Permissions‎ للتدقيق السريع والتصنيف حسب الفئات.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>مفتاح الإذن</th>
                    <th>البيان</th>
                    <th>الفئة</th>
                    <th>الوصف</th>
                    <th>آخر تحديث</th>
                  </tr>
                </thead>
                <tbody id="permissions-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-role-perms-pane"
            class="sys-pane"
            data-pane="rolePerms"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">تعيين أذونات الأدوار</h3>
              <p class="muted">
                خريطة الأذونات مع النطاق والحالة للمساعدة في مراجعة الصلاحيات.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>الدور</th>
                    <th>الإذن</th>
                    <th>النطاق</th>
                    <th>مسموح؟</th>
                    <th>آخر تحديث</th>
                  </tr>
                </thead>
                <tbody id="role-perms-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-properties-pane"
            class="sys-pane"
            data-pane="properties"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">خصائص المستخدم</h3>
              <p class="muted">
                يعرض جدول ‎SYS_User_Properties‎ لتتبع السمات المخصصة.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>المستخدم</th>
                    <th>المفتاح</th>
                    <th>القيمة</th>
                    <th>آخر تحديث</th>
                    <th>المحدّث</th>
                  </tr>
                </thead>
                <tbody id="properties-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-sessions-pane" class="sys-pane" data-pane="sessions">
            <div class="sys-pane__header">
              <h3 class="pane-heading">الجلسات النشطة والمغلقة</h3>
              <p class="muted">
                مراقبة سجلات ‎SYS_Sessions‎ بما في ذلك جلسات الانتحال.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>المعرّف</th>
                    <th>المستخدم</th>
                    <th>الممثل</th>
                    <th>النوع</th>
                    <th>الحالة</th>
                    <th>البداية</th>
                    <th>النهاية</th>
                  </tr>
                </thead>
                <tbody id="sessions-tbody">
                  <tr>
                    <td colspan="7" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-audit-pane" class="sys-pane" data-pane="audit">
            <div class="sys-pane__header">
              <h3 class="pane-heading">سجل التدقيق</h3>
              <p class="muted">
                أحدث إجراءات النظام من ‎SYS_Audit_Log‎ أو ‎SYS_Audit_Report‎.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>الوقت</th>
                    <th>المستخدم</th>
                    <th>الإجراء</th>
                    <th>التفاصيل</th>
                  </tr>
                </thead>
                <tbody id="audit-tbody">
                  <tr>
                    <td colspan="4" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        </section>

        <aside class="workspace-nav" id="sys-side-nav">
          <button class="nav-item" data-pane="overview">نظرة عامة</button>
          <button class="nav-item active" data-pane="users">المستخدمون</button>
          <button class="nav-item" data-pane="roles">الأدوار</button>
          <button class="nav-item" data-pane="permissions">الأذونات</button>
          <button class="nav-item" data-pane="rolePerms">
            تعيين أذونات الأدوار
          </button>
          <button class="nav-item" data-pane="properties">
            خصائص المستخدم
          </button>
          <button class="nav-item" data-pane="sessions">الجلسات</button>
          <button class="nav-item" data-pane="audit">التدقيق</button>
        </aside>
      </div>
    </div>

    <!-- إنشاء مستخدم (ديناميكي إن توفرت الجداول؛ وإلا نموذج مبسّط) -->
    <dialog id="dlg-new-user">
      <h3 style="margin-bottom: 0.6rem">إنشاء مستخدم جديد</h3>
      <form method="dialog" id="new-user-form">
        <div id="new-user-fields" class="dialog-body"></div>
        <div class="actions">
          <button type="submit" class="action-button save-button">حفظ</button>
          <button
            type="button"
            id="btn-cancel-new"
            class="action-button cancel-button"
          >
            إلغاء
          </button>
        </div>
      </form>
    </dialog>

    <!-- ملف المستخدم -->
    <dialog id="dlg-user-profile">
      <div class="profile-dialog__header">
        <h3 id="profile-title">ملف المستخدم</h3>
        <div id="profile-username" class="profile-dialog__username"></div>
      </div>
      <div class="profile-tabs" id="profile-tabs">
        <button type="button" class="nav-item active" data-tab="profile">
          الملف
        </button>
        <button type="button" class="nav-item" data-tab="properties">
          الخصائص
        </button>
        <button type="button" class="nav-item" data-tab="documents">
          المستندات
        </button>
        <button type="button" class="nav-item" data-tab="sessions">
          الجلسات
        </button>
        <button type="button" class="nav-item" data-tab="audit">التدقيق</button>
      </div>
      <div class="profile-panels" id="profile-panels">
        <section class="profile-panel active" data-tab="profile">
          <dl class="profile-dl" id="profile-overview-list"></dl>
        </section>
        <section class="profile-panel" data-tab="properties">
          <table class="profile-table">
            <thead>
              <tr>
                <th>المفتاح</th>
                <th>القيمة</th>
                <th>آخر تحديث</th>
                <th>المحدّث</th>
              </tr>
            </thead>
            <tbody id="profile-properties-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="documents">
          <table class="profile-table">
            <thead>
              <tr>
                <th>المستند</th>
                <th>المرفوع بواسطة</th>
                <th>التاريخ</th>
                <th>رابط</th>
              </tr>
            </thead>
            <tbody id="profile-documents-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="sessions">
          <table class="profile-table">
            <thead>
              <tr>
                <th>Session</th>
                <th>المنتحل</th>
                <th>النوع</th>
                <th>الحالة</th>
                <th>البداية</th>
                <th>النهاية</th>
              </tr>
            </thead>
            <tbody id="profile-sessions-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="audit">
          <table class="profile-table">
            <thead>
              <tr>
                <th>الوقت</th>
                <th>المستخدم</th>
                <th>الإجراء</th>
                <th>التفاصيل</th>
              </tr>
            </thead>
            <tbody id="profile-audit-body"></tbody>
          </table>
        </section>
      </div>
      <div class="actions">
        <button
          type="button"
          id="btn-close-profile"
          class="action-button cancel-button"
        >
          إغلاق
        </button>
      </div>
    </dialog>

    <!-- تعيين دور -->
    <dialog id="dlg-assign-role">
      <h3 style="margin-bottom: 0.6rem">تعيين دور للمستخدم</h3>
      <form method="dialog" id="form-assign-role">
        <input type="hidden" id="assign-role-user" name="userId" />
        <div class="form-grid">
          <div class="span-2">
            <label for="assign-role-select">اختر الدور</label>
            <select id="assign-role-select" name="roleId" required></select>
          </div>
          <div class="span-2 muted" id="assign-role-user-label"></div>
        </div>
        <div class="actions">
          <button type="submit" class="action-button save-button">حفظ</button>
          <button
            type="button"
            id="btn-cancel-assign"
            class="action-button cancel-button"
          >
            إلغاء
          </button>
        </div>
      </form>
    </dialog>

    <!-- إعادة تعيين كلمة المرور -->
    <dialog id="dlg-reset-pass">
      <h3 style="margin-bottom: 0.6rem">إعادة تعيين كلمة المرور</h3>
      <form method="dialog" id="form-reset-pass">
        <div class="form-grid">
          <div class="span-2">
            <label for="reset_pass">كلمة المرور الجديدة</label
            ><input
              type="password"
              id="reset_pass"
              name="password"
              autocomplete="new-password"
              required
            />
          </div>
          <div class="span-2">
            <label for="reset_confirm">تأكيد كلمة المرور</label
            ><input
              type="password"
              id="reset_confirm"
              name="confirm"
              autocomplete="new-password"
              required
            />
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action-button edit-button">تحديث</button>
          <button
            type="button"
            id="btn-cancel-reset"
            class="action-button cancel-button"
          >
            إلغاء
          </button>
        </div>
      </form>
    </dialog>

    <script>
      (function () {
        const views = Array.from(document.querySelectorAll(".view"));
        const navbar = document.getElementById("app-navbar");
        const userLabel = document.getElementById("navbar-user-label");
        const navButtonsContainer = document.getElementById("navbar-buttons");
        const txtSearch = document.getElementById("users-search");
        const selDept = document.getElementById("department-filter");
        const selRole = document.getElementById("role-filter");
        const selStatus = document.getElementById("status-filter");
        const dtUpdatedFrom = document.getElementById("updated-from");
        const dtUpdatedTo = document.getElementById("updated-to");
        const usersTbody = document.getElementById("users-tbody");
        const usersTable = document.getElementById("users-table");
        const selectAllUsers = document.getElementById("select-all-users");
        const bulkExportBtn = document.getElementById("bulk-export");
        const bulkActivateBtn = document.getElementById("bulk-activate");
        const bulkDeactivateBtn = document.getElementById("bulk-deactivate");
        const bulkAssignRoleBtn = document.getElementById("bulk-assign-role");
        const bulkRoleSelect = document.getElementById("bulk-role-select");
        const dlgReset = document.getElementById("dlg-reset-pass");
        const formReset = document.getElementById("form-reset-pass");
        const dlgProfile = document.getElementById("dlg-user-profile");
        const profileTabsContainer = document.getElementById("profile-tabs");
        const profilePanelsContainer =
          document.getElementById("profile-panels");
        const profileTabButtons = profileTabsContainer
          ? Array.from(profileTabsContainer.querySelectorAll("[data-tab]"))
          : [];
        const profilePanels = profilePanelsContainer
          ? Array.from(
              profilePanelsContainer.querySelectorAll(".profile-panel")
            )
          : [];
        const profileOverviewList = document.getElementById(
          "profile-overview-list"
        );
        const profilePropertiesBody = document.getElementById(
          "profile-properties-body"
        );
        const profileDocumentsBody = document.getElementById(
          "profile-documents-body"
        );
        const profileSessionsBody = document.getElementById(
          "profile-sessions-body"
        );
        const profileAuditBody = document.getElementById("profile-audit-body");
        const profileTitle = document.getElementById("profile-title");
        const profileUsername = document.getElementById("profile-username");
        const btnCloseProfile = document.getElementById("btn-close-profile");
        const dlgAssign = document.getElementById("dlg-assign-role");
        const formAssignRole = document.getElementById("form-assign-role");
        const assignRoleUserInput = document.getElementById("assign-role-user");
        const assignRoleSelect = document.getElementById("assign-role-select");
        const assignRoleUserLabel = document.getElementById(
          "assign-role-user-label"
        );
        const btnCancelAssign = document.getElementById("btn-cancel-assign");
        const sysView = document.getElementById("system-management-view");
        const sysNav = document.getElementById("sys-side-nav");
        const sysNavButtons = sysNav
          ? Array.from(sysNav.querySelectorAll("[data-pane]"))
          : [];
        const sysPanes = sysView
          ? Array.from(sysView.querySelectorAll(".sys-pane"))
          : [];
        const rolesTbody = document.getElementById("roles-tbody");
        const permissionsTbody = document.getElementById("permissions-tbody");
        const rolePermsTbody = document.getElementById("role-perms-tbody");
        const propertiesTbody = document.getElementById("properties-tbody");
        const sessionsTbody = document.getElementById("sessions-tbody");
        const auditTbody = document.getElementById("audit-tbody");
        const NAV_VIEW_MAP = {
          SYS: "system-management-view",
          PRJ: "projects-workspace",
          FIN: "finance-workspace",
          HR: "hr-workspace",
        };
        let bootstrapData = null;
        const selectedUsers = new Set();
        let resetUserId = null;
        let currentProfileUserId = null;
        let profileDataCache = null;
        let roleOptionsCache = null;
        let normalizedUsersCache = [];
        let overviewLoaded = false;
        let rolesLoaded = false;
        let permissionsLoaded = false;
        let rolePermsLoaded = false;
        let propertiesLoaded = false;
        let sessionsLoaded = false;
        let auditLoaded = false;
        let currentSysPane = "overview";

        /* Basic nav */
        function updateUserContext(name) {
          const safe = name || "User";
          userLabel.textContent = "User: " + safe;
          const welcome = document.getElementById("portal-welcome-message");
          if (welcome) welcome.textContent = "Welcome, " + safe;
        }
        function switchView(id) {
          views.forEach((v) => v.classList.toggle("active", v.id === id));
          document.querySelectorAll(".app-navbar .nav-btn").forEach((b) => {
            const target = b.getAttribute("data-target");
            b.classList.toggle(
              "active",
              target === id ||
                (id === "portal-view" && target === "portal-view")
            );
          });
          if (id === "system-management-view") {
            setActiveSysPane(currentSysPane || "overview");
          }
        }
        function createNavButton(label, target) {
          const btn = document.createElement("button");
          btn.className = "nav-btn";
          btn.dataset.target = target;
          btn.textContent = label;
          return btn;
        }
        function renderNav(navConfig = []) {
          if (!navButtonsContainer) return;
          navButtonsContainer.innerHTML = "";
          navButtonsContainer.appendChild(
            createNavButton("Portal", "portal-view")
          );
          ["PRJ", "FIN", "HR", "SYS"].forEach((key) => {
            navButtonsContainer.appendChild(
              createNavButton(
                key === "PRJ"
                  ? "Projects"
                  : key === "FIN"
                  ? "Finance"
                  : key === "HR"
                  ? "HR"
                  : "System",
                NAV_VIEW_MAP[key]
              )
            );
          });
          const activeView = document.querySelector(".view.active");
          if (activeView) switchView(activeView.id);
        }

        /* Bootstrap (server) */
        function applyBootstrap(data) {
          console.log("Bootstrap data received:", data);
          bootstrapData = data || {};
          renderNav(data?.nav || []);
          const displayName =
            data?.user?.Full_Name || data?.user?.Username || "User";
          if (data?.user) {
            updateUserContext(data.user);
          } else {
            updateUserContext(displayName);
          }
          // Fill filter selects if server sent lists
          if (data?.filters) {
            fillSelect(selDept, data.filters.departments);
            fillSelect(selRole, data.filters.roles);
            fillSelect(
              bulkRoleSelect,
              data.filters.roleOptions || data.filters.roles
            );
            bulkRoleSelect.disabled = !(
              (data.filters.roleOptions || data.filters.roles || []).length > 0
            );
          } else {
            // Try lazy fetch
            if (window.google && google.script && google.script.run) {
              google.script.run
                .withSuccessHandler((f) => {
                  console.log("Department and role filters received:", f);
                  fillSelect(selDept, f?.departments || []);
                  fillSelect(selRole, f?.roles || []);
                  fillSelect(bulkRoleSelect, f?.roleOptions || f?.roles || []);
                  bulkRoleSelect.disabled = !(f?.roleOptions || f?.roles || [])
                    ?.length;
                })
                .getDeptAndRoleFilters();
            }
          }
          fetchKPIs();
          loadUsers(); // prefetch for smoother UX
          syncBulkActionsState();
        }
        function fillSelect(selectEl, arr) {
          if (!selectEl) return;
          const keepFirst = selectEl.querySelector("option");
          selectEl.innerHTML = keepFirst ? keepFirst.outerHTML : "";
          (arr || []).forEach((item) => {
            const option = document.createElement("option");
            if (item && typeof item === "object") {
              option.value = item.value ?? item.label ?? "";
              option.textContent = item.label ?? item.value ?? "";
            } else {
              option.value = item;
              option.textContent = item;
            }
            selectEl.appendChild(option);
          });
        }
        function bootstrapApp() {
          if (!(window.google && google.script && google.script.run)) {
            console.warn("Apps Script runtime not available.");
            return;
          }
          google.script.run
            .withFailureHandler((err) => console.error("Bootstrap failed", err))
            .withSuccessHandler(applyBootstrap)
            .getBootstrapData();
        }

        /* Login */
        const loginForm = document.getElementById("login-form");
        const loginBtn = document.getElementById("login-button");
        const USERNAME = "mkhoraiby",
          PASSWORD = "210388";
        loginForm.addEventListener("submit", (e) => {
          e.preventDefault();
          loginBtn.classList.add("loading");
          const u = (document.getElementById("username").value || "")
            .trim()
            .toLowerCase();
          const p = (document.getElementById("password").value || "").trim();
          setTimeout(() => {
            loginBtn.classList.remove("loading");
            if (u === USERNAME && p === PASSWORD) {
              navbar.classList.remove("hidden");
              const fallback =
                bootstrapData?.user?.Full_Name ||
                bootstrapData?.user?.Username ||
                USERNAME;
              updateUserContext(fallback);
              renderNav(bootstrapData?.nav || []);
              switchView("portal-view");
              bootstrapApp();
              showToast("تم تسجيل الدخول بنجاح.", "success", "تم الدخول");
            } else {
              showToast(
                "بيانات الدخول غير صحيحة. حاول مرة أخرى.",
                "error",
                "خطأ"
              );
            }
          }, 450);
        });

        /* Top nav clicks */
        navbar.addEventListener("click", (e) => {
          const btn = e.target.closest(".nav-btn[data-target]");
          if (!btn) return;
          e.preventDefault();
          switchView(btn.dataset.target);
        });

        /* Card clicks */
        document.querySelectorAll(".module-card").forEach((card) => {
          card.addEventListener("click", () =>
            switchView(card.getAttribute("data-workspace"))
          );
        });

        /* Back-to-portal */
        document.querySelectorAll('[data-go="portal-view"]').forEach((btn) => {
          btn.addEventListener("click", () => switchView("portal-view"));
        });

        /* Logout */
        document
          .getElementById("logout-button")
          .addEventListener("click", () => {
            navbar.classList.add("hidden");
            userLabel.textContent = "";
            const welcome = document.getElementById("portal-welcome-message");
            if (welcome) welcome.textContent = "";
            bootstrapData = null;
            renderNav();
            switchView("login-screen");
            showToast("You have been signed out.", "info", "Logged Out");
          });

        /* ---------- KPIs ---------- */
        function fetchKPIs() {
          if (!(window.google && google.script && google.script.run)) return;
          google.script.run
            .withFailureHandler(() => {})
            .withSuccessHandler((k) => {
              console.log("System KPIs received:", k);
              if (!k) return;
              const $ = (id) => document.getElementById(id);
              $("kpi-total-users").textContent = k.totalUsers ?? "—";
              $("kpi-active-users").textContent = k.activeUsers ?? "—";
              $("kpi-inactive-users").textContent = k.inactiveUsers ?? "—";
              $("kpi-role-count").textContent = k.roleCount ?? "—";
              $("kpi-permission-count").textContent = k.permissionCount ?? "—";
              $("kpi-pending-resets").textContent =
                k.pendingPasswordResets ?? "—";
              overviewLoaded = true;
            })
            .getSystemKPIs();
        }

        function currentFilters() {
          return {
            search: (txtSearch.value || "").trim(),
            department: selDept.value || "",
            role: selRole.value || "",
            status: selStatus.value || "",
            updatedFrom: dtUpdatedFrom.value || "",
            updatedTo: dtUpdatedTo.value || "",
          };
        }

        let usersReqTimer = null;
        function loadUsers({ force } = {}) {
          console.log("[CLIENT] loadUsers called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            usersTbody.innerHTML =
              '<tr><td colspan="11" class="muted">غير متصل بالخادم.</td></tr>';
            selectedUsers.clear();
            syncSelectAllState();
            syncBulkActionsState();
            return;
          }
          if (force) {
            selectedUsers.clear();
            syncSelectAllState();
            syncBulkActionsState();
          }
          usersTbody.innerHTML =
            '<tr><td colspan="11" class="muted">جاري التحميل…</td></tr>';
          const filters = currentFilters();
          console.log("[CLIENT] Requesting users with filters:", filters);
          // watchdog in case server throws silently
          clearTimeout(usersReqTimer);
          usersReqTimer = setTimeout(() => {
            const stillLoading =
              usersTbody.textContent.includes("جاري التحميل");
            if (stillLoading) {
              console.warn("[CLIENT] User loading timeout after 8s");
              usersTbody.innerHTML =
                '<tr><td colspan="11" class="muted">تعذر التحميل.</td></tr>';
            }
            if (stillLoading) {
              selectedUsers.clear();
              syncSelectAllState();
              syncBulkActionsState();
            }
          }, 8000);
          google.script.run
            .withFailureHandler((err) => {
              clearTimeout(usersReqTimer);
              console.error("[CLIENT] searchUsers failed:", err);
              usersTbody.innerHTML =
                '<tr><td colspan="11" class="error-text">خطأ: ' +
                (err.message || err) +
                "</td></tr>";
              selectedUsers.clear();
              syncSelectAllState();
              syncBulkActionsState();
            })
            .withSuccessHandler((list) => {
              clearTimeout(usersReqTimer);
              console.log(
                "[CLIENT] User list received, count:",
                Array.isArray(list) ? list.length : 0
              );
              console.log("[CLIENT] User list data:", list);
              renderUsers(list);
            })
            .searchUsers(filters);
        }

        // تفويض أحداث الجدول
        usersTable.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-act]");
          if (!btn) return;
          const act = btn.dataset.act;
          const userId = btn.dataset.id;
          if (!userId) return;
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }

          if (act === "reset") {
            resetUserId = userId;
            formReset.reset();
            dlgReset.showModal();
          } else if (act === "toggle") {
            google.script.run
              .withFailureHandler((err) => {
                console.error(err);
                showToast("تعذر تغيير حالة الحساب.", "error");
              })
              .withSuccessHandler((res) => {
                console.log("Toggle user active response:", res);
                showToast("تم تحديث الحالة.", "success");
                loadUsers();
              })
              .toggleUserActive(userId);
          } else if (act === "edit") {
            openUserEditor(userId);
          } else if (act === "view") {
            openUserProfile(userId, "profile");
          } else if (act === "audit") {
            openUserProfile(userId, "audit");
          } else if (act === "assign") {
            openAssignRoleDialog(userId);
          } else if (act === "docs") {
            openUserProfile(userId, "documents");
          } else if (act === "impersonate") {
            startImpersonationFlow(userId);
          } else if (act === "delete") {
            performSoftDelete(userId);
          }
        });

        usersTable.addEventListener("change", (e) => {
          const checkbox = e.target.closest(".row-select");
          if (!checkbox) return;
          const userId = checkbox.dataset.id;
          if (!userId) return;
          if (checkbox.checked) {
            selectedUsers.add(userId);
          } else {
            selectedUsers.delete(userId);
          }
          syncSelectAllState();
          syncBulkActionsState();
        });

        selectAllUsers.addEventListener("change", (e) => {
          const checked = e.target.checked;
          usersTbody
            .querySelectorAll('input.row-select[type="checkbox"]')
            .forEach((cb) => {
              cb.checked = checked;
              const id = cb.dataset.id;
              if (!id) return;
              if (checked) {
                selectedUsers.add(id);
              } else {
                selectedUsers.delete(id);
              }
            });
          syncSelectAllState();
          syncBulkActionsState();
        });

        ["input", "change"].forEach((evt) => {
          txtSearch.addEventListener(evt, loadUsers);
          selDept.addEventListener(evt, loadUsers);
          selRole.addEventListener(evt, loadUsers);
          selStatus.addEventListener(evt, loadUsers);
          dtUpdatedFrom.addEventListener(evt, loadUsers);
          dtUpdatedTo.addEventListener(evt, loadUsers);
        });

        if (bulkExportBtn)
          bulkExportBtn.addEventListener("click", handleBulkExport);
        if (bulkActivateBtn)
          bulkActivateBtn.addEventListener("click", () =>
            performBulkStatus(true)
          );
        if (bulkDeactivateBtn)
          bulkDeactivateBtn.addEventListener("click", () =>
            performBulkStatus(false)
          );
        if (bulkAssignRoleBtn)
          bulkAssignRoleBtn.addEventListener("click", handleBulkAssignRole);
        if (bulkRoleSelect)
          bulkRoleSelect.addEventListener("change", () => {
            syncBulkActionsState();
          });

        // Reset password dialog is already initialized above
        document
          .getElementById("btn-cancel-reset")
          .addEventListener("click", () => dlgReset.close());
        formReset.addEventListener("submit", (e) => {
          e.preventDefault();
          const fd = new FormData(formReset);
          const p = fd.get("password") || "",
            c = fd.get("confirm") || "";
          if (p !== c) {
            showToast("التأكيد غير مطابق.", "error");
            return;
          }
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذّر إعادة كلمة المرور.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Reset password response:", res);
              showToast("تم تحديث كلمة المرور (مشفّرة).", "success");
              dlgReset.close();
            })
            .updateUserPassword(resetUserId, p);
        });

        const DATE_OPTS = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };

        function formatDateTime(value) {
          if (!value) return "—";
          const date = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(date.getTime())) return "—";
          try {
            return date.toLocaleString("ar-EG", DATE_OPTS);
          } catch (err) {
            return date.toISOString();
          }
        }

        function escapeHtml(value) {
          return String(value ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function setTableStatus(bodyEl, message, type = "muted") {
          if (!bodyEl) return;
          const colCount = bodyEl.parentElement
            ? bodyEl.parentElement.querySelectorAll("thead th").length || 1
            : 1;
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = colCount;
          td.className = type === "error" ? "error-text" : "muted";
          td.textContent = message;
          tr.appendChild(td);
          bodyEl.innerHTML = "";
          bodyEl.appendChild(tr);
        }

        function renderBooleanBadge(value, yesLabel = "نعم", noLabel = "لا") {
          const normalized = String(value).toLowerCase();
          const truthy =
            value === true ||
            normalized === "true" ||
            normalized === "yes" ||
            normalized === "1" ||
            normalized === "y";
          return truthy
            ? `<span class="badge badge--ok">${escapeHtml(yesLabel)}</span>`
            : `<span class="badge badge--no">${escapeHtml(noLabel)}</span>`;
        }

        function renderUsers(list) {
          usersTbody.innerHTML = "";
          if (!Array.isArray(list) || list.length === 0) {
            usersTbody.innerHTML =
              '<tr><td colspan="11" class="muted">لا توجد نتائج.</td></tr>';
            selectedUsers.clear();
            syncSelectAllState();
            syncBulkActionsState();
            return;
          }
          const toDate = (value) => {
            if (!value) return null;
            if (value instanceof Date) return value;
            const parsed = new Date(value);
            return Number.isNaN(parsed.getTime()) ? null : parsed;
          };
          const norm = (u) => {
            const id = u?.User_Id ?? u?.user_id ?? u?.id ?? "";
            const normalizedId = id != null ? String(id) : "";
            return {
              userId: normalizedId,
              fullName: u?.Full_Name ?? u?.fullName ?? u?.name ?? "",
              username: u?.Username ?? u?.username ?? "",
              email: u?.Email ?? u?.email ?? "",
              department: u?.Department ?? u?.department ?? "",
              role: u?.Role_Id ?? u?.role ?? u?.Role ?? "",
              isActive:
                u?.IsActive === true ||
                String(u?.IsActive).toLowerCase() === "true" ||
                u?.isActive === true,
              lastLogin: toDate(u?.Last_Login ?? u?.lastLogin),
              updatedAt: toDate(u?.Updated_At ?? u?.updatedAt),
            };
          };
          const normalized = list.map(norm);
          normalizedUsersCache = normalized;
          const frag = document.createDocumentFragment();
          const visibleIds = new Set();
          normalized.forEach((u) => {
            if (u.userId) visibleIds.add(u.userId);
            const tr = document.createElement("tr");
            const checked = u.userId && selectedUsers.has(u.userId);
            tr.innerHTML = `
              <td class="select-cell">
                <input type="checkbox" class="row-select" data-id="${escapeHtml(
                  u.userId
                )}" ${checked ? "checked" : ""} ${u.userId ? "" : "disabled"} />
              </td>
              <td>${escapeHtml(u.userId)}</td>
              <td>${escapeHtml(u.fullName)}</td>
              <td>${escapeHtml(u.username)}</td>
              <td>${escapeHtml(u.email)}</td>
              <td>${escapeHtml(u.department)}</td>
              <td>${escapeHtml(u.role)}</td>
              <td>${
                u.isActive
                  ? '<span class="badge badge--ok">نشط</span>'
                  : '<span class="badge badge--no">غير نشط</span>'
              }</td>
              <td>${formatDateTime(u.lastLogin)}</td>
              <td>${formatDateTime(u.updatedAt)}</td>
              <td>
                <div class="icon-row">
                  <button class="icon-btn" data-act="view" data-id="${escapeHtml(
                    u.userId
                  )}" title="عرض الملف" aria-label="عرض الملف">
                    <svg viewBox="0 0 24 24"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>
                  </button>
                  <button class="icon-btn" data-act="edit" data-id="${escapeHtml(
                    u.userId
                  )}" title="تعديل" aria-label="تعديل">
                    <svg viewBox="0 0 24 24"><path d="M3 21l3-1 11-11-2-2L4 18l-1 3z"/><path d="M14 4l2 2"/></svg>
                  </button>
                  <button class="icon-btn" data-act="assign" data-id="${escapeHtml(
                    u.userId
                  )}" title="تعيين دور" aria-label="تعيين دور">
                    <svg viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M4 20v-1a5 5 0 0 1 10 0v1"/><path d="M16 11v6"/><path d="M19 14h-6"/></svg>
                  </button>
                  <button class="icon-btn" data-act="reset" data-id="${escapeHtml(
                    u.userId
                  )}" title="إعادة كلمة المرور" aria-label="إعادة كلمة المرور">
                    <svg viewBox="0 0 24 24"><path d="M12 11v6"/><path d="M9 14h6"/><path d="M6 11V8a6 6 0 1 1 12 0v3"/></svg>
                  </button>
                  <button class="icon-btn" data-act="toggle" data-id="${escapeHtml(
                    u.userId
                  )}" title="${
              u.isActive ? "تعطيل" : "تفعيل"
            }" aria-label="تفعيل/تعطيل">
                    <svg viewBox="0 0 24 24">${
                      u.isActive
                        ? '<path d="M18 6L6 18"/><path d="M6 6l12 12"/>'
                        : '<path d="M5 12h14"/><path d="M12 5v14"/>'
                    }</svg>
                  </button>
                  <button class="icon-btn" data-act="docs" data-id="${escapeHtml(
                    u.userId
                  )}" title="مستندات" aria-label="مستندات">
                    <svg viewBox="0 0 24 24"><path d="M7 3h7l5 5v13H7z"/><path d="M14 3v5h5"/><path d="M10 13h6"/><path d="M10 17h6"/></svg>
                  </button>
                  <button class="icon-btn" data-act="impersonate" data-id="${escapeHtml(
                    u.userId
                  )}" title="انتحال" aria-label="انتحال">
                    <svg viewBox="0 0 24 24"><path d="M3 12c2-4 6-6 9-6s7 2 9 6c-2 4-6 6-9 6s-7-2-9-6z"/><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M9 15c1 .8 2 .8 3 0 1 .8 2 .8 3 0"/></svg>
                  </button>
                  <button class="icon-btn" data-act="delete" data-id="${escapeHtml(
                    u.userId
                  )}" title="حذف رمزي" aria-label="حذف رمزي">
                    <svg viewBox="0 0 24 24"><path d="M5 7h14"/><path d="M10 7V5h4v2"/><path d="M8 7l1 12h6l1-12"/></svg>
                  </button>
                  <button class="icon-btn" data-act="audit" data-id="${escapeHtml(
                    u.userId
                  )}" title="سجل التدقيق" aria-label="سجل التدقيق">
                    <svg viewBox="0 0 24 24"><path d="M7 3h10v4H7z"/><path d="M5 7h14v14H5z"/><path d="M9 11h6M9 15h6"/></svg>
                  </button>
                </div>
              </td>`;
            frag.appendChild(tr);
            const checkboxEl = tr.querySelector("input.row-select");
            if (checkboxEl) {
              if (u.userId) {
                checkboxEl.dataset.id = u.userId;
                checkboxEl.checked = !!checked;
              } else {
                checkboxEl.disabled = true;
                checkboxEl.removeAttribute("data-id");
              }
            }
            tr.querySelectorAll(".icon-btn").forEach((btn) => {
              if (u.userId) {
                btn.dataset.id = u.userId;
              } else {
                btn.removeAttribute("data-id");
              }
            });
          });
          usersTbody.appendChild(frag);
          Array.from(selectedUsers).forEach((id) => {
            if (!visibleIds.has(id)) {
              selectedUsers.delete(id);
            }
          });
          syncSelectAllState();
          syncBulkActionsState();
        }

        function loadRoles({ force = false } = {}) {
          if (!rolesTbody) return;
          if (rolesLoaded && !force) return;
          console.log("[CLIENT] loadRoles called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            setTableStatus(rolesTbody, "غير متصل بالخادم.", "error");
            return;
          }
          setTableStatus(rolesTbody, "جاري التحميل…");
          google.script.run
            .withFailureHandler((err) => {
              console.error("[CLIENT] listRoles failed:", err);
              rolesLoaded = false;
              setTableStatus(
                rolesTbody,
                "خطأ: " + (err.message || err),
                "error"
              );
            })
            .withSuccessHandler((rows) => {
              console.log(
                "[CLIENT] Roles data received, count:",
                Array.isArray(rows) ? rows.length : 0
              );
              console.log("[CLIENT] Roles data:", rows);
              rolesLoaded = true;
              const list = Array.isArray(rows) ? rows : [];
              renderTableRows(rolesTbody, list, (row) => {
                return `
                  <td>${escapeHtml(row.roleId || "")}</td>
                  <td>${escapeHtml(row.title || "")}</td>
                  <td>${escapeHtml(row.description || "")}</td>
                  <td>${renderBooleanBadge(row.isSystem)}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                `;
              });
            })
            .listRoles();
        }

        function loadPermissions({ force = false } = {}) {
          if (!permissionsTbody) return;
          if (permissionsLoaded && !force) return;
          console.log("[CLIENT] loadPermissions called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            setTableStatus(permissionsTbody, "غير متصل بالخادم.", "error");
            return;
          }
          setTableStatus(permissionsTbody, "جاري التحميل…");
          google.script.run
            .withFailureHandler((err) => {
              console.error("[CLIENT] listPermissions failed:", err);
              permissionsLoaded = false;
              setTableStatus(
                permissionsTbody,
                "خطأ: " + (err.message || err),
                "error"
              );
            })
            .withSuccessHandler((rows) => {
              console.log(
                "[CLIENT] Permissions data received, count:",
                Array.isArray(rows) ? rows.length : 0
              );
              console.log("[CLIENT] Permissions data:", rows);
              permissionsLoaded = true;
              const list = Array.isArray(rows) ? rows : [];
              renderTableRows(permissionsTbody, list, (row) => {
                return `
                  <td>${escapeHtml(row.permissionKey || row.key || "")}</td>
                  <td>${escapeHtml(row.label || "")}</td>
                  <td>${escapeHtml(row.category || "")}</td>
                  <td>${escapeHtml(row.description || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                `;
              });
            })
            .listPermissions();
        }

        function loadRolePermissions({ force = false } = {}) {
          if (!rolePermsTbody) return;
          if (rolePermsLoaded && !force) return;
          console.log("[CLIENT] loadRolePermissions called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            setTableStatus(rolePermsTbody, "غير متصل بالخادم.", "error");
            return;
          }
          setTableStatus(rolePermsTbody, "جاري التحميل…");
          google.script.run
            .withFailureHandler((err) => {
              console.error("[CLIENT] listRolePermissions failed:", err);
              rolePermsLoaded = false;
              setTableStatus(
                rolePermsTbody,
                "خطأ: " + (err.message || err),
                "error"
              );
            })
            .withSuccessHandler((rows) => {
              console.log(
                "[CLIENT] Role permissions data received, count:",
                Array.isArray(rows) ? rows.length : 0
              );
              console.log("[CLIENT] Role permissions data:", rows);
              rolePermsLoaded = true;
              const list = Array.isArray(rows) ? rows : [];
              renderTableRows(rolePermsTbody, list, (row) => {
                const roleDisplay =
                  row.roleTitle && row.roleId
                    ? `${escapeHtml(row.roleTitle)} (${escapeHtml(row.roleId)})`
                    : escapeHtml(row.roleTitle || row.roleId || "");
                const permDisplay =
                  row.permissionLabel && row.permissionKey
                    ? `${escapeHtml(row.permissionLabel)} (${escapeHtml(
                        row.permissionKey
                      )})`
                    : escapeHtml(
                        row.permissionLabel || row.permissionKey || ""
                      );
                return `
                  <td>${roleDisplay}</td>
                  <td>${permDisplay}</td>
                  <td>${escapeHtml(row.scope || "")}</td>
                  <td>${renderBooleanBadge(row.allowed, "مسموح", "مرفوض")}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                `;
              });
            })
            .listRolePermissions();
        }

        function loadProperties({ force = false } = {}) {
          if (!propertiesTbody) return;
          if (propertiesLoaded && !force) return;
          console.log("[CLIENT] loadProperties called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            setTableStatus(propertiesTbody, "غير متصل بالخادم.", "error");
            return;
          }
          setTableStatus(propertiesTbody, "جاري التحميل…");
          google.script.run
            .withFailureHandler((err) => {
              console.error("[CLIENT] listUserProperties failed:", err);
              propertiesLoaded = false;
              setTableStatus(
                propertiesTbody,
                "خطأ: " + (err.message || err),
                "error"
              );
            })
            .withSuccessHandler((rows) => {
              console.log(
                "[CLIENT] User properties data received, count:",
                Array.isArray(rows) ? rows.length : 0
              );
              console.log("[CLIENT] User properties data:", rows);
              propertiesLoaded = true;
              const list = Array.isArray(rows) ? rows : [];
              renderTableRows(propertiesTbody, list, (row) => {
                return `
                  <td>${escapeHtml(row.userId || "")}</td>
                  <td>${escapeHtml(row.key || "")}</td>
                  <td>${escapeHtml(row.value || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
                  <td>${escapeHtml(row.updatedBy || "")}</td>
                `;
              });
            })
            .listUserProperties();
        }

        function loadSessions({ force = false } = {}) {
          if (!sessionsTbody) return;
          if (sessionsLoaded && !force) return;
          console.log("[CLIENT] loadSessions called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            setTableStatus(sessionsTbody, "غير متصل بالخادم.", "error");
            return;
          }
          setTableStatus(sessionsTbody, "جاري التحميل…");
          google.script.run
            .withFailureHandler((err) => {
              console.error("[CLIENT] listSessions failed:", err);
              sessionsLoaded = false;
              setTableStatus(
                sessionsTbody,
                "خطأ: " + (err.message || err),
                "error"
              );
            })
            .withSuccessHandler((rows) => {
              console.log(
                "[CLIENT] Sessions data received, count:",
                Array.isArray(rows) ? rows.length : 0
              );
              console.log("[CLIENT] Sessions data:", rows);
              sessionsLoaded = true;
              const list = Array.isArray(rows) ? rows : [];
              renderTableRows(sessionsTbody, list, (row) => {
                return `
                  <td>${escapeHtml(row.sessionId || "")}</td>
                  <td>${escapeHtml(row.userId || "")}</td>
                  <td>${escapeHtml(row.actor || "")}</td>
                  <td>${escapeHtml(row.type || "")}</td>
                  <td>${escapeHtml(row.status || "")}</td>
                  <td>${escapeHtml(formatDateTime(row.startedAt))}</td>
                  <td>${escapeHtml(formatDateTime(row.endedAt))}</td>
                `;
              });
            })
            .listSessions();
        }

        function loadAuditLog({ force = false } = {}) {
          if (!auditTbody) return;
          if (auditLoaded && !force) return;
          console.log("[CLIENT] loadAuditLog called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            setTableStatus(auditTbody, "غير متصل بالخادم.", "error");
            return;
          }
          setTableStatus(auditTbody, "جاري التحميل…");
          google.script.run
            .withFailureHandler((err) => {
              console.error("[CLIENT] getAuditLog failed:", err);
              auditLoaded = false;
              setTableStatus(
                auditTbody,
                "خطأ: " + (err.message || err),
                "error"
              );
            })
            .withSuccessHandler((rows) => {
              console.log(
                "[CLIENT] Audit log data received, count:",
                Array.isArray(rows) ? rows.length : 0
              );
              console.log("[CLIENT] Audit log data:", rows);
              auditLoaded = true;
              const list = Array.isArray(rows) ? rows : [];
              renderTableRows(auditTbody, list, (row) => {
                return `
                  <td>${escapeHtml(formatDateTime(row.timestamp))}</td>
                  <td>${escapeHtml(row.user || "")}</td>
                  <td>${escapeHtml(row.action || "")}</td>
                  <td><pre style="white-space:pre-wrap;margin:0;">${escapeHtml(
                    parseDetails(row.details)
                  )}</pre></td>
                `;
              });
            })
            .getAuditLog();
        }

        const sysPaneLoaders = {
          overview: ({ force } = {}) => {
            if (force) overviewLoaded = false;
            if (!overviewLoaded) {
              fetchKPIs();
              overviewLoaded = true;
            }
          },
          users: (options = {}) => loadUsers(options),
          roles: (options = {}) => loadRoles(options),
          permissions: (options = {}) => loadPermissions(options),
          rolePerms: (options = {}) => loadRolePermissions(options),
          properties: (options = {}) => loadProperties(options),
          sessions: (options = {}) => loadSessions(options),
          audit: (options = {}) => loadAuditLog(options),
        };

        function runPaneLoaders(paneName, options = {}) {
          const loader = sysPaneLoaders[paneName];
          if (loader) loader(options);
        }

        function setActiveSysPane(paneName, options = {}) {
          if (!paneName || !sysPanes.length) return;
          if (paneName === currentSysPane && !options.force) {
            runPaneLoaders(paneName, options);
            return;
          }
          currentSysPane = paneName;
          sysPanes.forEach((pane) => {
            const paneKey = pane.dataset.pane;
            const stacksWith = (pane.dataset.stackWith || "")
              .split(",")
              .map((token) => token.trim())
              .filter(Boolean);
            const shouldShow =
              paneKey === paneName || stacksWith.includes(paneName);
            pane.classList.toggle("active", shouldShow);
          });
          sysNavButtons.forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.pane === paneName);
          });
          runPaneLoaders(paneName, options);
        }

        if (sysNav) {
          sysNav.addEventListener("click", (evt) => {
            const btn = evt.target.closest("button[data-pane]");
            if (!btn) return;
            evt.preventDefault();
            const pane = btn.dataset.pane || "users";
            setActiveSysPane(pane);
          });
        }

        function syncSelectAllState() {
          if (!selectAllUsers) return;
          const checkboxes = Array.from(
            usersTbody.querySelectorAll('input.row-select[type="checkbox"]')
          ).filter((cb) => !cb.disabled);
          if (checkboxes.length === 0) {
            selectAllUsers.checked = false;
            selectAllUsers.indeterminate = false;
            return;
          }
          const checkedCount = checkboxes.filter((cb) => cb.checked).length;
          selectAllUsers.checked = checkedCount === checkboxes.length;
          selectAllUsers.indeterminate =
            checkedCount > 0 && checkedCount < checkboxes.length;
        }

        function syncBulkActionsState() {
          const hasSelection = selectedUsers.size > 0;
          if (bulkExportBtn) bulkExportBtn.disabled = !hasSelection;
          if (bulkActivateBtn) bulkActivateBtn.disabled = !hasSelection;
          if (bulkDeactivateBtn) bulkDeactivateBtn.disabled = !hasSelection;
          if (bulkAssignRoleBtn)
            bulkAssignRoleBtn.disabled =
              !hasSelection || !bulkRoleSelect || !bulkRoleSelect.value;
        }

        function ensureSelection() {
          if (selectedUsers.size === 0) {
            showToast("الرجاء اختيار مستخدم واحد على الأقل.", "info");
            return false;
          }
          return true;
        }

        function performBulkStatus(makeActive) {
          if (!ensureSelection()) return;
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          const ids = Array.from(selectedUsers);
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تحديث الحالة للمستخدمين المحددين.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Bulk status update response:", res);
              const count = res?.updated ?? ids.length;
              showToast(
                "تم تحديث حالة " + count + " مستخدم.",
                "success",
                "تم التحديث"
              );
              selectedUsers.clear();
              loadUsers();
            })
            .bulkUpdateUserStatus(ids, makeActive);
        }

        function handleBulkAssignRole() {
          if (!bulkRoleSelect || !bulkRoleSelect.value) {
            showToast("يرجى اختيار دور للتعيين.", "info");
            return;
          }
          if (!ensureSelection()) return;
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          const ids = Array.from(selectedUsers);
          const roleId = bulkRoleSelect.value;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تعيين الدور للمستخدمين المحددين.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Bulk role assignment response:", res);
              const count = res?.updated ?? ids.length;
              showToast(
                "تم تعيين الدور لـ " + count + " مستخدم.",
                "success",
                "تم التعيين"
              );
              selectedUsers.clear();
              loadUsers();
            })
            .bulkAssignRole(ids, roleId);
        }

        function triggerExportDownload(payload) {
          if (!payload || !payload.content) {
            showToast("لا توجد بيانات للتصدير.", "info");
            return;
          }
          try {
            const blob = new Blob([payload.content], {
              type: payload.mimeType || "text/csv",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = payload.filename || "users_export.csv";
            document.body.appendChild(a);
            a.click();
            requestAnimationFrame(() => {
              URL.revokeObjectURL(url);
              a.remove();
            });
          } catch (err) {
            console.error(err);
            showToast("تعذر تنزيل ملف التصدير.", "error");
          }
        }

        function handleBulkExport() {
          if (!ensureSelection()) return;
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          const filters = Object.assign({}, currentFilters(), {
            userIds: Array.from(selectedUsers),
          });
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تجهيز ملف التصدير.", "error");
            })
            .withSuccessHandler((payload) => {
              console.log("Export payload received:", payload);
              triggerExportDownload(payload);
              showToast("تم تجهيز ملف التصدير.", "success");
            })
            .exportUsers(filters, "csv");
        }

        /* ---------- Global Toast (usable anywhere) ---------- */
        function ensureToastContainer() {
          let c = document.getElementById("toast-container");
          const loginScreen = document.getElementById("login-screen");
          const loginVisible =
            loginScreen && loginScreen.classList.contains("active");
          if (
            c &&
            c.parentElement &&
            c.parentElement !== document.body &&
            !loginVisible
          ) {
            c.id = "login-toast-container";
            c.classList.add("toast-container--login");
            c = null;
          }
          if (!c) {
            c = document.createElement("div");
            c.id = "toast-container";
            c.className = "toast-container";
            c.setAttribute("aria-live", "polite");
            c.setAttribute("aria-atomic", "true");
            document.body.appendChild(c);
          }
          return c;
        }
        function showToast(message, type = "info", title) {
          const toastContainer = ensureToastContainer();
          const t = document.createElement("div");
          t.className = "toast " + type;
          t.innerHTML =
            '<div class="toast__title">' +
            (title || (type === "success" ? "تم بنجاح" : "إشعار")) +
            '</div><div class="toast__msg">' +
            message +
            "</div>";
          toastContainer.appendChild(t);
          const hide = () => {
            t.classList.add("toast--hide");
            setTimeout(() => t.remove(), 300);
          };
          t.addEventListener("click", hide);
          setTimeout(hide, 3500);
        }

        /* ---------- Create / Edit User ---------- */
        const dlgNew = document.getElementById("dlg-new-user");
        const fieldsHost = document.getElementById("new-user-fields");
        let currentEditId = null; // null=create, value=edit mode

        document
          .getElementById("btn-new-user")
          .addEventListener("click", () => {
            if (!(window.google && google.script && google.script.run)) {
              showToast("غير متصل بالخادم.", "error");
              return;
            }
            currentEditId = null; // creation mode
            // Try dynamic form; if empty fallback to minimal static form
            google.script.run
              .withFailureHandler((err) => {
                console.error(err);
                buildMinimalUserForm();
                dlgNew.showModal();
              })
              .withSuccessHandler((fields) => {
                console.log("Add user form fields received:", fields);
                if (Array.isArray(fields) && fields.length) {
                  renderDynamicUserForm(fields, null);
                } else {
                  buildMinimalUserForm();
                }
                dlgNew.showModal();
              })
              .getFormWithOptions("FORM_SYS_AddUser");
          });

        document
          .getElementById("btn-cancel-new")
          .addEventListener("click", () => dlgNew.close());

        function renderDynamicUserForm(fields, initialData = null) {
          const host = document.getElementById("new-user-fields");
          host.classList.add("dialog-body");
          host.innerHTML = "";
          const layout = document.createElement("div");
          layout.className = "dyn-layout";
          const tabBar = document.createElement("div");
          tabBar.className = "dyn-tabs";
          tabBar.setAttribute("role", "tablist");
          const pages = document.createElement("div");
          pages.className = "dyn-pages";
          layout.appendChild(tabBar);
          layout.appendChild(pages);
          host.appendChild(layout);

          const tabs = {};
          fields.forEach((f) => {
            const tab = f.tabId || f.tabName || "default";
            const sec = f.section || "";
            if (!tabs[tab])
              tabs[tab] = { name: f.tabName || "عام", sections: {} };
            if (!tabs[tab].sections[sec]) tabs[tab].sections[sec] = [];
            tabs[tab].sections[sec].push(f);
          });

          function makePage(tabKey, tab, index) {
            const page = document.createElement("div");
            const safeKey = String(tabKey || "tab")
              .replace(/[^a-zA-Z0-9_-]+/g, "_")
              .toLowerCase();
            page.className = "form-grid dyn-page hidden";
            page.id = `dyn-tab-${index}-${safeKey}`;
            page.setAttribute("role", "tabpanel");
            page.setAttribute("aria-hidden", "true");
            Object.keys(tab.sections).forEach((sec) => {
              if (sec) {
                const h = document.createElement("div");
                h.className = "span-2 muted";
                h.style.margin = ".4rem 0 .2rem";
                h.textContent = sec;
                page.appendChild(h);
              }
              tab.sections[sec].forEach((f, i) => {
                const id = `nu_${(
                  f.targetColumn ||
                  f.fieldId ||
                  tabKey + i
                ).replace(/\s+/g, "_")}`;
                const wrap = document.createElement("div");
                const label = document.createElement("label");
                label.textContent =
                  f.label || f.targetColumn || f.fieldId || "حقل " + (i + 1);
                label.setAttribute("for", id);
                let el;
                const t = String(f.type || "text").toLowerCase();
                const isPassword =
                  f.targetColumn === "Password_Hash" ||
                  f.targetColumn === "password" ||
                  /password/i.test(f.fieldId || "");
                if (currentEditId && isPassword) return; // لا نعرض كلمة المرور في وضع التعديل
                if (t === "dropdown") {
                  el = document.createElement("select");
                  (f.options || []).forEach((opt) => {
                    const o = document.createElement("option");
                    o.value = opt.value;
                    o.textContent = opt.label || opt.value;
                    el.appendChild(o);
                  });
                } else if (t === "textarea" || t === "paragraph") {
                  el = document.createElement("textarea");
                  el.rows = 4;
                  wrap.classList.add("span-2");
                } else if (t === "auto") {
                  el = document.createElement("input");
                  el.type = "text";
                  el.readOnly = true;
                  el.placeholder = "AutoGenerate";
                } else if (t === "password" || isPassword) {
                  el = document.createElement("input");
                  el.type = "password";
                  el.autocomplete = initialData
                    ? "current-password"
                    : "new-password";
                } else {
                  el = document.createElement("input");
                  el.type = t === "email" ? "email" : "text";
                }
                el.name = f.targetColumn || f.fieldId || id;
                el.id = id;
                if (f.readOnly) {
                  el.readOnly = true;
                  el.setAttribute("aria-readonly", "true");
                }
                if (f.required && !el.readOnly) el.required = true;
                if (initialData) {
                  const k = f.targetColumn || f.fieldId;
                  if (k && initialData[k] != null) el.value = initialData[k];
                  if (k === "User_Id") el.readOnly = true;
                } else if (
                  f.defaultValue !== undefined &&
                  f.defaultValue !== null &&
                  String(f.defaultValue) !== ""
                ) {
                  el.value = f.defaultValue;
                }
                if (
                  !initialData &&
                  (f.targetColumn === "User_Id" ||
                    /User_Id/i.test(f.fieldId || ""))
                ) {
                  if (window.google && google.script && google.script.run) {
                    google.script.run
                      .withSuccessHandler((nextId) => {
                        el.value = nextId;
                        el.readOnly = true;
                      })
                      .getNextUserId();
                  }
                }
                if (
                  /Notes|ملاحظات/i.test(f.fieldId || "") ||
                  /Notes|ملاحظات/i.test(f.targetColumn || "")
                ) {
                  wrap.classList.add("span-2");
                }
                wrap.appendChild(label);
                wrap.appendChild(el);
                page.appendChild(wrap);
              });
            });
            return page;
          }

          const tabKeys = Object.keys(tabs);
          const pagesEls = tabKeys.map((k, idx) => makePage(k, tabs[k], idx));
          pagesEls.forEach((p) => pages.appendChild(p));
          const tabButtons = [];
          const activateTab = (targetIdx) => {
            pagesEls.forEach((page, idx) => {
              const isActive = idx === targetIdx;
              page.classList.toggle("hidden", !isActive);
              page.setAttribute("aria-hidden", isActive ? "false" : "true");
            });
            tabButtons.forEach((btn, idx) => {
              const isActive = idx === targetIdx;
              btn.classList.toggle("active", isActive);
              btn.setAttribute("aria-selected", isActive ? "true" : "false");
              btn.tabIndex = isActive ? 0 : -1;
            });
          };

          tabKeys.forEach((k, idx) => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "nav-item" + (idx === 0 ? " active" : "");
            b.textContent = tabs[k].name || "تبويب";
            b.setAttribute("role", "tab");
            b.setAttribute("aria-selected", idx === 0 ? "true" : "false");
            b.setAttribute("aria-controls", pagesEls[idx].id);
            b.tabIndex = idx === 0 ? 0 : -1;
            b.addEventListener("click", () => activateTab(idx));
            b.addEventListener("keydown", (evt) => {
              if (evt.key === "ArrowLeft" || evt.key === "ArrowUp") {
                evt.preventDefault();
                const prev = (idx - 1 + tabButtons.length) % tabButtons.length;
                activateTab(prev);
                tabButtons[prev].focus();
              } else if (evt.key === "ArrowRight" || evt.key === "ArrowDown") {
                evt.preventDefault();
                const next = (idx + 1) % tabButtons.length;
                activateTab(next);
                tabButtons[next].focus();
              }
            });
            tabBar.appendChild(b);
            tabButtons.push(b);
          });

          if (tabKeys.length) {
            activateTab(0);
          }
        }

        function buildMinimalUserForm(initialData = null) {
          fieldsHost.innerHTML = "";
          fieldsHost.classList.add("dialog-body");
          const grid = document.createElement("div");
          grid.className = "form-grid";
          const isEdit = !!initialData;
          grid.innerHTML = `
            <div><label>رقم المستخدم</label><input id="nu_uid" name="User_Id" type="text" ${
              isEdit ? "" : "readonly"
            } autocomplete="off" placeholder="AutoGenerate" /></div>
            <div><label>الاسم الكامل</label><input name="Full_Name" type="text" required /></div>
            <div><label>اسم المستخدم</label><input name="Username" type="text" required /></div>
            <div><label>البريد الإلكتروني</label><input name="Email" type="email" /></div>
            <div><label>القسم</label><select id="nu_dept" name="Department"></select></div>
            <div><label>الدور</label><select id="nu_role" name="Role_Id"></select></div>
            <div class="span-2"><label>ملاحظات</label><textarea name="Notes" rows="3"></textarea></div>
            <div><label>نشط؟</label><select name="IsActive"><option value="true">نعم</option><option value="false">لا</option></select></div>
            ${
              isEdit
                ? ""
                : '<div><label>كلمة المرور</label><input name="password" type="password" autocomplete="new-password" required /></div>'
            }`;
          fieldsHost.appendChild(grid);
          // next id & filters
          if (window.google && google.script && google.script.run) {
            if (!isEdit) {
              google.script.run
                .withSuccessHandler((nextId) => {
                  console.log("Next user ID received:", nextId);
                  const el = document.getElementById("nu_uid");
                  if (el) {
                    el.value = nextId;
                  }
                })
                .getNextUserId();
            }
            google.script.run
              .withSuccessHandler((f) => {
                console.log("Dynamic form filters received:", f);
                const d = f?.departments || [];
                const r = f?.roles || [];
                const dSel = document.getElementById("nu_dept");
                const rSel = document.getElementById("nu_role");
                [d, r].forEach((arr, idx) => {
                  const sel = idx === 0 ? dSel : rSel;
                  sel.innerHTML =
                    '<option value=""></option>' +
                    (arr || [])
                      .map((v) => `<option value="${v}">${v}</option>`)
                      .join("");
                });
                if (initialData) {
                  if (initialData.Department)
                    dSel.value = initialData.Department;
                  if (initialData.Role_Id) rSel.value = initialData.Role_Id;
                }
              })
              .getDeptAndRoleFilters();
          }
          if (initialData) {
            Object.keys(initialData).forEach((k) => {
              const el = grid.querySelector(`[name="${k}"]`);
              if (el) {
                el.value = initialData[k];
              }
            });
            const idEl = grid.querySelector("#nu_uid");
            if (idEl) {
              idEl.readOnly = true;
            }
          }
        }

        // إرسال النموذج (يخدم الإنشاء والتعديل)
        document
          .getElementById("new-user-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {};
            for (const [k, v] of fd.entries()) {
              if (k === "IsActive") {
                payload[k] =
                  v === "true" || v === "Yes" || v === "نشط" || v === "Active";
              } else if (k === "password") {
                payload.password = v;
              } else {
                payload[k] = v;
              }
            }
            if (!(window.google && google.script && google.script.run)) {
              showToast("غير متصل بالخادم.", "error");
              return;
            }
            if (currentEditId) {
              payload.User_Id = payload.User_Id || currentEditId;
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("تعذّر تحديث المستخدم.", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Update user response:", res);
                  showToast("تم تحديث بيانات المستخدم.", "success");
                  dlgNew.close();
                  e.target.reset();
                  loadUsers();
                })
                .updateUser(payload);
            } else {
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("تعذّر إنشاء المستخدم.", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Create user response:", res);
                  showToast("تم إنشاء المستخدم بنجاح.", "success");
                  dlgNew.close();
                  e.target.reset();
                  loadUsers();
                })
                .createUser(payload);
            }
          });

        function openUserEditor(userId) {
          currentEditId = userId;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تحميل بيانات المستخدم.", "error");
            })
            .withSuccessHandler((user) => {
              console.log("User profile for edit received:", user);
              if (!user) {
                showToast("لم يتم العثور على المستخدم.", "error");
                return;
              }
              const handleForm = (fields) => {
                console.log("Edit user form fields received:", fields);
                if (Array.isArray(fields) && fields.length) {
                  renderDynamicUserForm(fields, user);
                } else {
                  buildMinimalUserForm(user);
                }
                dlgNew.showModal();
              };
              google.script.run
                .withFailureHandler((err2) => {
                  console.error(err2);
                  buildMinimalUserForm(user);
                  dlgNew.showModal();
                })
                .withSuccessHandler(handleForm)
                .getFormWithOptions("FORM_SYS_EditUser");
            })
            .getUserById(userId);
        }

        function ensureRoleOptionsLoaded(callback) {
          const bootstrapRoles = (() => {
            if (bootstrapData?.filters?.roleOptions?.length) {
              return bootstrapData.filters.roleOptions;
            }
            if (bootstrapData?.filters?.roles?.length) {
              return bootstrapData.filters.roles.map((value) => ({
                value,
                label: value,
              }));
            }
            return [];
          })();
          const cached =
            (roleOptionsCache && roleOptionsCache.length
              ? roleOptionsCache
              : bootstrapRoles) || [];
          if (cached.length) {
            roleOptionsCache = cached;
            callback(roleOptionsCache);
            return;
          }
          if (!(window.google && google.script && google.script.run)) {
            callback([]);
            return;
          }
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              callback([]);
            })
            .withSuccessHandler((options) => {
              console.log("Role options received:", options);
              roleOptionsCache = Array.isArray(options) ? options : [];
              callback(roleOptionsCache);
            })
            .getRoleOptions();
        }

        function describeUserForLabel(userId) {
          const match = normalizedUsersCache.find((u) => u.userId === userId);
          if (!match) return userId;
          const pieces = [];
          if (match.fullName) pieces.push(match.fullName);
          if (match.username) pieces.push(`(${match.username})`);
          const joined = pieces.join(" ").trim();
          return joined || userId;
        }

        function openAssignRoleDialog(userId) {
          assignRoleUserInput.value = userId;
          assignRoleUserLabel.textContent = `المستخدم: ${describeUserForLabel(
            userId
          )}`;
          ensureRoleOptionsLoaded((options) => {
            assignRoleSelect.innerHTML = '<option value="">اختر دورًا</option>';
            fillSelect(assignRoleSelect, options);
            const match = normalizedUsersCache.find((u) => u.userId === userId);
            if (match?.role) {
              assignRoleSelect.value = match.role;
            }
            dlgAssign.showModal();
          });
        }

        function setProfileTab(tabName = "profile") {
          profileTabButtons.forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.tab === tabName);
          });
          profilePanels.forEach((panel) => {
            panel.classList.toggle("active", panel.dataset.tab === tabName);
          });
        }

        profileTabButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const tab = btn.dataset.tab || "profile";
            setProfileTab(tab);
          });
        });

        if (btnCloseProfile)
          btnCloseProfile.addEventListener("click", () => dlgProfile.close());
        if (btnCancelAssign)
          btnCancelAssign.addEventListener("click", () => dlgAssign.close());
        if (dlgProfile)
          dlgProfile.addEventListener("close", () => {
            currentProfileUserId = null;
            profileDataCache = null;
          });

        if (formAssignRole)
          formAssignRole.addEventListener("submit", (e) => {
            e.preventDefault();
            const userId = assignRoleUserInput.value;
            const roleId = assignRoleSelect.value;
            if (!userId || !roleId) {
              showToast("يرجى اختيار الدور.", "info");
              return;
            }
            google.script.run
              .withFailureHandler((err) => {
                console.error(err);
                showToast("تعذر تعيين الدور للمستخدم المحدد.", "error");
              })
              .withSuccessHandler((res) => {
                console.log("Assign user role response:", res);
                showToast("تم تعيين الدور بنجاح.", "success");
                dlgAssign.close();
                loadUsers();
              })
              .assignUserRole(userId, roleId);
          });

        function renderDefinitionList(listEl, rows) {
          if (!listEl) return;
          listEl.innerHTML = "";
          rows
            .filter((row) => row && row.label)
            .forEach((row) => {
              const dt = document.createElement("dt");
              dt.textContent = row.label;
              const dd = document.createElement("dd");
              dd.textContent = row.value ?? "—";
              listEl.appendChild(dt);
              listEl.appendChild(dd);
            });
        }

        function renderTableRows(bodyEl, rows, renderRow) {
          if (!bodyEl) return;
          bodyEl.innerHTML = "";
          if (!rows || !rows.length) {
            const empty = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = bodyEl.parentElement
              ? bodyEl.parentElement.querySelectorAll("thead th").length || 1
              : 1;
            td.className = "profile-empty";
            td.textContent = "لا توجد بيانات";
            empty.appendChild(td);
            bodyEl.appendChild(empty);
            return;
          }
          rows.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = renderRow(row);
            bodyEl.appendChild(tr);
          });
        }

        function normalizeBool(val) {
          if (val === true) return true;
          if (val === false) return false;
          const str = String(val || "").toLowerCase();
          return (
            str === "true" ||
            str === "yes" ||
            str === "نشط" ||
            str === "1" ||
            str === "enabled" ||
            str === "مفعل" ||
            str === "مُفعّل" ||
            str === "active"
          );
        }

        function parseDetails(details) {
          if (!details) return "";
          if (typeof details === "string") {
            try {
              const parsed = JSON.parse(details);
              if (parsed && typeof parsed === "object") {
                return JSON.stringify(parsed, null, 2);
              }
            } catch (err) {
              return details;
            }
            return details;
          }
          if (typeof details === "object") {
            try {
              return JSON.stringify(details, null, 2);
            } catch (err) {
              return String(details);
            }
          }
          return String(details);
        }

        function renderUserProfileDialog(payload, defaultTab = "profile") {
          if (!payload) return;
          const user = payload.user || {};
          profileTitle.textContent =
            user.Full_Name || user.Username || user.User_Id || "مستخدم";
          profileUsername.textContent = user.Username
            ? `@${user.Username}`
            : "";
          renderDefinitionList(profileOverviewList, [
            { label: "الاسم الكامل", value: user.Full_Name || "—" },
            { label: "اسم المستخدم", value: user.Username || "—" },
            { label: "البريد الإلكتروني", value: user.Email || "—" },
            { label: "القسم", value: user.Department || "—" },
            { label: "الدور", value: user.Role_Id || "—" },
            {
              label: "نشط؟",
              value: normalizeBool(user.IsActive) ? "نعم" : "لا",
            },
            {
              label: "تفعيل MFA",
              value: normalizeBool(user.MFA_Enabled) ? "مُفعّل" : "غير مُفعّل",
            },
            {
              label: "آخر تسجيل دخول",
              value: formatDateTime(user.Last_Login || user.lastLogin),
            },
            {
              label: "تاريخ الإنشاء",
              value: formatDateTime(user.Created_At || user.createdAt),
            },
            {
              label: "آخر تحديث",
              value: formatDateTime(user.Updated_At || user.updatedAt),
            },
            { label: "ملاحظات", value: user.Notes || "—" },
          ]);

          renderTableRows(profilePropertiesBody, payload.properties, (row) => {
            return `
              <td>${escapeHtml(row.key || "")}</td>
              <td>${escapeHtml(row.value || "")}</td>
              <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
              <td>${escapeHtml(row.updatedBy || "")}</td>
            `;
          });

          renderTableRows(profileDocumentsBody, payload.documents, (row) => {
            const label = row.label || row.fileName || "—";
            const link = row.url
              ? `<a class="profile-doc-link" href="${escapeHtml(
                  row.url
                )}" target="_blank" rel="noopener">فتح</a>`
              : "—";
            return `
              <td>${escapeHtml(label)}</td>
              <td>${escapeHtml(row.uploadedBy || "")}</td>
              <td>${escapeHtml(formatDateTime(row.createdAt))}</td>
              <td>${link}</td>
            `;
          });

          renderTableRows(profileSessionsBody, payload.sessions, (row) => {
            return `
              <td>${escapeHtml(row.sessionId || "")}</td>
              <td>${escapeHtml(row.actor || "")}</td>
              <td>${escapeHtml(row.type || "")}</td>
              <td>${escapeHtml(row.status || "")}</td>
              <td>${escapeHtml(formatDateTime(row.startedAt))}</td>
              <td>${escapeHtml(formatDateTime(row.endedAt))}</td>
            `;
          });

          renderTableRows(profileAuditBody, payload.audit, (row) => {
            return `
              <td>${escapeHtml(formatDateTime(row.timestamp))}</td>
              <td>${escapeHtml(row.actor || "")}</td>
              <td>${escapeHtml(row.action || "")}</td>
              <td><pre style="white-space:pre-wrap;margin:0;">${escapeHtml(
                parseDetails(row.details)
              )}</pre></td>
            `;
          });

          setProfileTab(defaultTab);
          dlgProfile.showModal();
        }

        function openUserProfile(userId, tabName = "profile") {
          currentProfileUserId = userId;
          profileDataCache = null;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تحميل ملف المستخدم.", "error");
            })
            .withSuccessHandler((payload) => {
              console.log("User profile payload received:", payload);
              if (!payload || !payload.user) {
                showToast("لم يتم العثور على المستخدم.", "error");
                return;
              }
              profileDataCache = payload;
              renderUserProfileDialog(payload, tabName);
            })
            .getUserProfile(userId);
        }

        function startImpersonationFlow(userId) {
          if (!userId) return;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر بدء جلسة الانتحال.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Impersonation start response:", res);
              const sessionId = res?.sessionId || "";
              showToast(
                sessionId
                  ? `تم بدء جلسة انتحال (${sessionId}).`
                  : "تم تسجيل الانتحال.",
                "success"
              );
              if (currentProfileUserId === userId && profileDataCache) {
                openUserProfile(userId, "sessions");
              }
            })
            .startImpersonation(userId);
        }

        function performSoftDelete(userId) {
          const confirmed = confirm("هل أنت متأكد من تنفيذ حذف رمزي؟");
          if (!confirmed) return;
          const reason = prompt("أدخل سبب الحذف الرمزي (اختياري):", "") || "";
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر حذف المستخدم.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Soft delete response:", res);
              showToast("تم تعطيل المستخدم ووضع علامة الحذف.", "success");
              loadUsers();
              if (currentProfileUserId === userId && profileDataCache) {
                openUserProfile(userId, "profile");
              }
            })
            .softDeleteUser(userId, reason);
        }

        /* Welcome label shows Full_Name (Username) when available */
        function updateUserContext(nameOrObj) {
          let display = "User";
          let uname = "";
          if (typeof nameOrObj === "object" && nameOrObj) {
            const username = nameOrObj.Username || "";
            display = nameOrObj.Full_Name || username || "User";
            uname = username && username !== display ? ` (${username})` : "";
          } else if (typeof nameOrObj === "string") {
            display = nameOrObj;
          }
          userLabel.textContent = `User: ${display}${uname}`;
          const welcome = document.getElementById("portal-welcome-message");
          if (welcome) welcome.textContent = `Welcome, ${display}${uname}`;
        }

        // Set up sys nav event handlers
        if (sysNav) {
          sysNav.addEventListener("click", (e) => {
            const btn = e.target.closest("[data-pane]");
            if (btn) {
              const pane = btn.dataset.pane;
              setActiveSysPane(pane);
            }
          });
        }

        // On login, immediately show typed username; server bootstrap will refine with Full_Name
        loginForm.addEventListener("submit", (e) => {
          const uVal = (document.getElementById("username").value || "").trim();
          setTimeout(() => {
            updateUserContext({ Username: uVal });
          }, 500);
        });

        /* Init */
        setActiveSysPane("overview", { force: true });
        renderNav();
        bootstrapApp();
      })();
    </script>
  </body>
</html>
