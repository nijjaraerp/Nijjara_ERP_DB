<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nijjara ERP - Demo Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-bg: #121212;
        --color-bg-panel: #1e1e1e;
        --color-border: rgba(255, 255, 255, 0.1);
        --color-text-primary: #f0f0f0;
        --color-text-secondary: #a0a0a0;
        --color-accent: #d4af37;
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
        --color-success: #2ecc71;
        --color-danger: #e74c3c;
        --font-family-arabic: "Cairo", sans-serif;
      }
      .module-card h2,
      .nav-btn,
      .nav-item,
      .portal-header h1,
      .portal-header p,
      .workspace-title,
      body,
      button,
      html,
      input,
      select,
      table,
      td,
      textarea,
      th {
        font-family: var(--font-family-arabic) !important;
      }
      .visually-hidden {
        position: absolute !important;
        height: 1px;
        width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
        background: var(--color-bg);
        color: var(--color-text-primary);
        overflow: hidden;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
      .view {
        position: fixed;
        inset: 0;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.45s ease, visibility 0.45s;
      }
      .view.active {
        opacity: 1;
        visibility: visible;
      }
      #login-screen {
        display: grid;
        place-content: center;
        background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%232a2a2a" fill-opacity="0.2"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v-1zm-7 5h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zM54 95h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zm-7 0h1v4h-1v-4zM9 95h1v4h-1v-4zm-7 0h1v4H2v-4zM95 0h1v4h-1V0zM2 0h1v4H2V0z"/%3E%3Cpath d="M6 95h4v1H6v-1zM4 95h1v4H4v-4zM95 6h1v4h-1V6zM95 4h1v1h-1V4z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
      }
      .login-container {
        width: 400px;
        max-width: 92vw;
        padding: 3rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.88);
        backdrop-filter: blur(10px);
        animation: fadeIn 0.6s ease;
        position: relative;
      }
      .logo {
        font-size: 2.4rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 2rem;
      }
      .logo span {
        color: var(--color-accent);
        font-weight: 600;
      }
      .form-group {
        margin-bottom: 1.2rem;
        text-align: right;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.4rem;
        font-size: 0.95rem;
        color: var(--color-text-secondary);
      }
      .form-group input {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 1px solid var(--color-border);
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-text-primary);
        font-size: 1rem;
        outline: 0;
        transition: border-color 0.25s, box-shadow 0.25s;
      }
      .form-group input:focus {
        border-color: var(--color-accent);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.15);
      }
      .main-button {
        width: 100%;
        padding: 0.9rem 1.2rem;
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 14px;
        background: linear-gradient(
          160deg,
          rgba(212, 175, 55, 0.92),
          rgba(164, 135, 34, 0.85)
        );
        color: #111;
        font-weight: 700;
        cursor: pointer;
        position: relative;
        box-shadow: 0 16px 32px rgba(0, 0, 0, 0.45),
          inset 0 1px 0 rgba(255, 255, 255, 0.35);
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      }
      .main-button:hover {
        transform: translateY(-3px);
        border-color: rgba(255, 255, 255, 0.45);
      }
      .main-button:active {
        transform: translateY(-1px);
      }
      .main-button .spinner {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid #000;
        border-top-color: transparent;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: spin 0.8s linear infinite;
      }
      .main-button.loading .spinner {
        display: block;
      }
      .main-button.loading span {
        visibility: hidden;
      }

      .app-navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(18, 18, 18, 0.98);
        border-bottom: 1px solid var(--color-border);
        padding: 0 2rem;
        z-index: 50;
      }
      .app-navbar.hidden {
        display: none;
      }
      .app-navbar__left,
      .app-navbar__right {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .navbar-buttons {
        display: inline-flex;
        gap: 0.5rem;
        margin-inline-start: 1rem;
      }
      .app-brand {
        font-weight: 700;
        color: var(--color-accent);
      }
      .nav-btn {
        background: 0 0;
        border: none;
        color: var(--color-text-secondary);
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }
      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: var(--color-text-primary);
      }
      .nav-btn.active {
        background: rgba(212, 175, 55, 0.18);
        color: var(--color-accent);
      }
      .navbar-user {
        color: var(--color-text-secondary);
      }

      #portal-view {
        padding: 5.5rem 2rem 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .portal-header {
        text-align: center;
        margin-bottom: 2.2rem;
      }
      .module-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(180px, 1fr));
        gap: 1.5rem;
        max-width: 1100px;
        width: 100%;
      }
      .module-card {
        --card-primary: rgba(36, 36, 36, 0.92);
        --card-secondary: rgba(17, 17, 17, 0.88);
        --card-border: rgba(255, 255, 255, 0.1);
        --card-glow: rgba(255, 255, 255, 0.12);
        position: relative;
        padding: 2rem 1.6rem;
        border: 1px solid var(--card-border);
        border-radius: 16px;
        background: linear-gradient(
          160deg,
          var(--card-primary),
          var(--card-secondary)
        );
        box-shadow: 0 18px 32px rgba(0, 0, 0, 0.55),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        text-align: center;
      }
      .module-card:hover {
        transform: translateY(-8px);
        border-color: var(--card-glow);
      }
      .module-card h2 {
        font-size: 1.3rem;
      }
      .module-card[data-theme="projects"] {
        --card-primary: rgba(40, 52, 82, 0.92);
        --card-secondary: rgba(22, 30, 50, 0.88);
        --card-border: rgba(90, 140, 255, 0.28);
        --card-glow: rgba(90, 140, 255, 0.4);
      }
      .module-card[data-theme="finance"] {
        --card-primary: rgba(55, 45, 26, 0.92);
        --card-secondary: rgba(34, 28, 16, 0.88);
        --card-border: rgba(210, 170, 80, 0.28);
        --card-glow: rgba(210, 170, 80, 0.4);
      }
      .module-card[data-theme="hr"] {
        --card-primary: rgba(36, 54, 48, 0.92);
        --card-secondary: rgba(19, 33, 28, 0.88);
        --card-border: rgba(102, 214, 168, 0.28);
        --card-glow: rgba(102, 214, 168, 0.4);
      }
      .module-card[data-theme="users"] {
        --card-primary: rgba(46, 33, 52, 0.92);
        --card-secondary: rgba(27, 18, 32, 0.88);
        --card-border: rgba(200, 110, 210, 0.28);
        --card-glow: rgba(200, 110, 210, 0.4);
      }

      .workspace {
        height: 100vh;
        display: grid;
        grid-template-columns: 1fr 280px;
        grid-template-rows: auto 1fr;
        grid-template-areas: "header header" "content nav";
        gap: 1.25rem;
        padding: 5.5rem 2rem 2rem;
        transform: scale(1.04);
        transition: transform 0.45s ease;
      }
      .view.active .workspace {
        transform: scale(1);
      }
      .workspace-header {
        grid-area: header;
        display: flex;
        align-items: end;
        justify-content: space-between;
      }
      .workspace-title {
        font-size: 1.6rem;
      }
      .workspace-content {
        grid-area: content;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(18, 18, 18, 0.9);
        padding: 1.25rem;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .workspace {
        --theme-accent: var(--color-accent);
        --theme-accent-16: rgba(212, 175, 55, 0.16);
        --theme-accent-24: rgba(212, 175, 55, 0.24);
      }
      .workspace[data-theme="projects"] {
        --theme-accent: #5a8cff;
        --theme-accent-16: rgba(90, 140, 255, 0.16);
        --theme-accent-24: rgba(90, 140, 255, 0.24);
      }
      .workspace[data-theme="finance"] {
        --theme-accent: #d2aa50;
        --theme-accent-16: rgba(210, 170, 80, 0.16);
        --theme-accent-24: rgba(210, 170, 80, 0.24);
      }
      .workspace[data-theme="hr"] {
        --theme-accent: #66d6a8;
        --theme-accent-16: rgba(102, 214, 168, 0.16);
        --theme-accent-24: rgba(102, 214, 168, 0.24);
      }
      .workspace[data-theme="users"] {
        --theme-accent: #c86ed2;
        --theme-accent-16: rgba(200, 110, 210, 0.16);
        --theme-accent-24: rgba(200, 110, 210, 0.24);
      }
      .workspace-nav {
        grid-area: nav;
        border: 1px solid var(--theme-accent-24);
        border-radius: 12px;
        background: rgba(18, 18, 18, 0.9);
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .nav-item {
        background: transparent;
        border: 1px solid var(--theme-accent-24);
        color: var(--color-text-secondary);
        text-align: right;
        padding: 0.6rem 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, border-color 0.2s;
        font-weight: 600;
      }
      .nav-item.active,
      .nav-item:hover {
        background: var(--theme-accent);
        border-color: var(--theme-accent);
        color: #111;
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.2) inset;
      }
      .nav-item:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 2px;
      }

      .sys-pane {
        display: none;
        flex-direction: column;
        gap: 1.5rem;
      }
      .sys-pane.active {
        display: flex;
      }
      .sys-pane__header {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .pane-heading {
        font-size: 1.1rem;
        font-weight: 600;
      }
      .sys-overview__summary {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .overview-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.8rem;
        margin-bottom: 0;
      }
      .overview-card {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.9);
        padding: 1rem;
      }
      .muted {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
      }
      .error-text {
        color: var(--color-danger);
        font-size: 0.95rem;
        text-align: center;
      }
      .table-wrapper {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: rgba(255, 255, 255, 0.04);
      }
      td,
      th {
        padding: 0.65rem 0.9rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        text-align: right;
      }
      tbody tr:hover {
        background: rgba(255, 255, 255, 0.04);
      }
      .ghost-button,
      .accent-button,
      .action-button {
        padding: 0.55rem 1rem;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }
      .ghost-button {
        background: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-secondary);
      }
      .ghost-button:hover {
        color: var(--color-text-primary);
        border-color: var(--theme-accent-24);
      }
      .accent-button {
        background: var(--theme-accent);
        color: #111;
        border: 1px solid var(--theme-accent-24);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
      }
      .accent-button:hover {
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.3);
      }
      .action-button {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid transparent;
        color: #111;
      }
      .save-button {
        background: var(--color-success);
        border-color: rgba(46, 204, 113, 0.4);
        color: #111;
      }
      .cancel-button {
        background: var(--color-danger);
        border-color: rgba(231, 76, 60, 0.4);
        color: #fff;
      }
      .edit-button {
        background: #e67e22;
        border-color: rgba(230, 126, 34, 0.4);
        color: #111;
      }
      .badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.8rem;
        border: 1px solid transparent;
      }
      .badge--ok {
        background: rgba(46, 204, 113, 0.15);
        color: #2ecc71;
        border-color: rgba(46, 204, 113, 0.3);
      }
      .badge--no {
        background: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
        border-color: rgba(231, 76, 60, 0.3);
      }
      .pane-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      .materials-catalog__controls,
      .materials-module__controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem 1rem;
      }
      .materials-catalog__search,
      .materials-module__search {
        flex: 1 1 260px;
        max-width: 420px;
      }
      .materials-catalog__search input,
      .materials-module__search input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border-radius: 10px;
        border: 1px solid var(--color-border);
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-text-primary);
      }
      .materials-catalog__table {
        width: 100%;
        border-collapse: collapse;
      }
      .materials-catalog__table th {
        cursor: pointer;
        position: relative;
      }
      .materials-catalog__table th.sorted-asc::after,
      .materials-catalog__table th.sorted-desc::after {
        content: "";
        position: absolute;
        inset-inline-end: 0.75rem;
        border: 5px solid transparent;
      }
      .materials-catalog__table th.sorted-asc::after {
        border-bottom-color: var(--color-accent);
        top: 45%;
      }
      .materials-catalog__table th.sorted-desc::after {
        border-top-color: var(--color-accent);
        bottom: 45%;
      }
      .materials-module {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .materials-module__tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .materials-module__section {
        display: block;
      }
      .materials-module__bulk {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .materials-module__select-column {
        width: 48px;
        text-align: center;
      }
      .materials-module__actions-column {
        white-space: nowrap;
        text-align: center;
      }
      .materials-module__count {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }
      .materials-status-toggle {
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        border: 1px solid rgba(212, 175, 55, 0.35);
        background: rgba(212, 175, 55, 0.08);
        color: var(--color-accent);
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .materials-status-toggle.is-active {
        border-color: rgba(46, 204, 113, 0.5);
        background: rgba(46, 204, 113, 0.15);
        color: var(--color-success);
      }
      .materials-row-action {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--color-text-primary);
        border-radius: 8px;
        padding: 0.25rem 0.45rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .materials-row-action:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .materials-row-action__icon {
        font-size: 0.85rem;
      }
      .pane-header .accent-button {
        min-width: 140px;
      }
      .direct-expense-pane {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .direct-expense__tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .direct-expense__section {
        display: block;
      }
      .direct-expense__section[hidden] {
        display: none !important;
      }
      .direct-expense__header {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem 1rem;
        align-items: end;
      }
      .direct-expense__footer {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
        justify-content: flex-start;
      }
      .direct-expense__meta {
        display: grid;
        grid-template-columns: minmax(260px, 2fr) minmax(200px, 1fr);
        gap: 0.75rem 1rem;
        align-items: stretch;
      }
      @media (max-width: 900px) {
        .direct-expense__meta {
          grid-template-columns: 1fr;
        }
      }
      .direct-expense__field {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 200px;
        flex: 1 1 200px;
      }
      .direct-expense__field--wide {
        flex-basis: 100%;
      }
      .direct-expense__field label {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__field select,
      .direct-expense__field input,
      .direct-expense__field textarea {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid var(--color-border);
        border-radius: 10px;
        padding: 0.6rem 0.75rem;
        color: var(--color-text-primary);
        width: 100%;
      }
      .direct-expense__field textarea {
        resize: vertical;
        min-height: 72px;
      }
      .direct-expense__main {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
      }
      .direct-expense__catalog,
      .direct-expense__cart {
        flex: 1;
        min-width: 300px;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.9);
        padding: 1.1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .direct-expense__cart {
        overflow: hidden;
      }
      .direct-expense__catalog h3,
      .direct-expense__cart h3 {
        font-size: 1.1rem;
      }
      .direct-expense__filters {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .direct-expense__filters input,
      .direct-expense__filters select {
        flex: 1 1 160px;
      }
      .direct-expense__filters input[type="search"] {
        max-width: 260px;
      }
      .direct-expense__materials-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 0.5rem;
        max-height: 420px;
        overflow-y: auto;
        padding-inline-end: 0.5rem;
        align-content: start;
      }
      .direct-expense__material-card {
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 10px;
        padding: 0.55rem 0.65rem;
        background: rgba(0, 0, 0, 0.25);
        display: grid;
        gap: 0.35rem;
        cursor: pointer;
        transition: border-color 0.2s ease, transform 0.2s ease,
          background 0.2s ease;
      }
      .direct-expense__material-card:hover,
      .direct-expense__material-card:focus-within {
        border-color: rgba(212, 175, 55, 0.6);
        transform: translateY(-2px);
        background: rgba(212, 175, 55, 0.08);
      }
      .direct-expense__material-id {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__material-name {
        font-weight: 600;
        font-size: 0.95rem;
      }
      .direct-expense__material-price {
        font-size: 0.85rem;
        color: var(--color-accent);
      }
      .direct-expense__cart-items {
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.2);
        overflow-x: auto;
        overflow-y: hidden;
        padding: 0.35rem;
      }
      #cart-items-table {
        width: 100%;
        min-width: 640px;
        border-collapse: separate;
        border-spacing: 0;
        background: rgba(10, 10, 10, 0.4);
        border-radius: 10px;
        overflow: hidden;
      }
      #cart-items-table thead th {
        background: rgba(255, 255, 255, 0.08);
        color: var(--color-text-primary);
        font-weight: 600;
        padding: 0.65rem 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
      }
      #cart-items-table tbody td {
        padding: 0.6rem 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        text-align: center;
      }
      #cart-items-table tbody tr:last-child td {
        border-bottom: none;
      }
      #cart-items-table td:first-child,
      #cart-items-table th:first-child {
        text-align: start;
      }
      #cart-items-table td:last-child,
      #cart-items-table th:last-child {
        width: 1%;
        white-space: nowrap;
        text-align: center;
      }
      #cart-items-table input[type="number"] {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 8px;
        padding: 0.35rem 0.5rem;
        color: var(--color-text-primary);
      }
      .direct-expense__totals {
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding-top: 0.75rem;
        display: grid;
        gap: 0.45rem;
      }
      .direct-expense__totals-row {
        display: flex;
        justify-content: space-between;
        color: var(--color-text-secondary);
      }
      .direct-expense__totals-row strong {
        color: var(--color-text-primary);
      }
      .direct-expense__remove-btn {
        background: transparent;
        border: 1px solid rgba(231, 76, 60, 0.6);
        color: #e74c3c;
        padding: 0.3rem 0.6rem;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }
      .direct-expense__remove-btn:hover {
        background: rgba(231, 76, 60, 0.12);
      }
      .direct-expense__attachments-section {
        display: grid;
        gap: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        background: rgba(30, 30, 30, 0.85);
      }
      .direct-expense__attachments-section h3 {
        margin: 0;
        font-size: 1.05rem;
      }
      .direct-expense__attachments-block {
        display: grid;
        gap: 0.65rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        padding-top: 0.75rem;
      }
      .direct-expense__attachment-list,
      .direct-expense__attachments-list {
        display: grid;
        gap: 0.45rem;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .direct-expense__attachments-btn {
        width: fit-content;
      }
      .direct-expense__attachments {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .direct-expense__field--attachments .direct-expense__attachments {
        align-items: flex-start;
        gap: 0.5rem;
      }
      .direct-expense__field--attachments .direct-expense__attachment-list {
        margin-top: 0.5rem;
      }
      .direct-expense__attachment-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.45rem 0.6rem;
        border: 1px dashed var(--color-border);
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
      }
      .direct-expense__attachment-item span {
        font-size: 0.85rem;
        color: var(--color-text-primary);
      }
      .direct-expense__attachment-label {
        flex: 1;
        background: transparent;
        border: 1px solid transparent;
        border-bottom: 1px solid var(--color-border);
        padding: 0.35rem 0.5rem;
        color: var(--color-text-primary);
      }
      .direct-expense__vat-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__vat-toggle input {
        width: auto;
      }
      .direct-expense__footer button {
        min-width: 180px;
      }
      .direct-expense__empty {
        color: var(--color-text-secondary);
        text-align: center;
        padding: 1rem 0;
      }
      .direct-expense__view-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
        margin-bottom: 1rem;
      }
      .direct-expense__view-controls input[type="search"] {
        flex: 1 1 260px;
        min-width: 220px;
        padding: 0.55rem 0.75rem;
        border-radius: 10px;
        border: 1px solid var(--color-border);
        background: rgba(0, 0, 0, 0.3);
        color: var(--color-text-primary);
      }
      .direct-expense__table {
        width: 100%;
        border-collapse: collapse;
      }
      .direct-expense__table th {
        cursor: pointer;
        position: relative;
      }
      .direct-expense__table th.sorted-asc::after,
      .direct-expense__table th.sorted-desc::after {
        content: "";
        position: absolute;
        inset-inline-end: 0.75rem;
        border: 5px solid transparent;
      }
      .direct-expense__table th.sorted-asc::after {
        border-bottom-color: var(--color-accent);
        top: 45%;
      }
      .direct-expense__table th.sorted-desc::after {
        border-top-color: var(--color-accent);
        bottom: 45%;
      }
      .direct-expense__table tbody tr {
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .direct-expense__table tbody tr:hover {
        background: rgba(212, 175, 55, 0.12);
      }
      .direct-expense__modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.72);
        display: grid;
        place-items: center;
        z-index: 2000;
        padding: 2rem 1.5rem;
      }
      .direct-expense__modal {
        width: min(680px, 96vw);
        max-height: 90vh;
        overflow-y: auto;
        background: rgba(18, 18, 18, 0.95);
        border: 1px solid var(--color-border);
        border-radius: 14px;
        padding: 1.5rem;
        display: grid;
        gap: 1rem;
      }
      .direct-expense__modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }
      .direct-expense__modal-body {
        display: grid;
        gap: 1rem;
      }
      .direct-expense__modal-grid {
        display: grid;
        gap: 0.5rem 1rem;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      .direct-expense__modal-grid dt {
        font-size: 0.85rem;
        color: var(--color-text-secondary);
      }
      .direct-expense__modal-grid dd {
        margin: 0;
        font-weight: 600;
      }
      .ghost-button--sm {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
      }
      .notice-card {
        border: 1px dashed var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        line-height: 1.6;
        color: var(--color-text-secondary);
        background: rgba(255, 255, 255, 0.04);
      }
      .notice-card strong {
        color: var(--color-accent);
      }
      .icon-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }
      .icon-btn {
        width: 32px;
        height: 32px;
        display: inline-grid;
        place-items: center;
        border: 1px solid var(--color-border);
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .icon-btn svg {
        width: 16px;
        height: 16px;
        fill: none;
        stroke: #cfcfcf;
        stroke-width: 1.6;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      dialog .form-grid textarea {
        width: 100%;
        min-height: 110px;
        resize: vertical;
      }
      dialog .form-grid .span-2 {
        grid-column: 1 / span 2;
      }

      .profile-dialog__header {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        margin-bottom: 0.8rem;
      }
      .profile-dialog__username {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
      }
      .profile-tabs {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.8rem;
        flex-wrap: wrap;
      }
      .profile-tabs .nav-item {
        border: 1px solid var(--color-border);
      }
      .profile-tabs .nav-item.active {
        background: var(--color-accent);
        color: #111;
        border-color: transparent;
      }
      .profile-panels {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.25);
        max-height: 340px;
        overflow: auto;
      }
      .profile-panel {
        display: none;
      }
      .profile-panel.active {
        display: block;
      }
      .profile-dl {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 0.4rem 0.8rem;
      }
      .profile-dl dt {
        color: var(--color-text-secondary);
      }
      .profile-dl dd {
        margin: 0;
      }
      .profile-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }
      .profile-table th,
      .profile-table td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 0.45rem 0.6rem;
        text-align: right;
      }
      .profile-table tbody tr:last-child td {
        border-bottom: none;
      }
      .profile-empty {
        text-align: center;
        color: var(--color-text-secondary);
        padding: 1rem 0;
      }
      .profile-doc-link {
        color: var(--color-accent);
        text-decoration: none;
      }

      /* Toasts (under login button) */
      #login-screen .toast-container {
        position: absolute;
        top: 100%;
        inset-inline-start: 50%;
        transform: translateX(-50%);
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        z-index: 1000;
      }
      /* Toasts (app views) */
      body > .toast-container {
        position: fixed;
        top: 16px;
        inset-inline-end: 16px;
        inset-inline-start: auto;
        transform: none;
        margin-top: 0;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        z-index: 10000;
      }
      .toast {
        min-width: 260px;
        max-width: 360px;
        padding: 0.9rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        background: rgba(30, 30, 30, 0.96);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
        color: var(--color-text-primary);
        opacity: 0;
        transform: translateY(12px);
        animation: toast-in 0.25s ease forwards;
      }
      .toast.success {
        border-color: rgba(46, 204, 113, 0.35);
        background: rgba(46, 204, 113, 0.12);
      }
      .toast.error {
        border-color: rgba(231, 76, 60, 0.35);
        background: rgba(231, 76, 60, 0.12);
      }
      .toast.info {
        border-color: rgba(212, 175, 55, 0.35);
        background: rgba(212, 175, 55, 0.12);
      }
      .toast__title {
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      .toast__msg {
        font-size: 0.95rem;
        color: var(--color-text-secondary);
      }
      .toast--hide {
        animation: toast-out 0.3s ease forwards;
      }
      @keyframes toast-in {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes toast-out {
        to {
          opacity: 0;
          transform: translateY(12px);
        }
      }

      .hidden {
        display: none !important;
      }
      .row-actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      .kpi-value {
        font-size: 1.6rem;
      }
      .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin: 0 0 1rem 0;
        flex-wrap: wrap;
      }
      .toolbar input,
      .toolbar select {
        padding: 0.5rem 0.7rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--color-text-primary);
      }
      .toolbar-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .toolbar--bulk {
        justify-content: flex-start;
        margin-top: -0.5rem;
        margin-bottom: 1rem;
      }
      .toolbar--bulk .ghost-button,
      .toolbar--bulk select {
        min-width: 110px;
      }
      .toolbar--bulk select:disabled,
      .toolbar--bulk button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .select-cell {
        width: 44px;
        text-align: center;
      }
      .select-cell input {
        width: 16px;
        height: 16px;
      }
      dialog[open] {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: #191919;
        color: var(--color-text-primary);
        padding: 1rem 1.2rem;
        max-width: 860px;
        width: 95vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
      }
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(2px);
      }
      dialog form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex: 1;
        min-height: 0;
      }
      dialog .dialog-body {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding-right: 0.2rem;
      }
      dialog .dialog-body .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.8rem;
        direction: rtl;
      }
      dialog .dialog-body label {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
      }
      dialog .dialog-body input,
      dialog .dialog-body select,
      dialog .dialog-body textarea {
        width: 100%;
        padding: 0.55rem 0.7rem;
        border: 1px solid var(--color-border);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.25);
        color: var(--color-text-primary);
      }
      dialog .dialog-body .span-2 {
        grid-column: 1 / -1;
      }
      dialog .actions {
        display: flex;
        gap: 0.6rem;
        justify-content: flex-start;
        margin-top: 0.5rem;
      }

      /* dynamic form layout */
      .dyn-layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 1rem;
        align-items: stretch;
        width: 100%;
        min-height: 320px;
      }
      .dyn-tabs {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.2);
        overflow-y: auto;
      }
      .dyn-tabs .nav-item {
        width: 100%;
        text-align: right;
        padding: 0.55rem 0.8rem;
        border-color: transparent;
        background: transparent;
        color: var(--color-text-secondary);
        border-radius: 10px;
        font-weight: 600;
      }
      .dyn-tabs .nav-item.active {
        background: linear-gradient(
          135deg,
          rgba(212, 175, 55, 0.3),
          rgba(212, 175, 55, 0.12)
        );
        border-color: var(--theme-accent);
        color: var(--color-text-primary);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25) inset,
          0 0 0 1px rgba(212, 175, 55, 0.25);
      }
      .dyn-tabs .nav-item:focus-visible {
        outline: 2px solid var(--theme-accent);
        outline-offset: 2px;
      }
      .dyn-tabs.direct-expense__tabs .nav-item,
      .dyn-tabs.materials-module__tabs .nav-item {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--color-text-secondary);
        transition: background 0.2s ease, color 0.2s ease,
          border-color 0.2s ease;
      }
      .dyn-tabs.direct-expense__tabs .nav-item:hover,
      .dyn-tabs.materials-module__tabs .nav-item:hover {
        color: var(--color-text-primary);
        border-color: rgba(212, 175, 55, 0.3);
      }
      .dyn-tabs.direct-expense__tabs .nav-item.active,
      .dyn-tabs.materials-module__tabs .nav-item.active {
        background: var(--theme-accent-16);
        border-color: var(--theme-accent);
        color: var(--color-text-primary);
        box-shadow: 0 0 0 1px rgba(212, 175, 55, 0.2);
      }
      .dyn-pages {
        border: 1px solid var(--color-border);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.25);
        padding: 1rem;
        overflow: hidden;
        position: relative;
      }
      .dyn-pages .dyn-page {
        max-height: calc(75vh - 160px);
        overflow-y: auto;
        padding-inline-end: 0.5rem;
      }
      .dyn-pages .dyn-page.hidden {
        display: none !important;
      }
      @media (max-width: 900px) {
        .dyn-layout {
          grid-template-columns: 1fr;
        }
        .dyn-tabs {
          flex-direction: row;
          justify-content: flex-start;
          overflow-x: auto;
          padding: 0.5rem;
        }
        .dyn-tabs .nav-item {
          flex: 0 0 auto;
          min-width: 140px;
        }
      }

      /* Hide scrollbars globally */
      /* For Webkit browsers (Chrome, Safari, Edge Chromium) */
      ::-webkit-scrollbar {
        display: none;
        width: 0 !important;
        height: 0 !important;
      }

      /* For Firefox */
      * {
        scrollbar-width: none;
      }

      /* For IE/Edge (older versions, might not be necessary) */
      body {
        -ms-overflow-style: none;
      }

      /* --- Compact pills for tabs (Direct Expense + Materials) --- */
      .dyn-tabs.direct-expense__tabs .nav-item,
      .dyn-tabs.materials-module__tabs .nav-item {
        width: auto;
        min-width: 0;
        padding: 0.35rem 0.7rem;
        line-height: 1.1;
        border-radius: 999px;
        flex: 0 0 auto;
        white-space: nowrap;
      }

      /* Place tabs side-by-side tightly */
      .dyn-tabs.direct-expense__tabs,
      .dyn-tabs.materials-module__tabs {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.4rem;
        align-items: center;
      }

      /* --- Readable selects (fix white-on-white) --- */
      select,
      select option {
        background-color: #ffffff !important;
        color: #000000 !important;
      }
      select:focus {
        outline: 2px solid var(--theme-accent-24);
        outline-offset: 1px;
      }

      /* --- Direct Expense: header meta arranged horizontally --- */
      .direct-expense__header {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem 1rem;
        align-items: end;
      }
      .direct-expense__meta {
        display: grid !important;
        grid-template-columns: minmax(260px, 2fr) minmax(200px, 1fr);
        gap: 0.75rem 1rem;
        align-items: stretch;
      }
      @media (max-width: 900px) {
        .direct-expense__meta {
          grid-template-columns: 1fr;
        }
      }

      /* Add spacing before Notes and between sections */
      .direct-expense__field--wide {
        margin-top: 0.25rem;
      }
      .direct-expense__main {
        margin-top: 0.5rem;
      }

      /* --- Cart table fixes: middle-align + no overflow --- */
      .direct-expense__cart-items table th,
      .direct-expense__cart-items table td {
        vertical-align: middle;
        white-space: nowrap;
      }
      .direct-expense__cart-items table td {
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .direct-expense__cart-items input[type="number"] {
        width: 110px;
        text-align: center;
      }

      /* Align Delete button inside cell */
      .direct-expense__remove-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        max-width: 100%;
        white-space: nowrap;
      }

      /* --- Materials module compact tabs (match Direct Expense) --- */
      .materials-module__tabs .nav-item {
        padding: 0.35rem 0.7rem;
      }

      /* Remove any odd overlay/overlap effect */
      .materials-module__tabs .nav-item.active,
      .direct-expense__tabs .nav-item.active {
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.2) inset;
      }
    </style>
  
<style>
/* --- Compact pills for tabs (Direct Expense + Materials) --- */
.dyn-tabs.direct-expense__tabs .nav-item,
.dyn-tabs.materials-module__tabs .nav-item {
  padding: 0.35rem 0.7rem;
  line-height: 1.1;
  border-radius: 999px;
  flex: 0 0 auto;
  white-space: nowrap;
}

/* Place tabs side-by-side tightly */
.dyn-tabs.direct-expense__tabs,
.dyn-tabs.materials-module__tabs {
  gap: 0.4rem;
}

/* --- Readable selects (fix white-on-white) --- */
select,
select option {
  background-color: #ffffff !important;
  color: #000000 !important;
}
select:focus {
  outline: 2px solid var(--theme-accent-24);
}

/* --- Direct Expense: header/meta layout --- */
.direct-expense__header {
  display: grid !important;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 0.75rem 1rem;
  align-items: end;
}
.direct-expense__meta {
  display: grid !important;
  grid-template-columns: minmax(260px, 2fr) minmax(200px, 1fr);
  gap: 0.75rem 1rem;
  align-items: stretch;
}
@media (max-width: 900px) {
  .direct-expense__meta {
    grid-template-columns: 1fr;
  }
}

/* Add spacing before Notes and between sections */
.direct-expense__field--wide { margin-top: 0.25rem; }
.direct-expense__main { margin-top: 0.5rem; }

/* --- Cart table fixes: middle-align + no overflow --- */
.direct-expense__cart-items {
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 10px;
  background: rgba(0, 0, 0, 0.2);
  overflow-x: auto;
  overflow-y: hidden;
}
.direct-expense__cart {
  overflow: hidden;
}
.direct-expense__cart-items table {
  width: 100%;
  min-width: 680px;
  border-collapse: separate;
  border-spacing: 0;
}
.direct-expense__cart-items table th,
.direct-expense__cart-items table td {
  vertical-align: middle;
  white-space: nowrap;
  padding: 0.5rem;
}
.direct-expense__cart-items table th:last-child,
.direct-expense__cart-items table td:last-child {
  width: 1%;
  text-align: center;
}
.direct-expense__cart-items input[type="number"] {
  width: 110px;
  text-align: center;
}

.direct-expense__field--attachments .direct-expense__attachments {
  align-items: flex-start;
  gap: 0.5rem;
}
.direct-expense__field--attachments .direct-expense__attachment-list {
  margin-top: 0.5rem;
}

/* Align Delete button inside cell */
.direct-expense__remove-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  max-width: 100%;
  white-space: nowrap;
}

/* --- Materials module compact tabs (match Direct Expense) --- */
.materials-module__tabs .nav-item {
  padding: 0.35rem 0.7rem;
}

/* Avoid overlapping highlight appearance */
.materials-module__tabs .nav-item.active,
.direct-expense__tabs .nav-item.active {
  box-shadow: 0 0 0 1px rgba(0,0,0,0.2) inset;
}
</style>

</head>
  <body>
    <!-- Login -->
    <div id="login-screen" class="view active">
      <div class="login-container">
        <div class="logo">نجارة<span>ERP</span></div>
        <form id="login-form" novalidate>
          <div class="form-group">
            <label for="username">اسم المستخدم</label>
            <input id="username" type="text" autocomplete="username" />
          </div>
          <div class="form-group">
            <label for="password">كلمة المرور</label>
            <input
              id="password"
              type="password"
              autocomplete="current-password"
            />
          </div>
          <button id="login-button" class="main-button" type="submit">
            <span>تسجيل الدخول</span>
            <div class="spinner"></div>
          </button>
        </form>
        <div
          id="toast-container"
          class="toast-container"
          aria-live="polite"
          aria-atomic="true"
        ></div>
      </div>
    </div>

    <!-- Top navbar -->
    <nav id="app-navbar" class="app-navbar hidden">
      <div class="app-navbar__left">
        <span class="app-brand">Nijjara ERP</span>
        <div id="navbar-buttons" class="navbar-buttons"></div>
      </div>
      <div class="app-navbar__right">
        <span id="navbar-user-label" class="navbar-user"></span>
        <button id="logout-button" class="nav-btn">تسجيل الخروج</button>
      </div>
    </nav>

    <!-- Portal -->
    <div id="portal-view" class="view">
      <div class="portal-header">
        <h1 id="portal-welcome-message"></h1>
        <p class="muted">اختر الوحدة التي تريد العمل عليها</p>
      </div>
      <div class="module-grid"></div>
    </div>

    <!-- Projects (no demo data) -->
    <div id="projects-workspace" class="view">
      <div class="workspace" data-theme="projects">
        <header class="workspace-header">
          <h2 class="workspace-title">المشاريع</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">لا توجد بيانات معروضة هنا بعد.</p>
        </section>
        <aside id="prj-side-nav" class="workspace-nav"></aside>
      </div>
    </div>

    <!-- Finance (no demo data) -->
    <div id="finance-workspace" class="view">
      <div class="workspace" data-theme="finance">
        <header class="workspace-header">
          <h2 class="workspace-title">المالية</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">لا توجد بيانات معروضة هنا بعد.</p>
        </section>
        <aside id="fin-side-nav" class="workspace-nav"></aside>
      </div>
    </div>

    <!-- HR (no demo data) -->
    <div id="hr-workspace" class="view">
      <div class="workspace" data-theme="hr">
        <header class="workspace-header">
          <h2 class="workspace-title">الموارد البشرية</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>
        <section class="workspace-content">
          <p class="muted">لا توجد بيانات معروضة هنا بعد.</p>
        </section>
        <aside id="hr-side-nav" class="workspace-nav"></aside>
      </div>
    </div>

    <!-- System Management -->
    <div id="system-management-view" class="view">
      <div class="workspace" data-theme="users">
        <header class="workspace-header">
          <h2 class="workspace-title">إدارة النظام</h2>
          <div>
            <button class="ghost-button" data-go="portal-view">
              العودة للبوابة
            </button>
          </div>
        </header>

        <section class="workspace-content">
          <section
            id="sys-overview-pane"
            class="sys-pane sys-pane--overview active"
            data-pane="overview"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">نظرة عامة على النظام</h3>
              <p class="muted">
                تلخيص للحالة الحالية، يتم سحب بياناته من ‎SYS_Profile_View‎ عند
                توفرها.
              </p>
            </div>
            <div class="sys-overview__summary">
              <div class="overview-cards">
                <div class="overview-card">
                  <div class="muted">إجمالي المستخدمين</div>
                  <div id="kpi-total-users" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">المستخدمون النشطون</div>
                  <div id="kpi-active-users" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">المستخدمون المعطلون</div>
                  <div id="kpi-inactive-users" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">عدد الأدوار</div>
                  <div id="kpi-role-count" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">عدد الأذونات</div>
                  <div id="kpi-permission-count" class="kpi-value">—</div>
                </div>
                <div class="overview-card">
                  <div class="muted">طلبات إعادة التعيين</div>
                  <div id="kpi-pending-resets" class="kpi-value">—</div>
                </div>
              </div>
              <p class="muted" style="margin: 0">
                استعرض الأرقام المجمّعة هنا، ثم انتقل إلى تبويب
                <strong>المستخدمون</strong> لإدارة دليل المستخدمين بالكامل طبقًا
                لـ PV_SYS_Users_Table.
              </p>
            </div>
          </section>

          <section id="sys-users-pane" class="sys-pane" data-pane="users">
            <div class="sys-pane__header">
              <h3 class="pane-heading">دليل المستخدمين</h3>
              <p class="muted">
                أدوات بحث وإجراءات مجمّعة لإدارة المستخدمين بجميع حالاتهم.
              </p>
            </div>
            <div class="toolbar toolbar--filters">
              <input
                type="search"
                id="users-search"
                placeholder="بحث سريع..."
              />
              <select id="department-filter">
                <option value="">كل الأقسام</option>
              </select>
              <select id="role-filter">
                <option value="">كل الأدوار</option>
              </select>
              <select id="status-filter">
                <option value="">كل الحالات</option>
                <option value="true">نشط</option>
                <option value="false">غير نشط</option>
              </select>
              <input
                type="date"
                id="updated-from"
                aria-label="تاريخ التحديث من"
              />
              <input
                type="date"
                id="updated-to"
                aria-label="تاريخ التحديث إلى"
              />
              <button id="btn-new-user" class="accent-button">
                إنشاء مستخدم جديد
              </button>
            </div>
            <div class="toolbar toolbar--bulk">
              <div class="toolbar-group">
                <button id="bulk-export" class="ghost-button" disabled>
                  تصدير
                </button>
                <button id="bulk-activate" class="ghost-button" disabled>
                  تفعيل
                </button>
                <button id="bulk-deactivate" class="ghost-button" disabled>
                  تعطيل
                </button>
                <select id="bulk-role-select" disabled>
                  <option value="">اختر دورًا</option>
                </select>
                <button id="bulk-assign-role" class="ghost-button" disabled>
                  تعيين الدور
                </button>
              </div>
            </div>
            <div class="table-wrapper">
              <table id="users-table">
                <thead>
                  <tr>
                    <th class="select-cell">
                      <input type="checkbox" id="select-all-users" />
                    </th>
                    <th>معرّف المستخدم</th>
                    <th>الاسم الكامل</th>
                    <th>اسم المستخدم</th>
                    <th>البريد الإلكتروني</th>
                    <th>القسم</th>
                    <th>الدور</th>
                    <th>الحالة</th>
                    <th>آخر تسجيل دخول</th>
                    <th>آخر تحديث</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody id="users-tbody">
                  <tr>
                    <td colspan="11" class="muted">جاري التحميل…</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-roles-pane" class="sys-pane" data-pane="roles">
            <div class="sys-pane__header">
              <h3 class="pane-heading">سجل الأدوار</h3>
              <p class="muted">
                متابعة الأدوار المعرّفة في ‎SYS_Roles‎ وتحديد الأدوار النظامية.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>معرّف الدور</th>
                    <th>المسمى</th>
                    <th>الوصف</th>
                    <th>دور نظامي؟</th>
                    <th>آخر تحديث</th>
                  </tr>
                </thead>
                <tbody id="roles-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-permissions-pane"
            class="sys-pane"
            data-pane="permissions"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">سجل الأذونات</h3>
              <p class="muted">
                يعرض ‎SYS_Permissions‎ للتدقيق السريع والتصنيف حسب الفئات.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>مفتاح الإذن</th>
                    <th>البيان</th>
                    <th>الفئة</th>
                    <th>الوصف</th>
                    <th>آخر تحديث</th>
                  </tr>
                </thead>
                <tbody id="permissions-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-role-perms-pane"
            class="sys-pane"
            data-pane="rolePerms"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">تعيين أذونات الأدوار</h3>
              <p class="muted">
                خريطة الأذونات مع النطاق والحالة للمساعدة في مراجعة الصلاحيات.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>الدور</th>
                    <th>الإذن</th>
                    <th>النطاق</th>
                    <th>مسموح؟</th>
                    <th>آخر تحديث</th>
                  </tr>
                </thead>
                <tbody id="role-perms-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section
            id="sys-properties-pane"
            class="sys-pane"
            data-pane="properties"
          >
            <div class="sys-pane__header">
              <h3 class="pane-heading">خصائص المستخدم</h3>
              <p class="muted">
                يعرض جدول ‎SYS_User_Properties‎ لتتبع السمات المخصصة.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>المستخدم</th>
                    <th>المفتاح</th>
                    <th>القيمة</th>
                    <th>آخر تحديث</th>
                    <th>المحدّث</th>
                  </tr>
                </thead>
                <tbody id="properties-tbody">
                  <tr>
                    <td colspan="5" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-sessions-pane" class="sys-pane" data-pane="sessions">
            <div class="sys-pane__header">
              <h3 class="pane-heading">الجلسات النشطة والمغلقة</h3>
              <p class="muted">
                مراقبة سجلات ‎SYS_Sessions‎ بما في ذلك جلسات الانتحال.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>المعرّف</th>
                    <th>المستخدم</th>
                    <th>الممثل</th>
                    <th>النوع</th>
                    <th>الحالة</th>
                    <th>البداية</th>
                    <th>النهاية</th>
                  </tr>
                </thead>
                <tbody id="sessions-tbody">
                  <tr>
                    <td colspan="7" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <section id="sys-audit-pane" class="sys-pane" data-pane="audit">
            <div class="sys-pane__header">
              <h3 class="pane-heading">سجل التدقيق</h3>
              <p class="muted">
                أحدث إجراءات النظام من ‎SYS_Audit_Log‎ أو ‎SYS_Audit_Report‎.
              </p>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>الوقت</th>
                    <th>المستخدم</th>
                    <th>الإجراء</th>
                    <th>التفاصيل</th>
                  </tr>
                </thead>
                <tbody id="audit-tbody">
                  <tr>
                    <td colspan="4" class="muted">
                      لم يتم تحميل البيانات بعد.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        </section>

        <aside class="workspace-nav" id="sys-side-nav">
          <!-- Tabs will be rendered dynamically -->
        </aside>
      </div>
    </div>

    <!-- إنشاء مستخدم (ديناميكي إن توفرت الجداول؛ وإلا نموذج مبسّط) -->
    <dialog id="dlg-new-user">
      <h3 style="margin-bottom: 0.6rem">إنشاء مستخدم جديد</h3>
      <form method="dialog" id="new-user-form">
        <div id="new-user-fields" class="dialog-body"></div>
        <div class="actions">
          <button type="submit" class="action-button save-button">حفظ</button>
          <button
            type="button"
            id="btn-cancel-new"
            class="action-button cancel-button"
          >
            إلغاء
          </button>
        </div>
      </form>
    </dialog>

    <!-- ملف المستخدم -->
    <dialog id="dlg-user-profile">
      <div class="profile-dialog__header">
        <h3 id="profile-title">ملف المستخدم</h3>
        <div id="profile-username" class="profile-dialog__username"></div>
      </div>
      <div class="profile-tabs" id="profile-tabs">
        <button type="button" class="nav-item active" data-tab="profile">
          الملف
        </button>
        <button type="button" class="nav-item" data-tab="properties">
          الخصائص
        </button>
        <button type="button" class="nav-item" data-tab="documents">
          المستندات
        </button>
        <button type="button" class="nav-item" data-tab="sessions">
          الجلسات
        </button>
        <button type="button" class="nav-item" data-tab="audit">التدقيق</button>
      </div>
      <div class="profile-panels" id="profile-panels">
        <section class="profile-panel active" data-tab="profile">
          <dl class="profile-dl" id="profile-overview-list"></dl>
        </section>
        <section class="profile-panel" data-tab="properties">
          <table class="profile-table">
            <thead>
              <tr>
                <th>المفتاح</th>
                <th>القيمة</th>
                <th>آخر تحديث</th>
                <th>المحدّث</th>
              </tr>
            </thead>
            <tbody id="profile-properties-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="documents">
          <table class="profile-table">
            <thead>
              <tr>
                <th>المستند</th>
                <th>المرفوع بواسطة</th>
                <th>التاريخ</th>
                <th>رابط</th>
              </tr>
            </thead>
            <tbody id="profile-documents-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="sessions">
          <table class="profile-table">
            <thead>
              <tr>
                <th>Session</th>
                <th>المنتحل</th>
                <th>النوع</th>
                <th>الحالة</th>
                <th>البداية</th>
                <th>النهاية</th>
              </tr>
            </thead>
            <tbody id="profile-sessions-body"></tbody>
          </table>
        </section>
        <section class="profile-panel" data-tab="audit">
          <table class="profile-table">
            <thead>
              <tr>
                <th>الوقت</th>
                <th>المستخدم</th>
                <th>الإجراء</th>
                <th>التفاصيل</th>
              </tr>
            </thead>
            <tbody id="profile-audit-body"></tbody>
          </table>
        </section>
      </div>
      <div class="actions">
        <button
          type="button"
          id="btn-close-profile"
          class="action-button cancel-button"
        >
          إغلاق
        </button>
      </div>
    </dialog>

    <!-- تعيين دور -->
    <dialog id="dlg-assign-role">
      <h3 style="margin-bottom: 0.6rem">تعيين دور للمستخدم</h3>
      <form method="dialog" id="form-assign-role">
        <input type="hidden" id="assign-role-user" name="userId" />
        <div class="form-grid">
          <div class="span-2">
            <label for="assign-role-select">اختر الدور</label>
            <select id="assign-role-select" name="roleId" required></select>
          </div>
          <div class="span-2 muted" id="assign-role-user-label"></div>
        </div>
        <div class="actions">
          <button type="submit" class="action-button save-button">حفظ</button>
          <button
            type="button"
            id="btn-cancel-assign"
            class="action-button cancel-button"
          >
            إلغاء
          </button>
        </div>
      </form>
    </dialog>

    <!-- إعادة تعيين كلمة المرور -->
    <dialog id="dlg-reset-pass">
      <h3 style="margin-bottom: 0.6rem">إعادة تعيين كلمة المرور</h3>
      <form method="dialog" id="form-reset-pass">
        <div class="form-grid">
          <div class="span-2">
            <label for="reset_pass">كلمة المرور الجديدة</label
            ><input
              type="password"
              id="reset_pass"
              name="password"
              autocomplete="new-password"
              required
            />
          </div>
          <div class="span-2">
            <label for="reset_confirm">تأكيد كلمة المرور</label
            ><input
              type="password"
              id="reset_confirm"
              name="confirm"
              autocomplete="new-password"
              required
            />
          </div>
        </div>
        <div class="actions">
          <button type="submit" class="action-button edit-button">تحديث</button>
          <button
            type="button"
            id="btn-cancel-reset"
            class="action-button cancel-button"
          >
            إلغاء
          </button>
        </div>
      </form>
    </dialog>

    <script>
      (function () {
        const views = Array.from(document.querySelectorAll(".view"));
        const navbar = document.getElementById("app-navbar");
        const userLabel = document.getElementById("navbar-user-label");
        const navButtonsContainer = document.getElementById("navbar-buttons");
        const txtSearch = document.getElementById("users-search");
        const selDept = document.getElementById("department-filter");
        const selRole = document.getElementById("role-filter");
        const selStatus = document.getElementById("status-filter");
        const dtUpdatedFrom = document.getElementById("updated-from");
        const dtUpdatedTo = document.getElementById("updated-to");
        const usersTbody = document.getElementById("users-tbody");
        const usersTable = document.getElementById("users-table");
        const selectAllUsers = document.getElementById("select-all-users");
        const bulkExportBtn = document.getElementById("bulk-export");
        const bulkActivateBtn = document.getElementById("bulk-activate");
        const bulkDeactivateBtn = document.getElementById("bulk-deactivate");
        const bulkAssignRoleBtn = document.getElementById("bulk-assign-role");
        const bulkRoleSelect = document.getElementById("bulk-role-select");
        const dlgReset = document.getElementById("dlg-reset-pass");
        const formReset = document.getElementById("form-reset-pass");
        const dlgProfile = document.getElementById("dlg-user-profile");
        const profileTabsContainer = document.getElementById("profile-tabs");
        const profilePanelsContainer =
          document.getElementById("profile-panels");
        const profileTabButtons = profileTabsContainer
          ? Array.from(profileTabsContainer.querySelectorAll("[data-tab]"))
          : [];
        const profilePanels = profilePanelsContainer
          ? Array.from(
              profilePanelsContainer.querySelectorAll(".profile-panel")
            )
          : [];
        const profileOverviewList = document.getElementById(
          "profile-overview-list"
        );
        const profilePropertiesBody = document.getElementById(
          "profile-properties-body"
        );
        const profileDocumentsBody = document.getElementById(
          "profile-documents-body"
        );
        const profileSessionsBody = document.getElementById(
          "profile-sessions-body"
        );
        const profileAuditBody = document.getElementById("profile-audit-body");
        const profileTitle = document.getElementById("profile-title");
        const profileUsername = document.getElementById("profile-username");
        const btnCloseProfile = document.getElementById("btn-close-profile");
        const dlgAssign = document.getElementById("dlg-assign-role");
        const formAssignRole = document.getElementById("form-assign-role");
        const assignRoleUserInput = document.getElementById("assign-role-user");
        const assignRoleSelect = document.getElementById("assign-role-select");
        const assignRoleUserLabel = document.getElementById(
          "assign-role-user-label"
        );
        const btnCancelAssign = document.getElementById("btn-cancel-assign");
        const sysView = document.getElementById("system-management-view");
        const sysNav = document.getElementById("sys-side-nav");
        const sysPanes = sysView
          ? Array.from(sysView.querySelectorAll(".sys-pane"))
          : [];
        const moduleGridContainer = document.querySelector(".module-grid");
        const prjSideNav = document.getElementById("prj-side-nav");
        const finSideNav = document.getElementById("fin-side-nav");
        const hrSideNav = document.getElementById("hr-side-nav");
        const rolesTbody = document.getElementById("roles-tbody");
        const permissionsTbody = document.getElementById("permissions-tbody");
        const rolePermsTbody = document.getElementById("role-perms-tbody");
        const propertiesTbody = document.getElementById("properties-tbody");
        const workspaceConfigs = {
          "projects-workspace": {
            tabId: "Tab_PRJ_Management",
            nav: prjSideNav,
            navId: "prj-side-nav",
            contentSelector: "#projects-workspace .workspace-content",
          },
          "finance-workspace": {
            tabId: "Tab_FIN_Management",
            nav: finSideNav,
            navId: "fin-side-nav",
            contentSelector: "#finance-workspace .workspace-content",
          },
          "hr-workspace": {
            tabId: "Tab_HR_Management",
            nav: hrSideNav,
            navId: "hr-side-nav",
            contentSelector: "#hr-workspace .workspace-content",
          },
        };
        let lastWorkspaceNavRendered = null;
        let currencyFormatter;
        try {
          currencyFormatter = new Intl.NumberFormat("ar-EG", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        } catch (err) {
          currencyFormatter = null;
        }
        const formatCurrencyValue = (value) => {
          const number = Number(value) || 0;
          if (currencyFormatter) {
            try {
              return currencyFormatter.format(number);
            } catch (err) {
              // fallback below
            }
          }
          return number.toFixed(2);
        };
        const sessionsTbody = document.getElementById("sessions-tbody");
        const auditTbody = document.getElementById("audit-tbody");
        const NAV_VIEW_MAP = {
          SYS: "system-management-view",
          PRJ: "projects-workspace",
          FIN: "finance-workspace",
          HR: "hr-workspace",
        };

        function resolveThemeFromIdentifier(identifier) {
          const normalized = (identifier || "")
            .toString()
            .toUpperCase();
          if (normalized.includes("PRJ")) return "projects";
          if (normalized.includes("FIN")) return "finance";
          if (normalized.includes("HR")) return "hr";
          return "users";
        }
        const DEFAULT_SYS_SUB_TABS = [
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_Overview",
            pane: "overview",
            labelAr: "نظرة عامة",
            labelEn: "Overview",
            route: "/sys",
            sortOrder: 1,
          },
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_Users",
            pane: "users",
            labelAr: "المستخدمون",
            labelEn: "Users",
            route: "/sys/users",
            sortOrder: 2,
          },
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_Roles",
            pane: "roles",
            labelAr: "الأدوار",
            labelEn: "Roles",
            route: "/sys/roles",
            sortOrder: 3,
          },
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_Permissions",
            pane: "permissions",
            labelAr: "الأذونات",
            labelEn: "Permissions",
            route: "/sys/permissions",
            sortOrder: 4,
          },
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_RolePerms",
            pane: "rolePerms",
            labelAr: "تعيين أذونات الأدوار",
            labelEn: "Role Permissions",
            route: "/sys/role-perms",
            sortOrder: 5,
          },
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_Properties",
            pane: "properties",
            labelAr: "خصائص المستخدم",
            labelEn: "User Properties",
            route: "/sys/properties",
            sortOrder: 6,
          },
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_Sessions",
            pane: "sessions",
            labelAr: "الجلسات",
            labelEn: "Sessions",
            route: "/sys/sessions",
            sortOrder: 7,
          },
          {
            tabId: "Tab_SYS_Management",
            subId: "Sub_SYS_Audit",
            pane: "audit",
            labelAr: "التدقيق",
            labelEn: "Audit",
            route: "/sys/audit",
            sortOrder: 8,
          },
        ];
        let bootstrapData = {};
        const selectedUsers = new Set();
        let resetUserId = null;
        let currentProfileUserId = null;
        let profileDataCache = null;
        let roleOptionsCache = null;
        let normalizedUsersCache = [];
        let overviewLoaded = false;
        let sysTabRegister = DEFAULT_SYS_SUB_TABS.map((entry) => ({
          ...entry,
        }));
        let sysSubTabLookup = Object.create(null);
        const tableLoadState = {
          roles: false,
          permissions: false,
          rolePerms: false,
          properties: false,
          sessions: false,
          audit: false,
        };
        let currentSysPane = "overview";
        let lastLoginIdentity = null;

        /* Basic nav */
        function isSysManagementTab(tabId) {
          return String(tabId || "")
            .trim()
            .toLowerCase() === "tab_sys_management";
        }

        function toNumberOrNull(value) {
          if (value == null || value === "") return null;
          const num = Number(value);
          return Number.isFinite(num) ? num : null;
        }

        function derivePaneNameFromEntry(entry) {
          if (!entry) return "";
          const subIdRaw =
            entry.subId || entry.Sub_ID || entry.subID || entry.id || "";
          if (subIdRaw) {
            let clean = String(subIdRaw).trim();
            if (clean) {
              clean = clean.replace(/^Sub_/i, "");
              clean = clean.replace(/^SYS_/i, "");
              clean = clean.replace(/^Tab_/i, "");
              const tokens = clean.split(/[_\s]+/).filter(Boolean);
              if (tokens.length) {
                const camel = tokens
                  .map((token, idx) => {
                    const normalized = token.replace(/[^A-Za-z0-9]/g, "");
                    if (!normalized) return "";
                    if (idx === 0) {
                      return (
                        normalized.charAt(0).toLowerCase() +
                        normalized.slice(1)
                      );
                    }
                    return (
                      normalized.charAt(0).toUpperCase() +
                      normalized.slice(1)
                    );
                  })
                  .join("");
                if (camel) return camel;
              }
            }
          }

          const routeRaw = entry.route || entry.Route || entry.path || "";
          if (routeRaw) {
            const route = String(routeRaw).trim();
            if (route) {
              const parts = route.split("/").filter(Boolean);
              if (!parts.length) {
                return "";
              }
              let lastSegment = parts[parts.length - 1] || "";
              if (!lastSegment && parts.length > 1) {
                lastSegment = parts[parts.length - 2];
              }
              if (!lastSegment) {
                return "";
              }
              if (lastSegment.toLowerCase() === "sys") {
                return "overview";
              }
              const tokens = lastSegment.split(/[-_\s]+/).filter(Boolean);
              if (tokens.length) {
                const camel = tokens
                  .map((token, idx) => {
                    const normalized = token.replace(/[^A-Za-z0-9]/g, "");
                    if (!normalized) return "";
                    if (idx === 0) {
                      return normalized.toLowerCase();
                    }
                    return (
                      normalized.charAt(0).toUpperCase() +
                      normalized.slice(1).toLowerCase()
                    );
                  })
                  .join("");
                if (camel) return camel;
              }
            }
          }

          return "";
        }

        function normalizeTabRegister(tabRegisterData) {
          if (!Array.isArray(tabRegisterData)) return [];

          const map = new Map();

          const storeNormalized = (rawEntry) => {
            if (!rawEntry) return;
            const tabId =
              rawEntry.tabId ||
              rawEntry.Tab_ID ||
              rawEntry.TabId ||
              rawEntry.tabID ||
              "";
            if (!isSysManagementTab(tabId)) return;

            const paneName = rawEntry.pane || derivePaneNameFromEntry(rawEntry);
            const subId = rawEntry.subId || rawEntry.Sub_ID || rawEntry.subID || "";
            if (!paneName && !subId) return;

            const normalized = {
              tabId: tabId || "Tab_SYS_Management",
              subId: subId ? String(subId) : paneName,
              labelAr:
                rawEntry.labelAr ||
                rawEntry.Sub_Label_AR ||
                rawEntry.subLabelAr ||
                rawEntry.Tab_Label_AR ||
                "",
              labelEn:
                rawEntry.labelEn ||
                rawEntry.Sub_Label_EN ||
                rawEntry.subLabelEn ||
                rawEntry.Tab_Label_EN ||
                "",
              route: rawEntry.route || rawEntry.Route || rawEntry.path || "",
              sortOrder: toNumberOrNull(
                rawEntry.sortOrder ?? rawEntry.Sort_Order ?? rawEntry.order
              ),
              pane: paneName || (subId ? String(subId) : ""),
            };

            if (!normalized.pane) return;
            const key = normalized.subId || normalized.pane;
            if (!key) return;

            if (!map.has(key)) {
              map.set(key, normalized);
            } else {
              const existing = map.get(key);
              if (!existing.labelAr && normalized.labelAr)
                existing.labelAr = normalized.labelAr;
              if (!existing.labelEn && normalized.labelEn)
                existing.labelEn = normalized.labelEn;
              if (!existing.route && normalized.route)
                existing.route = normalized.route;
              if (
                (existing.sortOrder == null ||
                  !Number.isFinite(existing.sortOrder)) &&
                normalized.sortOrder != null
              ) {
                existing.sortOrder = normalized.sortOrder;
              }
              if (!existing.pane && normalized.pane) {
                existing.pane = normalized.pane;
              }
            }
          };

          const acceptRecordType = (value) => {
            if (!value) return true;
            const normalized = String(value).trim().toUpperCase();
            return (
              normalized === "SUB" ||
              normalized === "SUBTAB" ||
              normalized === "SUB_TAB"
            );
          };

          const hasSubCollections = tabRegisterData.some((item) =>
            Array.isArray(item && item.subTabs)
          );

          if (hasSubCollections) {
            tabRegisterData.forEach((tab) => {
              if (!tab) return;
              const tabId = tab.tabId || tab.Tab_ID || tab.TabId || tab.tabID || "";
              if (!isSysManagementTab(tabId)) return;
              const subTabs = Array.isArray(tab.subTabs) ? tab.subTabs : [];
              subTabs.forEach((sub) => {
                if (!sub) return;
                storeNormalized({
                  tabId,
                  subId: sub.subId || sub.Sub_ID || sub.subID || sub.id || "",
                  labelAr:
                    sub.subLabelAr ||
                    sub.Sub_Label_AR ||
                    sub.labelAr ||
                    sub.label_ar ||
                    tab.tabLabelAr ||
                    tab.Tab_Label_AR ||
                    "",
                  labelEn:
                    sub.subLabelEn ||
                    sub.Sub_Label_EN ||
                    sub.labelEn ||
                    sub.label_en ||
                    tab.tabLabelEn ||
                    tab.Tab_Label_EN ||
                    "",
                  route: sub.route || sub.Route || sub.path || "",
                  sortOrder: toNumberOrNull(
                    sub.sortOrder ?? sub.Sort_Order ?? sub.order
                  ),
                  pane: sub.pane,
                });
              });
            });
          } else {
            tabRegisterData.forEach((row) => {
              if (!row) return;
              const recordType =
                row.recordType || row.Record_Type || row.Type || "";
              if (!acceptRecordType(recordType)) return;
              storeNormalized({
                tabId: row.tabId || row.Tab_ID || row.TabId || row.tabID || "",
                subId: row.subId || row.Sub_ID || row.subID || row.id || "",
                labelAr:
                  row.subLabelAr ||
                  row.Sub_Label_AR ||
                  row.labelAr ||
                  row.Tab_Label_AR ||
                  "",
                labelEn:
                  row.subLabelEn ||
                  row.Sub_Label_EN ||
                  row.labelEn ||
                  row.Tab_Label_EN ||
                  "",
                route: row.route || row.Route || row.path || "",
                sortOrder: toNumberOrNull(
                  row.sortOrder ?? row.Sort_Order ?? row.order
                ),
                pane: row.pane,
              });
            });
          }

          return Array.from(map.values()).sort((a, b) => {
            const aOrder =
              a.sortOrder != null && Number.isFinite(a.sortOrder)
                ? a.sortOrder
                : Number.MAX_SAFE_INTEGER;
            const bOrder =
              b.sortOrder != null && Number.isFinite(b.sortOrder)
                ? b.sortOrder
                : Number.MAX_SAFE_INTEGER;
            if (aOrder !== bOrder) return aOrder - bOrder;
            return String(a.pane || "").localeCompare(String(b.pane || ""));
          });
        }

        function updateSysNavActive(paneName) {
          if (!sysNav) return;
          Array.from(sysNav.querySelectorAll("[data-pane]")).forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.pane === paneName);
          });
        }

        function renderSysNav(tabRegisterData) {
          if (!sysNav) return;

          const sourceData =
            tabRegisterData !== undefined ? tabRegisterData : sysTabRegister;
          const normalized = normalizeTabRegister(sourceData);
          const effectiveRegister = normalized.length
            ? normalized
            : DEFAULT_SYS_SUB_TABS;

          sysTabRegister = effectiveRegister.map((entry) => ({ ...entry }));
          sysSubTabLookup = Object.create(null);
          sysNav.innerHTML = "";

          let firstPane = "";
          const seen = new Set();

          sysTabRegister.forEach((entry) => {
            if (!entry || !entry.pane) return;
            const pane = entry.pane;
            const key = entry.subId || pane;
            if (seen.has(key)) return;
            seen.add(key);

            if (!firstPane) firstPane = pane;

            const button = document.createElement("button");
            button.type = "button";
            button.className = "nav-item";
            button.dataset.pane = pane;
            if (entry.subId) button.dataset.subId = entry.subId;
            if (entry.route) button.dataset.route = entry.route;
            button.textContent = entry.labelAr || entry.labelEn || pane;
            sysNav.appendChild(button);

            const lookupKeys = new Set([
              pane,
              pane.toLowerCase(),
              entry.subId,
              entry.subId ? entry.subId.toLowerCase() : "",
              entry.route,
              entry.route ? entry.route.toLowerCase() : "",
            ]);

            if (entry.route) {
              const routeParts = String(entry.route)
                .split("/")
                .filter(Boolean);
              if (routeParts.length) {
                const last = routeParts[routeParts.length - 1];
                if (last) {
                  lookupKeys.add(last);
                  lookupKeys.add(last.toLowerCase());
                }
              }
            }

            lookupKeys.forEach((lookupKey) => {
              if (!lookupKey) return;
              sysSubTabLookup[lookupKey] = entry;
            });
          });

          if (!firstPane) {
            updateSysNavActive(currentSysPane);
            return;
          }

          if (!currentSysPane || !sysSubTabLookup[currentSysPane]) {
            currentSysPane = firstPane;
          }

          updateSysNavActive(currentSysPane);
        }

        function loadTab(identifier, options = {}) {
          if (!identifier) {
            if (currentSysPane) {
              setActiveSysPane(currentSysPane, options);
            }
            return;
          }

          const rawKey = String(identifier).trim();
          if (!rawKey) return;

          const candidates = [rawKey, rawKey.toLowerCase()];
          if (rawKey.startsWith("Sub_")) {
            const trimmed = rawKey.replace(/^Sub_/i, "");
            candidates.push(trimmed);
            candidates.push(trimmed.toLowerCase());
          }

          let entry = null;
          for (const candidate of candidates) {
            if (!candidate) continue;
            if (sysSubTabLookup[candidate]) {
              entry = sysSubTabLookup[candidate];
              break;
            }
          }

          const paneName = entry?.pane || derivePaneNameFromEntry({ subId: rawKey });
          if (paneName) {
            setActiveSysPane(paneName, options);
          } else {
            setActiveSysPane(rawKey, options);
          }
        }

        function switchView(id) {
          Object.keys(workspaceConfigs).forEach((key) => {
            if (key === id) return;
            const config = workspaceConfigs[key];
            if (!config) return;
            const navEl =
              config.nav || (config.navId ? document.getElementById(config.navId) : null);
            if (navEl) {
              navEl.innerHTML = "";
              config.nav = navEl;
            }
            const contentEl =
              config.content ||
              (config.contentSelector
                ? document.querySelector(config.contentSelector)
                : null);
            if (contentEl) {
              config.content = contentEl;
              contentEl.innerHTML = "";
            }
          });

          views.forEach((v) => v.classList.toggle("active", v.id === id));
          document.querySelectorAll(".app-navbar .nav-btn").forEach((b) => {
            const target = b.getAttribute("data-target");
            b.classList.toggle(
              "active",
              target === id ||
                (id === "portal-view" && target === "portal-view")
            );
          });
          if (id === "system-management-view") {
            lastWorkspaceNavRendered = null;
            loadTab(currentSysPane || "overview");
            return;
          }

          const workspaceConfig = workspaceConfigs[id];
          if (workspaceConfig) {
            const navEl =
              workspaceConfig.nav ||
              (workspaceConfig.navId
                ? document.getElementById(workspaceConfig.navId)
                : null);
            if (navEl) {
              workspaceConfig.nav = navEl;
            }

            const contentEl =
              workspaceConfig.content ||
              (workspaceConfig.contentSelector
                ? document.querySelector(workspaceConfig.contentSelector)
                : null);
            if (contentEl) {
              workspaceConfig.content = contentEl;
            }

            if (
              navEl &&
              (navEl.dataset.rendered !== "true" ||
                navEl.childElementCount === 0 ||
                lastWorkspaceNavRendered !== id)
            ) {
              renderWorkspaceNav(
                workspaceConfig.tabId,
                navEl.id || workspaceConfig.navId,
                contentEl
              );
              lastWorkspaceNavRendered = id;
            }
          } else {
            lastWorkspaceNavRendered = null;
          }
        }
        function createNavButton(label, target) {
          const btn = document.createElement("button");
          btn.className = "nav-btn";
          btn.dataset.target = target;
          btn.textContent = label;
          return btn;
        }
        function renderNav(navConfig = []) {
          if (!navButtonsContainer) return;
          navButtonsContainer.innerHTML = "";
          navButtonsContainer.appendChild(
            createNavButton("Portal", "portal-view")
          );

          const appendedTargets = new Set(["portal-view"]);
          const items = Array.isArray(navConfig) ? navConfig : [];

          items
            .map((entry) => ({
              key: entry?.key || entry?.id || entry?.module || "",
              label:
                entry?.label ||
                entry?.title ||
                entry?.text ||
                entry?.key ||
                entry?.id ||
                "",
              target:
                entry?.target ||
                entry?.viewId ||
                NAV_VIEW_MAP[entry?.key] ||
                entry?.route ||
                entry?.moduleTarget ||
                "",
            }))
            .filter((item) => item.target)
            .forEach((item) => {
              const label = item.label || item.key || item.target;
              const btn = createNavButton(label, item.target);
              if (item.key) {
                btn.dataset.key = item.key;
              }
              appendedTargets.add(item.target);
              navButtonsContainer.appendChild(btn);
            });

          if (items.length === 0) {
            ["PRJ", "FIN", "HR", "SYS"].forEach((key) => {
              const target = NAV_VIEW_MAP[key];
              if (!target || appendedTargets.has(target)) return;
              const label =
                key === "PRJ"
                  ? "Projects"
                  : key === "FIN"
                  ? "Finance"
                  : key === "HR"
                  ? "HR"
                  : "System";
              const btn = createNavButton(label, target);
              btn.dataset.key = key;
              appendedTargets.add(target);
              navButtonsContainer.appendChild(btn);
            });
          }

          const activeView = document.querySelector(".view.active");
          if (activeView) switchView(activeView.id);
        }

        function renderModuleGrid(navConfig = []) {
          if (!moduleGridContainer) return;
          moduleGridContainer.innerHTML = "";

          const items = Array.isArray(navConfig) ? navConfig : [];
          items
            .filter((item) => item && item.target)
            .forEach((item) => {
              const theme = resolveThemeFromIdentifier(
                item?.key || item?.target || ""
              );
              const card = document.createElement("div");
              card.className = "module-card";
              card.dataset.workspace = item.target;
              card.dataset.theme = theme;
              card.textContent = item.label || item.key || item.target;
              card.addEventListener("click", () => switchView(item.target));
              moduleGridContainer.appendChild(card);
            });

          if (!moduleGridContainer.children.length) {
            moduleGridContainer.innerHTML =
              '<p class="muted">لا توجد وحدات متاحة للعرض.</p>';
          }
        }

        function renderWorkspaceNav(tabId, navElementId, contentElement) {
          const navEl = navElementId
            ? document.getElementById(navElementId)
            : null;
          if (!navEl) return;

          const theme = resolveThemeFromIdentifier(tabId);
          const workspaceElement =
            navEl.closest(".workspace") ||
            (contentElement ? contentElement.closest(".workspace") : null);
          if (workspaceElement) {
            workspaceElement.dataset.theme = theme;
          }

          navEl.innerHTML = "";
          navEl.dataset.rendered = "false";

          if (contentElement) {
            contentElement.innerHTML = "";
          }

          const register = Array.isArray(bootstrapData?.tabRegister)
            ? bootstrapData.tabRegister
            : [];
          const normalizedId = (tabId || "").toString().toUpperCase();
          const tabEntry = register.find((tab) => {
            const tabKey = tab?.tabId || tab?.tabID;
            return (
              tabKey && String(tabKey).toUpperCase() === normalizedId
            );
          });
          const subTabs = Array.isArray(tabEntry?.subTabs)
            ? tabEntry.subTabs
            : [];

          subTabs.forEach((sub) => {
            if (!sub?.subId) return;
            const button = document.createElement("button");
            button.type = "button";
            button.className = "nav-item";
            button.textContent =
              sub.subLabelAr || sub.subLabelEn || sub.subId || "";
            button.dataset.subId = sub.subId;
            if (sub.route) button.dataset.route = sub.route;
            const subSource = (sub.sourceSheet || "").trim();
            button.dataset.sourceSheet = subSource;
            button.addEventListener("click", () => {
              navEl
                .querySelectorAll(".nav-item")
                .forEach((item) => item.classList.toggle("active", item === button));
              loadGenericTab(sub.subId, subSource, contentElement);
            });
            navEl.appendChild(button);
          });

          const firstButton = navEl.querySelector("button.nav-item");
          if (firstButton) {
            firstButton.click();
          } else if (contentElement) {
            contentElement.innerHTML =
              '<p class="muted">لا توجد تبويبات فرعية متاحة.</p>';
          }

          navEl.dataset.rendered = "true";
        }

    function loadGenericTab(paneName, sourceSheet, contentElement) {
  if (!contentElement || !paneName) return;

  const paneId = String(paneName);
  const trimmedSource = (sourceSheet || "").trim();
  let paneElement = contentElement.querySelector(
    `[data-generic-pane="${paneId}"]`
  );
  if (!paneElement) {
    paneElement = document.createElement("div");
    paneElement.className = "generic-pane";
    paneElement.dataset.genericPane = paneId;
    contentElement.appendChild(paneElement);
  }

  Array.from(contentElement.children).forEach((child) => {
    if (child === paneElement) {
      child.style.display = "";
      child.classList.add("active");
    } else {
      child.style.display = "none";
      child.classList.remove("active");
    }
  });

  paneElement.classList.remove("direct-expense-pane");
  paneElement.classList.remove("materials-catalog-pane");

  if (paneName === "Sub_PRJ_Materials") {
    if (typeof renderMaterialsModule === "function") {
      renderMaterialsModule(paneElement);
    } else {
      paneElement.innerHTML =
        '<p class="error-text">واجهة كتالوج المواد غير متاحة حالياً.</p>';
    }
    return;
  }

  if (paneName === "Sub_FIN_Direct") {
    if (typeof renderDirectExpenseShell === "function") {
      renderDirectExpenseShell(paneElement);
    } else {
      paneElement.innerHTML =
        '<p class="error-text">واجهة المصروفات غير متاحة حالياً.</p>';
    }
    return;
  }

  const formsRegister =
    (bootstrapData && bootstrapData.forms) || Object.create(null);
  const formMeta = formsRegister[paneName];

  // Developer diagnostics (from feature branch)
  if (window.console && typeof console.groupCollapsed === "function") {
    console.groupCollapsed(
      `[loadGenericTab] ${paneId} (source: ${trimmedSource || "<none>"})`
    );
    console.log("forms keys", Object.keys(formsRegister));
    console.log("form meta", formMeta);
    console.groupEnd();
  } else if (window.console) {
    console.log("[loadGenericTab]", paneId, {
      source: trimmedSource || null,
      formsKeys: Object.keys(formsRegister),
      formMeta,
    });
  }

  if (!trimmedSource) {
    paneElement.innerHTML =
      '<p class="error-text">لم يتم تعيين مصدر بيانات لهذا التبويب.</p>';
    return;
  }

  paneElement.innerHTML =
    '<p class="muted">جارٍ تحميل البيانات، يرجى الانتظار...</p>';

  if (!(window.google && google.script && google.script.run)) {
    paneElement.innerHTML =
      '<p class="error-text">خدمة Google Apps Script غير متاحة.</p>';
    return;
  }

  google.script.run
    .withFailureHandler((err) => {
      console.error("loadGenericTab failed", err);
      paneElement.innerHTML =
        '<p class="error-text">تعذر تحميل البيانات.</p>';
    })
    .withSuccessHandler((result) => {
      if (formMeta) {
        renderPaneHeader(paneElement, paneName);
      }
      renderGenericTable(paneElement, result);
    })
    .getSheetData(trimmedSource);
}
function renderGenericTable(paneElement, data) {
  if (!paneElement) return;
  const headers = Array.isArray(data?.headers) ? data.headers : [];
  const rows = Array.isArray(data?.rows) ? data.rows : [];

          const preservedHeader = paneElement.querySelector(".pane-header");
          paneElement.innerHTML = "";
          if (preservedHeader) {
            paneElement.appendChild(preservedHeader);
          }

          if (!headers.length) {
            const emptyMessage = document.createElement("p");
            emptyMessage.className = "muted";
            emptyMessage.textContent = "لا توجد بيانات متاحة للعرض.";
            paneElement.appendChild(emptyMessage);
            return;
          }

          const table = document.createElement("table");
          table.className = "sys-table";

          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");
          headers.forEach((header) => {
            const th = document.createElement("th");
            th.textContent = header;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          const tbody = document.createElement("tbody");
          rows.forEach((row) => {
            const tr = document.createElement("tr");
            headers.forEach((_, index) => {
              const td = document.createElement("td");
              const value = Array.isArray(row) ? row[index] : row?.[index];
              if (value === true || value === false) {
                td.innerHTML = renderBooleanBadge(value);
              } else if (
                typeof value === "string" &&
                /^(true|false|yes|no|y|n|1|0)$/i.test(value.trim())
              ) {
                td.innerHTML = renderBooleanBadge(value);
              } else if (value instanceof Date) {
                td.textContent = formatDateTime(value);
              } else if (
                typeof value === "string" &&
                /^\d{4}-\d{2}-\d{2}T/.test(value)
              ) {
                td.textContent = formatDateTime(value);
              } else {
                td.innerHTML = escapeHtml(value == null ? "" : String(value));
              }
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          table.appendChild(thead);
          table.appendChild(tbody);
  paneElement.appendChild(table);
}

function renderMaterialsModule(paneElement) {
  if (!paneElement) return;

  const paneName =
    (paneElement.dataset && paneElement.dataset.genericPane) ||
    "Sub_PRJ_Materials";
  const formsRegister =
    (bootstrapData && bootstrapData.forms) || Object.create(null);
  const formMeta = formsRegister[paneName] || null;
  const formId = formMeta?.formId || "FORM_PRJ_AddMaterial";

  paneElement.dataset.materialsFormId = formId;
  paneElement.classList.add("materials-catalog-pane");
  paneElement.innerHTML = "";

  try {
    renderPaneHeader(paneElement, paneName);
  } catch (err) {
    console.warn("[renderMaterialsModule] unable to render pane header", err);
  }

  const moduleWrapper = document.createElement("div");
  moduleWrapper.className = "materials-module";

  const tabs = document.createElement("div");
  tabs.className = "dyn-tabs materials-module__tabs";

  const viewTab = document.createElement("button");
  viewTab.type = "button";
  viewTab.id = "mat-view-tab-btn";
  viewTab.className = "nav-item active";
  viewTab.textContent = "عرض المواد";
  tabs.appendChild(viewTab);

  const addTab = document.createElement("button");
  addTab.type = "button";
  addTab.id = "mat-add-tab-btn";
  addTab.className = "nav-item";
  addTab.textContent = "إضافة مادة";
  tabs.appendChild(addTab);

  const viewContainer = document.createElement("div");
  viewContainer.id = "mat-view-content";
  viewContainer.className = "materials-module__section";
  viewContainer.dataset.viewLoaded = "false";

  const addContainer = document.createElement("div");
  addContainer.id = "mat-add-content";
  addContainer.className = "materials-module__section";
  addContainer.hidden = true;

  moduleWrapper.appendChild(tabs);
  moduleWrapper.appendChild(viewContainer);
  moduleWrapper.appendChild(addContainer);
  paneElement.appendChild(moduleWrapper);

  let addInitialized = false;

  const resolveFormHandler = () => {
    const handler =
      (typeof window !== "undefined" && window.renderForm) ||
      (typeof window !== "undefined" &&
        window.app &&
        typeof window.app.renderForm === "function" &&
        window.app.renderForm) ||
      (typeof window !== "undefined" &&
        window.forms &&
        typeof window.forms.renderForm === "function" &&
        window.forms.renderForm);
    if (!handler) return null;
    const context =
      (typeof window !== "undefined" && window.app) ||
      (typeof window !== "undefined" && window.forms) ||
      window;
    return { handler, context };
  };

  const activateTab = (target) => {
    if (target === "view") {
      viewTab.classList.add("active");
      addTab.classList.remove("active");
      viewContainer.hidden = false;
      addContainer.hidden = true;
      loadMaterialsViewData(viewContainer, {
        formId,
      });
    } else {
      viewTab.classList.remove("active");
      addTab.classList.add("active");
      viewContainer.hidden = true;
      addContainer.hidden = false;

      if (addInitialized) return;

      addContainer.innerHTML =
        '<p class="muted">جارٍ تحميل نموذج إضافة المادة...</p>';

      const resolved = resolveFormHandler();
      if (!resolved || !resolved.handler) {
        addContainer.innerHTML =
          '<p class="error-text">ميزة النماذج غير متاحة حالياً.</p>';
        addInitialized = true;
        return;
      }

      try {
        const maybePromise = resolved.handler.call(
          resolved.context,
          formId,
          null,
          addContainer
        );
        if (maybePromise && typeof maybePromise.then === "function") {
          maybePromise.catch((err) => {
            console.error("renderForm promise rejected", err);
            addContainer.innerHTML =
              '<p class="error-text">تعذر تحميل نموذج إضافة المادة.</p>';
          });
        }
      } catch (err) {
        console.error("renderForm invocation failed", err);
        addContainer.innerHTML =
          '<p class="error-text">تعذر تحميل نموذج إضافة المادة.</p>';
      }

      addInitialized = true;
    }
  };

  viewTab.addEventListener("click", () => activateTab("view"));
  addTab.addEventListener("click", () => activateTab("add"));

  activateTab("view");
}

function loadMaterialsViewData(container, options = {}) {
  if (!container) return;
  const { reload = false, onComplete, formId } = options;
  const alreadyLoaded = container.dataset.viewLoaded === "true";
  if (alreadyLoaded && !reload) {
    if (typeof onComplete === "function") onComplete();
    return;
  }

  container.dataset.viewLoaded = "false";
  container.innerHTML =
    '<p class="muted">جارٍ تحميل كتالوج المواد، يرجى الانتظار...</p>';

  if (!(window.google && google.script && google.script.run)) {
    container.innerHTML =
      '<p class="error-text">خدمة Google Apps Script غير متاحة.</p>';
    if (typeof onComplete === "function") onComplete();
    return;
  }

  google.script.run
    .withFailureHandler((err) => {
      console.error("getMaterialsViewData failed", err);
      container.innerHTML =
        '<p class="error-text">تعذر تحميل كتالوج المواد.</p>';
      if (typeof showToast === "function") {
        showToast("تعذر تحميل كتالوج المواد.", "error");
      }
      if (typeof onComplete === "function") onComplete(err);
    })
    .withSuccessHandler((result) => {
      container.dataset.viewLoaded = "true";
      renderMaterialsTable(container, result, {
        formId,
        onRefresh: () =>
          loadMaterialsViewData(container, {
            reload: true,
            formId,
          }),
      });
      if (typeof onComplete === "function") onComplete(result);
    })
    .getMaterialsViewData();
}
function renderMaterialsTable(container, data, options = {}) {
  if (!container) return;

  const headers = Array.isArray(data?.headers) ? data.headers : [];
  const rows = Array.isArray(data?.rows) ? data.rows : [];
  const formId =
    options?.formId ||
    (container.closest?.(".materials-catalog-pane")?.dataset?.materialsFormId ??
      "FORM_PRJ_AddMaterial");

  container.innerHTML = "";

  if (!headers.length) {
    const empty = document.createElement("p");
    empty.className = "muted";
    empty.textContent = "لا توجد مواد مسجلة حالياً.";
    container.appendChild(empty);
    return;
  }

  const normalizeHeader = (header) =>
    String(header || "")
      .replace(/[\s\u200f\u200e]+/g, "")
      .replace(/[_-]+/g, "")
      .toLowerCase();

  const matchHeaderIndex = (patterns) =>
    headers.findIndex((header) =>
      patterns.includes(normalizeHeader(header))
    );

  const idIndex = matchHeaderIndex([
    "materialid",
    "materialcode",
    "id",
    "itemid",
    "معرفالخامات",
    "معرفالمادة",
  ]);
  const categoryIndex = matchHeaderIndex([
    "category",
    "materialcategory",
    "الفئة",
    "التصنيف",
  ]);
  const subcategoryIndex = matchHeaderIndex([
    "subcategory",
    "materialsubcategory",
    "الفئةالفرعية",
    "التصنيفالفرعي",
  ]);
  const activeIndex = matchHeaderIndex([
    "active",
    "isactive",
    "status",
    "enabled",
    "مفعل",
  ]);
  const priceIndex = matchHeaderIndex([
    "defaultprice",
    "unitprice",
    "price",
    "السعر",
    "سعر",
  ]);

  const nameKeys = new Set([
    "namear",
    "arabicname",
    "materialnamear",
    "nameen",
    "materialnameen",
    "name",
    "الاسم",
    "اسمالخامة",
    "أسمالخامه",
  ]);

  const records = rows.map((row, rowIndex) => {
    const entry = {};
    headers.forEach((header, index) => {
      entry[header] = row[index];
    });
    const rawId = idIndex >= 0 ? row[idIndex] : rowIndex + 1;
    const materialId = rawId != null && rawId !== "" ? String(rawId) : `row-${rowIndex}`;
    const category =
      categoryIndex >= 0 ? String(row[categoryIndex] || "").trim() : "";
    const subcategory =
      subcategoryIndex >= 0 ? String(row[subcategoryIndex] || "").trim() : "";
    const nameTokens = headers
      .map((header, index) => ({ header, index }))
      .filter(({ header }) => nameKeys.has(normalizeHeader(header)))
      .map(({ index }) => String(row[index] || ""))
      .filter(Boolean);

    const searchText = [materialId, category, subcategory]
      .concat(nameTokens)
      .map((value) => String(value || "").toLowerCase())
      .join(" ");

    return {
      record: entry,
      materialId,
      category,
      subcategory,
      searchText,
      isActive: activeIndex >= 0 ? isTruthyFlag_(row[activeIndex]) : true,
      priceValue: priceIndex >= 0 ? row[priceIndex] : "",
    };
  });

  const categories = Array.from(
    new Set(records.map((entry) => entry.category).filter(Boolean))
  ).sort((a, b) => a.localeCompare(b, "ar", { sensitivity: "base" }));

  const controls = document.createElement("div");
  controls.className = "materials-module__controls";

  const searchWrapper = document.createElement("div");
  searchWrapper.className = "materials-module__search";
  const searchInput = document.createElement("input");
  searchInput.type = "search";
  searchInput.id = "material-view-search";
  searchInput.placeholder = "ابحث عن مادة...";
  searchWrapper.appendChild(searchInput);
  controls.appendChild(searchWrapper);

  const categorySelect = document.createElement("select");
  categorySelect.id = "material-view-category";
  const categoryDefault = document.createElement("option");
  categoryDefault.value = "";
  categoryDefault.textContent = "جميع الفئات";
  categorySelect.appendChild(categoryDefault);
  categories.forEach((category) => {
    const option = document.createElement("option");
    option.value = category;
    option.textContent = category;
    categorySelect.appendChild(option);
  });
  controls.appendChild(categorySelect);

  const subcategorySelect = document.createElement("select");
  subcategorySelect.id = "material-view-subcategory";
  const subcategoryDefault = document.createElement("option");
  subcategoryDefault.value = "";
  subcategoryDefault.textContent = "كل الأصناف الفرعية";
  subcategorySelect.appendChild(subcategoryDefault);
  subcategorySelect.disabled = true;
  controls.appendChild(subcategorySelect);

  const bulkActions = document.createElement("div");
  bulkActions.className = "materials-module__bulk";
  bulkActions.hidden = true;

  const activateSelected = document.createElement("button");
  activateSelected.type = "button";
  activateSelected.className = "ghost-button ghost-button--sm";
  activateSelected.textContent = "تفعيل المحدد";
  bulkActions.appendChild(activateSelected);

  const deactivateSelected = document.createElement("button");
  deactivateSelected.type = "button";
  deactivateSelected.className = "ghost-button ghost-button--sm";
  deactivateSelected.textContent = "تعطيل المحدد";
  bulkActions.appendChild(deactivateSelected);

  controls.appendChild(bulkActions);
  container.appendChild(controls);
  const table = document.createElement("table");
  table.className = "sys-table materials-catalog__table";
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");

  const selectAllTh = document.createElement("th");
  selectAllTh.className = "materials-module__select-column";
  const selectAllCheckbox = document.createElement("input");
  selectAllCheckbox.type = "checkbox";
  selectAllCheckbox.setAttribute("aria-label", "تحديد الكل");
  selectAllTh.appendChild(selectAllCheckbox);
  headerRow.appendChild(selectAllTh);

  const headerCells = [];
  headers.forEach((header, index) => {
    const th = document.createElement("th");
    th.textContent = header;
    th.dataset.columnIndex = index;
    th.tabIndex = 0;
    th.addEventListener("click", () => toggleSort(index));
    th.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        toggleSort(index);
      }
    });
    headerCells.push(th);
    headerRow.appendChild(th);
  });

  const actionsTh = document.createElement("th");
  actionsTh.className = "materials-module__actions-column";
  actionsTh.textContent = "إجراءات";
  headerRow.appendChild(actionsTh);

  thead.appendChild(headerRow);
  table.appendChild(thead);
  const tbody = document.createElement("tbody");
  table.appendChild(tbody);
  container.appendChild(table);

  const countBadge = document.createElement("div");
  countBadge.className = "materials-module__count";
  container.appendChild(countBadge);

  const selectedIds = new Set();
  const state = {
    search: "",
    category: "",
    subcategory: "",
    sortIndex: -1,
    sortDir: "asc",
  };

  const updateBulkActionsVisibility = () => {
    const hasSelection = selectedIds.size > 0;
    bulkActions.hidden = !hasSelection;
    activateSelected.disabled = !hasSelection;
    deactivateSelected.disabled = !hasSelection;
  };

  const populateSubcategories = (category) => {
    const options = Array.from(
      new Set(
        records
          .filter((entry) => !category || entry.category === category)
          .map((entry) => entry.subcategory)
          .filter(Boolean)
      )
    ).sort((a, b) => a.localeCompare(b, "ar", { sensitivity: "base" }));

    subcategorySelect.innerHTML = "";
    subcategorySelect.appendChild(subcategoryDefault.cloneNode(true));
    options.forEach((value) => {
      const option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      subcategorySelect.appendChild(option);
    });
    subcategorySelect.disabled = options.length === 0;
    if (state.subcategory && !options.includes(state.subcategory)) {
      state.subcategory = "";
    }
    if (state.subcategory) {
      subcategorySelect.value = state.subcategory;
    }
  };

  const toComparable = (value) => {
    if (value === null || value === undefined || value === "") {
      return { rank: 3, value: "" };
    }
    if (value instanceof Date) {
      return { rank: 0, value: value.getTime() };
    }
    if (typeof value === "number") {
      return { rank: 0, value };
    }
    const str = String(value).trim();
    if (!str) return { rank: 3, value: "" };
    const numeric = Number(str.replace(/,/g, ""));
    if (!Number.isNaN(numeric) && str !== "") {
      return { rank: 0, value: numeric };
    }
    const dateValue = Date.parse(str);
    if (!Number.isNaN(dateValue)) {
      return { rank: 0, value: dateValue };
    }
    return { rank: 2, value: str.toLowerCase() };
  };

  const updateSortIndicators = () => {
    headerCells.forEach((cell, index) => {
      cell.classList.toggle(
        "sorted-asc",
        state.sortIndex === index && state.sortDir === "asc"
      );
      cell.classList.toggle(
        "sorted-desc",
        state.sortIndex === index && state.sortDir === "desc"
      );
    });
  };

  const toggleSort = (index) => {
    if (state.sortIndex === index) {
      state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
    } else {
      state.sortIndex = index;
      state.sortDir = "asc";
    }
    updateSortIndicators();
    applyFilters();
  };
  const selectedCheckboxes = () =>
    tbody.querySelectorAll("input.materials-module__select");

  const renderRows = (entries) => {
    tbody.innerHTML = "";
    countBadge.textContent = `عدد السجلات: ${entries.length} من ${records.length}`;

    if (!entries.length) {
      const emptyRow = document.createElement("tr");
      const emptyCell = document.createElement("td");
      emptyCell.colSpan = headers.length + 2;
      emptyCell.className = "materials-module__empty";
      emptyCell.textContent = "لا توجد مواد مطابقة للمعايير المحددة.";
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      return;
    }

    entries.forEach((entry) => {
      const row = document.createElement("tr");
      row.dataset.materialId = entry.materialId;

      const selectCell = document.createElement("td");
      selectCell.className = "materials-module__select-column";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "materials-module__select";
      checkbox.dataset.materialId = entry.materialId;
      checkbox.checked = selectedIds.has(entry.materialId);
      checkbox.addEventListener("change", (event) => {
        if (event.target.checked) {
          selectedIds.add(entry.materialId);
        } else {
          selectedIds.delete(entry.materialId);
        }
        updateBulkActionsVisibility();
      });
      selectCell.appendChild(checkbox);
      row.appendChild(selectCell);

      headers.forEach((header, index) => {
        const td = document.createElement("td");
        const value = entry.record[header];
        if (index === activeIndex) {
          const button = document.createElement("button");
          button.type = "button";
          button.className =
            "materials-status-toggle" + (entry.isActive ? " is-active" : "");
          button.textContent = entry.isActive ? "مفعل" : "معطل";
          button.dataset.materialId = entry.materialId;
          button.addEventListener("click", () =>
            handleToggleStatus(entry.materialId, button)
          );
          td.appendChild(button);
        } else if (value === true || value === false) {
          td.innerHTML = renderBooleanBadge(value);
        } else if (
          typeof value === "string" &&
          /^(true|false|yes|no|y|n|1|0)$/i.test(value.trim())
        ) {
          td.innerHTML = renderBooleanBadge(value);
        } else if (value instanceof Date) {
          td.textContent = formatDateTime(value);
        } else if (
          typeof value === "string" &&
          /^\d{4}-\d{2}-\d{2}T/.test(value)
        ) {
          td.textContent = formatDateTime(value);
        } else {
          td.textContent = value == null ? "" : String(value);
        }
        row.appendChild(td);
      });

      const actionsCell = document.createElement("td");
      actionsCell.className = "materials-module__actions-column";

      const createAction = (label, icon, handler) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "materials-row-action";
        btn.title = label;
        const iconSpan = document.createElement("span");
        iconSpan.className = "materials-row-action__icon";
        iconSpan.setAttribute("aria-hidden", "true");
        iconSpan.textContent = icon;
        const textSpan = document.createElement("span");
        textSpan.className = "visually-hidden";
        textSpan.textContent = label;
        btn.appendChild(iconSpan);
        btn.appendChild(textSpan);
        btn.addEventListener("click", handler);
        return btn;
      };

      actionsCell.appendChild(
        createAction("تعديل", "✏️", () => handleEdit(entry))
      );
      actionsCell.appendChild(
        createAction("أرشفة", "🗂️", () => handleArchive(entry))
      );
      actionsCell.appendChild(
        createAction("تعديل السعر", "🏷️", () => handlePriceAdjust(entry))
      );

      row.appendChild(actionsCell);
      tbody.appendChild(row);
    });
  };

  const applyFilters = () => {
    const term = state.search.trim().toLowerCase();
    let filtered = records.slice();
    if (state.category) {
      filtered = filtered.filter((entry) => entry.category === state.category);
    }
    if (state.subcategory) {
      filtered = filtered.filter((entry) => entry.subcategory === state.subcategory);
    }
    if (term) {
      filtered = filtered.filter((entry) => entry.searchText.includes(term));
    }
    if (state.sortIndex >= 0) {
      const dir = state.sortDir === "asc" ? 1 : -1;
      const header = headers[state.sortIndex];
      filtered.sort((a, b) => {
        const aComparable = toComparable(a.record[header]);
        const bComparable = toComparable(b.record[header]);
        if (aComparable.rank !== bComparable.rank) {
          return (aComparable.rank - bComparable.rank) * dir;
        }
        if (aComparable.value === bComparable.value) return 0;
        return aComparable.value > bComparable.value ? dir : -dir;
      });
    }
    renderRows(filtered);
    return filtered;
  };
  const handleToggleStatus = (materialId, button) => {
    if (!(window.google && google.script && google.script.run)) {
      if (typeof showToast === "function") {
        showToast("خدمة الخادم غير متاحة حالياً.", "error");
      }
      return;
    }
    button.disabled = true;
    google.script.run
      .withFailureHandler((err) => {
        console.error("toggleMaterialActiveStatus failed", err);
        button.disabled = false;
        if (typeof showToast === "function") {
          showToast("تعذر تحديث حالة المادة.", "error");
        }
      })
      .withSuccessHandler((result) => {
        button.disabled = false;
        if (result?.success) {
          if (typeof showToast === "function") {
            showToast("تم تحديث حالة المادة بنجاح.", "success");
          }
          options?.onRefresh?.();
        } else if (typeof showToast === "function") {
          showToast(result?.message || "تعذر تحديث حالة المادة.", "warning");
        }
      })
      .toggleMaterialActiveStatus(materialId);
  };

  const handleArchive = (entry) => {
    if (!(window.google && google.script && google.script.run)) {
      if (typeof showToast === "function") {
        showToast("خدمة الخادم غير متاحة حالياً.", "error");
      }
      return;
    }
    google.script.run
      .withFailureHandler((err) => {
        console.error("archiveMaterial failed", err);
        if (typeof showToast === "function") {
          showToast("تعذر أرشفة المادة.", "error");
        }
      })
      .withSuccessHandler((result) => {
        if (result?.success) {
          if (typeof showToast === "function") {
            showToast("تم أرشفة المادة بنجاح.", "success");
          }
          options?.onRefresh?.();
        } else if (typeof showToast === "function") {
          showToast("تعذر أرشفة المادة.", "warning");
        }
      })
      .archiveMaterial(entry.materialId);
  };

  const handlePriceAdjust = (entry) => {
    const currentPrice = entry.priceValue != null ? String(entry.priceValue) : "";
    const response = window.prompt("الرجاء إدخال السعر الجديد", currentPrice);
    if (response === null) return;
    const numeric = Number(response);
    if (!Number.isFinite(numeric) || numeric < 0) {
      if (typeof showToast === "function") {
        showToast("الرجاء إدخال قيمة سعر صحيحة.", "warning");
      }
      return;
    }
    if (!(window.google && google.script && google.script.run)) {
      if (typeof showToast === "function") {
        showToast("خدمة الخادم غير متاحة حالياً.", "error");
      }
      return;
    }
    google.script.run
      .withFailureHandler((err) => {
        console.error("updateMaterialPrice failed", err);
        if (typeof showToast === "function") {
          showToast("تعذر تحديث سعر المادة.", "error");
        }
      })
      .withSuccessHandler((result) => {
        if (result?.success) {
          if (typeof showToast === "function") {
            showToast("تم تحديث سعر المادة بنجاح.", "success");
          }
          options?.onRefresh?.();
        } else if (typeof showToast === "function") {
          showToast("تعذر تحديث سعر المادة.", "warning");
        }
      })
      .updateMaterialPrice(entry.materialId, numeric);
  };

  const handleEdit = (entry) => {
    const resolved = (() => {
      const handler =
        (typeof window !== "undefined" && window.renderForm) ||
        (typeof window !== "undefined" &&
          window.app &&
          typeof window.app.renderForm === "function" &&
          window.app.renderForm) ||
        (typeof window !== "undefined" &&
          window.forms &&
          typeof window.forms.renderForm === "function" &&
          window.forms.renderForm);
      if (!handler) return null;
      const context =
        (typeof window !== "undefined" && window.app) ||
        (typeof window !== "undefined" && window.forms) ||
        window;
      return { handler, context };
    })();

    if (!resolved || !resolved.handler) {
      if (typeof showToast === "function") {
        showToast("ميزة النماذج غير متاحة حالياً.", "warning");
      }
      return;
    }

    try {
      resolved.handler.call(resolved.context, formId, entry.record);
    } catch (err) {
      console.error("renderForm edit invocation failed", err);
      if (typeof showToast === "function") {
        showToast("تعذر فتح نموذج تعديل المادة.", "error");
      }
    }
  };

  const performBulkStatusUpdate = (makeActive) => {
    const ids = Array.from(selectedIds);
    if (!ids.length) return;
    if (!(window.google && google.script && google.script.run)) {
      if (typeof showToast === "function") {
        showToast("خدمة الخادم غير متاحة حالياً.", "error");
      }
      return;
    }
    google.script.run
      .withFailureHandler((err) => {
        console.error("bulkUpdateMaterialStatus failed", err);
        if (typeof showToast === "function") {
          showToast("تعذر تحديث حالة المواد المحددة.", "error");
        }
      })
      .withSuccessHandler((result) => {
        if (result?.success) {
          if (typeof showToast === "function") {
            showToast("تم تحديث حالة المواد المحددة.", "success");
          }
          selectedIds.clear();
          updateBulkActionsVisibility();
          options?.onRefresh?.();
        } else if (typeof showToast === "function") {
          showToast("لم يتم تحديث أي مواد.", "warning");
        }
      })
      .bulkUpdateMaterialStatus(ids, makeActive);
  };

  activateSelected.addEventListener("click", () => performBulkStatusUpdate(true));
  deactivateSelected.addEventListener("click", () => performBulkStatusUpdate(false));

  selectAllCheckbox.addEventListener("change", (event) => {
    const shouldSelect = event.target.checked;
    selectedCheckboxes().forEach((input) => {
      input.checked = shouldSelect;
      const id = input.dataset.materialId;
      if (!id) return;
      if (shouldSelect) {
        selectedIds.add(id);
      } else {
        selectedIds.delete(id);
      }
    });
    updateBulkActionsVisibility();
  });

  searchInput.addEventListener("input", () => {
    state.search = String(searchInput.value || "");
    applyFilters();
  });

  categorySelect.addEventListener("change", () => {
    state.category = categorySelect.value || "";
    state.subcategory = "";
    populateSubcategories(state.category);
    subcategorySelect.value = "";
    applyFilters();
  });

  subcategorySelect.addEventListener("change", () => {
    state.subcategory = subcategorySelect.value || "";
    applyFilters();
  });

  populateSubcategories("");
  updateSortIndicators();
  applyFilters();
  updateBulkActionsVisibility();
}


function renderPaneHeader(paneElement, paneName) {
  if (!paneElement) return;

  const formsRegister =
    (bootstrapData && bootstrapData.forms) || Object.create(null);
  const formEntry = formsRegister?.[paneName];

  // Developer diagnostics
  if (window.console) {
    console.log(`[renderPaneHeader] lookup`, {
      paneName,
      hasForms: Boolean(formsRegister),
      availableForms: Object.keys(formsRegister),
      formEntry,
    });
  }

  const formId = formEntry?.formId;
  if (!formId) return;

  let header = paneElement.querySelector(".pane-header");
  if (!header) {
    header = document.createElement("div");
    header.className = "pane-header";
    paneElement.prepend(header);
  }

  header.dataset.formId = formId;
  header.innerHTML = "";

  const addButton = document.createElement("button");
  addButton.type = "button";
  addButton.className = "accent-button";
  addButton.textContent = "إضافة جديد";

  // Flexible renderForm handler resolution
  const renderFormHandler =
    (typeof window !== "undefined" && window.renderForm) ||
    (typeof window !== "undefined" &&
      window.app &&
      typeof window.app.renderForm === "function" &&
      window.app.renderForm) ||
    (typeof window !== "undefined" &&
      window.forms &&
      typeof window.forms.renderForm === "function" &&
      window.forms.renderForm);

  if (typeof renderFormHandler === "function") {
    const context =
      (typeof window !== "undefined" && window.app) ||
      (typeof window !== "undefined" && window.forms) ||
      window;
    addButton.addEventListener("click", () => {
      if (window.console) {
        console.log("[renderPaneHeader] Add New button clicked", {
          paneName,
          formId,
        });
      }
      renderFormHandler.call(context, formId, null);
    });
  } else {
    addButton.addEventListener("click", () => {
      console.warn("renderForm handler is not available", {
        formId,
        windowHasRenderForm:
          typeof window !== "undefined" &&
          typeof window.renderForm === "function",
      });
      showToast("ميزة النماذج غير متاحة حالياً.", "warning");
    });
  }

  header.appendChild(addButton);
}
function renderDirectExpenseShell(paneElement) {
  if (!paneElement) return;

  paneElement.classList.add("direct-expense-pane");
  paneElement.innerHTML = "";

  const tabs = document.createElement("div");
  tabs.className = "dyn-tabs direct-expense__tabs";

  const viewTab = document.createElement("button");
  viewTab.type = "button";
  viewTab.id = "de-view-tab-btn";
  viewTab.className = "nav-item active";
  viewTab.textContent = "عرض المصروفات";

  const addTab = document.createElement("button");
  addTab.type = "button";
  addTab.id = "de-add-tab-btn";
  addTab.className = "nav-item";
  addTab.textContent = "إضافة مصروف";

  tabs.appendChild(viewTab);
  tabs.appendChild(addTab);

  const viewContainer = document.createElement("div");
  viewContainer.id = "de-view-content";
  viewContainer.className = "direct-expense__section";
  viewContainer.dataset.viewLoaded = "false";

  const addContainer = document.createElement("div");
  addContainer.id = "de-add-content";
  addContainer.className = "direct-expense__section";
  addContainer.hidden = true;

  paneElement.appendChild(tabs);
  paneElement.appendChild(viewContainer);
  paneElement.appendChild(addContainer);

  let addInitialized = false;

  const activateTab = (target) => {
    if (target === "view") {
      viewTab.classList.add("active");
      addTab.classList.remove("active");
      viewContainer.hidden = false;
      addContainer.hidden = true;
      loadDirectExpenseViewData(viewContainer);
    } else {
      viewTab.classList.remove("active");
      addTab.classList.add("active");
      viewContainer.hidden = true;
      addContainer.hidden = false;
      if (!addInitialized) {
        renderDirectExpenseForm(addContainer, {
          onSaved: () => {
            viewContainer.dataset.viewLoaded = "false";
            loadDirectExpenseViewData(viewContainer, { reload: true, silent: true });
          },
        });
        addInitialized = true;
      }
    }
  };

  viewTab.addEventListener("click", () => activateTab("view"));
  addTab.addEventListener("click", () => activateTab("add"));

  activateTab("view");
}

function loadDirectExpenseViewData(container, options = {}) {
  if (!container) return;
  const { reload = false, onComplete, silent = false } = options;
  const alreadyLoaded = container.dataset.viewLoaded === "true";
  if (alreadyLoaded && !reload) {
    if (typeof onComplete === "function") onComplete();
    return;
  }

  container.dataset.viewLoaded = "false";
  if (!silent) {
    container.innerHTML =
      '<p class="muted">جارٍ تحميل المصروفات، يرجى الانتظار...</p>';
  }

  if (!(window.google && google.script && google.script.run)) {
    container.innerHTML =
      '<p class="error-text">خدمة Google Apps Script غير متاحة.</p>';
    if (typeof onComplete === "function") onComplete();
    return;
  }

  google.script.run
    .withFailureHandler((err) => {
      console.error("getDirectExpenseViewData failed", err);
      container.innerHTML =
        '<p class="error-text">تعذر تحميل المصروفات.</p>';
      if (typeof showToast === "function") {
        showToast("تعذر تحميل المصروفات.", "error");
      }
      if (typeof onComplete === "function") onComplete(err);
    })
    .withSuccessHandler((result) => {
      container.dataset.viewLoaded = "true";
      renderDirectExpenseTable(container, result, {
        onRefresh: () =>
          loadDirectExpenseViewData(container, { reload: true, silent: false }),
      });
      if (typeof onComplete === "function") onComplete(result);
    })
    .getDirectExpenseViewData();
}

function renderDirectExpenseTable(container, data, options = {}) {
  if (!container) return;

  const headers = Array.isArray(data?.headers) ? data.headers : [];
  const rows = Array.isArray(data?.rows) ? data.rows : [];

  container.innerHTML = "";

  if (!headers.length) {
    const empty = document.createElement("p");
    empty.className = "direct-expense__empty";
    empty.textContent = "لا توجد مصروفات مسجلة حالياً.";
    container.appendChild(empty);
    return;
  }

  const resolveExpenseIdentifier = (record, fallbackIndex) => {
    if (!record || typeof record !== "object") {
      return String(fallbackIndex);
    }
    const normalized = Object.keys(record).reduce((acc, key) => {
      acc[String(key || "").trim().toLowerCase()] = record[key];
      return acc;
    }, {});
    const candidates = [
      "expense_id",
      "expenseid",
      "directexpense_id",
      "direct_expense_id",
      "direct expense id",
      "id",
      "record_id",
      "expense code",
      "view_id",
      "viewid",
      "معرف_العرض",
      "معرفالعرض",
    ];
    for (const key of candidates) {
      if (Object.prototype.hasOwnProperty.call(normalized, key)) {
        const value = normalized[key];
        if (value !== undefined && value !== null && String(value).trim() !== "") {
          return value;
        }
      }
    }
    return String(fallbackIndex);
  };

  const currencyColumns = headers.map((header) =>
    /amount|total|price|cost|vat|قيمة|سعر|إجمالي|اجمالي|ضريبة/i.test(
      String(header || "")
    )
  );

  const records = rows.map((row, index) => {
    const record = {};
    headers.forEach((header, columnIndex) => {
      record[header] = row[columnIndex];
    });
    const identifier = resolveExpenseIdentifier(record, index);
    const searchText = Object.values(record)
      .concat(identifier)
      .filter((value) => value !== undefined && value !== null)
      .map((value) => String(value).toLowerCase())
      .join(" ");
    return { record, identifier, index, searchText };
  });

  const totalRecords = records.length;
  const state = { search: "", sortIndex: -1, sortDir: "asc" };

  const controls = document.createElement("div");
  controls.className = "direct-expense__view-controls";

  const searchInput = document.createElement("input");
  searchInput.type = "search";
  searchInput.placeholder = "ابحث في المصروفات...";
  controls.appendChild(searchInput);

  const refreshButton = document.createElement("button");
  refreshButton.type = "button";
  refreshButton.className = "ghost-button ghost-button--sm";
  refreshButton.textContent = "تحديث";
  refreshButton.addEventListener("click", () => {
    if (typeof options.onRefresh === "function") {
      options.onRefresh();
    } else {
      loadDirectExpenseViewData(container, { reload: true });
    }
  });
  controls.appendChild(refreshButton);

  const countBadge = document.createElement("span");
  countBadge.className = "muted";
  controls.appendChild(countBadge);

  container.appendChild(controls);

  const table = document.createElement("table");
  table.className = "sys-table direct-expense__table";
  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  const headerCells = [];

  const updateSortIndicators = () => {
    headerCells.forEach((cell, index) => {
      cell.classList.toggle(
        "sorted-asc",
        state.sortIndex === index && state.sortDir === "asc"
      );
      cell.classList.toggle(
        "sorted-desc",
        state.sortIndex === index && state.sortDir === "desc"
      );
    });
  };

  const toggleSort = (index) => {
    if (state.sortIndex === index) {
      state.sortDir = state.sortDir === "asc" ? "desc" : "asc";
    } else {
      state.sortIndex = index;
      state.sortDir = "asc";
    }
    updateSortIndicators();
    applyFilters();
  };

  headers.forEach((header, headerIndex) => {
    const th = document.createElement("th");
    th.textContent = header;
    th.tabIndex = 0;
    th.addEventListener("click", () => toggleSort(headerIndex));
    th.addEventListener("keypress", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        toggleSort(headerIndex);
      }
    });
    headerCells.push(th);
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  table.appendChild(tbody);
  container.appendChild(table);

  const updateCount = (visibleCount) => {
    countBadge.textContent = `عدد السجلات: ${visibleCount} من ${totalRecords}`;
  };

  const toComparable = (value) => {
    if (value === null || value === undefined || value === "") {
      return { rank: 3, value: "" };
    }
    if (value instanceof Date) {
      return { rank: 0, value: value.getTime() };
    }
    if (typeof value === "number") {
      return { rank: 0, value };
    }
    if (typeof value === "boolean") {
      return { rank: 1, value: value ? 1 : 0 };
    }
    const str = String(value).trim();
    if (!str) return { rank: 3, value: "" };
    const numeric = Number(str.replace(/,/g, ""));
    if (!Number.isNaN(numeric) && str !== "") {
      return { rank: 0, value: numeric };
    }
    const dateValue = Date.parse(str);
    if (!Number.isNaN(dateValue)) {
      return { rank: 0, value: dateValue };
    }
    return { rank: 2, value: str.toLowerCase() };
  };

  const renderRows = (entries) => {
    tbody.innerHTML = "";
    updateCount(entries.length);

    if (!entries.length) {
      const emptyRow = document.createElement("tr");
      const emptyCell = document.createElement("td");
      emptyCell.colSpan = headers.length;
      emptyCell.className = "direct-expense__empty";
      emptyCell.textContent = "لا توجد نتائج مطابقة.";
      emptyRow.appendChild(emptyCell);
      tbody.appendChild(emptyRow);
      return;
    }

    entries.forEach((entry) => {
      const row = document.createElement("tr");
      row.dataset.expenseId = entry.identifier != null ? String(entry.identifier) : "";

      headers.forEach((header, index) => {
        const td = document.createElement("td");
        const value = entry.record[header];
        if (value === true || value === false) {
          td.innerHTML = renderBooleanBadge(value);
        } else if (
          typeof value === "string" &&
          /^(true|false|yes|no|y|n|1|0)$/i.test(value.trim())
        ) {
          td.innerHTML = renderBooleanBadge(value);
        } else if (value instanceof Date) {
          td.textContent = formatDateTime(value);
        } else if (
          typeof value === "string" &&
          /^\d{4}-\d{2}-\d{2}T/.test(value)
        ) {
          td.textContent = formatDateTime(value);
        } else if (currencyColumns[index]) {
          const numericValue = Number(value);
          td.textContent = Number.isFinite(numericValue)
            ? formatCurrencyValue(numericValue)
            : String(value ?? "");
        } else {
          td.textContent = value == null ? "" : String(value);
        }
        row.appendChild(td);
      });

      row.addEventListener("click", () =>
        showExpenseDetailsPopup(entry.identifier, entry.record)
      );
      tbody.appendChild(row);
    });
  };

  const applyFilters = () => {
    const term = state.search.trim().toLowerCase();
    let filtered = records.slice();
    if (term) {
      filtered = filtered.filter((entry) => entry.searchText.includes(term));
    }
    if (state.sortIndex >= 0) {
      const dir = state.sortDir === "asc" ? 1 : -1;
      const header = headers[state.sortIndex];
      filtered.sort((a, b) => {
        const aComparable = toComparable(a.record[header]);
        const bComparable = toComparable(b.record[header]);
        if (aComparable.rank !== bComparable.rank) {
          return (aComparable.rank - bComparable.rank) * dir;
        }
        if (aComparable.value === bComparable.value) return 0;
        return aComparable.value > bComparable.value ? dir : -dir;
      });
    }
    renderRows(filtered);
    return filtered;
  };

  searchInput.addEventListener("input", () => {
    state.search = String(searchInput.value || "");
    applyFilters();
  });

  updateSortIndicators();
  applyFilters();
}

function showExpenseDetailsPopup(expenseId, fallbackRecord) {
  const existing = document.querySelector(".direct-expense__modal-overlay");
  if (existing && existing.parentElement) {
    existing.parentElement.removeChild(existing);
  }

  const overlay = document.createElement("div");
  overlay.className = "direct-expense__modal-overlay";
  const dialog = document.createElement("div");
  dialog.className = "direct-expense__modal";
  overlay.appendChild(dialog);

  const header = document.createElement("div");
  header.className = "direct-expense__modal-header";
  const title = document.createElement("h3");
  title.textContent = "تفاصيل المصروف";
  header.appendChild(title);
  const closeButton = document.createElement("button");
  closeButton.type = "button";
  closeButton.className = "ghost-button ghost-button--sm";
  closeButton.textContent = "إغلاق";
  header.appendChild(closeButton);
  dialog.appendChild(header);

  const body = document.createElement("div");
  body.className = "direct-expense__modal-body";
  const status = document.createElement("p");
  status.className = "muted";
  status.textContent = "جارٍ تحميل التفاصيل...";
  body.appendChild(status);
  dialog.appendChild(body);

  const handleClose = () => {
    document.removeEventListener("keydown", handleKeydown);
    if (overlay.parentElement) {
      overlay.parentElement.removeChild(overlay);
    }
  };

  const handleKeydown = (event) => {
    if (event.key === "Escape") {
      event.preventDefault();
      handleClose();
    }
  };

  closeButton.addEventListener("click", handleClose);
  overlay.addEventListener("click", (event) => {
    if (event.target === overlay) {
      handleClose();
    }
  });
  document.addEventListener("keydown", handleKeydown);

  document.body.appendChild(overlay);

  if (!(window.google && google.script && google.script.run)) {
    status.textContent = "خدمة Google Apps Script غير متاحة.";
    return;
  }

  const targetId =
    expenseId != null && expenseId !== ""
      ? expenseId
      : fallbackRecord && typeof fallbackRecord === "object"
      ? fallbackRecord.Expense_ID || fallbackRecord.ID || ""
      : "";

  const renderExpenseDetails = (
    detailsResult,
    attachments,
    resolvedId,
    fallback
  ) => {
    body.innerHTML = "";

    const records = Array.isArray(detailsResult?.details)
      ? detailsResult.details
      : [];
    const headers = Array.isArray(detailsResult?.headers)
      ? detailsResult.headers
      : [];
    const primaryRecord =
      (records.length && records[0]) ||
      (fallback && typeof fallback === "object" ? fallback : {});

    const resolveValue = (record, candidates) => {
      if (!record || typeof record !== "object") return "";
      for (const candidate of candidates) {
        const key = String(candidate || "").trim();
        if (key && key in record && record[key] !== undefined) {
          return record[key];
        }
        const lowerKey = key.toLowerCase();
        const match = Object.keys(record).find(
          (rk) => rk && String(rk).toLowerCase() === lowerKey
        );
        if (match && record[match] !== undefined) {
          return record[match];
        }
      }
      return "";
    };

    const metaFields = [
      { label: "رقم المصروف", keys: ["Expense_ID", "ExpenseId", "ID", "Record_ID"] },
      {
        label: "المشروع",
        keys: ["Project_Name", "Project", "Project_ID", "ProjectId", "Project Code"],
      },
      { label: "التاريخ", keys: ["Date", "Transaction_Date", "Posting_Date"] },
      {
        label: "طريقة الدفع",
        keys: ["Payment_Method", "Pay_Method", "PaymentMethod", "Method"],
      },
      {
        label: "حالة الدفع",
        keys: ["Payment_Status", "Pay_Status", "Status"],
      },
      { label: "ملاحظات", keys: ["Notes", "Note", "Remarks"] },
    ];

    const metaList = document.createElement("dl");
    metaList.className = "direct-expense__modal-grid";
    metaFields.forEach(({ label, keys }) => {
      const value = resolveValue(primaryRecord, keys);
      if (value === undefined || value === null || value === "") return;
      const dt = document.createElement("dt");
      dt.textContent = label;
      const dd = document.createElement("dd");
      const normalizedKeys = keys.map((k) => String(k || "").toLowerCase());
      if (normalizedKeys.some((k) => k.includes("date"))) {
        dd.textContent = formatDateTime(value);
      } else {
        dd.textContent = String(value);
      }
      metaList.appendChild(dt);
      metaList.appendChild(dd);
    });
    if (metaList.children.length) {
      body.appendChild(metaList);
    }

    if (records.length) {
      const itemsTable = document.createElement("table");
      itemsTable.className = "sys-table direct-expense__table";
      const itemsHead = document.createElement("thead");
      const headRow = document.createElement("tr");
      const itemColumns = [
        { label: "المادة", keys: ["Material_Name", "Material", "Item_Name"] },
        { label: "الوحدة", keys: ["Unit", "Default_Unit"] },
        { label: "الكمية", keys: ["Qty", "Quantity"] },
        { label: "السعر", keys: ["Unit_Price", "Price"] },
        { label: "الإجمالي", keys: ["Amount", "Line_Amount"] },
        { label: "الضريبة", keys: ["VAT_Amount", "Tax_Amount"] },
        {
          label: "الإجمالي مع الضريبة",
          keys: ["Total_With_VAT", "TotalWithVat", "Total"],
        },
      ];
      itemColumns.forEach((column) => {
        const th = document.createElement("th");
        th.textContent = column.label;
        headRow.appendChild(th);
      });
      itemsHead.appendChild(headRow);
      itemsTable.appendChild(itemsHead);
      const itemsBody = document.createElement("tbody");
      itemsTable.appendChild(itemsBody);

      records.forEach((record) => {
        const row = document.createElement("tr");
        itemColumns.forEach((column, columnIndex) => {
          const td = document.createElement("td");
          const rawValue = resolveValue(record, column.keys);
          if (rawValue === undefined || rawValue === null || rawValue === "") {
            td.textContent = "—";
          } else if (column.label.includes("التاريخ")) {
            td.textContent = formatDateTime(rawValue);
          } else if (column.label.includes("السعر") || columnIndex >= 3) {
            const numeric = Number(rawValue);
            td.textContent = Number.isFinite(numeric)
              ? formatCurrencyValue(numeric)
              : String(rawValue);
          } else if (column.label.includes("الكمية")) {
            const numeric = Number(rawValue);
            td.textContent = Number.isFinite(numeric)
              ? numeric.toLocaleString("ar-EG", { maximumFractionDigits: 2 })
              : String(rawValue);
          } else {
            td.textContent = String(rawValue);
          }
          row.appendChild(td);
        });
        itemsBody.appendChild(row);
      });

      body.appendChild(itemsTable);
    } else {
      const noDetails = document.createElement("p");
      noDetails.className = "direct-expense__empty";
      noDetails.textContent = "لا تتوفر تفاصيل إضافية لهذا المصروف.";
      body.appendChild(noDetails);
    }

    const attachmentsSection = document.createElement("div");
    attachmentsSection.className = "direct-expense__attachments-block";
    const attachmentsHeader = document.createElement("h4");
    attachmentsHeader.textContent = "المرفقات";
    attachmentsSection.appendChild(attachmentsHeader);

    const attachmentList = document.createElement("ul");
    attachmentList.className = "direct-expense__attachment-list";

    if (attachments && attachments.length) {
      attachments.forEach((attachment) => {
        const item = document.createElement("li");
        const link = document.createElement("a");
        const url =
          attachment?.Drive_URL || attachment?.URL || attachment?.Link || "";
        const label =
          attachment?.Label || attachment?.File_Name || attachment?.Name || "مرفق";

        link.textContent = label;
        if (url) {
          link.href = url;
          link.target = "_blank";
          link.rel = "noopener";
        } else {
          link.href = "#";
          link.addEventListener("click", (event) => event.preventDefault());
        }
        item.appendChild(link);
        attachmentList.appendChild(item);
      });
      attachmentsSection.appendChild(attachmentList);
    } else {
      const emptyAttachments = document.createElement("p");
      emptyAttachments.className = "direct-expense__empty";
      emptyAttachments.textContent = "لا توجد مرفقات مرتبطة بهذا المصروف.";
      attachmentsSection.appendChild(emptyAttachments);
    }

    body.appendChild(attachmentsSection);

    if (resolvedId) {
      title.textContent = `تفاصيل المصروف (${resolvedId})`;
    }
  };

  google.script.run
    .withFailureHandler((err) => {
      console.error("getDirectExpenseDetailsById failed", err);
      status.textContent = "تعذر تحميل تفاصيل المصروف.";
      if (typeof showToast === "function") {
        showToast("تعذر تحميل تفاصيل المصروف.", "error");
      }
    })
    .withSuccessHandler((details) => {
      const resolvedId =
        (details && details.expenseId) ||
        targetId ||
        (fallbackRecord && fallbackRecord.Expense_ID) ||
        "";

      const renderWithAttachments = (attachments) => {
        renderExpenseDetails(details, attachments, resolvedId, fallbackRecord);
      };

      if (resolvedId) {
        google.script.run
          .withFailureHandler((err) => {
            console.error("getAttachmentsForEntity failed", err);
            renderWithAttachments([]);
          })
          .withSuccessHandler((attachments) => {
            renderWithAttachments(Array.isArray(attachments) ? attachments : []);
          })
          .getAttachmentsForEntity(resolvedId, "DirectExpense");
      } else {
        renderWithAttachments([]);
      }
    })
    .getDirectExpenseDetailsById(targetId || "");
}
function renderDirectExpenseForm(paneElement, options = {}) {
  if (!paneElement) return;
  paneElement.innerHTML = "";
  const { onSaved } = options || {};

  let cart = [];
  let materialsCatalog = [];
  let materialsCatalogLoaded = false;
  let attachments = [];
          let selectedCategory = "";
          let selectedSubcategory = "";
          let isVatEnabled = false;

          const VAT_RATE = 0.14;

          const headerSection = document.createElement("div");
          headerSection.className = "direct-expense__header";

          const projectField = document.createElement("div");
          projectField.className = "direct-expense__field";
          const projectLabel = document.createElement("label");
          projectLabel.setAttribute("for", "de-project-select");
          projectLabel.textContent = "المشروع";
          const projectSelect = document.createElement("select");
          projectSelect.id = "de-project-select";
          const defaultProjectOption = document.createElement("option");
          defaultProjectOption.value = "";
          defaultProjectOption.textContent = "اختر مشروعًا";
          projectSelect.appendChild(defaultProjectOption);
          projectField.appendChild(projectLabel);
          projectField.appendChild(projectSelect);

          const dateField = document.createElement("div");
          dateField.className = "direct-expense__field";
          const dateLabel = document.createElement("label");
          dateLabel.setAttribute("for", "de-date-input");
          dateLabel.textContent = "التاريخ";
          const dateInput = document.createElement("input");
          dateInput.type = "date";
          dateInput.id = "de-date-input";
          dateField.appendChild(dateLabel);
          dateField.appendChild(dateInput);

          headerSection.appendChild(projectField);
          headerSection.appendChild(dateField);

          const dropdowns =
            (typeof bootstrapData === "object" && bootstrapData?.dropdowns) ||
            {};
          const paymentMethodOptions = Array.isArray(dropdowns.paymentMethod)
            ? dropdowns.paymentMethod
            : [];
          const paymentStatusOptions = Array.isArray(dropdowns.paymentStatus)
            ? dropdowns.paymentStatus
            : [];

          const metaSection = document.createElement("div");
          metaSection.className = "direct-expense__meta";

          const paymentMethodField = document.createElement("div");
          paymentMethodField.className = "direct-expense__field";
          const paymentMethodLabel = document.createElement("label");
          paymentMethodLabel.setAttribute("for", "de-payment-method");
          paymentMethodLabel.textContent = "طريقة الدفع";
          const paymentMethodSelect = document.createElement("select");
          paymentMethodSelect.id = "de-payment-method";
          const paymentMethodDefault = document.createElement("option");
          paymentMethodDefault.value = "";
          paymentMethodDefault.textContent = "اختر طريقة الدفع";
          paymentMethodSelect.appendChild(paymentMethodDefault);
          paymentMethodOptions.forEach((option) => {
            const opt = document.createElement("option");
            opt.value = option?.value ?? option?.label ?? "";
            opt.textContent = option?.label ?? option?.value ?? "";
            paymentMethodSelect.appendChild(opt);
          });
          paymentMethodField.appendChild(paymentMethodLabel);
          paymentMethodField.appendChild(paymentMethodSelect);
          headerSection.appendChild(paymentMethodField);

          const paymentStatusField = document.createElement("div");
          paymentStatusField.className = "direct-expense__field";
          const paymentStatusLabel = document.createElement("label");
          paymentStatusLabel.setAttribute("for", "de-payment-status");
          paymentStatusLabel.textContent = "حالة الدفع";
          const paymentStatusSelect = document.createElement("select");
          paymentStatusSelect.id = "de-payment-status";
          const paymentStatusDefault = document.createElement("option");
          paymentStatusDefault.value = "";
          paymentStatusDefault.textContent = "اختر حالة الدفع";
          paymentStatusSelect.appendChild(paymentStatusDefault);
          paymentStatusOptions.forEach((option) => {
            const opt = document.createElement("option");
            opt.value = option?.value ?? option?.label ?? "";
            opt.textContent = option?.label ?? option?.value ?? "";
            paymentStatusSelect.appendChild(opt);
          });
          paymentStatusField.appendChild(paymentStatusLabel);
          paymentStatusField.appendChild(paymentStatusSelect);
          headerSection.appendChild(paymentStatusField);

          paneElement.appendChild(headerSection);

          const notesField = document.createElement("div");
          notesField.className = "direct-expense__field direct-expense__field--wide";
          const notesLabel = document.createElement("label");
          notesLabel.setAttribute("for", "de-notes");
          notesLabel.textContent = "ملاحظات";
          const notesInput = document.createElement("textarea");
          notesInput.id = "de-notes";
          notesInput.rows = 3;
          notesField.appendChild(notesLabel);
          notesField.appendChild(notesInput);

          const attachmentsField = document.createElement("div");
          attachmentsField.className =
            "direct-expense__field direct-expense__field--attachments";
          const attachmentsLabel = document.createElement("label");
          attachmentsLabel.setAttribute("for", "de-attachments");
          attachmentsLabel.textContent = "المرفقات";
          const attachmentsControls = document.createElement("div");
          attachmentsControls.className = "direct-expense__attachments";
          const attachmentsInput = document.createElement("input");
          attachmentsInput.type = "file";
          attachmentsInput.id = "de-attachments";
          attachmentsInput.multiple = true;
          attachmentsInput.className = "direct-expense__file-input";
          attachmentsInput.style.display = "none";
          const attachmentsButton = document.createElement("label");
          attachmentsButton.className =
            "accent-button direct-expense__attachments-btn";
          attachmentsButton.setAttribute("for", "de-attachments");
          attachmentsButton.textContent = "إضافة مرفقات";
          attachmentsControls.appendChild(attachmentsInput);
          attachmentsControls.appendChild(attachmentsButton);
          const attachmentList = document.createElement("div");
          attachmentList.id = "de-attachment-list";
          attachmentList.className = "direct-expense__attachment-list";
          attachmentsField.appendChild(attachmentsLabel);
          attachmentsField.appendChild(attachmentsControls);
          attachmentsField.appendChild(attachmentList);

          metaSection.appendChild(notesField);
          metaSection.appendChild(attachmentsField);
          paneElement.appendChild(metaSection);

          const mainSection = document.createElement("div");
          mainSection.className = "direct-expense__main";

          const catalogContainer = document.createElement("div");
          catalogContainer.className = "direct-expense__catalog";
          const catalogTitle = document.createElement("h3");
          catalogTitle.textContent = "كتالوج المواد";
          const filtersWrapper = document.createElement("div");
          filtersWrapper.className = "direct-expense__filters";
          const searchInput = document.createElement("input");
          searchInput.type = "search";
          searchInput.id = "material-search";
          searchInput.placeholder = "ابحث عن مادة...";
          filtersWrapper.appendChild(searchInput);

          const categorySelect = document.createElement("select");
          categorySelect.id = "de-category-select";
          categorySelect.disabled = true;
          const categoryDefault = document.createElement("option");
          categoryDefault.value = "";
          categoryDefault.textContent = "جميع الفئات";
          categorySelect.appendChild(categoryDefault);
          filtersWrapper.appendChild(categorySelect);

          const subcategorySelect = document.createElement("select");
          subcategorySelect.id = "de-subcategory-select";
          subcategorySelect.disabled = true;
          const subcategoryDefault = document.createElement("option");
          subcategoryDefault.value = "";
          subcategoryDefault.textContent = "كل الأصناف الفرعية";
          subcategorySelect.appendChild(subcategoryDefault);
          filtersWrapper.appendChild(subcategorySelect);
          const materialsList = document.createElement("div");
          materialsList.id = "materials-list";
          materialsList.className = "direct-expense__materials-list";
          materialsList.innerHTML =
            '<p class="muted">جارٍ تحميل كتالوج المواد...</p>';
          catalogContainer.appendChild(catalogTitle);
          catalogContainer.appendChild(filtersWrapper);
          catalogContainer.appendChild(materialsList);

          const cartContainer = document.createElement("div");
          cartContainer.className = "direct-expense__cart";
          const cartTitle = document.createElement("h3");
          cartTitle.textContent = "سلة المشتريات";
          const cartItemsContainer = document.createElement("div");
          cartItemsContainer.className = "direct-expense__cart-items";
          const cartTotals = document.createElement("div");
          cartTotals.id = "cart-totals";
          cartTotals.className = "direct-expense__totals";
          // Live totals updater (no full re-render)
          function updateCartTotalsOnly() {
            try {
              const totalsBox = document.getElementById("cart-totals");
              if (!totalsBox) return;
              const strongs = totalsBox.querySelectorAll(".direct-expense__totals-row strong");
              if (strongs.length !== 3) return;
              let subtotal = 0, vatTotal = 0, grandTotal = 0;
              const defaultRate =
                Number(typeof VAT_RATE !== "undefined" ? VAT_RATE : 0.14) || 0.14;
              (cart || []).forEach((item) => {
                const quantity = Number(item?.quantity) || 0;
                const price = Number(item?.price ?? item?.unitPrice) || 0;
                const amount = quantity * price;
                const vatRate = item?.vatApplied
                  ? Number(item?.vatRate ?? item?.baseVatRate ?? defaultRate)
                  : 0;
                const vat = item?.vatApplied ? amount * vatRate : 0;
                subtotal += amount;
                vatTotal += vat;
                grandTotal += amount + vat;
              });
              strongs[0].textContent = formatCurrencyValue(subtotal);
              strongs[1].textContent = formatCurrencyValue(vatTotal);
              strongs[2].textContent = formatCurrencyValue(grandTotal);
            } catch (e) {
              console.warn("[updateCartTotalsOnly] failed", e);
            }
          }

          const vatToggleWrapper = document.createElement("label");
          vatToggleWrapper.className = "direct-expense__vat-toggle";
          vatToggleWrapper.setAttribute("for", "de-vat-toggle");
          const vatToggle = document.createElement("input");
          vatToggle.type = "checkbox";
          vatToggle.id = "de-vat-toggle";
          vatToggleWrapper.appendChild(vatToggle);
          const vatToggleText = document.createElement("span");
          vatToggleText.textContent = "تضمين ضريبة القيمة المضافة (Include VAT)";
          vatToggleWrapper.appendChild(vatToggleText);

          cartContainer.appendChild(cartTitle);
          cartContainer.appendChild(cartItemsContainer);
          cartContainer.appendChild(cartTotals);

          mainSection.appendChild(catalogContainer);
          mainSection.appendChild(cartContainer);
          paneElement.appendChild(mainSection);

          const footerSection = document.createElement("div");
          footerSection.className = "direct-expense__footer";

          const submitButton = document.createElement("button");
          submitButton.type = "button";
          submitButton.id = "submit-cart-btn";
          submitButton.className = "accent-button";
          submitButton.textContent = "حفظ المصروفات";
          footerSection.appendChild(submitButton);
          paneElement.appendChild(footerSection);

          const normalizeId = (material) =>
            material?.Material_ID ||
            material?.MaterialId ||
            material?.materialId ||
            material?.ID ||
            material?.id ||
            "";

          const toDecimalRate = (rate) => {
            let value = Number(rate);
            if (!Number.isFinite(value)) return null;
            if (value > 1) {
              value = value / 100;
            }
            if (value < 0) {
              return 0;
            }
            return value;
          };

          const hydrateMaterial = (material) => {
            if (Array.isArray(material)) {
              const [
                materialId,
                nameAr,
                nameEn,
                category,
                subcategory,
                defaultUnit,
                defaultPrice,
                vatRate,
              ] = material;
              return {
                Material_ID: materialId,
                Name_AR: nameAr || nameEn || materialId,
                Name_EN: nameEn || nameAr || materialId,
                Category: category || "",
                Subcategory: subcategory || "",
                Default_Unit: defaultUnit || "",
                Default_Price: Number(defaultPrice) || 0,
                VAT_Rate: toDecimalRate(vatRate) ?? VAT_RATE,
              };
            }
            const hydratedId = normalizeId(material);
            const decimalRate = toDecimalRate(
              material?.VAT_Rate ??
                material?.Default_VAT ??
                material?.vatRate ??
                material?.VatRate
            );
            return {
              Material_ID: hydratedId,
              Name_AR:
                material?.Name_AR ||
                material?.Material_Name_AR ||
                material?.Material_Name ||
                material?.Name ||
                hydratedId,
              Name_EN:
                material?.Name_EN ||
                material?.Material_Name_EN ||
                material?.MaterialName ||
                material?.Name ||
                hydratedId,
              Category:
                material?.Category ||
                material?.Category_Name ||
                material?.Material_Category ||
                "",
              Subcategory:
                material?.Subcategory ||
                material?.Sub_Category ||
                material?.Material_Subcategory ||
                "",
              Default_Unit:
                material?.Default_Unit ||
                material?.Unit ||
                material?.Unit_Name ||
                "",
              Default_Price:
                Number(
                  material?.Default_Price ??
                    material?.Unit_Price ??
                    material?.UnitPrice ??
                    material?.Price
                ) || 0,
              VAT_Rate: decimalRate ?? VAT_RATE,
            };
          };

          function populateMaterialsList(materials) {
            materialsList.innerHTML = "";
            const list = Array.isArray(materials)
              ? materials.map(hydrateMaterial)
              : [];

            if (!list.length) {
              const empty = document.createElement("p");
              empty.className = "direct-expense__empty";
              empty.textContent = "لا توجد مواد متاحة.";
              materialsList.appendChild(empty);
              return;
            }

            list.forEach((material) => {
              const materialId = normalizeId(material);
              const displayName =
                material?.Name_AR ||
                material?.Name_EN ||
                materialId ||
                "";
              const card = document.createElement("div");
              card.className = "direct-expense__material-card";
              card.tabIndex = 0;
              card.setAttribute("role", "button");
              card.setAttribute(
                "aria-label",
                `إضافة المادة ${displayName || "مادة"}`
              );

              const idBadge = document.createElement("span");
              idBadge.className = "direct-expense__material-id";
              idBadge.textContent = materialId ? `#${materialId}` : "—";
              card.appendChild(idBadge);

              const title = document.createElement("strong");
              title.className = "direct-expense__material-name";
              title.textContent = displayName || "مادة";
              card.appendChild(title);

              const unitPrice =
                Number(
                  material?.Default_Price ||
                    material?.Unit_Price ||
                    material?.UnitPrice ||
                    0
                ) || 0;
              const priceSpan = document.createElement("span");
              priceSpan.className = "direct-expense__material-price";
              priceSpan.textContent = `السعر: ${formatCurrencyValue(unitPrice)}`;
              card.appendChild(priceSpan);

              const triggerAddToCart = () => {
                if (!materialId) {
                  if (typeof showToast === "function") {
                    showToast(
                      "لا يمكن إضافة مادة بدون معرف صالح.",
                      "warning"
                    );
                  }
                  return;
                }
                addToCart(materialId);
              };
              card.addEventListener("click", triggerAddToCart);
              card.addEventListener("keydown", (event) => {
                if (event.key === "Enter" || event.key === " ") {
                  event.preventDefault();
                  triggerAddToCart();
                }
              });
              materialsList.appendChild(card);
            });
          }

          function getUniqueValues(list, key) {
            return Array.from(
              new Set(
                list
                  .map((item) => String(item?.[key] || "").trim())
                  .filter(Boolean)
              )
            ).sort((a, b) => a.localeCompare(b, "ar", { sensitivity: "base" }));
          }

          function populateSubcategoryOptions(category) {
            if (!materialsCatalogLoaded || !Array.isArray(materialsCatalog)) {
              subcategorySelect.innerHTML = "";
              const defaultOption = document.createElement("option");
              defaultOption.value = "";
              defaultOption.textContent = "كل الأصناف الفرعية";
              subcategorySelect.appendChild(defaultOption);
              subcategorySelect.disabled = true;
              return;
            }
            const relevant = category
              ? materialsCatalog.filter(
                  (item) => String(item?.Category || "") === category
                )
              : materialsCatalog;
            const subcategories = getUniqueValues(relevant, "Subcategory");
            subcategorySelect.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "كل الأصناف الفرعية";
            subcategorySelect.appendChild(defaultOption);
            subcategories.forEach((subcategory) => {
              const option = document.createElement("option");
              option.value = subcategory;
              option.textContent = subcategory;
              subcategorySelect.appendChild(option);
            });
            const enableSub = Boolean(category) && subcategories.length > 0;
            if (!enableSub) {
              selectedSubcategory = "";
              subcategorySelect.value = "";
            } else if (
              selectedSubcategory &&
              !subcategories.includes(selectedSubcategory)
            ) {
              selectedSubcategory = "";
            }
            if (selectedSubcategory) {
              subcategorySelect.value = selectedSubcategory;
            }
            subcategorySelect.disabled = !enableSub;
          }

          function populateCategoryOptions() {
            if (!materialsCatalogLoaded || !Array.isArray(materialsCatalog)) {
              categorySelect.innerHTML = "";
              const defaultOption = document.createElement("option");
              defaultOption.value = "";
              defaultOption.textContent = "جميع الفئات";
              categorySelect.appendChild(defaultOption);
              categorySelect.disabled = true;
              subcategorySelect.disabled = true;
              return;
            }
            const categories = getUniqueValues(materialsCatalog, "Category");
            if (selectedCategory && !categories.includes(selectedCategory)) {
              selectedCategory = "";
            }
            categorySelect.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "جميع الفئات";
            categorySelect.appendChild(defaultOption);
            categories.forEach((category) => {
              const option = document.createElement("option");
              option.value = category;
              option.textContent = category;
              categorySelect.appendChild(option);
            });
            categorySelect.disabled = categories.length === 0;
            if (selectedCategory) {
              categorySelect.value = selectedCategory;
            }
            populateSubcategoryOptions(selectedCategory);
          }

          function applyMaterialFilters() {
            if (!materialsCatalogLoaded || !Array.isArray(materialsCatalog)) {
              return [];
            }
            if (!materialsCatalog.length) {
              populateMaterialsList([]);
              return [];
            }
            const term = String(searchInput.value || "").trim().toLowerCase();
            const filtered = materialsCatalog.filter((material) => {
              const categoryValue = String(material?.Category || "").trim();
              if (selectedCategory && categoryValue !== selectedCategory) {
                return false;
              }
              const subcategoryValue = String(material?.Subcategory || "").trim();
              if (
                selectedSubcategory &&
                subcategoryValue !== selectedSubcategory
              ) {
                return false;
              }
              if (!term) {
                return true;
              }
              const haystack = [
                normalizeId(material),
                material?.Name_AR,
                material?.Name_EN,
                material?.Category,
                material?.Subcategory,
              ]
                .filter(Boolean)
                .map((value) => String(value).toLowerCase());
              return haystack.some((value) => value.includes(term));
            });
            populateMaterialsList(filtered);
            return filtered;
          }

          function renderAttachmentList() {
            attachmentList.innerHTML = "";
            if (!attachments.length) {
              const emptyAttachment = document.createElement("p");
              emptyAttachment.className = "direct-expense__empty";
              emptyAttachment.textContent = "لم يتم اختيار مرفقات بعد.";
              attachmentList.appendChild(emptyAttachment);
              return;
            }
            attachments.forEach((attachment, index) => {
              const item = document.createElement("div");
              item.className = "direct-expense__attachment-item";
              const nameSpan = document.createElement("span");
              nameSpan.textContent = attachment.file.name;
              item.appendChild(nameSpan);
              const labelInput = attachment.labelInput;
              labelInput.type = "text";
              labelInput.classList.add("direct-expense__attachment-label");
              if (!labelInput.placeholder) {
                labelInput.placeholder = "أدخل اسمًا للمرفق";
              }
              labelInput.dataset.attachmentIndex = index;
              item.appendChild(labelInput);
              attachmentList.appendChild(item);
            });
          }

          function addToCart(materialId) {
            const material = materialsCatalog.find(
              (item) => String(normalizeId(item)) === String(materialId)
            );
            if (!material) {
              showToast("تعذر العثور على المادة المحددة.", "error");
              return;
            }

            const defaultPrice =
              Number(
                material.Default_Price ||
                  material.Unit_Price ||
                  material.UnitPrice ||
                  0
              ) || 0;
            const baseVatRate =
              toDecimalRate(material.VAT_Rate) ?? VAT_RATE;

            const existing = cart.find(
              (item) => String(item.materialId) === String(materialId)
            );

            if (existing) {
              existing.quantity += 1;
              existing.baseVatRate = baseVatRate;
            } else {
              const name =
                material.Name_AR ||
                material.Name_EN ||
                String(materialId);
              const unit = material.Default_Unit || "";
              const category = material.Category || "";
              const subcategory = material.Subcategory || "";
              const price = defaultPrice;
              const quantity = 1;
              const effectiveVatRate = isVatEnabled ? baseVatRate : 0;
              const subtotal = quantity * price;
              const vatAmount = subtotal * effectiveVatRate;
              const totalWithVat = subtotal + vatAmount;

              cart.push({
                materialId: String(materialId),
                name,
                materialName: name,
                category,
                subcategory,
                unit,
                price,
                unitPrice: price,
                quantity,
                baseVatRate,
                vatRate: effectiveVatRate,
                vatApplied: isVatEnabled,
                subtotal,
                amount: subtotal,
                vatAmount,
                total: totalWithVat,
                totalWithVat,
              });
            }

            renderCart();
          }

          function renderCart() {
            const previousScrollTop = window.scrollY;
            cartItemsContainer.innerHTML = "";
            cartTotals.innerHTML = "";

            vatToggle.checked = isVatEnabled;
            vatToggle.disabled = cart.length === 0;
            cartTotals.appendChild(vatToggleWrapper);

            let subtotal = 0;
            let vatTotal = 0;
            let grandTotal = 0;

            if (!cart.length) {
              const emptyCart = document.createElement("p");
              emptyCart.className = "direct-expense__empty";
              emptyCart.textContent = "لم يتم إضافة أي عناصر بعد.";
              cartItemsContainer.appendChild(emptyCart);
            } else {
              const table = document.createElement("table");
              table.id = "cart-items-table";
              const thead = document.createElement("thead");
              const headRow = document.createElement("tr");
              [
                "المادة",
                "الكمية",
                "السعر",
                "الوحدة",
                "الأجمالي",
                "",
              ].forEach((label) => {
                const th = document.createElement("th");
                th.textContent = label;
                headRow.appendChild(th);
              });
              thead.appendChild(headRow);
              table.appendChild(thead);

              const tbody = document.createElement("tbody");

              cart.forEach((item, index) => {
                const quantity = Number(item.quantity) || 0;
                const price = Number(item.price ?? item.unitPrice) || 0;
                const baseRate = Number.isFinite(item.baseVatRate)
                  ? Number(item.baseVatRate)
                  : VAT_RATE;
                const effectiveVatRate = isVatEnabled ? baseRate : 0;

                item.baseVatRate = baseRate;

                const rowSubtotal = quantity * price;
                const rowVatAmount = rowSubtotal * effectiveVatRate;
                const rowTotal = rowSubtotal + rowVatAmount;

                item.quantity = quantity;
                item.price = price;
                item.unitPrice = price;
                item.subtotal = rowSubtotal;
                item.amount = rowSubtotal;
                item.vatAmount = rowVatAmount;
                item.total = rowTotal;
                item.totalWithVat = rowTotal;
                item.vatRate = effectiveVatRate;
                item.vatApplied = isVatEnabled;

                subtotal += rowSubtotal;
                vatTotal += rowVatAmount;
                grandTotal += rowTotal;

                const row = document.createElement("tr");
                row.dataset.index = String(index);

                const nameCell = document.createElement("td");
                nameCell.textContent =
                  item.name || item.materialName || item.materialId || "—";
                row.appendChild(nameCell);

                const quantityCell = document.createElement("td");
                const qtyInput = document.createElement("input");
                qtyInput.type = "number";
                qtyInput.min = "0";
                qtyInput.step = "0.01";
                qtyInput.value = quantity.toString();
                qtyInput.dataset.field = "quantity";
                const handleQuantityChange = () => {
                  const value = Number(qtyInput.value);
                  const resolved =
                    Number.isFinite(value) && value > 0 ? value : 1;
                  item.quantity = resolved;
                  renderCart();
                };
                qtyInput.addEventListener("input", () => {
                  const value = Number(qtyInput.value);
                  const resolved =
                    Number.isFinite(value) && value > 0 ? value : 1;
                  item.quantity = resolved;
                  updateCartTotalsOnly();
                });
                qtyInput.addEventListener("change", handleQuantityChange);
                quantityCell.appendChild(qtyInput);
                row.appendChild(quantityCell);

                const priceCell = document.createElement("td");
                const priceInput = document.createElement("input");
                priceInput.type = "number";
                priceInput.min = "0";
                priceInput.step = "0.01";
                priceInput.value = price.toString();
                priceInput.dataset.field = "price";
                const handlePriceChange = () => {
                  const value = Number(priceInput.value);
                  const resolved =
                    Number.isFinite(value) && value >= 0 ? value : 0;
                  item.price = resolved;
                  item.unitPrice = resolved;
                  renderCart();
                };
                priceInput.addEventListener("input", () => {
                  const value = Number(priceInput.value);
                  const resolved =
                    Number.isFinite(value) && value >= 0 ? value : 0;
                  item.price = resolved;
                  item.unitPrice = resolved;
                  updateCartTotalsOnly();
                });
                priceInput.addEventListener("change", handlePriceChange);
                priceCell.appendChild(priceInput);
                row.appendChild(priceCell);

                const unitCell = document.createElement("td");
                unitCell.textContent = item.unit || "—";
                row.appendChild(unitCell);

                const totalCell = document.createElement("td");
                totalCell.textContent = formatCurrencyValue(rowTotal);
                totalCell.dataset.field = "total";
                row.appendChild(totalCell);

                const actionsCell = document.createElement("td");
                const removeButton = document.createElement("button");
                removeButton.type = "button";
                removeButton.className = "direct-expense__remove-btn";
                removeButton.textContent = "حذف";
                removeButton.addEventListener("click", () => {
                  cart.splice(index, 1);
                  renderCart();
                });
                actionsCell.appendChild(removeButton);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
              });

              table.appendChild(tbody);
              cartItemsContainer.appendChild(table);
            }

            const totalsConfig = [
              { label: "الإجمالي قبل الضريبة", value: subtotal },
              { label: "ضريبة القيمة المضافة", value: vatTotal },
              { label: "الإجمالي الكلي", value: grandTotal },
            ];

            totalsConfig.forEach(({ label, value }) => {
              const row = document.createElement("div");
              row.className = "direct-expense__totals-row";
              const labelSpan = document.createElement("span");
              labelSpan.textContent = label;
              const valueSpan = document.createElement("strong");
              valueSpan.textContent = formatCurrencyValue(value);
              row.appendChild(labelSpan);
              row.appendChild(valueSpan);
              cartTotals.appendChild(row);
            });

            window.scrollTo({ top: previousScrollTop });
          }

          function recomputeRowAndTotals(rootElement, items) {
            if (!rootElement) return;
            const table = rootElement.querySelector(
              ".direct-expense__cart-items table"
            );
            const totalsBox = rootElement.querySelector("#cart-totals");
            if (!table || !totalsBox) return;

            let subtotal = 0;
            let vatTotal = 0;
            let grandTotal = 0;

            table.querySelectorAll("tbody tr").forEach((row) => {
              const index = Number(row.dataset.index);
              if (!Number.isFinite(index) || index < 0 || index >= items.length) {
                return;
              }

              const currentItem = items[index];
              if (!currentItem) return;

              const priceInputEl = row.querySelector('input[data-field="price"]');
              const qtyInputEl = row.querySelector('input[data-field="quantity"]');

              const priceValue = Number(priceInputEl?.value);
              const qtyValue = Number(qtyInputEl?.value);

              const price =
                Number.isFinite(priceValue) && priceValue >= 0 ? priceValue : 0;
              const quantity =
                Number.isFinite(qtyValue) && qtyValue > 0 ? qtyValue : 1;

              const baseRate = Number.isFinite(currentItem.baseVatRate)
                ? Number(currentItem.baseVatRate)
                : VAT_RATE;
              const effectiveVatRate = isVatEnabled ? baseRate : 0;

              currentItem.price = price;
              currentItem.unitPrice = price;
              currentItem.quantity = quantity;
              currentItem.vatApplied = isVatEnabled;
              currentItem.vatRate = effectiveVatRate;

              const amount = quantity * price;
              const vatAmount = amount * effectiveVatRate;
              const totalWithVat = amount + vatAmount;

              currentItem.subtotal = amount;
              currentItem.amount = amount;
              currentItem.vatAmount = vatAmount;
              currentItem.total = totalWithVat;
              currentItem.totalWithVat = totalWithVat;

              subtotal += amount;
              vatTotal += vatAmount;
              grandTotal += totalWithVat;

              const totalCell = row.querySelector('[data-field="total"]');
              if (totalCell)
                totalCell.textContent = formatCurrencyValue(totalWithVat);
            });

            const totalsRows = totalsBox.querySelectorAll(
              ".direct-expense__totals-row strong"
            );
            if (totalsRows.length >= 3) {
              totalsRows[0].textContent = formatCurrencyValue(subtotal);
              totalsRows[1].textContent = formatCurrencyValue(vatTotal);
              totalsRows[2].textContent = formatCurrencyValue(grandTotal);
            }
          }

          cartItemsContainer.addEventListener("input", (event) => {
            const input = event.target;
            if (!(input instanceof HTMLInputElement)) return;
            if (input.type !== "number") return;
            const field = input.dataset.field;
            if (field !== "price" && field !== "quantity") return;

            const row = input.closest("tr");
            if (!row) return;
            const index = Number(row.dataset.index);
            if (!Number.isFinite(index) || index < 0 || index >= cart.length) {
              return;
            }

            const value = Number(input.value);
            if (field === "price") {
              const resolved =
                Number.isFinite(value) && value >= 0 ? value : 0;
              cart[index].price = resolved;
              cart[index].unitPrice = resolved;
            } else if (field === "quantity") {
              cart[index].quantity =
                Number.isFinite(value) && value > 0 ? value : 1;
            }

            recomputeRowAndTotals(paneElement, cart);
          });

          cartItemsContainer.addEventListener("change", (event) => {
            const input = event.target;
            if (!(input instanceof HTMLInputElement)) return;
            if (input.type !== "number") return;
            const field = input.dataset.field;
            if (field !== "price" && field !== "quantity") return;

            const row = input.closest("tr");
            if (!row) return;
            const index = Number(row.dataset.index);
            if (!Number.isFinite(index) || index < 0 || index >= cart.length) {
              return;
            }

            const scrollTopBeforeRender = window.scrollY;
            renderCart();
            window.scrollTo({ top: scrollTopBeforeRender });
          });

          searchInput.addEventListener("input", () => {
            if (!materialsCatalogLoaded) return;
            applyMaterialFilters();
          });

          searchInput.addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
            }
          });

          categorySelect.addEventListener("change", () => {
            if (!materialsCatalogLoaded) return;
            selectedCategory = categorySelect.value;
            selectedSubcategory = "";
            subcategorySelect.value = "";
            populateSubcategoryOptions(selectedCategory);
            applyMaterialFilters();
          });

          subcategorySelect.addEventListener("change", () => {
            if (!materialsCatalogLoaded) return;
            selectedSubcategory = subcategorySelect.value;
            applyMaterialFilters();
          });

          
          vatToggle.addEventListener("change", () => {
            isVatEnabled = vatToggle.checked;
            cart.forEach((item) => { item.vatApplied = isVatEnabled; });
            const y = window.scrollY;
            renderCart();
            window.scrollTo({ top: y });
          });


          attachmentsInput.addEventListener("change", (event) => {
            const files = Array.from(event.target.files || []);
            files.forEach((file) => {
              const exists = attachments.some(
                (attachment) =>
                  attachment.file.name === file.name &&
                  attachment.file.size === file.size &&
                  attachment.file.lastModified === file.lastModified
              );
              if (exists) {
                return;
              }
              const labelInput = document.createElement("input");
              labelInput.type = "text";
              labelInput.className = "direct-expense__attachment-label";
              const defaultLabel = file.name.replace(/\.[^.]+$/, "").trim();
              if (defaultLabel) {
                labelInput.value = defaultLabel;
              }
              labelInput.placeholder = "أدخل اسمًا للمرفق";
              attachments.push({ file, labelInput });
            });
            attachmentsInput.value = "";
            renderAttachmentList();
          });

          renderCart();
          renderAttachmentList();

          if (!(window.google && google.script && google.script.run)) {
            materialsList.innerHTML =
              '<p class="error-text">خدمة Google Apps Script غير متاحة.</p>';
            return;
          }

          google.script.run
            .withFailureHandler((err) => {
              console.error("getMaterialsCatalog failed", err);
              materialsCatalog = [];
              materialsCatalogLoaded = false;
              materialsList.innerHTML =
                '<p class="error-text">تعذر تحميل كتالوج المواد.</p>';
              populateCategoryOptions();
              showToast("تعذر تحميل كتالوج المواد.", "error");
            })
            .withSuccessHandler((result) => {
              const source = Array.isArray(result) ? result : [];
              materialsCatalog = source.map(hydrateMaterial);
              materialsCatalogLoaded = true;
              populateCategoryOptions();
              populateMaterialsList(materialsCatalog);
              if (
                String(searchInput.value || "").trim() ||
                selectedCategory ||
                selectedSubcategory
              ) {
                applyMaterialFilters();
              }
            })
            .getMaterialsCatalog();

          google.script.run
            .withFailureHandler((err) => {
              console.error("getProjectsForDropdown failed", err);
              showToast("تعذر تحميل المشاريع.", "warning");
            })
            .withSuccessHandler((projects) => {
              const list = Array.isArray(projects) ? projects : [];
              list.forEach((project) => {
                const option = document.createElement("option");
                option.value =
                  project?.Project_ID ||
                  project?.projectId ||
                  project?.value ||
                  "";
                option.textContent =
                  project?.Project_Name ||
                  project?.projectName ||
                  project?.label ||
                  option.value;
                projectSelect.appendChild(option);
              });
            })
            .getProjectsForDropdown();

          submitButton.addEventListener("click", () => {
            if (!cart.length) {
              showToast("أضف مادة واحدة على الأقل قبل الحفظ.", "warning");
              return;
            }

            if (!projectSelect.value) {
              showToast("يرجى اختيار المشروع.", "warning");
              projectSelect.focus();
              return;
            }

            if (!dateInput.value) {
              showToast("يرجى اختيار التاريخ.", "warning");
              dateInput.focus();
              return;
            }

            const invalidItem = cart.some(
              (item) =>
                !Number.isFinite(item.quantity) ||
                item.quantity <= 0 ||
                !Number.isFinite(item.price ?? item.unitPrice) ||
                (item.price ?? item.unitPrice) < 0
            );
            if (invalidItem) {
              showToast("يرجى التحقق من الكميات والأسعار في السلة.", "warning");
              return;
            }

            if (!(window.google && google.script && google.script.run)) {
              showToast("خدمة الخادم غير متاحة.", "error");
              return;
            }

            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = "جاري الحفظ...";

            const payload = {
              header: {
                project: projectSelect.value,
                date: dateInput.value,
                vatIncluded: isVatEnabled,
                paymentMethod: paymentMethodSelect.value || "",
                paymentStatus: paymentStatusSelect.value || "",
                notes: notesInput.value.trim(),
              },
              items: cart.map((item) => ({
                materialId: item.materialId,
                materialName: item.name || item.materialName || "",
                category: item.category,
                subcategory: item.subcategory,
                unit: item.unit,
                quantity: item.quantity,
                unitPrice: item.price ?? item.unitPrice,
                amount: item.amount ?? item.subtotal,
                vatRate: item.vatRate,
                vatAmount: item.vatAmount,
                totalWithVat: item.totalWithVat ?? item.total,
                vatApplied: item.vatApplied,
              })),
              attachments: attachments.map((attachment) => ({
                name: attachment.file.name,
                size: attachment.file.size,
                type: attachment.file.type,
                label: attachment.labelInput.value.trim(),
                lastModified: attachment.file.lastModified,
              })),
            };

            google.script.run
              .withFailureHandler((err) => {
                console.error("saveDirectExpenses failed", err);
                showToast("تعذر حفظ المصروفات.", "error");
                submitButton.disabled = false;
                submitButton.textContent = originalText;
              })
              .withSuccessHandler((response) => {
                if (response && response.success) {
                  cart = [];
                  renderCart();
                  attachments = [];
                  attachmentsInput.value = "";
                  renderAttachmentList();
                  showToast(
                    response.message || "تم حفظ المصروفات بنجاح.",
                    "success"
                  );
                  if (typeof onSaved === "function") {
                    try {
                      onSaved(response);
                    } catch (callbackError) {
                      console.error("onSaved callback failed", callbackError);
                    }
                  }
                } else {
                  showToast(
                    (response && response.message) ||
                      "تعذر حفظ المصروفات.",
                    "error"
                  );
                }
                submitButton.disabled = false;
                submitButton.textContent = originalText;
              })
              .saveDirectExpenses(payload);
          });
        }

        function markTableLoaded(key, value) {
          if (!key) return;
          tableLoadState[key] = !!value;
        }

        function isTableLoaded(key) {
          return !!tableLoadState[key];
        }

        function resetTableLoadState() {
          Object.keys(tableLoadState).forEach((key) => {
            tableLoadState[key] = false;
          });
        }

        /* Bootstrap (server) */
        function applyBootstrap(data) {
          console.log("Bootstrap data received:", data);
          bootstrapData = Object.assign({}, data || {});
          overviewLoaded = false;
          resetTableLoadState();
          selectedUsers.clear();
          normalizedUsersCache = [];
          renderNav(data?.nav || []);
          // Restore module cards grid rendering after login bootstrap
          renderModuleGrid(data?.nav || []);
          renderSysNav(
            data?.tabRegister ||
              data?.tabs ||
              data?.tabRegistry ||
              data?.tabConfig ||
              undefined
          );
          const identityFromServer =
            data?.user &&
            (data.user.Full_Name || data.user.Username || data.user.Email)
              ? data.user
              : null;
          const displayName =
            data?.user?.Full_Name || data?.user?.Username || "User";
          const identityToUse = identityFromServer || lastLoginIdentity || displayName;
          updateUserContext(identityToUse);
          // Fill filter selects if server sent lists
          if (data?.filters) {
            fillSelect(selDept, data.filters.departments);
            fillSelect(selRole, data.filters.roles);
            fillSelect(
              bulkRoleSelect,
              data.filters.roleOptions || data.filters.roles
            );
            bulkRoleSelect.disabled = !(
              (data.filters.roleOptions || data.filters.roles || []).length > 0
            );
          } else {
            // Try lazy fetch
            if (window.google && google.script && google.script.run) {
              google.script.run
                .withSuccessHandler((f) => {
                  console.log("Department and role filters received:", f);
                  fillSelect(selDept, f?.departments || []);
                  fillSelect(selRole, f?.roles || []);
                  fillSelect(bulkRoleSelect, f?.roleOptions || f?.roles || []);
                  bulkRoleSelect.disabled = !(f?.roleOptions || f?.roles || [])
                    ?.length;
                })
                .getDeptAndRoleFilters();
            }
          }
          fetchKPIs();
          loadUsers(); // prefetch for smoother UX
          syncBulkActionsState();
        }
        function fillSelect(selectEl, arr) {
          if (!selectEl) return;
          const keepFirst = selectEl.querySelector("option");
          selectEl.innerHTML = keepFirst ? keepFirst.outerHTML : "";
          (arr || []).forEach((item) => {
            const option = document.createElement("option");
            if (item && typeof item === "object") {
              option.value = item.value ?? item.label ?? "";
              option.textContent = item.label ?? item.value ?? "";
            } else {
              option.value = item;
              option.textContent = item;
            }
            selectEl.appendChild(option);
          });
        }
        function handleServerResponse(result, onSuccess) {
          if (result && typeof result === "object" && result.error) {
            console.error("Backend error:", result.message);
            alert("Error: " + (result.message || "Unknown error"));
            return;
          }
          if (typeof onSuccess === "function") {
            onSuccess(result);
          }
        }

        function bootstrapApp() {
          if (!(window.google && google.script && google.script.run)) {
            console.warn("Apps Script runtime not available.");
            return;
          }
          google.script.run
            .withFailureHandler((err) => console.error("Bootstrap failed", err))
            .withSuccessHandler(applyBootstrap)
            .getBootstrapData();
        }

        /* Login */
        const loginForm = document.getElementById("login-form");
        const loginBtn = document.getElementById("login-button");
        if (loginForm) {
          loginForm.addEventListener("submit", (e) => {
            e.preventDefault();
            if (!(window.google && google.script && google.script.run)) {
              console.warn("[CLIENT] Login attempt without Apps Script runtime");
              showToast("الخادم غير متصل حاليًا.", "error", "خطأ");
              return;
          }

          const usernameInput = document.getElementById("username");
          const passwordInput = document.getElementById("password");
          const username = (usernameInput?.value || "").trim();
          const password = passwordInput?.value || "";

          if (!username || !password) {
            showToast("يرجى إدخال بيانات الدخول كاملة.", "info");
            return;
          }

          if (loginBtn) loginBtn.classList.add("loading");
          console.log("[CLIENT] Login attempt for:", username);

          google.script.run
            .withFailureHandler((err) => {
              if (loginBtn) loginBtn.classList.remove("loading");
              console.error("[CLIENT] Login failed:", err);
              showToast("تعذر الاتصال بالخادم.", "error", "خطأ");
            })
            .withSuccessHandler((res) => {
              if (loginBtn) loginBtn.classList.remove("loading");
              console.log("[CLIENT] Login response received:", res);
              try {
                console.log("[CLIENT] Evaluating login response success flag...");
                if (!res || res.success !== true) {
                  const messageFromServer =
                    res?.message ||
                    "بيانات الدخول غير صحيحة أو حدث خطأ غير متوقع.";
                  console.warn(
                    "[CLIENT] Login response indicates failure:",
                    messageFromServer,
                    res
                  );
                  showToast(messageFromServer, "error", "فشل تسجيل الدخول");
                  return;
                }

                console.log("[CLIENT] Login response marked success. Extracting bootstrap data...");
                const data = res.bootstrap || {};
                console.log(
                  "[CLIENT] Bootstrap payload keys:",
                  Object.keys(data || {})
                );
                const identity =
                  res.user || data.user || {
                    Username: username,
                  };
                console.log("[CLIENT] Resolved login identity:", identity);
                lastLoginIdentity = identity;
                navbar.classList.remove("hidden");
                console.log("[CLIENT] Applying bootstrap data to UI...");
                applyBootstrap(data);
                console.log("[CLIENT] Bootstrap applied. Switching to portal view...");
                switchView("portal-view");
                console.log("[CLIENT] Displaying success toast.");
                showToast("تم تسجيل الدخول بنجاح.", "success", "تم الدخول");
              } catch (handlerError) {
                console.error(
                  "[CLIENT] Exception while handling successful login response:",
                  handlerError,
                  res
                );
                showToast(
                  "حدث خطأ غير متوقع بعد تسجيل الدخول.",
                  "error",
                  "خطأ"
                );
              }
            })
            .authenticateUser({
              username,
              password,
            });
          });
        }

        /* Top nav clicks */
        navbar.addEventListener("click", (e) => {
          const btn = e.target.closest(".nav-btn[data-target]");
          if (!btn) return;
          e.preventDefault();
          switchView(btn.dataset.target);
        });

        /* Card clicks */
        document.querySelectorAll(".module-card").forEach((card) => {
          card.addEventListener("click", () =>
            switchView(card.getAttribute("data-workspace"))
          );
        });

        /* Back-to-portal */
        document.querySelectorAll('[data-go="portal-view"]').forEach((btn) => {
          btn.addEventListener("click", () => switchView("portal-view"));
        });

        /* Logout */
        document
          .getElementById("logout-button")
          .addEventListener("click", () => {
            navbar.classList.add("hidden");
            userLabel.textContent = "";
            const welcome = document.getElementById("portal-welcome-message");
            if (welcome) welcome.textContent = "";
            bootstrapData = {};
            lastLoginIdentity = null;
            overviewLoaded = false;
            resetTableLoadState();
            selectedUsers.clear();
            normalizedUsersCache = [];
            profileDataCache = null;
            currentProfileUserId = null;
            renderNav();
            renderModuleGrid();
            switchView("login-screen");
            showToast("You have been signed out.", "info", "Logged Out");
          });

        /* ---------- KPIs ---------- */
        function fetchKPIs() {
          if (!(window.google && google.script && google.script.run)) return;
          google.script.run
            .withFailureHandler(() => {})
            .withSuccessHandler((k) => {
              console.log("System KPIs received:", k);
              if (!k) return;
              const $ = (id) => document.getElementById(id);
              $("kpi-total-users").textContent = k.totalUsers ?? "—";
              $("kpi-active-users").textContent = k.activeUsers ?? "—";
              $("kpi-inactive-users").textContent = k.inactiveUsers ?? "—";
              $("kpi-role-count").textContent = k.roleCount ?? "—";
              $("kpi-permission-count").textContent = k.permissionCount ?? "—";
              $("kpi-pending-resets").textContent =
                k.pendingPasswordResets ?? "—";
              overviewLoaded = true;
            })
            .getSystemKPIs();
        }

        function currentFilters() {
          return {
            search: (txtSearch.value || "").trim(),
            department: selDept.value || "",
            role: selRole.value || "",
            status: selStatus.value || "",
            updatedFrom: dtUpdatedFrom.value || "",
            updatedTo: dtUpdatedTo.value || "",
          };
        }

        let usersReqTimer = null;
        function loadUsers({ force } = {}) {
          console.log("[CLIENT] loadUsers called with force:", force);
          if (!(window.google && google.script && google.script.run)) {
            console.error("[CLIENT] Apps Script runtime not available");
            usersTbody.innerHTML =
              '<tr><td colspan="11" class="muted">غير متصل بالخادم.</td></tr>';
            selectedUsers.clear();
            syncSelectAllState();
            syncBulkActionsState();
            return;
          }
          if (force) {
            selectedUsers.clear();
            syncSelectAllState();
            syncBulkActionsState();
          }
          usersTbody.innerHTML =
            '<tr><td colspan="11" class="muted">جاري التحميل…</td></tr>';
          const filters = currentFilters();
          console.log("[CLIENT] Requesting users with filters:", filters);
          // watchdog in case server throws silently
          clearTimeout(usersReqTimer);
          usersReqTimer = setTimeout(() => {
            const stillLoading =
              usersTbody.textContent.includes("جاري التحميل");
            if (stillLoading) {
              console.warn("[CLIENT] User loading timeout after 8s");
              usersTbody.innerHTML =
                '<tr><td colspan="11" class="muted">تعذر التحميل.</td></tr>';
            }
            if (stillLoading) {
              selectedUsers.clear();
              syncSelectAllState();
              syncBulkActionsState();
            }
          }, 8000);
          google.script.run
            .withFailureHandler((err) => {
              clearTimeout(usersReqTimer);
              console.error("[CLIENT] searchUsers failed:", err);
              usersTbody.innerHTML =
                '<tr><td colspan="11" class="error-text">خطأ: ' +
                (err.message || err) +
                "</td></tr>";
              selectedUsers.clear();
              syncSelectAllState();
              syncBulkActionsState();
            })
            .withSuccessHandler((result) => {
              clearTimeout(usersReqTimer);
              handleServerResponse(result, (users) => {
                console.log("Users received from server:", users);
                console.log(
                  "[CLIENT] User list received, count:",
                  Array.isArray(users) ? users.length : 0
                );
                console.log("[CLIENT] User list data:", users);
                renderUsers(users);
              });
            })
            .searchUsers(filters);
        }

        // تفويض أحداث الجدول
        if (usersTable) {
          usersTable.addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-act]");
            if (!btn) return;
            const act = btn.dataset.act;
            const userId = btn.dataset.id;
            if (!userId) return;
            if (!(window.google && google.script && google.script.run)) {
              showToast("غير متصل بالخادم.", "error");
              return;
            }

            if (act === "reset") {
              resetUserId = userId;
              formReset.reset();
              dlgReset.showModal();
            } else if (act === "toggle") {
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("تعذر تغيير حالة الحساب.", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Toggle user active response:", res);
                  showToast("تم تحديث الحالة.", "success");
                  loadUsers();
                })
                .toggleUserActive(userId);
            } else if (act === "edit") {
              openUserEditor(userId);
            } else if (act === "view") {
              openUserProfile(userId, "profile");
            } else if (act === "audit") {
              openUserProfile(userId, "audit");
            } else if (act === "assign") {
              openAssignRoleDialog(userId);
            } else if (act === "docs") {
              openUserProfile(userId, "documents");
            } else if (act === "impersonate") {
              startImpersonationFlow(userId);
            } else if (act === "delete") {
              performSoftDelete(userId);
            }
          });

          usersTable.addEventListener("change", (e) => {
            const checkbox = e.target.closest(".row-select");
            if (!checkbox) return;
            const userId = checkbox.dataset.id;
            if (!userId) return;
            if (checkbox.checked) {
              selectedUsers.add(userId);
            } else {
              selectedUsers.delete(userId);
            }
            syncSelectAllState();
            syncBulkActionsState();
          });
        } else {
          console.warn("[CLIENT] Users table element not found; actions disabled");
        }

        selectAllUsers.addEventListener("change", (e) => {
          const checked = e.target.checked;
          usersTbody
            .querySelectorAll('input.row-select[type="checkbox"]')
            .forEach((cb) => {
              cb.checked = checked;
              const id = cb.dataset.id;
              if (!id) return;
              if (checked) {
                selectedUsers.add(id);
              } else {
                selectedUsers.delete(id);
              }
            });
          syncSelectAllState();
          syncBulkActionsState();
        });

        ["input", "change"].forEach((evt) => {
          txtSearch.addEventListener(evt, loadUsers);
          selDept.addEventListener(evt, loadUsers);
          selRole.addEventListener(evt, loadUsers);
          selStatus.addEventListener(evt, loadUsers);
          dtUpdatedFrom.addEventListener(evt, loadUsers);
          dtUpdatedTo.addEventListener(evt, loadUsers);
        });

        if (bulkExportBtn)
          bulkExportBtn.addEventListener("click", handleBulkExport);
        if (bulkActivateBtn)
          bulkActivateBtn.addEventListener("click", () =>
            performBulkStatus(true)
          );
        if (bulkDeactivateBtn)
          bulkDeactivateBtn.addEventListener("click", () =>
            performBulkStatus(false)
          );
        if (bulkAssignRoleBtn)
          bulkAssignRoleBtn.addEventListener("click", handleBulkAssignRole);
        if (bulkRoleSelect)
          bulkRoleSelect.addEventListener("change", () => {
            syncBulkActionsState();
          });

        // Reset password dialog is already initialized above
        document
          .getElementById("btn-cancel-reset")
          .addEventListener("click", () => dlgReset.close());
        formReset.addEventListener("submit", (e) => {
          e.preventDefault();
          const fd = new FormData(formReset);
          const p = fd.get("password") || "",
            c = fd.get("confirm") || "";
          if (p !== c) {
            showToast("التأكيد غير مطابق.", "error");
            return;
          }
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذّر إعادة كلمة المرور.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Reset password response:", res);
              showToast("تم تحديث كلمة المرور (مشفّرة).", "success");
              dlgReset.close();
            })
            .updateUserPassword(resetUserId, p);
        });

        const DATE_OPTS = {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };

        function formatDateTime(value) {
          if (!value) return "—";
          // Attempt parsing robustly - handles ISO strings, common date strings, and Date objects
          const date = value instanceof Date ? value : new Date(value);

          // Check if the parsed date is valid
          if (Number.isNaN(date.getTime())) {
            // If invalid, return the original string (escaped) or a placeholder
            console.warn("formatDateTime: Invalid date value encountered:", value);
            return typeof value === "string" ? escapeHtml(value) : "—";
          }

          try {
            // Use a locale that often gives a clear format like YYYY-MM-DD HH:MM
            // Adjust 'en-CA' or options if needed for your preferred display
            return date
              .toLocaleString("en-CA", {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false,
              })
              .replace(",", ""); // Remove potential comma separator
          } catch (err) {
            console.error("formatDateTime: localeString failed:", err);
            // Fallback to ISO string format YYYY-MM-DD HH:MM if locale fails
            try {
              return date.toISOString().replace("T", " ").substring(0, 16);
            } catch (isoErr) {
              console.error("formatDateTime: ISOString fallback failed:", isoErr);
              return "Invalid Date"; // Final fallback
            }
          }
        }

        function escapeHtml(value) {
          return String(value ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function setTableStatus(bodyEl, message, type = "muted") {
          if (!bodyEl) return;
          const colCount = bodyEl.parentElement
            ? bodyEl.parentElement.querySelectorAll("thead th").length || 1
            : 1;
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = colCount;
          td.className = type === "error" ? "error-text" : "muted";
          td.textContent = message;
          tr.appendChild(td);
          bodyEl.innerHTML = "";
          bodyEl.appendChild(tr);
        }

        function renderBooleanBadge(value, yesLabel = "نعم", noLabel = "لا") {
          const normalized = String(value).toLowerCase();
          const truthy =
            value === true ||
            normalized === "true" ||
            normalized === "yes" ||
            normalized === "1" ||
            normalized === "y";
          return truthy
            ? `<span class="badge badge--ok">${escapeHtml(yesLabel)}</span>`
            : `<span class="badge badge--no">${escapeHtml(noLabel)}</span>`;
        }

        function loadSimpleTable({
          key,
          fetcher,
          tbody,
          renderer,
          normalize,
          force = false,
          label,
        }) {
          if (!tbody) return;
          if (isTableLoaded(key) && !force) return;
          if (force) markTableLoaded(key, false);
          const methodLabel = label || fetcher || key || "list";
          console.log(`[CLIENT] ${methodLabel} requested (force=${force})`);
          if (!(window.google && google.script && google.script.run)) {
            console.error(
              `[CLIENT] ${methodLabel} requires Apps Script runtime`
            );
            setTableStatus(tbody, "غير متصل بالخادم.", "error");
            return;
          }
          setTableStatus(tbody, "جاري التحميل…");
          const request = google.script.run
            .withFailureHandler((err) => {
              console.error(`[CLIENT] ${methodLabel} failed:`, err);
              markTableLoaded(key, false);
              setTableStatus(
                tbody,
                "خطأ: " + (err && err.message ? err.message : err),
                "error"
              );
            })
            .withSuccessHandler((rows) => {
              const count = Array.isArray(rows) ? rows.length : 0;
              console.log(
                `[CLIENT] ${methodLabel} data received, count:`,
                count
              );
              markTableLoaded(key, true);
              const list = Array.isArray(rows) ? rows : [];
              const normalized = normalize
                ? list.map((item) => normalize(item || {}))
                : list;
              renderTableRows(tbody, normalized, (row) => renderer(row || {}));
            });
          const fn = fetcher && request[fetcher];
          if (typeof fn === "function") {
            fn.call(request);
          } else {
            console.error(`[CLIENT] Missing server function: ${fetcher}`);
            markTableLoaded(key, false);
            setTableStatus(tbody, "تعذر تحميل البيانات.", "error");
          }
        }

        function renderUsers(list) {
          usersTbody.innerHTML = "";
          if (!Array.isArray(list) || list.length === 0) {
            usersTbody.innerHTML =
              '<tr><td colspan="11" class="muted">لا توجد نتائج.</td></tr>';
            selectedUsers.clear();
            syncSelectAllState();
            syncBulkActionsState();
            return;
          }
          const toDate = (value) => {
            if (!value) return null;
            if (value instanceof Date) return value;
            const parsed = new Date(value);
            return Number.isNaN(parsed.getTime()) ? null : parsed;
          };
          const norm = (u) => {
            const id = u?.User_Id ?? u?.user_id ?? u?.id ?? "";
            const normalizedId = id != null ? String(id) : "";
            return {
              userId: normalizedId,
              fullName: u?.Full_Name ?? u?.fullName ?? u?.name ?? "",
              username: u?.Username ?? u?.username ?? "",
              email: u?.Email ?? u?.email ?? "",
              department: u?.Department ?? u?.department ?? "",
              role: u?.Role_Id ?? u?.role ?? u?.Role ?? "",
              isActive:
                u?.IsActive === true ||
                String(u?.IsActive).toLowerCase() === "true" ||
                u?.isActive === true,
              lastLogin: toDate(u?.Last_Login ?? u?.lastLogin),
              updatedAt: toDate(u?.Updated_At ?? u?.updatedAt),
            };
          };
          const normalized = list.map(norm);
          normalizedUsersCache = normalized;
          const frag = document.createDocumentFragment();
          const visibleIds = new Set();
          normalized.forEach((u) => {
            if (u.userId) visibleIds.add(u.userId);
            const tr = document.createElement("tr");
            const checked = u.userId && selectedUsers.has(u.userId);
            tr.innerHTML = `
              <td class="select-cell">
                <input type="checkbox" class="row-select" data-id="${escapeHtml(
                  u.userId
                )}" ${checked ? "checked" : ""} ${u.userId ? "" : "disabled"} />
              </td>
              <td>${escapeHtml(u.userId)}</td>
              <td>${escapeHtml(u.fullName)}</td>
              <td>${escapeHtml(u.username)}</td>
              <td>${escapeHtml(u.email)}</td>
              <td>${escapeHtml(u.department)}</td>
              <td>${escapeHtml(u.role)}</td>
              <td>${
                u.isActive
                  ? '<span class="badge badge--ok">نشط</span>'
                  : '<span class="badge badge--no">غير نشط</span>'
              }</td>
              <td>${formatDateTime(u.lastLogin)}</td>
              <td>${formatDateTime(u.updatedAt)}</td>
              <td>
                <div class="icon-row">
                  <button class="icon-btn" data-act="view" data-id="${escapeHtml(
                    u.userId
                  )}" title="عرض الملف" aria-label="عرض الملف">
                    <svg viewBox="0 0 24 24"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>
                  </button>
                  <button class="icon-btn" data-act="edit" data-id="${escapeHtml(
                    u.userId
                  )}" title="تعديل" aria-label="تعديل">
                    <svg viewBox="0 0 24 24"><path d="M3 21l3-1 11-11-2-2L4 18l-1 3z"/><path d="M14 4l2 2"/></svg>
                  </button>
                  <button class="icon-btn" data-act="assign" data-id="${escapeHtml(
                    u.userId
                  )}" title="تعيين دور" aria-label="تعيين دور">
                    <svg viewBox="0 0 24 24"><circle cx="9" cy="8" r="4"/><path d="M4 20v-1a5 5 0 0 1 10 0v1"/><path d="M16 11v6"/><path d="M19 14h-6"/></svg>
                  </button>
                  <button class="icon-btn" data-act="reset" data-id="${escapeHtml(
                    u.userId
                  )}" title="إعادة كلمة المرور" aria-label="إعادة كلمة المرور">
                    <svg viewBox="0 0 24 24"><path d="M12 11v6"/><path d="M9 14h6"/><path d="M6 11V8a6 6 0 1 1 12 0v3"/></svg>
                  </button>
                  <button class="icon-btn" data-act="toggle" data-id="${escapeHtml(
                    u.userId
                  )}" title="${
              u.isActive ? "تعطيل" : "تفعيل"
            }" aria-label="تفعيل/تعطيل">
                    <svg viewBox="0 0 24 24">${
                      u.isActive
                        ? '<path d="M18 6L6 18"/><path d="M6 6l12 12"/>'
                        : '<path d="M5 12h14"/><path d="M12 5v14"/>'
                    }</svg>
                  </button>
                  <button class="icon-btn" data-act="docs" data-id="${escapeHtml(
                    u.userId
                  )}" title="مستندات" aria-label="مستندات">
                    <svg viewBox="0 0 24 24"><path d="M7 3h7l5 5v13H7z"/><path d="M14 3v5h5"/><path d="M10 13h6"/><path d="M10 17h6"/></svg>
                  </button>
                  <button class="icon-btn" data-act="impersonate" data-id="${escapeHtml(
                    u.userId
                  )}" title="انتحال" aria-label="انتحال">
                    <svg viewBox="0 0 24 24"><path d="M3 12c2-4 6-6 9-6s7 2 9 6c-2 4-6 6-9 6s-7-2-9-6z"/><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M9 15c1 .8 2 .8 3 0 1 .8 2 .8 3 0"/></svg>
                  </button>
                  <button class="icon-btn" data-act="delete" data-id="${escapeHtml(
                    u.userId
                  )}" title="حذف رمزي" aria-label="حذف رمزي">
                    <svg viewBox="0 0 24 24"><path d="M5 7h14"/><path d="M10 7V5h4v2"/><path d="M8 7l1 12h6l1-12"/></svg>
                  </button>
                  <button class="icon-btn" data-act="audit" data-id="${escapeHtml(
                    u.userId
                  )}" title="سجل التدقيق" aria-label="سجل التدقيق">
                    <svg viewBox="0 0 24 24"><path d="M7 3h10v4H7z"/><path d="M5 7h14v14H5z"/><path d="M9 11h6M9 15h6"/></svg>
                  </button>
                </div>
              </td>`;
            frag.appendChild(tr);
            const checkboxEl = tr.querySelector("input.row-select");
            if (checkboxEl) {
              if (u.userId) {
                checkboxEl.dataset.id = u.userId;
                checkboxEl.checked = !!checked;
              } else {
                checkboxEl.disabled = true;
                checkboxEl.removeAttribute("data-id");
              }
            }
            tr.querySelectorAll(".icon-btn").forEach((btn) => {
              if (u.userId) {
                btn.dataset.id = u.userId;
              } else {
                btn.removeAttribute("data-id");
              }
            });
          });
          usersTbody.appendChild(frag);
          Array.from(selectedUsers).forEach((id) => {
            if (!visibleIds.has(id)) {
              selectedUsers.delete(id);
            }
          });
          syncSelectAllState();
          syncBulkActionsState();
        }

        function loadRoles({ force = false } = {}) {
          loadSimpleTable({
            key: "roles",
            fetcher: "listRoles",
            tbody: rolesTbody,
            force,
            label: "listRoles",
            normalize: (row = {}) => ({
              roleId: row.roleId ?? row.Role_Id ?? row.RoleID ?? row.id ?? "",
              title:
                row.title ??
                row.Role_Title ??
                row.role ??
                row.name ??
                "",
              description: row.description ?? row.Description ?? "",
              isSystem: normalizeBool(
                row.isSystem ??
                  row.Is_System ??
                  row.is_system ??
                  row.isSystemFlag
              ),
              updatedAt:
                row.updatedAt ??
                row.Updated_At ??
                row.updated ??
                row.updated_at ??
                row.Last_Modified ??
                "",
            }),
            renderer: (row) => `
              <td>${escapeHtml(row.roleId || "")}</td>
              <td>${escapeHtml(row.title || "")}</td>
              <td>${escapeHtml(row.description || "")}</td>
              <td>${renderBooleanBadge(row.isSystem)}</td>
              <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
            `,
          });
        }

        function loadPermissions({ force = false } = {}) {
          loadSimpleTable({
            key: "permissions",
            fetcher: "listPermissions",
            tbody: permissionsTbody,
            force,
            label: "listPermissions",
            normalize: (row = {}) => ({
              permissionKey:
                row.permissionKey ??
                row.Permission_Key ??
                row.key ??
                row.id ??
                "",
              label:
                row.label ??
                row.Permission_Label ??
                row.name ??
                row.Permission ??
                "",
              category: row.category ?? row.Category ?? "",
              description: row.description ?? row.Description ?? "",
              updatedAt:
                row.updatedAt ??
                row.Updated_At ??
                row.updated ??
                row.updated_at ??
                "",
            }),
            renderer: (row) => `
              <td>${escapeHtml(row.permissionKey || "")}</td>
              <td>${escapeHtml(row.label || "")}</td>
              <td>${escapeHtml(row.category || "")}</td>
              <td>${escapeHtml(row.description || "")}</td>
              <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
            `,
          });
        }

        function loadRolePermissions({ force = false } = {}) {
          loadSimpleTable({
            key: "rolePerms",
            fetcher: "listRolePermissions",
            tbody: rolePermsTbody,
            force,
            label: "listRolePermissions",
            normalize: (row = {}) => ({
              roleId: row.roleId ?? row.Role_Id ?? row.role ?? "",
              roleTitle:
                row.roleTitle ?? row.Role_Title ?? row.roleName ?? row.role ?? "",
              permissionKey:
                row.permissionKey ??
                row.Permission_Key ??
                row.permission ??
                "",
              permissionLabel:
                row.permissionLabel ??
                row.Permission_Label ??
                row.permissionLabelAr ??
                row.permission ??
                "",
              scope: row.scope ?? row.Scope ?? "",
              allowed: normalizeBool(row.allowed ?? row.Allowed),
              updatedAt:
                row.updatedAt ??
                row.Updated_At ??
                row.updated ??
                row.updated_at ??
                "",
            }),
            renderer: (row) => {
              const roleDisplay = row.roleTitle && row.roleId
                ? `${escapeHtml(row.roleTitle)} (${escapeHtml(row.roleId)})`
                : escapeHtml(row.roleTitle || row.roleId || "");
              const permDisplay = row.permissionLabel && row.permissionKey
                ? `${escapeHtml(row.permissionLabel)} (${escapeHtml(
                    row.permissionKey
                  )})`
                : escapeHtml(row.permissionLabel || row.permissionKey || "");
              return `
                <td>${roleDisplay}</td>
                <td>${permDisplay}</td>
                <td>${escapeHtml(row.scope || "")}</td>
                <td>${renderBooleanBadge(row.allowed, "مسموح", "مرفوض")}</td>
                <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
              `;
            },
          });
        }

        function loadProperties({ force = false } = {}) {
          loadSimpleTable({
            key: "properties",
            fetcher: "listUserProperties",
            tbody: propertiesTbody,
            force,
            label: "listUserProperties",
            normalize: (row = {}) => ({
              userId: row.userId ?? row.User_Id ?? row.user ?? "",
              key: row.key ?? row.Property_Key ?? row.name ?? "",
              value: row.value ?? row.Property_Value ?? row.Property ?? "",
              updatedAt:
                row.updatedAt ??
                row.Updated_At ??
                row.updated ??
                row.updated_at ??
                "",
              updatedBy:
                row.updatedBy ?? row.Updated_By ?? row.actor ?? row.User ?? "",
            }),
            renderer: (row) => `
              <td>${escapeHtml(row.userId || "")}</td>
              <td>${escapeHtml(row.key || "")}</td>
              <td>${escapeHtml(row.value || "")}</td>
              <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
              <td>${escapeHtml(row.updatedBy || "")}</td>
            `,
          });
        }

        function loadSessions({ force = false } = {}) {
          loadSimpleTable({
            key: "sessions",
            fetcher: "listSessions",
            tbody: sessionsTbody,
            force,
            label: "listSessions",
            normalize: (row = {}) => ({
              sessionId: row.sessionId ?? row.Session_Id ?? row.session ?? row.id ?? "",
              userId: row.userId ?? row.User_Id ?? row.user ?? "",
              actor:
                row.actor ??
                row.Actor ??
                row.actorEmail ??
                row.Actor_Email ??
                row.Created_By ??
                "",
              type: row.type ?? row.Type ?? row.Session_Type ?? "",
              status: row.status ?? row.Status ?? row.Session_Status ?? "",
              startedAt:
                row.startedAt ??
                row.Started_At ??
                row.Created_At ??
                row.start ??
                "",
              endedAt:
                row.endedAt ??
                row.Ended_At ??
                row.Revoked_At ??
                row.end ??
                row.Last_Seen ??
                "",
            }),
            renderer: (row) => `
              <td>${escapeHtml(row.sessionId || "")}</td>
              <td>${escapeHtml(row.userId || "")}</td>
              <td>${escapeHtml(row.actor || "")}</td>
              <td>${escapeHtml(row.type || "")}</td>
              <td>${escapeHtml(row.status || "")}</td>
              <td>${escapeHtml(formatDateTime(row.startedAt))}</td>
              <td>${escapeHtml(formatDateTime(row.endedAt))}</td>
            `,
          });
        }

        function loadAuditLog({ force = false } = {}) {
          loadSimpleTable({
            key: "audit",
            fetcher: "getAuditLog",
            tbody: auditTbody,
            force,
            label: "getAuditLog",
            normalize: (row = {}) => ({
              timestamp:
                row.timestamp ??
                row.Timestamp ??
                row.Created_At ??
                row.createdAt ??
                "",
              user:
                row.user ??
                row.User ??
                row.actor ??
                row.Actor ??
                row.Actor_Email ??
                "",
              action: row.action ?? row.Action ?? row.event ?? "",
              details:
                row.details ??
                row.Details ??
                row.Summary ??
                row.Message ??
                "",
            }),
            renderer: (row) => `
              <td>${escapeHtml(formatDateTime(row.timestamp))}</td>
              <td>${escapeHtml(row.user || "")}</td>
              <td>${escapeHtml(row.action || "")}</td>
              <td><pre style="white-space:pre-wrap;margin:0;">${escapeHtml(
                parseDetails(row.details)
              )}</pre></td>
            `,
          });
        }

        const sysPaneLoaders = {
          overview: ({ force } = {}) => {
            if (force) overviewLoaded = false;
            if (!overviewLoaded) {
              fetchKPIs();
              overviewLoaded = true;
            }
          },
          users: (options = {}) => loadUsers(options),
          roles: (options = {}) => loadRoles(options),
          permissions: (options = {}) => loadPermissions(options),
          rolePerms: (options = {}) => loadRolePermissions(options),
          properties: (options = {}) => loadProperties(options),
          sessions: (options = {}) => loadSessions(options),
          audit: (options = {}) => loadAuditLog(options),
        };

        function runPaneLoaders(paneName, options = {}) {
          const loader = sysPaneLoaders[paneName];
          if (loader) loader(options);
        }

        function setActiveSysPane(paneName, options = {}) {
          if (!paneName || !sysPanes.length) return;
          if (paneName === currentSysPane && !options.force) {
            updateSysNavActive(paneName);
            runPaneLoaders(paneName, options);
            return;
          }
          currentSysPane = paneName;
          sysPanes.forEach((pane) => {
            const paneKey = pane.dataset.pane;
            const stacksWith = (pane.dataset.stackWith || "")
              .split(",")
              .map((token) => token.trim())
              .filter(Boolean);
            const shouldShow =
              paneKey === paneName || stacksWith.includes(paneName);
            pane.classList.toggle("active", shouldShow);
          });
          updateSysNavActive(paneName);
          runPaneLoaders(paneName, options);
        }

        if (sysNav) {
          sysNav.addEventListener("click", (evt) => {
            const btn = evt.target.closest("button[data-pane]");
            if (!btn) return;
            evt.preventDefault();
            const pane = btn.dataset.subId || btn.dataset.pane || "users";
            loadTab(pane);
          });
        }

        function syncSelectAllState() {
          if (!selectAllUsers) return;
          const checkboxes = Array.from(
            usersTbody.querySelectorAll('input.row-select[type="checkbox"]')
          ).filter((cb) => !cb.disabled);
          if (checkboxes.length === 0) {
            selectAllUsers.checked = false;
            selectAllUsers.indeterminate = false;
            return;
          }
          const checkedCount = checkboxes.filter((cb) => cb.checked).length;
          selectAllUsers.checked = checkedCount === checkboxes.length;
          selectAllUsers.indeterminate =
            checkedCount > 0 && checkedCount < checkboxes.length;
        }

        function syncBulkActionsState() {
          const hasSelection = selectedUsers.size > 0;
          if (bulkExportBtn) bulkExportBtn.disabled = !hasSelection;
          if (bulkActivateBtn) bulkActivateBtn.disabled = !hasSelection;
          if (bulkDeactivateBtn) bulkDeactivateBtn.disabled = !hasSelection;
          if (bulkAssignRoleBtn)
            bulkAssignRoleBtn.disabled =
              !hasSelection || !bulkRoleSelect || !bulkRoleSelect.value;
        }

        function ensureSelection() {
          if (selectedUsers.size === 0) {
            showToast("الرجاء اختيار مستخدم واحد على الأقل.", "info");
            return false;
          }
          return true;
        }

        function performBulkStatus(makeActive) {
          if (!ensureSelection()) return;
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          const ids = Array.from(selectedUsers);
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تحديث الحالة للمستخدمين المحددين.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Bulk status update response:", res);
              const count = res?.updated ?? ids.length;
              showToast(
                "تم تحديث حالة " + count + " مستخدم.",
                "success",
                "تم التحديث"
              );
              selectedUsers.clear();
              loadUsers();
            })
            .bulkUpdateUserStatus(ids, makeActive);
        }

        function handleBulkAssignRole() {
          if (!bulkRoleSelect || !bulkRoleSelect.value) {
            showToast("يرجى اختيار دور للتعيين.", "info");
            return;
          }
          if (!ensureSelection()) return;
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          const ids = Array.from(selectedUsers);
          const roleId = bulkRoleSelect.value;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تعيين الدور للمستخدمين المحددين.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Bulk role assignment response:", res);
              const count = res?.updated ?? ids.length;
              showToast(
                "تم تعيين الدور لـ " + count + " مستخدم.",
                "success",
                "تم التعيين"
              );
              selectedUsers.clear();
              loadUsers();
            })
            .bulkAssignRole(ids, roleId);
        }

        function triggerExportDownload(payload) {
          if (!payload || !payload.content) {
            showToast("لا توجد بيانات للتصدير.", "info");
            return;
          }
          try {
            const blob = new Blob([payload.content], {
              type: payload.mimeType || "text/csv",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = payload.filename || "users_export.csv";
            document.body.appendChild(a);
            a.click();
            requestAnimationFrame(() => {
              URL.revokeObjectURL(url);
              a.remove();
            });
          } catch (err) {
            console.error(err);
            showToast("تعذر تنزيل ملف التصدير.", "error");
          }
        }

        function handleBulkExport() {
          if (!ensureSelection()) return;
          if (!(window.google && google.script && google.script.run)) {
            showToast("غير متصل بالخادم.", "error");
            return;
          }
          const filters = Object.assign({}, currentFilters(), {
            userIds: Array.from(selectedUsers),
          });
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تجهيز ملف التصدير.", "error");
            })
            .withSuccessHandler((payload) => {
              console.log("Export payload received:", payload);
              triggerExportDownload(payload);
              showToast("تم تجهيز ملف التصدير.", "success");
            })
            .exportUsers(filters, "csv");
        }

        /* ---------- Global Toast (usable anywhere) ---------- */
        function ensureToastContainer() {
          let c = document.getElementById("toast-container");
          const loginScreen = document.getElementById("login-screen");
          const loginVisible =
            loginScreen && loginScreen.classList.contains("active");
          if (
            c &&
            c.parentElement &&
            c.parentElement !== document.body &&
            !loginVisible
          ) {
            c.id = "login-toast-container";
            c.classList.add("toast-container--login");
            c = null;
          }
          if (!c) {
            c = document.createElement("div");
            c.id = "toast-container";
            c.className = "toast-container";
            c.setAttribute("aria-live", "polite");
            c.setAttribute("aria-atomic", "true");
            document.body.appendChild(c);
          }
          return c;
        }
        function showToast(message, type = "info", title) {
          const toastContainer = ensureToastContainer();
          const t = document.createElement("div");
          t.className = "toast " + type;
          t.innerHTML =
            '<div class="toast__title">' +
            (title || (type === "success" ? "تم بنجاح" : "إشعار")) +
            '</div><div class="toast__msg">' +
            message +
            "</div>";
          toastContainer.appendChild(t);
          const hide = () => {
            t.classList.add("toast--hide");
            setTimeout(() => t.remove(), 300);
          };
          t.addEventListener("click", hide);
          setTimeout(hide, 3500);
        }

        /* ---------- Create / Edit User ---------- */
        const dlgNew = document.getElementById("dlg-new-user");
        const fieldsHost = document.getElementById("new-user-fields");
        let currentEditId = null; // null=create, value=edit mode

        document
          .getElementById("btn-new-user")
          .addEventListener("click", () => {
            if (!(window.google && google.script && google.script.run)) {
              showToast("غير متصل بالخادم.", "error");
              return;
            }
            currentEditId = null; // creation mode
            // Try dynamic form; if empty fallback to minimal static form
            google.script.run
              .withFailureHandler((err) => {
                console.error(err);
                buildMinimalUserForm();
                dlgNew.showModal();
              })
              .withSuccessHandler((fields) => {
                console.log("Add user form fields received:", fields);
                if (Array.isArray(fields) && fields.length) {
                  renderDynamicUserForm(fields, null);
                } else {
                  buildMinimalUserForm();
                }
                dlgNew.showModal();
              })
              .getFormWithOptions("FORM_SYS_AddUser");
          });

        document
          .getElementById("btn-cancel-new")
          .addEventListener("click", () => dlgNew.close());

        function renderDynamicUserForm(fields, initialData = null) {
          const host = document.getElementById("new-user-fields");
          host.classList.add("dialog-body");
          host.innerHTML = "";
          const layout = document.createElement("div");
          layout.className = "dyn-layout";
          const tabBar = document.createElement("div");
          tabBar.className = "dyn-tabs";
          tabBar.setAttribute("role", "tablist");
          const pages = document.createElement("div");
          pages.className = "dyn-pages";
          layout.appendChild(tabBar);
          layout.appendChild(pages);
          host.appendChild(layout);

          const tabs = {};
          fields.forEach((f) => {
            const tab = f.tabId || f.tabName || "default";
            const sec = f.section || "";
            if (!tabs[tab])
              tabs[tab] = { name: f.tabName || "عام", sections: {} };
            if (!tabs[tab].sections[sec]) tabs[tab].sections[sec] = [];
            tabs[tab].sections[sec].push(f);
          });

          function makePage(tabKey, tab, index) {
            const page = document.createElement("div");
            const safeKey = String(tabKey || "tab")
              .replace(/[^a-zA-Z0-9_-]+/g, "_")
              .toLowerCase();
            page.className = "form-grid dyn-page hidden";
            page.id = `dyn-tab-${index}-${safeKey}`;
            page.setAttribute("role", "tabpanel");
            page.setAttribute("aria-hidden", "true");
            Object.keys(tab.sections).forEach((sec) => {
              if (sec) {
                const h = document.createElement("div");
                h.className = "span-2 muted";
                h.style.margin = ".4rem 0 .2rem";
                h.textContent = sec;
                page.appendChild(h);
              }
              tab.sections[sec].forEach((f, i) => {
                const id = `nu_${(
                  f.targetColumn ||
                  f.fieldId ||
                  tabKey + i
                ).replace(/\s+/g, "_")}`;
                const wrap = document.createElement("div");
                const label = document.createElement("label");
                label.textContent =
                  f.label || f.targetColumn || f.fieldId || "حقل " + (i + 1);
                label.setAttribute("for", id);
                let el;
                const t = String(f.type || "text").toLowerCase();
                const isPassword =
                  f.targetColumn === "Password_Hash" ||
                  f.targetColumn === "password" ||
                  /password/i.test(f.fieldId || "");
                if (currentEditId && isPassword) return; // لا نعرض كلمة المرور في وضع التعديل
                if (t === "dropdown") {
                  el = document.createElement("select");
                  (f.options || []).forEach((opt) => {
                    const o = document.createElement("option");
                    o.value = opt.value;
                    o.textContent = opt.label || opt.value;
                    el.appendChild(o);
                  });
                } else if (t === "textarea" || t === "paragraph") {
                  el = document.createElement("textarea");
                  el.rows = 4;
                  wrap.classList.add("span-2");
                } else if (t === "auto") {
                  el = document.createElement("input");
                  el.type = "text";
                  el.readOnly = true;
                  el.placeholder = "AutoGenerate";
                } else if (t === "password" || isPassword) {
                  el = document.createElement("input");
                  el.type = "password";
                  el.autocomplete = initialData
                    ? "current-password"
                    : "new-password";
                } else {
                  el = document.createElement("input");
                  el.type = t === "email" ? "email" : "text";
                }
                el.name = f.targetColumn || f.fieldId || id;
                el.id = id;
                if (f.readOnly) {
                  el.readOnly = true;
                  el.setAttribute("aria-readonly", "true");
                }
                if (f.required && !el.readOnly) el.required = true;
                if (initialData) {
                  const k = f.targetColumn || f.fieldId;
                  if (k && initialData[k] != null) el.value = initialData[k];
                  if (k === "User_Id") el.readOnly = true;
                } else if (
                  f.defaultValue !== undefined &&
                  f.defaultValue !== null &&
                  String(f.defaultValue) !== ""
                ) {
                  el.value = f.defaultValue;
                }
                if (
                  !initialData &&
                  (f.targetColumn === "User_Id" ||
                    /User_Id/i.test(f.fieldId || ""))
                ) {
                  if (window.google && google.script && google.script.run) {
                    google.script.run
                      .withSuccessHandler((nextId) => {
                        el.value = nextId;
                        el.readOnly = true;
                      })
                      .getNextUserId();
                  }
                }
                if (
                  /Notes|ملاحظات/i.test(f.fieldId || "") ||
                  /Notes|ملاحظات/i.test(f.targetColumn || "")
                ) {
                  wrap.classList.add("span-2");
                }
                wrap.appendChild(label);
                wrap.appendChild(el);
                page.appendChild(wrap);
              });
            });
            return page;
          }

          const tabKeys = Object.keys(tabs);
          const pagesEls = tabKeys.map((k, idx) => makePage(k, tabs[k], idx));
          pagesEls.forEach((p) => pages.appendChild(p));
          const tabButtons = [];
          const activateTab = (targetIdx) => {
            pagesEls.forEach((page, idx) => {
              const isActive = idx === targetIdx;
              page.classList.toggle("hidden", !isActive);
              page.setAttribute("aria-hidden", isActive ? "false" : "true");
            });
            tabButtons.forEach((btn, idx) => {
              const isActive = idx === targetIdx;
              btn.classList.toggle("active", isActive);
              btn.setAttribute("aria-selected", isActive ? "true" : "false");
              btn.tabIndex = isActive ? 0 : -1;
            });
          };

          tabKeys.forEach((k, idx) => {
            const b = document.createElement("button");
            b.type = "button";
            b.className = "nav-item" + (idx === 0 ? " active" : "");
            b.textContent = tabs[k].name || "تبويب";
            b.setAttribute("role", "tab");
            b.setAttribute("aria-selected", idx === 0 ? "true" : "false");
            b.setAttribute("aria-controls", pagesEls[idx].id);
            b.tabIndex = idx === 0 ? 0 : -1;
            b.addEventListener("click", () => activateTab(idx));
            b.addEventListener("keydown", (evt) => {
              if (evt.key === "ArrowLeft" || evt.key === "ArrowUp") {
                evt.preventDefault();
                const prev = (idx - 1 + tabButtons.length) % tabButtons.length;
                activateTab(prev);
                tabButtons[prev].focus();
              } else if (evt.key === "ArrowRight" || evt.key === "ArrowDown") {
                evt.preventDefault();
                const next = (idx + 1) % tabButtons.length;
                activateTab(next);
                tabButtons[next].focus();
              }
            });
            tabBar.appendChild(b);
            tabButtons.push(b);
          });

          if (tabKeys.length) {
            activateTab(0);
          }
        }

        function buildMinimalUserForm(initialData = null) {
          fieldsHost.innerHTML = "";
          fieldsHost.classList.add("dialog-body");
          const grid = document.createElement("div");
          grid.className = "form-grid";
          const isEdit = !!initialData;
          grid.innerHTML = `
            <div><label>رقم المستخدم</label><input id="nu_uid" name="User_Id" type="text" ${
              isEdit ? "" : "readonly"
            } autocomplete="off" placeholder="AutoGenerate" /></div>
            <div><label>الاسم الكامل</label><input name="Full_Name" type="text" required /></div>
            <div><label>اسم المستخدم</label><input name="Username" type="text" required /></div>
            <div><label>البريد الإلكتروني</label><input name="Email" type="email" /></div>
            <div><label>القسم</label><select id="nu_dept" name="Department"></select></div>
            <div><label>الدور</label><select id="nu_role" name="Role_Id"></select></div>
            <div class="span-2"><label>ملاحظات</label><textarea name="Notes" rows="3"></textarea></div>
            <div><label>نشط؟</label><select name="IsActive"><option value="true">نعم</option><option value="false">لا</option></select></div>
            ${
              isEdit
                ? ""
                : '<div><label>كلمة المرور</label><input name="password" type="password" autocomplete="new-password" required /></div>'
            }`;
          fieldsHost.appendChild(grid);
          // next id & filters
          if (window.google && google.script && google.script.run) {
            if (!isEdit) {
              google.script.run
                .withSuccessHandler((nextId) => {
                  console.log("Next user ID received:", nextId);
                  const el = document.getElementById("nu_uid");
                  if (el) {
                    el.value = nextId;
                  }
                })
                .getNextUserId();
            }
            google.script.run
              .withSuccessHandler((f) => {
                console.log("Dynamic form filters received:", f);
                const d = f?.departments || [];
                const r = f?.roles || [];
                const dSel = document.getElementById("nu_dept");
                const rSel = document.getElementById("nu_role");
                [d, r].forEach((arr, idx) => {
                  const sel = idx === 0 ? dSel : rSel;
                  sel.innerHTML =
                    '<option value=""></option>' +
                    (arr || [])
                      .map((v) => `<option value="${v}">${v}</option>`)
                      .join("");
                });
                if (initialData) {
                  if (initialData.Department)
                    dSel.value = initialData.Department;
                  if (initialData.Role_Id) rSel.value = initialData.Role_Id;
                }
              })
              .getDeptAndRoleFilters();
          }
          if (initialData) {
            Object.keys(initialData).forEach((k) => {
              const el = grid.querySelector(`[name="${k}"]`);
              if (el) {
                el.value = initialData[k];
              }
            });
            const idEl = grid.querySelector("#nu_uid");
            if (idEl) {
              idEl.readOnly = true;
            }
          }
        }

        // إرسال النموذج (يخدم الإنشاء والتعديل)
        document
          .getElementById("new-user-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const payload = {};
            for (const [k, v] of fd.entries()) {
              if (k === "IsActive") {
                payload[k] =
                  v === "true" || v === "Yes" || v === "نشط" || v === "Active";
              } else if (k === "password") {
                payload.password = v;
              } else {
                payload[k] = v;
              }
            }
            if (!(window.google && google.script && google.script.run)) {
              showToast("غير متصل بالخادم.", "error");
              return;
            }
            if (currentEditId) {
              payload.User_Id = payload.User_Id || currentEditId;
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("تعذّر تحديث المستخدم.", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Update user response:", res);
                  showToast("تم تحديث بيانات المستخدم.", "success");
                  dlgNew.close();
                  e.target.reset();
                  loadUsers();
                })
                .updateUser(payload);
            } else {
              google.script.run
                .withFailureHandler((err) => {
                  console.error(err);
                  showToast("تعذّر إنشاء المستخدم.", "error");
                })
                .withSuccessHandler((res) => {
                  console.log("Create user response:", res);
                  showToast("تم إنشاء المستخدم بنجاح.", "success");
                  dlgNew.close();
                  e.target.reset();
                  loadUsers();
                })
                .createUser(payload);
            }
          });

        function openUserEditor(userId) {
          currentEditId = userId;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تحميل بيانات المستخدم.", "error");
            })
            .withSuccessHandler((user) => {
              console.log("User profile for edit received:", user);
              if (!user) {
                showToast("لم يتم العثور على المستخدم.", "error");
                return;
              }
              const handleForm = (fields) => {
                console.log("Edit user form fields received:", fields);
                if (Array.isArray(fields) && fields.length) {
                  renderDynamicUserForm(fields, user);
                } else {
                  buildMinimalUserForm(user);
                }
                dlgNew.showModal();
              };
              google.script.run
                .withFailureHandler((err2) => {
                  console.error(err2);
                  buildMinimalUserForm(user);
                  dlgNew.showModal();
                })
                .withSuccessHandler(handleForm)
                .getFormWithOptions("FORM_SYS_EditUser");
            })
            .getUserById(userId);
        }

        function ensureRoleOptionsLoaded(callback) {
          const bootstrapRoles = (() => {
            if (bootstrapData?.filters?.roleOptions?.length) {
              return bootstrapData.filters.roleOptions;
            }
            if (bootstrapData?.filters?.roles?.length) {
              return bootstrapData.filters.roles.map((value) => ({
                value,
                label: value,
              }));
            }
            return [];
          })();
          const cached =
            (roleOptionsCache && roleOptionsCache.length
              ? roleOptionsCache
              : bootstrapRoles) || [];
          if (cached.length) {
            roleOptionsCache = cached;
            callback(roleOptionsCache);
            return;
          }
          if (!(window.google && google.script && google.script.run)) {
            callback([]);
            return;
          }
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              callback([]);
            })
            .withSuccessHandler((options) => {
              console.log("Role options received:", options);
              roleOptionsCache = Array.isArray(options) ? options : [];
              callback(roleOptionsCache);
            })
            .getRoleOptions();
        }

        function describeUserForLabel(userId) {
          const match = normalizedUsersCache.find((u) => u.userId === userId);
          if (!match) return userId;
          const pieces = [];
          if (match.fullName) pieces.push(match.fullName);
          if (match.username) pieces.push(`(${match.username})`);
          const joined = pieces.join(" ").trim();
          return joined || userId;
        }

        function openAssignRoleDialog(userId) {
          assignRoleUserInput.value = userId;
          assignRoleUserLabel.textContent = `المستخدم: ${describeUserForLabel(
            userId
          )}`;
          ensureRoleOptionsLoaded((options) => {
            assignRoleSelect.innerHTML = '<option value="">اختر دورًا</option>';
            fillSelect(assignRoleSelect, options);
            const match = normalizedUsersCache.find((u) => u.userId === userId);
            if (match?.role) {
              assignRoleSelect.value = match.role;
            }
            dlgAssign.showModal();
          });
        }

        function setProfileTab(tabName = "profile") {
          profileTabButtons.forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.tab === tabName);
          });
          profilePanels.forEach((panel) => {
            panel.classList.toggle("active", panel.dataset.tab === tabName);
          });
        }

        profileTabButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const tab = btn.dataset.tab || "profile";
            setProfileTab(tab);
          });
        });

        if (btnCloseProfile)
          btnCloseProfile.addEventListener("click", () => dlgProfile.close());
        if (btnCancelAssign)
          btnCancelAssign.addEventListener("click", () => dlgAssign.close());
        if (dlgProfile)
          dlgProfile.addEventListener("close", () => {
            currentProfileUserId = null;
            profileDataCache = null;
          });

        if (formAssignRole)
          formAssignRole.addEventListener("submit", (e) => {
            e.preventDefault();
            const userId = assignRoleUserInput.value;
            const roleId = assignRoleSelect.value;
            if (!userId || !roleId) {
              showToast("يرجى اختيار الدور.", "info");
              return;
            }
            google.script.run
              .withFailureHandler((err) => {
                console.error(err);
                showToast("تعذر تعيين الدور للمستخدم المحدد.", "error");
              })
              .withSuccessHandler((res) => {
                console.log("Assign user role response:", res);
                showToast("تم تعيين الدور بنجاح.", "success");
                dlgAssign.close();
                loadUsers();
              })
              .assignUserRole(userId, roleId);
          });

        function renderDefinitionList(listEl, rows) {
          if (!listEl) return;
          listEl.innerHTML = "";
          rows
            .filter((row) => row && row.label)
            .forEach((row) => {
              const dt = document.createElement("dt");
              dt.textContent = row.label;
              const dd = document.createElement("dd");
              dd.textContent = row.value ?? "—";
              listEl.appendChild(dt);
              listEl.appendChild(dd);
            });
        }

        function renderTableRows(bodyEl, rows, renderRow) {
          if (!bodyEl) return;
          bodyEl.innerHTML = "";
          if (!rows || !rows.length) {
            const empty = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = bodyEl.parentElement
              ? bodyEl.parentElement.querySelectorAll("thead th").length || 1
              : 1;
            td.className = "profile-empty";
            td.textContent = "لا توجد بيانات";
            empty.appendChild(td);
            bodyEl.appendChild(empty);
            return;
          }
          const frag = document.createDocumentFragment();
          rows.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = renderRow(row || {});
            frag.appendChild(tr);
          });
          bodyEl.appendChild(frag);
        }

        function normalizeBool(val) {
          if (val === true) return true;
          if (val === false) return false;
          const str = String(val || "").toLowerCase();
          return (
            str === "true" ||
            str === "yes" ||
            str === "نشط" ||
            str === "1" ||
            str === "enabled" ||
            str === "مفعل" ||
            str === "مُفعّل" ||
            str === "active"
          );
        }

        function parseDetails(details) {
          if (!details) return "";
          if (typeof details === "string") {
            try {
              const parsed = JSON.parse(details);
              if (parsed && typeof parsed === "object") {
                return JSON.stringify(parsed, null, 2);
              }
            } catch (err) {
              return details;
            }
            return details;
          }
          if (typeof details === "object") {
            try {
              return JSON.stringify(details, null, 2);
            } catch (err) {
              return String(details);
            }
          }
          return String(details);
        }

        function renderUserProfileDialog(payload, defaultTab = "profile") {
          if (!payload) return;
          const user = payload.user || {};
          profileTitle.textContent =
            user.Full_Name || user.Username || user.User_Id || "مستخدم";
          profileUsername.textContent = user.Username
            ? `@${user.Username}`
            : "";
          renderDefinitionList(profileOverviewList, [
            { label: "الاسم الكامل", value: user.Full_Name || "—" },
            { label: "اسم المستخدم", value: user.Username || "—" },
            { label: "البريد الإلكتروني", value: user.Email || "—" },
            { label: "القسم", value: user.Department || "—" },
            { label: "الدور", value: user.Role_Id || "—" },
            {
              label: "نشط؟",
              value: normalizeBool(user.IsActive) ? "نعم" : "لا",
            },
            {
              label: "تفعيل MFA",
              value: normalizeBool(user.MFA_Enabled) ? "مُفعّل" : "غير مُفعّل",
            },
            {
              label: "آخر تسجيل دخول",
              value: formatDateTime(user.Last_Login || user.lastLogin),
            },
            {
              label: "تاريخ الإنشاء",
              value: formatDateTime(user.Created_At || user.createdAt),
            },
            {
              label: "آخر تحديث",
              value: formatDateTime(user.Updated_At || user.updatedAt),
            },
            { label: "ملاحظات", value: user.Notes || "—" },
          ]);

          renderTableRows(profilePropertiesBody, payload.properties, (row) => {
            return `
              <td>${escapeHtml(row.key || "")}</td>
              <td>${escapeHtml(row.value || "")}</td>
              <td>${escapeHtml(formatDateTime(row.updatedAt))}</td>
              <td>${escapeHtml(row.updatedBy || "")}</td>
            `;
          });

          renderTableRows(profileDocumentsBody, payload.documents, (row) => {
            const label = row.label || row.fileName || "—";
            const link = row.url
              ? `<a class="profile-doc-link" href="${escapeHtml(
                  row.url
                )}" target="_blank" rel="noopener">فتح</a>`
              : "—";
            return `
              <td>${escapeHtml(label)}</td>
              <td>${escapeHtml(row.uploadedBy || "")}</td>
              <td>${escapeHtml(formatDateTime(row.createdAt))}</td>
              <td>${link}</td>
            `;
          });

          renderTableRows(profileSessionsBody, payload.sessions, (row) => {
            return `
              <td>${escapeHtml(row.sessionId || "")}</td>
              <td>${escapeHtml(row.actor || "")}</td>
              <td>${escapeHtml(row.type || "")}</td>
              <td>${escapeHtml(row.status || "")}</td>
              <td>${escapeHtml(formatDateTime(row.startedAt))}</td>
              <td>${escapeHtml(formatDateTime(row.endedAt))}</td>
            `;
          });

          renderTableRows(profileAuditBody, payload.audit, (row) => {
            return `
              <td>${escapeHtml(formatDateTime(row.timestamp))}</td>
              <td>${escapeHtml(row.actor || "")}</td>
              <td>${escapeHtml(row.action || "")}</td>
              <td><pre style="white-space:pre-wrap;margin:0;">${escapeHtml(
                parseDetails(row.details)
              )}</pre></td>
            `;
          });

          setProfileTab(defaultTab);
          dlgProfile.showModal();
        }

        function openUserProfile(userId, tabName = "profile") {
          currentProfileUserId = userId;
          profileDataCache = null;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر تحميل ملف المستخدم.", "error");
            })
            .withSuccessHandler((payload) => {
              console.log("User profile payload received:", payload);
              if (!payload || !payload.user) {
                showToast("لم يتم العثور على المستخدم.", "error");
                return;
              }
              profileDataCache = payload;
              renderUserProfileDialog(payload, tabName);
            })
            .getUserProfile(userId);
        }

        function startImpersonationFlow(userId) {
          if (!userId) return;
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر بدء جلسة الانتحال.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Impersonation start response:", res);
              const sessionId = res?.sessionId || "";
              showToast(
                sessionId
                  ? `تم بدء جلسة انتحال (${sessionId}).`
                  : "تم تسجيل الانتحال.",
                "success"
              );
              if (currentProfileUserId === userId && profileDataCache) {
                openUserProfile(userId, "sessions");
              }
            })
            .startImpersonation(userId);
        }

        function performSoftDelete(userId) {
          const confirmed = confirm("هل أنت متأكد من تنفيذ حذف رمزي؟");
          if (!confirmed) return;
          const reason = prompt("أدخل سبب الحذف الرمزي (اختياري):", "") || "";
          google.script.run
            .withFailureHandler((err) => {
              console.error(err);
              showToast("تعذر حذف المستخدم.", "error");
            })
            .withSuccessHandler((res) => {
              console.log("Soft delete response:", res);
              showToast("تم تعطيل المستخدم ووضع علامة الحذف.", "success");
              loadUsers();
              if (currentProfileUserId === userId && profileDataCache) {
                openUserProfile(userId, "profile");
              }
            })
            .softDeleteUser(userId, reason);
        }

        /* Welcome label shows Full_Name (Username) when available */
        function updateUserContext(identity) {
          if (!userLabel) return;
          let display = "";
          let username = "";

          if (identity && typeof identity === "object") {
            const normalizedFull =
              identity.Full_Name ||
              identity.fullName ||
              identity.Name ||
              identity.name ||
              identity.displayName ||
              "";
            const normalizedUser =
              identity.Username ||
              identity.username ||
              identity.UserName ||
              identity.userName ||
              identity.Email ||
              identity.email ||
              "";
            display = normalizedFull || "";
            username = normalizedUser || "";
            lastLoginIdentity = {
              Full_Name: normalizedFull || "",
              Username: normalizedUser || normalizedFull || "",
            };
          } else if (typeof identity === "string") {
            const trimmed = identity.trim();
            if (trimmed) {
              display = trimmed;
              if (trimmed !== "User" || !lastLoginIdentity) {
                lastLoginIdentity = {
                  Full_Name: trimmed,
                  Username: trimmed,
                };
              }
            }
          } else if (identity != null) {
            const text = String(identity).trim();
            if (text) {
              display = text;
              if (text !== "User" || !lastLoginIdentity) {
                lastLoginIdentity = {
                  Full_Name: text,
                  Username: text,
                };
              }
            }
          }

          if (!display && lastLoginIdentity) {
            display =
              lastLoginIdentity.Full_Name ||
              lastLoginIdentity.Username ||
              "";
            username = lastLoginIdentity.Username || username;
          }

          if (!display) display = "User";
          if (!username && lastLoginIdentity) {
            username = lastLoginIdentity.Username || "";
          }

          const suffix = username && username !== display ? ` (${username})` : "";
          userLabel.textContent = `User: ${display}${suffix}`;
          const welcome = document.getElementById("portal-welcome-message");
          if (welcome) welcome.textContent = `Welcome, ${display}${suffix}`;
        }

        // Set up sys nav event handlers
        /* Init */
        renderNav();
        renderSysNav();
        renderModuleGrid();
        setActiveSysPane("overview", { force: true });
        bootstrapApp();
      })();
    </script>
  </body>
</html>
